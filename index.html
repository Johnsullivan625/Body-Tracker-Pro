<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Body Tracker Pro - Ultimate Edition</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Work+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --accent-cyan: #06b6d4;
            --accent-purple: #8b5cf6;
            --accent-success: #10b981;
            --accent-danger: #ef4444;
            --accent-warning: #f59e0b;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border: #334155;
        }
        
        body {
            font-family: 'Work Sans', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container { max-width: 1600px; margin: 0 auto; }
        
        .header {
            background: var(--bg-secondary);
            padding: 30px;
            border-radius: 16px;
            margin-bottom: 30px;
            border: 1px solid var(--border);
        }
        
        .header h1 {
            font-size: 2.5em;
            font-weight: 700;
            font-family: 'Space Mono', monospace;
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }
        
        .header-subtitle {
            color: var(--text-secondary);
            font-family: 'Space Mono', monospace;
            font-size: 0.9em;
            margin-bottom: 5px;
        }
        
        .header-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        /* INTEGRITY BADGES */
        .integrity-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
            font-family: 'Space Mono', monospace;
        }
        
        .integrity-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        .integrity-green {
            background: rgba(16, 185, 129, 0.15);
            color: var(--accent-success);
            border: 1px solid var(--accent-success);
        }
        
        .integrity-yellow {
            background: rgba(245, 158, 11, 0.15);
            color: var(--accent-warning);
            border: 1px solid var(--accent-warning);
        }
        
        .integrity-red {
            background: rgba(239, 68, 68, 0.15);
            color: var(--accent-danger);
            border: 1px solid var(--accent-danger);
        }
        
        .integrity-blue {
            background: rgba(6, 182, 212, 0.15);
            color: var(--accent-cyan);
            border: 1px solid var(--accent-cyan);
        }
        
        .integrity-gray {
            background: rgba(148, 163, 184, 0.15);
            color: var(--text-secondary);
            border: 1px solid var(--border);
        }
        
        .dot-green { background: var(--accent-success); }
        .dot-yellow { background: var(--accent-warning); }
        .dot-red { background: var(--accent-danger); }
        .dot-blue { background: var(--accent-cyan); }
        .dot-gray { background: var(--text-secondary); }
        
        button {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border);
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 0.9em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        button:hover {
            background: var(--accent-cyan);
            border-color: var(--accent-cyan);
            transform: translateY(-2px);
        }
        
        button.primary {
            background: var(--accent-cyan);
            border-color: var(--accent-cyan);
        }
        
        button.danger {
            background: var(--accent-danger);
            border-color: var(--accent-danger);
            padding: 5px 10px;
            font-size: 0.8em;
        }
        
        .card {
            background: var(--bg-secondary);
            padding: 25px;
            border-radius: 12px;
            border: 1px solid var(--border);
            margin-bottom: 20px;
        }
        
        .card h2 {
            font-size: 1.5em;
            margin-bottom: 20px;
            color: var(--accent-cyan);
        }
        
        .grid { display: grid; gap: 20px; margin-bottom: 20px; }
        .grid-4 { grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); }
        
        .stat-card {
            background: var(--bg-tertiary);
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid var(--accent-cyan);
        }
        
        .stat-label {
            font-size: 0.85em;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: 700;
            font-family: 'Space Mono', monospace;
            margin: 10px 0;
        }
        
        .stat-change {
            font-size: 0.9em;
            font-family: 'Space Mono', monospace;
        }
        
        .positive { color: var(--accent-success); }
        .negative { color: var(--accent-danger); }
        
        .chart-wrapper {
            position: relative;
            height: 400px;
            width: 100%;
            margin-bottom: 20px;
        }
        
        canvas { max-height: 400px !important; }
        
        .chart-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .chart-tab {
            padding: 10px 20px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9em;
        }
        
        .chart-tab.active {
            background: var(--accent-cyan);
            border-color: var(--accent-cyan);
            font-weight: 600;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.75em;
        }
        
        th {
            background: var(--bg-tertiary);
            padding: 10px 6px;
            text-align: left;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.8em;
            letter-spacing: 0.5px;
            border-bottom: 2px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        td {
            padding: 8px 6px;
            border-bottom: 1px solid var(--border);
        }
        
        tbody tr:hover {
            background: var(--bg-tertiary);
            cursor: pointer;
        }
        
        tbody tr.editing {
            background: rgba(6, 182, 212, 0.15);
            outline: 2px solid var(--accent-cyan);
        }
        
        .refeed-row {
            background: rgba(239, 68, 68, 0.1);
        }
        
        .refeed-row:hover {
            background: rgba(239, 68, 68, 0.15);
        }
        
        td.editing input {
            width: 100%;
            background: var(--bg-primary);
            border: 1px solid var(--accent-cyan);
            color: var(--text-primary);
            padding: 4px 6px;
            border-radius: 4px;
            font-size: 0.95em;
        }
        
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            align-items: center;
            justify-content: center;
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
        }
        
        .modal-overlay.show { display: flex; }
        
        .modal {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 30px;
            max-width: 700px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid var(--border);
        }
        
        .form-section {
            background: var(--bg-tertiary);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        
        .form-section h3 {
            font-size: 1.1em;
            margin-bottom: 15px;
            color: var(--accent-cyan);
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
        }
        
        .form-field label {
            display: block;
            font-size: 0.85em;
            color: var(--text-secondary);
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .form-field input, .form-field textarea {
            width: 100%;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 8px;
            border-radius: 6px;
            font-size: 0.9em;
        }
        
        .form-field input:focus {
            outline: none;
            border-color: var(--accent-cyan);
        }
        
        .form-field input[readonly] {
            background: var(--bg-primary);
            color: var(--text-secondary);
            cursor: not-allowed;
        }
        
        .required::after {
            content: " *";
            color: var(--accent-danger);
        }
        
        .integrity-notice {
            background: rgba(6, 182, 212, 0.1);
            border-left: 4px solid var(--accent-cyan);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        .integrity-notice h4 {
            color: var(--accent-cyan);
            margin-bottom: 8px;
            font-size: 1em;
        }
        
        .integrity-notice p {
            font-size: 0.9em;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }
        
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--accent-success);
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 2000;
            display: none;
            animation: slideIn 0.3s ease;
            max-width: 500px;
            font-size: 0.9em;
            white-space: pre-line;
            font-family: 'Space Mono', monospace;
        }
        
        .toast.show { display: block; }
        .toast.error { background: var(--accent-danger); }
        .toast.warning { background: var(--accent-warning); }
        
        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .table-container {
            overflow-x: auto;
            max-height: 600px;
            overflow-y: auto;
        }
        
        .edit-actions {
            display: flex;
            gap: 5px;
        }
        
        .tab-button {
            padding: 12px 24px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1em;
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .tab-button:hover {
            background: var(--accent-cyan);
            border-color: var(--accent-cyan);
            transform: translateY(-2px);
        }
        
        .tab-button.active {
            background: var(--accent-cyan);
            border-color: var(--accent-cyan);
            font-weight: 600;
        }
        
        .main-tab-content {
            display: none;
        }
        
        .main-tab-content.active {
            display: block;
        }
        
        .grid-2 { grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); }
        
        .nutrition-card {
            background: var(--bg-tertiary);
            padding: 20px;
            border-radius: 10px;
            margin: 10px 0;
        }
        
        .nutrition-label {
            font-size: 0.9em;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }
        
        .nutrition-value {
            font-size: 1.8em;
            font-weight: 700;
            font-family: 'Space Mono', monospace;
            color: var(--accent-cyan);
        }
        
        @media (max-width: 768px) {
            .header h1 { font-size: 1.8em; }
            .grid-4, .grid-2 { grid-template-columns: 1fr; }
            .form-grid { grid-template-columns: 1fr; }
            table { font-size: 0.7em; }
            th, td { padding: 6px 3px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üí™ BODY TRACKER PRO - ULTIMATE EDITION</h1>
            <p class="header-subtitle">‚ú® With Intelligent Data Integrity Validation</p>
            <p style="color: var(--text-secondary); font-family: 'Space Mono', monospace;" id="headerStatus">Loading...</p>
            <div class="header-actions">
                <button onclick="showAddEntry()" class="primary">+ Add Entry</button>
                <button onclick="exportCSV()">üì• Export CSV</button>
                <button onclick="exportBackup()">üíæ Backup JSON</button>
                <button onclick="reloadData()" style="background: var(--accent-purple);">üîÑ Reload Data</button>
                <button onclick="debugData()" style="background: var(--accent-warning);">üîß Debug Data</button>
            </div>
        </div>

        <!-- TAB NAVIGATION -->
        <div style="display: flex; gap: 10px; margin-bottom: 30px; flex-wrap: wrap; background: var(--bg-secondary); padding: 15px; border-radius: 12px; border: 1px solid var(--border);">
            <button class="tab-button active" onclick="switchMainTab('dashboard', this)">üìä Dashboard</button>
            <button class="tab-button" onclick="switchMainTab('nutrition', this)">üçΩÔ∏è Nutrition</button>
            <button class="tab-button" onclick="switchMainTab('measurements', this)">üìè Body Measurements</button>
            <button class="tab-button" onclick="switchMainTab('training', this)">üèãÔ∏è Training Log</button>
            <button class="tab-button" onclick="switchMainTab('correlations', this)">üîç Correlations</button>
            <button class="tab-button" onclick="switchMainTab('data', this)">üìã All Data</button>
        </div>

        <!-- DASHBOARD TAB -->
        <div id="dashboard-tab" class="main-tab-content active">
            <div class="grid grid-4" id="statsGrid"></div>

            <div class="card">
                <h2>üéØ Goal Projection</h2>
                <div id="goalContent"></div>
            </div>

            <div class="card">
                <h2>üìä Body Composition Analysis</h2>
                <p style="color: var(--text-secondary); margin-bottom: 15px;">Choose a view to understand your transformation better</p>
                <div class="chart-tabs">
                    <div class="chart-tab active" onclick="switchChart('fatVsLean', this)">Fat vs Lean Breakdown</div>
                    <div class="chart-tab" onclick="switchChart('weightTrend', this)">Weight & BF% Trend</div>
                    <div class="chart-tab" onclick="switchChart('rateOfChange', this)">Daily Rate of Change</div>
                    <div class="chart-tab" onclick="switchChart('nutrition', this)">Nutrition Tracking</div>
                    <div class="chart-tab" onclick="switchChart('waterOverlay', this)">Body Water % Overlay</div>
                </div>
                <div class="chart-wrapper">
                    <canvas id="mainChart"></canvas>
                </div>
            </div>
        </div>

        <!-- NUTRITION TAB -->
        <div id="nutrition-tab" class="main-tab-content">
            <div class="card">
                <h2>üçΩÔ∏è Nutrition Goals & Analysis</h2>
                <div id="nutritionGoals"></div>
            </div>
            <div class="grid grid-2">
                <div class="card">
                    <h3>üìä Total Averages (All Time)</h3>
                    <div id="totalAverages"></div>
                </div>
                <div class="card">
                    <h3>üìà Rolling 7-Day Averages</h3>
                    <div id="rollingAverages"></div>
                </div>
            </div>
            <div class="card">
                <h2>üí° Calorie Recommendations</h2>
                <div id="recommendations"></div>
            </div>
            <div class="card">
                <h2>üéØ What-If Calculator</h2>
                <div id="whatIfCalc"></div>
            </div>
        </div>

        <!-- MEASUREMENTS TAB -->
        <div id="measurements-tab" class="main-tab-content">
            <div class="card">
                <h2>üìè Body Measurements</h2>
                <button onclick="showAddMeasurement()" class="primary" style="margin-bottom: 20px;">+ Add Measurement</button>
                <div id="measurementsContent"></div>
            </div>
        </div>

        <!-- TRAINING TAB -->
        <div id="training-tab" class="main-tab-content">
            <div class="card">
                <h2>üèãÔ∏è Training Log</h2>
                <button onclick="showAddWorkout()" class="primary" style="margin-bottom: 20px;">+ Add Workout</button>
                <div id="trainingContent"></div>
            </div>
        </div>

        <!-- CORRELATIONS TAB -->
        <div id="correlations-tab" class="main-tab-content">
            <div class="card">
                <h2>üîç Correlations & Insights</h2>
                <div id="correlationsContent"></div>
            </div>
        </div>

        <!-- DATA TAB -->
        <div id="data-tab" class="main-tab-content">
            <div class="card">
                <h2>üìã Complete Data Log (<span id="entryCount">0</span> entries)</h2>
                <p style="color: var(--text-secondary); margin-bottom: 15px;">Click any row to edit ‚Ä¢ Red rows = refeed days ‚Ä¢ Badges show data integrity</p>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>‚úì</th>
                                <th>Weight</th>
                                <th>BF%</th>
                                <th>BF lbs</th>
                                <th>Lean</th>
                                <th>Lean%</th>
                                <th>Water%</th>
                                <th>Cal</th>
                                <th>Pro</th>
                                <th>Fat</th>
                                <th>Carbs</th>
                                <th>Steps</th>
                                <th>RHR</th>
                                <th>Sleep</th>
                                <th>Sleep Hrs</th>
                                <th>Refeed</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="dataTable"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- ADD ENTRY MODAL -->
    <div class="modal-overlay" id="addEntryModal">
        <div class="modal">
            <h2 id="modalTitle">Add New Entry</h2>
            
            <div class="integrity-notice">
                <h4>üõ°Ô∏è Intelligent Data Validation</h4>
                <p>This tracker automatically validates your entries to catch typos and errors.</p>
                <p>You'll be alerted if weight, body fat %, or lean mass don't align with your typical patterns.</p>
            </div>
            
            <div class="form-section">
                <h3>Body Composition (Required)</h3>
                <div class="form-grid">
                    <div class="form-field">
                        <label class="required">Date</label>
                        <input type="date" id="entryDate" required>
                    </div>
                    <div class="form-field">
                        <label class="required">Weight (lbs)</label>
                        <input type="number" step="0.1" id="entryWeight" required>
                    </div>
                    <div class="form-field">
                        <label class="required">Body Fat %</label>
                        <input type="number" step="0.1" id="entryBfPercent" required>
                    </div>
                    <div class="form-field">
                        <label class="required">Lean Mass (lbs)</label>
                        <input type="number" step="0.1" id="entryLeanLbs" required>
                    </div>
                    <div class="form-field">
                        <label>BF lbs (Auto)</label>
                        <input type="text" id="entryBfLbsAuto" readonly>
                    </div>
                    <div class="form-field">
                        <label>Lean % (Auto)</label>
                        <input type="text" id="entryLeanPercentAuto" readonly>
                    </div>
                    <div class="form-field">
                        <label>Residual (Auto)</label>
                        <input type="text" id="entryResidualAuto" readonly>
                        <div style="font-size: 0.75em; color: var(--text-secondary); margin-top: 3px;">Used for integrity check</div>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h3>Nutrition</h3>
                <div class="form-grid">
                    <div class="form-field">
                        <label>Calories</label>
                        <input type="number" id="entryCalories">
                    </div>
                    <div class="form-field">
                        <label>Protein (g)</label>
                        <input type="number" id="entryProtein">
                    </div>
                    <div class="form-field">
                        <label>Fat (g)</label>
                        <input type="number" id="entryFat">
                    </div>
                    <div class="form-field">
                        <label>Carbs (g)</label>
                        <input type="number" id="entryCarbs">
                    </div>
                    <div class="form-field">
                        <label><input type="checkbox" id="entryRefeed" style="width: auto; margin-right: 8px;">Refeed Day üî•</label>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h3>Activity & Wellness</h3>
                <div class="form-grid">
                    <div class="form-field">
                        <label>Steps</label>
                        <input type="number" id="entrySteps">
                    </div>
                    <div class="form-field">
                        <label>RHR (bpm)</label>
                        <input type="number" id="entryRhr">
                    </div>
                    <div class="form-field">
                        <label>Sleep Score (0-100)</label>
                        <input type="number" min="0" max="100" id="entrySleepScore">
                    </div>
                    <div class="form-field">
                        <label>Sleep Hours</label>
                        <input type="number" step="0.1" id="entrySleepHours">
                    </div>
                    <div class="form-field">
                        <label>Body Water % (Optional)</label>
                        <input type="number" step="0.1" id="entryBodyWater">
                    </div>
                </div>
            </div>

            <div class="form-section">
                <div class="form-field">
                    <label>Notes</label>
                    <textarea rows="2" id="entryNotes"></textarea>
                </div>
            </div>

            <!-- Integrity Status in Modal -->
            <div id="modalIntegrityStatus" style="margin: 15px 0;"></div>

            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button onclick="saveEntry()" class="primary" id="saveBtn">Save Entry</button>
                <button onclick="hideModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- MEASUREMENTS MODAL -->
    <div class="modal-overlay" id="measurementsModal"></div>

    <!-- TRAINING MODAL -->
    <div class="modal-overlay" id="trainingModal"></div>

    <!-- SYNC MODAL -->
    <div class="modal-overlay" id="syncModal"></div>

    <div class="toast" id="toast"></div>

    <script>
        // ===== GLOBAL CONFIGURATION =====
        const STORAGE_KEY = 'bodyTrackingData_User1';
        
        const MEASUREMENTS_KEY = 'bodyMeasurements_User1';
        const TRAINING_KEY = 'trainingLog_User1';
const GOALS = {
            // Body composition goals
            target_weight: 215,
            target_bf_percent: 10.0,
            target_bf_lbs: 21.5,

            // Nutrition targets (used in Nutrition tab UI)
            // You can adjust these anytime in code (future: make editable in Settings UI)
            target_calories: 1600,
            target_protein: 195,
            target_fat: 60,
            target_carbs: 100
        };
        
        // Integrity validation thresholds
        const INTEGRITY_CONFIG = {
            baselineWindow: 14,  // Days to use for baseline calculation
            greenThreshold: 1.0, // lbs - good integrity
            yellowThreshold: 2.0, // lbs - warning
            // Anything above yellowThreshold is red (error likely)
        };

        let bodyData = [];
        let currentChart = null;
        let currentChartType = 'fatVsLean';
        let editingRow = null;

        // ===== INITIAL DATA (48 days: Oct 27 - Dec 13, 2025) =====
        const INITIAL_DATA = [
            {"date":"2025-10-27","weight":208.1,"bf_percent":20.5,"lean_lbs":156.3,"calories":1405,"protein":116,"fat":83,"carbs":40,"rhr":48,"sleep_score":87,"sleep_duration_hrs":9.42,"steps":7046,"refeed":false,"notes":""},
            {"date":"2025-10-28","weight":208.9,"bf_percent":20.5,"lean_lbs":154.5,"calories":1565,"protein":139,"fat":92,"carbs":30,"rhr":null,"sleep_score":77,"sleep_duration_hrs":6.62,"steps":null,"refeed":false,"notes":""},
            {"date":"2025-10-29","weight":203.4,"bf_percent":20.3,"lean_lbs":154.6,"calories":1577,"protein":151,"fat":79,"carbs":50,"rhr":null,"sleep_score":63,"sleep_duration_hrs":9.18,"steps":null,"refeed":false,"notes":""},
            {"date":"2025-10-30","weight":202.6,"bf_percent":20.0,"lean_lbs":154.5,"calories":1555,"protein":142,"fat":95,"carbs":23,"rhr":55,"sleep_score":null,"sleep_duration_hrs":null,"steps":6480,"refeed":false,"notes":""},
            {"date":"2025-10-31","weight":205.0,"bf_percent":19.7,"lean_lbs":154.2,"calories":1290,"protein":147,"fat":59,"carbs":35,"rhr":54,"sleep_score":86,"sleep_duration_hrs":10.38,"steps":9519,"refeed":false,"notes":""},
            {"date":"2025-11-01","weight":204.4,"bf_percent":19.7,"lean_lbs":154.2,"calories":1735,"protein":146,"fat":41,"carbs":31,"rhr":52,"sleep_score":66,"sleep_duration_hrs":7.0,"steps":5231,"refeed":false,"notes":""},
            {"date":"2025-11-02","weight":203.8,"bf_percent":19.5,"lean_lbs":154.3,"calories":1436,"protein":134,"fat":76,"carbs":29,"rhr":51,"sleep_score":91,"sleep_duration_hrs":8.1,"steps":2859,"refeed":false,"notes":""},
            {"date":"2025-11-03","weight":204.0,"bf_percent":19.3,"lean_lbs":154.4,"calories":1981,"protein":207,"fat":76,"carbs":35,"rhr":55,"sleep_score":67,"sleep_duration_hrs":7.53,"steps":9321,"refeed":false,"notes":""},
            {"date":"2025-11-04","weight":203.9,"bf_percent":19.2,"lean_lbs":154.4,"calories":1660,"protein":131,"fat":48,"carbs":50,"rhr":54,"sleep_score":73,"sleep_duration_hrs":6.65,"steps":7202,"refeed":false,"notes":""},
            {"date":"2025-11-05","weight":200.8,"bf_percent":19.5,"lean_lbs":153.8,"calories":1525,"protein":161,"fat":85,"carbs":20,"rhr":52,"sleep_score":87,"sleep_duration_hrs":9.1,"steps":5753,"refeed":false,"notes":""},
            {"date":"2025-11-06","weight":200.6,"bf_percent":19.6,"lean_lbs":153.3,"calories":1492,"protein":141,"fat":82,"carbs":39,"rhr":50,"sleep_score":76,"sleep_duration_hrs":9.03,"steps":10762,"refeed":false,"notes":""},
            {"date":"2025-11-07","weight":200.2,"bf_percent":19.4,"lean_lbs":153.2,"calories":1724,"protein":179,"fat":71,"carbs":83,"rhr":52,"sleep_score":65,"sleep_duration_hrs":6.48,"steps":11448,"refeed":false,"notes":""},
            {"date":"2025-11-08","weight":201.1,"bf_percent":19.1,"lean_lbs":153.3,"calories":2465,"protein":180,"fat":82,"carbs":197,"rhr":49,"sleep_score":73,"sleep_duration_hrs":8.67,"steps":4149,"refeed":true,"notes":""},
            {"date":"2025-11-09","weight":202.8,"bf_percent":18.6,"lean_lbs":153.8,"calories":1710,"protein":203,"fat":57,"carbs":81,"rhr":48,"sleep_score":85,"sleep_duration_hrs":7.17,"steps":4673,"refeed":false,"notes":""},
            {"date":"2025-11-10","weight":201.8,"bf_percent":18.4,"lean_lbs":154.2,"calories":1908,"protein":203,"fat":68,"carbs":100,"rhr":51,"sleep_score":78,"sleep_duration_hrs":9.0,"steps":7444,"refeed":false,"notes":""},
            {"date":"2025-11-11","weight":200.3,"bf_percent":18.3,"lean_lbs":154.4,"calories":1199,"protein":150,"fat":26,"carbs":65,"rhr":45,"sleep_score":56,"sleep_duration_hrs":4.88,"steps":2327,"refeed":false,"notes":""},
            {"date":"2025-11-12","weight":199.1,"bf_percent":18.3,"lean_lbs":154.2,"calories":1210,"protein":101,"fat":72,"carbs":28,"rhr":46,"sleep_score":76,"sleep_duration_hrs":9.7,"steps":3724,"refeed":false,"notes":""},
            {"date":"2025-11-13","weight":199.5,"bf_percent":18.3,"lean_lbs":153.7,"calories":1756,"protein":133,"fat":112,"carbs":39,"rhr":48,"sleep_score":83,"sleep_duration_hrs":8.78,"steps":10266,"refeed":false,"notes":""},
            {"date":"2025-11-14","weight":197.5,"bf_percent":18.4,"lean_lbs":153.5,"calories":2583,"protein":202,"fat":51,"carbs":270,"rhr":47,"sleep_score":81,"sleep_duration_hrs":8.53,"steps":6214,"refeed":true,"notes":""},
            {"date":"2025-11-15","weight":199.1,"bf_percent":18.0,"lean_lbs":153.6,"calories":1960,"protein":219,"fat":84,"carbs":75,"rhr":55,"sleep_score":62,"sleep_duration_hrs":6.62,"steps":4173,"refeed":false,"notes":""},
            {"date":"2025-11-16","weight":199.6,"bf_percent":17.8,"lean_lbs":153.8,"calories":1502,"protein":156,"fat":30,"carbs":128,"rhr":54,"sleep_score":60,"sleep_duration_hrs":7.1,"steps":4655,"refeed":false,"notes":""},
            {"date":"2025-11-17","weight":198.3,"bf_percent":17.7,"lean_lbs":153.8,"calories":2165,"protein":207,"fat":127,"carbs":32,"rhr":52,"sleep_score":67,"sleep_duration_hrs":8.88,"steps":12478,"refeed":true,"notes":""},
            {"date":"2025-11-18","weight":199.8,"bf_percent":17.8,"lean_lbs":153.4,"calories":1718,"protein":163,"fat":103,"carbs":26,"rhr":50,"sleep_score":71,"sleep_duration_hrs":7.05,"steps":4852,"refeed":false,"notes":""},
            {"date":"2025-11-19","weight":199.8,"bf_percent":17.5,"lean_lbs":153.9,"calories":1715,"protein":169,"fat":60,"carbs":61,"rhr":57,"sleep_score":null,"sleep_duration_hrs":null,"steps":10165,"refeed":false,"notes":""},
            {"date":"2025-11-20","weight":197.9,"bf_percent":17.2,"lean_lbs":154.4,"calories":2008,"protein":195,"fat":105,"carbs":50,"rhr":54,"sleep_score":63,"sleep_duration_hrs":8.33,"steps":4982,"refeed":true,"notes":""},
            {"date":"2025-11-21","weight":197.2,"bf_percent":16.9,"lean_lbs":154.7,"calories":1275,"protein":207,"fat":48,"carbs":17,"rhr":54,"sleep_score":85,"sleep_duration_hrs":9.3,"steps":6988,"refeed":false,"notes":""},
            {"date":"2025-11-22","weight":198.4,"bf_percent":16.4,"lean_lbs":155.3,"calories":1835,"protein":229,"fat":48,"carbs":114,"rhr":48,"sleep_score":null,"sleep_duration_hrs":null,"steps":4021,"refeed":false,"notes":""},
            {"date":"2025-11-23","weight":200.2,"bf_percent":16.0,"lean_lbs":155.9,"calories":1501,"protein":132,"fat":37,"carbs":146,"rhr":51,"sleep_score":72,"sleep_duration_hrs":7.35,"steps":5803,"refeed":false,"notes":""},
            {"date":"2025-11-24","weight":196.7,"bf_percent":16.6,"lean_lbs":154.9,"calories":null,"protein":null,"fat":98,"carbs":18,"rhr":49,"sleep_score":88,"sleep_duration_hrs":10.03,"steps":7179,"refeed":false,"notes":""},
            {"date":"2025-11-25","weight":199.7,"bf_percent":16.5,"lean_lbs":154.7,"calories":1431,"protein":110,"fat":23,"carbs":188,"rhr":50,"sleep_score":76,"sleep_duration_hrs":7.98,"steps":9946,"refeed":false,"notes":""},
            {"date":"2025-11-26","weight":200.2,"bf_percent":16.5,"lean_lbs":154.8,"calories":1325,"protein":195,"fat":47,"carbs":25,"rhr":48,"sleep_score":67,"sleep_duration_hrs":7.82,"steps":10712,"refeed":false,"notes":""},
            {"date":"2025-11-27","weight":196.0,"bf_percent":16.9,"lean_lbs":154.3,"calories":null,"protein":null,"fat":null,"carbs":null,"rhr":49,"sleep_score":null,"sleep_duration_hrs":10.3,"steps":7392,"refeed":true,"notes":"Thanksgiving"},
            {"date":"2025-11-28","weight":200.1,"bf_percent":16.4,"lean_lbs":154.7,"calories":967,"protein":133,"fat":40,"carbs":13,"rhr":53,"sleep_score":78,"sleep_duration_hrs":10.3,"steps":7310,"refeed":false,"notes":""},
            {"date":"2025-11-29","weight":196.2,"bf_percent":16.7,"lean_lbs":154.6,"calories":null,"protein":null,"fat":75,"carbs":49,"rhr":50,"sleep_score":85,"sleep_duration_hrs":7.55,"steps":4914,"refeed":false,"notes":""},
            {"date":"2025-11-30","weight":196.3,"bf_percent":16.7,"lean_lbs":154.2,"calories":1410,"protein":206,"fat":46,"carbs":47,"rhr":49,"sleep_score":89,"sleep_duration_hrs":7.63,"steps":3947,"refeed":false,"notes":""},
            {"date":"2025-12-01","weight":192.6,"bf_percent":16.7,"lean_lbs":154.0,"calories":1105,"protein":182,"fat":27,"carbs":46,"rhr":49,"sleep_score":84,"sleep_duration_hrs":12.1,"steps":5540,"refeed":false,"notes":""},
            {"date":"2025-12-02","weight":194.1,"bf_percent":16.4,"lean_lbs":153.9,"calories":1442,"protein":201,"fat":36,"carbs":94,"rhr":49,"sleep_score":73,"sleep_duration_hrs":7.2,"steps":10665,"refeed":false,"notes":"Starting today (Dec 2), all carb entries are Total Carbs (not Net Carbs)."},
            {"date":"2025-12-03","weight":192.5,"bf_percent":16.1,"lean_lbs":154.1,"calories":1522,"protein":195,"fat":66,"carbs":45,"rhr":51,"sleep_score":81,"sleep_duration_hrs":8.72,"steps":6742,"refeed":false,"notes":""},
            {"date":"2025-12-04","weight":192.9,"bf_percent":16.1,"lean_lbs":152.8,"calories":1817,"protein":219,"fat":61,"carbs":118,"rhr":49,"sleep_score":85,"sleep_duration_hrs":7.5,"steps":3050,"refeed":false,"notes":""},
            {"date":"2025-12-05","weight":195.2,"bf_percent":15.6,"lean_lbs":154.1,"calories":1525,"protein":136,"fat":81,"carbs":159,"rhr":48,"sleep_score":90,"sleep_duration_hrs":7.99,"steps":8607,"refeed":false,"notes":"Traveled back from Tampa. Ate dinner at friend's house. Had sour dough bread and a cream of chicken dish. Difficult to accurately track nutrition."},
            {"date":"2025-12-06","weight":194.4,"bf_percent":15.7,"lean_lbs":153.7,"calories":1837,"protein":168,"fat":81,"carbs":122,"rhr":49,"sleep_score":85,"sleep_duration_hrs":8.27,"steps":2662,"refeed":false,"notes":"Ate at a friends but had 2 helpings of instant mashed potatoes and had cheese when I came home. Picked a little and probably had a half of a potato skin w/cheese."},
            {"date":"2025-12-07","weight":195.3,"bf_percent":15.5,"lean_lbs":153.9,"calories":1776,"protein":198,"fat":61,"carbs":118,"rhr":53,"sleep_score":null,"sleep_duration_hrs":8.25,"steps":5230,"refeed":false,"notes":"Diet was atrocious. Had crackers and dip around lunch time. Cleaned diet up in the afternoon and went to the gym and put in 1500 ropes to lessen the negative impact."},
            {"date":"2025-12-08","weight":193.2,"bf_percent":16.2,"lean_lbs":152.8,"calories":1768,"protein":198,"fat":67,"carbs":114,"rhr":47,"sleep_score":86,"sleep_duration_hrs":8.1,"steps":7734,"refeed":false,"notes":""},
            {"date":"2025-12-09","weight":193.2,"bf_percent":16.2,"lean_lbs":152.5,"calories":1330,"protein":185,"fat":36,"carbs":47,"rhr":47,"sleep_score":78,"sleep_duration_hrs":6.62,"steps":6809,"refeed":false,"notes":""},
            {"date":"2025-12-10","weight":196.7,"bf_percent":16.1,"lean_lbs":152.3,"calories":1465,"protein":213,"fat":47,"carbs":48,"rhr":47,"sleep_score":72,"sleep_duration_hrs":7.37,"steps":9408,"refeed":false,"notes":""},
            {"date":"2025-12-11","weight":192.5,"bf_percent":16.2,"lean_lbs":152.4,"calories":1604,"protein":194,"fat":66,"carbs":55,"rhr":47,"sleep_score":90,"sleep_duration_hrs":9.48,"steps":2821,"refeed":false,"notes":""},
            {"date":"2025-12-12","weight":193.2,"bf_percent":16.2,"lean_lbs":152.1,"calories":1571,"protein":193,"fat":66,"carbs":59,"rhr":52,"sleep_score":83,"sleep_duration_hrs":7.72,"steps":4484,"refeed":false,"notes":""},
            {"date":"2025-12-13","weight":193.8,"bf_percent":16.0,"lean_lbs":152.2,"calories":null,"protein":null,"fat":null,"carbs":null,"rhr":44,"sleep_score":82,"sleep_duration_hrs":6.43,"steps":null,"refeed":false,"notes":""}
        ];

        // ===== INTEGRITY VALIDATION FUNCTIONS =====
        
        function computeDerivedFields(weight, bfPercent, leanMass) {
            if (!isFinite(weight) || !isFinite(bfPercent) || !isFinite(leanMass)) {
                return null;
            }
            
            const bfLbs = weight * (bfPercent / 100);
            const leanPercent = (leanMass / weight) * 100;
            const residual = weight - bfLbs - leanMass;
            
            return {
                bf_lbs: parseFloat(bfLbs.toFixed(2)),
                lean_percent: parseFloat(leanPercent.toFixed(2)),
                residual: parseFloat(residual.toFixed(2))
            };
        }
        
        function validateEntry(weight, bfPercent, leanMass) {
            // Sanity checks
            const errors = [];
            
            if (!isFinite(weight) || !isFinite(bfPercent) || !isFinite(leanMass)) {
                return { status: 'gray', message: 'Missing required fields', errors: ['Enter weight, body fat %, and lean mass'] };
            }
            
            if (weight <= 50 || weight >= 500) errors.push('Weight looks out of range (50-500 lbs)');
            if (bfPercent <= 2 || bfPercent >= 70) errors.push('Body fat % looks out of range (2-70%)');
            if (leanMass <= 50 || leanMass >= weight) errors.push('Lean mass must be less than weight and plausible');
            
            const derived = computeDerivedFields(weight, bfPercent, leanMass);
            if (!derived) {
                errors.push('Unable to compute derived fields');
                return { status: 'red', message: 'Validation failed', errors, derived: null };
            }
            
            if (derived.bf_lbs < 0 || derived.bf_lbs > weight) errors.push('Computed body fat lbs out of range');
            if (derived.lean_percent < 30 || derived.lean_percent > 95) errors.push('Computed lean % out of range (30-95%)');
            if (derived.residual < -5 || derived.residual > 80) errors.push('Residual out of plausible range');
            
            if (errors.length > 0) {
                return { status: 'red', message: errors[0], errors, derived };
            }
            
            return { status: 'valid', message: 'Entry passes sanity checks', errors: [], derived };
        }
        
        function computeIntegrityStatus(weight, bfPercent, leanMass) {
            const validation = validateEntry(weight, bfPercent, leanMass);
            
            if (validation.status === 'red' || validation.status === 'gray') {
                return validation;
            }
            
            // Get historical residuals for baseline
            const validEntries = bodyData.filter(e => 
                isFinite(e.weight) && isFinite(e.bf_percent) && isFinite(e.lean_lbs) && e.residual !== undefined
            ).sort((a, b) => a.date.localeCompare(b.date));
            
            const recent = validEntries.slice(-INTEGRITY_CONFIG.baselineWindow);
            
            if (recent.length < 7) {
                return {
                    status: 'blue',
                    message: 'Building baseline (need 7+ entries)',
                    errors: [],
                    derived: validation.derived,
                    baselineCount: recent.length
                };
            }
            
            const residuals = recent.map(e => e.residual);
            const baselineMean = residuals.reduce((sum, r) => sum + r, 0) / residuals.length;
            const residualDelta = Math.abs(validation.derived.residual - baselineMean);
            
            if (residualDelta <= INTEGRITY_CONFIG.greenThreshold) {
                return {
                    status: 'green',
                    message: 'Good - Values align with baseline',
                    errors: [],
                    derived: validation.derived,
                    baselineMean,
                    residualDelta
                };
            } else if (residualDelta <= INTEGRITY_CONFIG.yellowThreshold) {
                return {
                    status: 'yellow',
                    message: 'Warning - Slight variance detected',
                    errors: [],
                    derived: validation.derived,
                    baselineMean,
                    residualDelta
                };
            } else {
                return {
                    status: 'red',
                    message: `Check data - Residual shifted ${residualDelta.toFixed(1)} lbs from baseline`,
                    errors: ['Possible entry error - verify values from Hume app'],
                    derived: validation.derived,
                    baselineMean,
                    residualDelta
                };
            }
        }
        
        function createIntegrityBadge(status, message) {
            const badges = {
                green: { class: 'integrity-green', dot: 'dot-green', text: '‚úì Good' },
                yellow: { class: 'integrity-yellow', dot: 'dot-yellow', text: '‚ö† Warn' },
                red: { class: 'integrity-red', dot: 'dot-red', text: '‚úó Check' },
                blue: { class: 'integrity-blue', dot: 'dot-blue', text: '‚óã Build' },
                gray: { class: 'integrity-gray', dot: 'dot-gray', text: '‚Äî N/A' }
            };
            
            const badge = badges[status] || badges.gray;
            return `<span class="integrity-badge ${badge.class}" title="${message}">
                        <span class="integrity-dot ${badge.dot}"></span>
                        <span>${badge.text}</span>
                    </span>`;
        }

        // ===== DATA MANAGEMENT =====
        
        function loadData() {
            const stored = localStorage.getItem(STORAGE_KEY);
            if (stored) {
                bodyData = JSON.parse(stored);
                console.log(`‚úÖ Loaded ${bodyData.length} entries from localStorage`);
            } else {
                // First time - load initial data
                bodyData = INITIAL_DATA.map(entry => {
                    const derived = computeDerivedFields(entry.weight, entry.bf_percent, entry.lean_lbs);
                    return {
                        ...entry,
                        bf_lbs: derived?.bf_lbs || (entry.weight * entry.bf_percent / 100),
                        lean_percent: derived?.lean_percent || ((entry.lean_lbs / entry.weight) * 100),
                        residual: derived?.residual || (entry.weight - (entry.weight * entry.bf_percent / 100) - entry.lean_lbs)
                    };
                });
                saveData();
                console.log(`‚úÖ Loaded ${bodyData.length} entries from INITIAL_DATA`);
            }
            
            // Recompute integrity for all entries
            bodyData = bodyData.map(entry => {
                const integrity = computeIntegrityStatus(entry.weight, entry.bf_percent, entry.lean_lbs);
                return {
                    ...entry,
                    integrity_status: integrity.status,
                    integrity_message: integrity.message
                };
            });
        }
        
        function saveData() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(bodyData));
        }
        
        function reloadData() {
            if (confirm('Reload original 48-day dataset? This will replace any new entries you added.')) {
                localStorage.removeItem(STORAGE_KEY);
                location.reload();
            }
        }
        
        // ===== UI UPDATE FUNCTIONS =====
        
        function updateStats() {
            if (bodyData.length === 0) {
                document.getElementById('headerStatus').textContent = 'No data yet - add your first entry!';
                return;
            }
            
            const sorted = bodyData.slice().sort((a, b) => a.date.localeCompare(b.date));
            const first = sorted[0];
            const latest = sorted[sorted.length - 1];
            
            const weightChange = latest.weight - first.weight;
            const bfChange = latest.bf_percent - first.bf_percent;
            const leanChange = latest.lean_lbs - first.lean_lbs;
            
            const fatLost = (first.weight * first.bf_percent / 100) - (latest.weight * latest.bf_percent / 100);
            
            document.getElementById('headerStatus').textContent = 
                `${bodyData.length} entries ‚Ä¢ ${first.date} to ${latest.date} ‚Ä¢ ` +
                `Weight: ${weightChange >= 0 ? '+' : ''}${weightChange.toFixed(1)} lbs ‚Ä¢ ` +
                `Fat Lost: ${fatLost.toFixed(1)} lbs`;
            
            document.getElementById('entryCount').textContent = bodyData.length;
            
            // Stats cards
            const statsHtml = `
                <div class="stat-card">
                    <div class="stat-label">Current Weight</div>
                    <div class="stat-value">${latest.weight.toFixed(1)}</div>
                    <div class="stat-change ${weightChange <= 0 ? 'positive' : 'negative'}">
                        ${weightChange >= 0 ? '+' : ''}${weightChange.toFixed(1)} lbs from start
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Body Fat %</div>
                    <div class="stat-value">${latest.bf_percent.toFixed(1)}%</div>
                    <div class="stat-change ${bfChange <= 0 ? 'positive' : 'negative'}">
                        ${bfChange >= 0 ? '+' : ''}${bfChange.toFixed(1)}% from start
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Fat Lost</div>
                    <div class="stat-value">${fatLost.toFixed(1)}</div>
                    <div class="stat-change positive">
                        lbs of pure fat
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Lean Mass</div>
                    <div class="stat-value">${latest.lean_lbs.toFixed(1)}</div>
                    <div class="stat-change ${leanChange >= 0 ? 'positive' : 'negative'}">
                        ${leanChange >= 0 ? '+' : ''}${leanChange.toFixed(1)} lbs from start
                    </div>
                </div>
            `;
            
            document.getElementById('statsGrid').innerHTML = statsHtml;
            
            // Goal projection
            updateGoalProjection(sorted, latest, fatLost);
        }
        
        function updateGoalProjection(sorted, latest, fatLost) {
            const currentFatLbs = latest.weight * latest.bf_percent / 100;
            const targetFatLbs = GOALS.target_bf_lbs;
            const fatToLose = currentFatLbs - targetFatLbs;
            
            const days = sorted.length;
            const avgFatLossPerDay = days > 1 ? fatLost / days : 0;
            const daysToGoal = avgFatLossPerDay > 0 ? fatToLose / avgFatLossPerDay : 0;
            
            const goalDate = new Date(latest.date);
            goalDate.setDate(goalDate.getDate() + daysToGoal);
            
            const progress = Math.max(0, Math.min(100, (fatLost / (fatLost + fatToLose)) * 100));
            
            const goalHtml = `
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span style="font-family: 'Space Mono', monospace;">Current: ${currentFatLbs.toFixed(1)} lbs fat</span>
                        <span style="font-family: 'Space Mono', monospace;">Target: ${targetFatLbs.toFixed(1)} lbs fat</span>
                    </div>
                    <div style="background: var(--bg-tertiary); height: 30px; border-radius: 8px; overflow: hidden;">
                        <div style="background: linear-gradient(90deg, var(--accent-success), var(--accent-cyan)); height: 100%; width: ${progress}%; transition: width 0.5s ease;"></div>
                    </div>
                    <div style="text-align: center; margin-top: 10px; color: var(--text-secondary);">
                        ${progress.toFixed(1)}% to goal
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div>
                        <div style="color: var(--text-secondary); font-size: 0.85em;">Fat to Lose</div>
                        <div style="font-size: 1.5em; font-weight: 700; font-family: 'Space Mono', monospace;">${fatToLose.toFixed(1)} lbs</div>
                    </div>
                    <div>
                        <div style="color: var(--text-secondary); font-size: 0.85em;">Avg Loss Rate</div>
                        <div style="font-size: 1.5em; font-weight: 700; font-family: 'Space Mono', monospace;">${(avgFatLossPerDay * 7).toFixed(2)} lbs/week</div>
                    </div>
                    <div>
                        <div style="color: var(--text-secondary); font-size: 0.85em;">Estimated Goal Date</div>
                        <div style="font-size: 1.5em; font-weight: 700; font-family: 'Space Mono', monospace;">
                            ${daysToGoal > 0 ? goalDate.toLocaleDateString() : 'N/A'}
                        </div>
                    </div>
                    <div>
                        <div style="color: var(--text-secondary); font-size: 0.85em;">Days Remaining</div>
                        <div style="font-size: 1.5em; font-weight: 700; font-family: 'Space Mono', monospace;">
                            ${daysToGoal > 0 ? Math.ceil(daysToGoal) : 'N/A'}
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('goalContent').innerHTML = goalHtml;
        }
        
        function updateTable() {
            const tbody = document.getElementById('dataTable');
            tbody.innerHTML = '';
            
            const sorted = bodyData.slice().sort((a, b) => b.date.localeCompare(a.date));
            
            sorted.forEach((entry, idx) => {
                const row = document.createElement('tr');
                if (entry.refeed) row.classList.add('refeed-row');
                
                const integrityBadge = createIntegrityBadge(
                    entry.integrity_status || 'gray',
                    entry.integrity_message || 'No validation'
                );
                
                row.innerHTML = `
                    <td>${entry.date}</td>
                    <td>${integrityBadge}</td>
                    <td>${entry.weight?.toFixed(1) || ''}</td>
                    <td>${entry.bf_percent?.toFixed(1) || ''}%</td>
                    <td>${entry.bf_lbs?.toFixed(1) || ''}</td>
                    <td>${entry.lean_lbs?.toFixed(1) || ''}</td>
                    <td>${entry.lean_percent?.toFixed(1) || ''}%</td>
                    <td>${entry.body_water_percent?.toFixed(1) || ''}%</td>
                    <td>${entry.calories || ''}</td>
                    <td>${entry.protein || ''}</td>
                    <td>${entry.fat || ''}</td>
                    <td>${entry.carbs || ''}</td>
                    <td>${entry.steps || ''}</td>
                    <td>${entry.rhr || ''}</td>
                    <td>${entry.sleep_score || ''}</td>
                    <td>${entry.sleep_duration_hrs?.toFixed(1) || ''}</td>
                    <td>${entry.refeed ? 'üî•' : ''}</td>
                    <td>
                        <div class="edit-actions">
                            <button class="danger" onclick="deleteEntry('${entry.date}')">√ó</button>
                        </div>
                    </td>
                `;
                
                row.onclick = (e) => {
                    if (!e.target.classList.contains('danger')) {
                        editEntry(entry.date);
                    }
                };
                
                tbody.appendChild(row);
            });
        }

        // ===== MODAL FUNCTIONS =====
        
        function showAddEntry() {
            document.getElementById('modalTitle').textContent = 'Add New Entry';
            document.getElementById('entryDate').value = new Date().toISOString().split('T')[0];
            clearForm();
            document.getElementById('addEntryModal').classList.add('show');
            updateModalDerivedFields();
        }
        
        function editEntry(date) {
            const entry = bodyData.find(e => e.date === date);
            if (!entry) return;
            
            document.getElementById('modalTitle').textContent = 'Edit Entry';
            document.getElementById('entryDate').value = entry.date;
            document.getElementById('entryWeight').value = entry.weight || '';
            document.getElementById('entryBfPercent').value = entry.bf_percent || '';
            document.getElementById('entryLeanLbs').value = entry.lean_lbs || '';
            document.getElementById('entryCalories').value = entry.calories || '';
            document.getElementById('entryProtein').value = entry.protein || '';
            document.getElementById('entryFat').value = entry.fat || '';
            document.getElementById('entryCarbs').value = entry.carbs || '';
            document.getElementById('entrySteps').value = entry.steps || '';
            document.getElementById('entryRhr').value = entry.rhr || '';
            document.getElementById('entrySleepScore').value = entry.sleep_score || '';
            document.getElementById('entrySleepHours').value = entry.sleep_duration_hrs || '';
            document.getElementById('entryBodyWater').value = entry.body_water_percent || '';
            document.getElementById('entryRefeed').checked = entry.refeed || false;
            document.getElementById('entryNotes').value = entry.notes || '';
            
            updateModalDerivedFields();
            document.getElementById('addEntryModal').classList.add('show');
        }
        
        function hideModal() {
            document.getElementById('addEntryModal').classList.remove('show');
            clearForm();
        }
        
        function clearForm() {
            document.getElementById('entryWeight').value = '';
            document.getElementById('entryBfPercent').value = '';
            document.getElementById('entryLeanLbs').value = '';
            document.getElementById('entryCalories').value = '';
            document.getElementById('entryProtein').value = '';
            document.getElementById('entryFat').value = '';
            document.getElementById('entryCarbs').value = '';
            document.getElementById('entrySteps').value = '';
            document.getElementById('entryRhr').value = '';
            document.getElementById('entrySleepScore').value = '';
            document.getElementById('entrySleepHours').value = '';
            document.getElementById('entryBodyWater').value = '';
            document.getElementById('entryRefeed').checked = false;
            document.getElementById('entryNotes').value = '';
            updateModalDerivedFields();
        }
        
        function updateModalDerivedFields() {
            const weight = parseFloat(document.getElementById('entryWeight').value);
            const bfPercent = parseFloat(document.getElementById('entryBfPercent').value);
            const leanLbs = parseFloat(document.getElementById('entryLeanLbs').value);
            
            const derived = computeDerivedFields(weight, bfPercent, leanLbs);
            
            if (derived) {
                document.getElementById('entryBfLbsAuto').value = derived.bf_lbs.toFixed(1);
                document.getElementById('entryLeanPercentAuto').value = derived.lean_percent.toFixed(1) + '%';
                document.getElementById('entryResidualAuto').value = derived.residual.toFixed(2);
            } else {
                document.getElementById('entryBfLbsAuto').value = '';
                document.getElementById('entryLeanPercentAuto').value = '';
                document.getElementById('entryResidualAuto').value = '';
            }
            
            // Update integrity status in modal
            const integrity = computeIntegrityStatus(weight, bfPercent, leanLbs);
            const statusDiv = document.getElementById('modalIntegrityStatus');
            
            if (integrity.status === 'gray') {
                statusDiv.innerHTML = '';
            } else {
                const badge = createIntegrityBadge(integrity.status, integrity.message);
                let details = `<p style="margin: 5px 0; font-size: 0.9em; color: var(--text-secondary);">${integrity.message}</p>`;
                
                if (integrity.residualDelta !== undefined) {
                    details += `<p style="margin: 5px 0; font-size: 0.85em; font-family: 'Space Mono', monospace; color: var(--text-secondary);">
                        Residual: ${integrity.derived.residual.toFixed(2)} lbs | 
                        Baseline: ${integrity.baselineMean?.toFixed(2) || 'N/A'} lbs | 
                        Delta: ${integrity.residualDelta.toFixed(2)} lbs
                    </p>`;
                }
                
                statusDiv.innerHTML = `
                    <div style="background: rgba(6, 182, 212, 0.05); border: 1px solid var(--border); padding: 15px; border-radius: 8px;">
                        <div style="margin-bottom: 8px;">${badge}</div>
                        ${details}
                    </div>
                `;
            }
        }
        
        // Auto-update when user types
        ['entryWeight', 'entryBfPercent', 'entryLeanLbs'].forEach(id => {
            document.addEventListener('DOMContentLoaded', () => {
                document.getElementById(id)?.addEventListener('input', updateModalDerivedFields);
            });
        });
        
        function saveEntry() {
            const date = document.getElementById('entryDate').value;
            const weight = parseFloat(document.getElementById('entryWeight').value);
            const bf_percent = parseFloat(document.getElementById('entryBfPercent').value);
            const lean_lbs = parseFloat(document.getElementById('entryLeanLbs').value);
            
            if (!date || !isFinite(weight) || !isFinite(bf_percent) || !isFinite(lean_lbs)) {
                showToast('Please fill in required fields: Date, Weight, BF%, Lean Mass', true);
                return;
            }
            
            // Validate integrity
            const integrity = computeIntegrityStatus(weight, bf_percent, lean_lbs);
            
            // Show warning for yellow or red status
            if (integrity.status === 'red') {
                const confirm = window.confirm(
                    `‚ö†Ô∏è DATA INTEGRITY WARNING\n\n` +
                    `${integrity.message}\n\n` +
                    `${integrity.errors.join('\n')}\n\n` +
                    `This may indicate a data entry error.\n` +
                    `Please double-check your values from the Hume app.\n\n` +
                    `Save anyway?`
                );
                if (!confirm) return;
            } else if (integrity.status === 'yellow') {
                const confirm = window.confirm(
                    `‚ö†Ô∏è Slight Variance Detected\n\n` +
                    `${integrity.message}\n\n` +
                    `Residual: ${integrity.derived.residual.toFixed(2)} lbs\n` +
                    `Baseline: ${integrity.baselineMean.toFixed(2)} lbs\n` +
                    `Delta: ${integrity.residualDelta.toFixed(2)} lbs\n\n` +
                    `This is usually normal day-to-day variance.\n` +
                    `Continue saving?`
                );
                if (!confirm) return;
            }
            
            const entry = {
                date,
                weight,
                bf_percent,
                lean_lbs,
                bf_lbs: integrity.derived.bf_lbs,
                lean_percent: integrity.derived.lean_percent,
                residual: integrity.derived.residual,
                calories: parseFloat(document.getElementById('entryCalories').value) || null,
                protein: parseFloat(document.getElementById('entryProtein').value) || null,
                fat: parseFloat(document.getElementById('entryFat').value) || null,
                carbs: parseFloat(document.getElementById('entryCarbs').value) || null,
                steps: parseFloat(document.getElementById('entrySteps').value) || null,
                rhr: parseFloat(document.getElementById('entryRhr').value) || null,
                sleep_score: parseFloat(document.getElementById('entrySleepScore').value) || null,
                sleep_duration_hrs: parseFloat(document.getElementById('entrySleepHours').value) || null,
                body_water_percent: parseFloat(document.getElementById('entryBodyWater').value) || null,
                refeed: document.getElementById('entryRefeed').checked,
                notes: document.getElementById('entryNotes').value,
                integrity_status: integrity.status,
                integrity_message: integrity.message
            };
            
            // Remove existing entry with same date
            bodyData = bodyData.filter(e => e.date !== date);
            bodyData.push(entry);
            bodyData.sort((a, b) => a.date.localeCompare(b.date));
            
            saveData();
            updateStats();
            updateTable();
            updateChart();
            hideModal();
            
            showToast(`Entry saved for ${date}\nIntegrity: ${integrity.message}`);
        }
        
        function deleteEntry(date) {
            if (!confirm(`Delete entry for ${date}?`)) return;
            
            bodyData = bodyData.filter(e => e.date !== date);
            saveData();
            updateStats();
            updateTable();
            updateChart();
            showToast(`Deleted entry for ${date}`);
        }

        // ===== CHART FUNCTIONS =====
        
        function switchChart(chartType, el) {
            currentChartType = chartType;

            // Update active tab
            document.querySelectorAll('.chart-tab').forEach(tab => tab.classList.remove('active'));
            if (el && el.classList) {
                el.classList.add('active');
            } else {
                const map = {
                    fatVsLean: 'Fat vs Lean Breakdown',
                    weightTrend: 'Weight & BF% Trend',
                    rateOfChange: 'Daily Rate of Change',
                    nutrition: 'Nutrition Tracking',
                    waterOverlay: 'Body Water % Overlay'
                };
                const label = map[chartType];
                if (label) {
                    document.querySelectorAll('.chart-tab').forEach(tab => {
                        if ((tab.textContent || '').trim() === label) tab.classList.add('active');
                    });
                }
            }

            updateChart();
        }
        
        function updateChart() {
            if (currentChart) {
                currentChart.destroy();
            }
            
            const sorted = bodyData.slice().sort((a, b) => a.date.localeCompare(b.date));
            
            if (sorted.length === 0) return;
            
            const ctx = document.getElementById('mainChart').getContext('2d');
            
            switch (currentChartType) {
                case 'fatVsLean':
                    currentChart = createFatVsLeanChart(ctx, sorted);
                    break;
                case 'weightTrend':
                    currentChart = createWeightTrendChart(ctx, sorted);
                    break;
                case 'rateOfChange':
                    currentChart = createRateOfChangeChart(ctx, sorted);
                    break;
                case 'nutrition':
                    currentChart = createNutritionChart(ctx, sorted);
                    break;
            
                case 'waterOverlay':
                    currentChart = createWaterOverlayChart(ctx, sorted);
                    break;
}
        }
        
        function createFatVsLeanChart(ctx, data) {
            return new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [
                        {
                            label: 'Fat Mass',
                            data: data.map(d => d.bf_lbs),
                            backgroundColor: 'rgba(239, 68, 68, 0.3)',
                            borderColor: 'rgba(239, 68, 68, 1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.3
                        },
                        {
                            label: 'Lean Mass',
                            data: data.map(d => d.lean_lbs),
                            backgroundColor: 'rgba(16, 185, 129, 0.3)',
                            borderColor: 'rgba(16, 185, 129, 1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Body Composition: Fat vs Lean Mass',
                            color: '#f1f5f9',
                            font: { size: 16 }
                        },
                        legend: {
                            labels: { color: '#f1f5f9' }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(51, 65, 85, 0.3)' }
                        },
                        y: {
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(51, 65, 85, 0.3)' },
                            title: {
                                display: true,
                                text: 'Mass (lbs)',
                                color: '#f1f5f9'
                            }
                        }
                    }
                }
            });
        }
        
        function createWeightTrendChart(ctx, data) {
            return new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [
                        {
                            label: 'Weight (lbs)',
                            data: data.map(d => d.weight),
                            backgroundColor: 'rgba(6, 182, 212, 0.1)',
                            borderColor: 'rgba(6, 182, 212, 1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.3,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Body Fat %',
                            data: data.map(d => d.bf_percent),
                            backgroundColor: 'rgba(139, 92, 246, 0.1)',
                            borderColor: 'rgba(139, 92, 246, 1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.3,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Weight & Body Fat % Trend',
                            color: '#f1f5f9',
                            font: { size: 16 }
                        },
                        legend: {
                            labels: { color: '#f1f5f9' }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(51, 65, 85, 0.3)' }
                        },
                        y: {
                            type: 'linear',
                            position: 'left',
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(51, 65, 85, 0.3)' },
                            title: {
                                display: true,
                                text: 'Weight (lbs)',
                                color: '#06b6d4'
                            }
                        },
                        y1: {
                            type: 'linear',
                            position: 'right',
                            ticks: { color: '#94a3b8' },
                            grid: { display: false },
                            title: {
                                display: true,
                                text: 'Body Fat %',
                                color: '#8b5cf6'
                            }
                        }
                    }
                }
            });
        }
        
        function createRateOfChangeChart(ctx, data) {
            const changes = data.slice(1).map((d, i) => ({
                date: d.date,
                weightChange: d.weight - data[i].weight,
                fatChange: d.bf_lbs - data[i].bf_lbs,
                leanChange: d.lean_lbs - data[i].lean_lbs
            }));
            
            return new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: changes.map(d => d.date),
                    datasets: [
                        {
                            label: 'Weight Œî',
                            data: changes.map(d => d.weightChange),
                            backgroundColor: 'rgba(6, 182, 212, 0.7)',
                            borderColor: 'rgba(6, 182, 212, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Fat Œî',
                            data: changes.map(d => d.fatChange),
                            backgroundColor: 'rgba(239, 68, 68, 0.7)',
                            borderColor: 'rgba(239, 68, 68, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Lean Œî',
                            data: changes.map(d => d.leanChange),
                            backgroundColor: 'rgba(16, 185, 129, 0.7)',
                            borderColor: 'rgba(16, 185, 129, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Daily Rate of Change',
                            color: '#f1f5f9',
                            font: { size: 16 }
                        },
                        legend: {
                            labels: { color: '#f1f5f9' }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(51, 65, 85, 0.3)' }
                        },
                        y: {
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(51, 65, 85, 0.3)' },
                            title: {
                                display: true,
                                text: 'Change (lbs)',
                                color: '#f1f5f9'
                            }
                        }
                    }
                }
            });
        }
        
        function createNutritionChart(ctx, data) {
            const withNutrition = data.filter(d => d.calories);
            
            return new Chart(ctx, {
                type: 'line',
                data: {
                    labels: withNutrition.map(d => d.date),
                    datasets: [
                        {
                            label: 'Calories',
                            data: withNutrition.map(d => d.calories),
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            borderColor: 'rgba(245, 158, 11, 1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.3,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Protein (g)',
                            data: withNutrition.map(d => d.protein),
                            backgroundColor: 'rgba(6, 182, 212, 0.1)',
                            borderColor: 'rgba(6, 182, 212, 1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.3,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Nutrition Tracking',
                            color: '#f1f5f9',
                            font: { size: 16 }
                        },
                        legend: {
                            labels: { color: '#f1f5f9' }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(51, 65, 85, 0.3)' }
                        },
                        y: {
                            type: 'linear',
                            position: 'left',
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(51, 65, 85, 0.3)' },
                            title: {
                                display: true,
                                text: 'Calories',
                                color: '#f59e0b'
                            }
                        },
                        y1: {
                            type: 'linear',
                            position: 'right',
                            ticks: { color: '#94a3b8' },
                            grid: { display: false },
                            title: {
                                display: true,
                                text: 'Protein (g)',
                                color: '#06b6d4'
                            }
                        }
                    }
                }
            });
        }

        
        
        function createWaterOverlayChart(ctx, data) {
            const withWater = data.filter(d => d.body_water_percent != null && isFinite(d.body_water_percent));
            if (withWater.length < 2) {
                return createWeightTrendChart(ctx, data);
            }
            return new Chart(ctx, {
                type: 'line',
                data: {
                    labels: withWater.map(d => d.date),
                    datasets: [
                        {
                            label: 'Weight (lbs)',
                            data: withWater.map(d => d.weight),
                            backgroundColor: 'rgba(6, 182, 212, 0.1)',
                            borderColor: 'rgba(6, 182, 212, 1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.3,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Body Water %',
                            data: withWater.map(d => d.body_water_percent),
                            backgroundColor: 'rgba(16, 185, 129, 0.08)',
                            borderColor: 'rgba(16, 185, 129, 1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.3,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Weight with Body Water % Overlay',
                            color: '#f1f5f9',
                            font: { size: 16 }
                        },
                        legend: {
                            labels: { color: '#f1f5f9' }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.dataset.label || '';
                                    const v = context.parsed.y;
                                    if (label.includes('%')) return `${label}: ${v.toFixed(1)}%`;
                                    return `${label}: ${v.toFixed(1)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(51, 65, 85, 0.3)' }
                        },
                        y: {
                            type: 'linear',
                            position: 'left',
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(51, 65, 85, 0.3)' },
                            title: {
                                display: true,
                                text: 'Weight (lbs)',
                                color: '#06b6d4'
                            }
                        },
                        y1: {
                            type: 'linear',
                            position: 'right',
                            ticks: { color: '#94a3b8' },
                            grid: { display: false },
                            title: {
                                display: true,
                                text: 'Body Water %',
                                color: '#10b981'
                            }
                        }
                    }
                }
            });
        }


        // ===== EXPORT FUNCTIONS =====
        
        function exportCSV() {
            if (bodyData.length === 0) {
                showToast('No data to export', true);
                return;
            }
            
            const headers = [
                'Date', 'Weight', 'BF%', 'BF lbs', 'Lean lbs', 'Lean%', 'Residual',
                'Calories', 'Protein', 'Fat', 'Carbs', 'Steps', 'RHR', 
                'Sleep Score', 'Sleep Hrs', 'Water %', 'Refeed', 'Integrity', 'Notes'
            ];
            
            const rows = bodyData
                .slice()
                .sort((a, b) => a.date.localeCompare(b.date))
                .map(d => [
                    d.date,
                    d.weight?.toFixed(1) || '',
                    d.bf_percent?.toFixed(1) || '',
                    d.bf_lbs?.toFixed(1) || '',
                    d.lean_lbs?.toFixed(1) || '',
                    d.lean_percent?.toFixed(1) || '',
                    d.residual?.toFixed(2) || '',
                    d.calories || '',
                    d.protein || '',
                    d.fat || '',
                    d.carbs || '',
                    d.steps || '',
                    d.rhr || '',
                    d.sleep_score || '',
                    d.sleep_duration_hrs?.toFixed(2) || '',
                    d.body_water_percent?.toFixed(1) || '',
                    d.refeed ? 'Yes' : 'No',
                    d.integrity_status || '',
                    `"${(d.notes || '').replace(/"/g, '""')}"`
                ]);
            
            const csv = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `body-tracker-export-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            
            showToast('CSV exported successfully!');
        }
        
        function exportBackup() {
            if (bodyData.length === 0) {
                showToast('No data to backup', true);
                return;
            }
            
            const backup = {
                version: '2.0',
                exportDate: new Date().toISOString(),
                entries: bodyData.length,
                goals: GOALS,
                data: bodyData
            };
            
            const json = JSON.stringify(backup, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `body-tracker-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showToast('Backup created successfully!');
        }
        
        
        // ===== TAB NAVIGATION =====
        
        function switchMainTab(tabName, el) {
            // Hide all tabs
            document.querySelectorAll('.main-tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active from all buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // Set button active
            if (el) {
                el.classList.add('active');
            } else {
                const btn = Array.from(document.querySelectorAll('.tab-button')).find(b => (b.getAttribute('onclick') || '').includes("switchMainTab('" + tabName + "'"));
                if (btn) btn.classList.add('active');
            }
            
            // Update content for specific tabs
            if (tabName === 'nutrition') updateNutritionTab();
            if (tabName === 'measurements') updateMeasurementsTab();
            if (tabName === 'training') updateTrainingTab();
            if (tabName === 'correlations') updateCorrelationsTab();
        }
        
        // ===== NUTRITION TAB FUNCTIONS =====
        
        function updateNutritionTab() {
            updateNutritionGoals();
            updateTotalAverages();
            updateRollingAverages();
            updateRecommendations();
            updateWhatIfCalculator();
        }
        
        function updateNutritionGoals() {
            const html = `
                <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 10px;">
                    <h3 style="color: var(--accent-purple); margin-bottom: 15px;">Your Nutrition Targets</h3>
                    <div class="grid grid-4">
                        <div>
                            <div class="nutrition-label">Target Calories</div>
                            <div class="nutrition-value">${GOALS.target_calories}</div>
                        </div>
                        <div>
                            <div class="nutrition-label">Target Protein (g)</div>
                            <div class="nutrition-value">${GOALS.target_protein}</div>
                        </div>
                        <div>
                            <div class="nutrition-label">Target Fat (g)</div>
                            <div class="nutrition-value">${GOALS.target_fat}</div>
                        </div>
                        <div>
                            <div class="nutrition-label">Target Carbs (g)</div>
                            <div class="nutrition-value">${GOALS.target_carbs}</div>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('nutritionGoals').innerHTML = html;
        }
        
        function updateTotalAverages() {
            const withNutrition = bodyData.filter(d => d.calories && d.protein);
            
            if (withNutrition.length === 0) {
                document.getElementById('totalAverages').innerHTML = '<p style="color: var(--text-secondary);">No nutrition data yet</p>';
                return;
            }
            
            const avgCals = withNutrition.reduce((sum, d) => sum + (d.calories || 0), 0) / withNutrition.length;
            const avgProtein = withNutrition.reduce((sum, d) => sum + (d.protein || 0), 0) / withNutrition.length;
            const avgFat = withNutrition.reduce((sum, d) => sum + (d.fat || 0), 0) / withNutrition.length;
            const avgCarbs = withNutrition.reduce((sum, d) => sum + (d.carbs || 0), 0) / withNutrition.length;
            
            const latest = bodyData[bodyData.length - 1];
            const avgProteinPerLb = latest.lean_lbs ? avgProtein / latest.lean_lbs : 0;
            
            const html = `
                <div class="nutrition-card">
                    <div class="nutrition-label">Average Calories</div>
                    <div class="nutrition-value">${Math.round(avgCals)}</div>
                    <div style="font-size: 0.85em; color: var(--text-secondary); margin-top: 5px;">
                        Based on ${withNutrition.length} days
                    </div>
                </div>
                <div class="nutrition-card">
                    <div class="nutrition-label">Average Protein</div>
                    <div class="nutrition-value">${Math.round(avgProtein)}g</div>
                    <div style="font-size: 0.85em; color: var(--text-secondary); margin-top: 5px;">
                        ${avgProteinPerLb.toFixed(2)}g per lb lean mass
                    </div>
                </div>
                <div class="nutrition-card">
                    <div class="nutrition-label">Average Fat</div>
                    <div class="nutrition-value">${Math.round(avgFat)}g</div>
                </div>
                <div class="nutrition-card">
                    <div class="nutrition-label">Average Carbs</div>
                    <div class="nutrition-value">${Math.round(avgCarbs)}g</div>
                </div>
            `;
            
            document.getElementById('totalAverages').innerHTML = html;
        }
        
        function updateRollingAverages() {
            const sorted = bodyData.slice().sort((a, b) => a.date.localeCompare(b.date));
            const recent7 = sorted.slice(-7).filter(d => d.calories && d.protein);
            
            if (recent7.length === 0) {
                document.getElementById('rollingAverages').innerHTML = '<p style="color: var(--text-secondary);">Need at least 7 days of nutrition data</p>';
                return;
            }
            
            const avgCals = recent7.reduce((sum, d) => sum + (d.calories || 0), 0) / recent7.length;
            const avgProtein = recent7.reduce((sum, d) => sum + (d.protein || 0), 0) / recent7.length;
            const avgFat = recent7.reduce((sum, d) => sum + (d.fat || 0), 0) / recent7.length;
            const avgCarbs = recent7.reduce((sum, d) => sum + (d.carbs || 0), 0) / recent7.length;
            
            const html = `
                <div class="nutrition-card">
                    <div class="nutrition-label">7-Day Avg Calories</div>
                    <div class="nutrition-value">${Math.round(avgCals)}</div>
                    <div style="font-size: 0.85em; color: var(--text-secondary); margin-top: 5px;">
                        Last ${recent7.length} days
                    </div>
                </div>
                <div class="nutrition-card">
                    <div class="nutrition-label">7-Day Avg Protein</div>
                    <div class="nutrition-value">${Math.round(avgProtein)}g</div>
                </div>
                <div class="nutrition-card">
                    <div class="nutrition-label">7-Day Avg Fat</div>
                    <div class="nutrition-value">${Math.round(avgFat)}g</div>
                </div>
                <div class="nutrition-card">
                    <div class="nutrition-label">7-Day Avg Carbs</div>
                    <div class="nutrition-value">${Math.round(avgCarbs)}g</div>
                </div>
            `;
            
            document.getElementById('rollingAverages').innerHTML = html;
        }
        
        function updateRecommendations() {
            const sorted = bodyData.slice().sort((a, b) => a.date.localeCompare(b.date));
            const latest = sorted[sorted.length - 1];
            
            if (!latest) {
                document.getElementById('recommendations').innerHTML = '<p style="color: var(--text-secondary);">No data available</p>';
                return;
            }
            
            // Calculate TDEE estimate based on recent fat loss
            const recent14 = sorted.slice(-14);
            if (recent14.length < 2) {
                document.getElementById('recommendations').innerHTML = '<p style="color: var(--text-secondary);">Need at least 14 days of data for recommendations</p>';
                return;
            }
            
            const first14 = recent14[0];
            const last14 = recent14[recent14.length - 1];
            const days = 14;
            
            const fatLost = (first14.weight * first14.bf_percent / 100) - (last14.weight * last14.bf_percent / 100);
            const fatLostPerDay = fatLost / days;
            const fatLostPerWeek = fatLostPerDay * 7;
            
            // 1 lb fat = 3500 calories
            const calorieDeficit = fatLostPerDay * 3500;
            
            const avgCals = recent14.filter(d => d.calories).reduce((sum, d) => sum + d.calories, 0) / recent14.filter(d => d.calories).length;
            const estimatedTDEE = avgCals + calorieDeficit;
            
            // Max fat burn = 1% body weight per week
            const maxFatBurnPerWeek = latest.weight * 0.01;
            const maxFatBurnCals = estimatedTDEE - (maxFatBurnPerWeek * 3500 / 7);
            
            // Muscle retention = 0.5% body weight per week
            const muscleRetentionFatLoss = latest.weight * 0.005;
            const muscleRetentionCals = estimatedTDEE - (muscleRetentionFatLoss * 3500 / 7);
            
            const proteinRec = latest.lean_lbs ? latest.lean_lbs * 1.0 : 180;
            
            const html = `
                <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 10px; margin-bottom: 15px;">
                    <h3 style="color: var(--accent-purple); margin-bottom: 10px;">Estimated TDEE</h3>
                    <div class="nutrition-value" style="color: var(--accent-success);">${Math.round(estimatedTDEE)} cals/day</div>
                    <p style="font-size: 0.85em; color: var(--text-secondary); margin-top: 5px;">
                        Based on ${fatLostPerWeek.toFixed(2)} lbs/week fat loss
                    </p>
                </div>
                
                <div class="grid grid-2">
                    <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 10px;">
                        <h3 style="color: var(--accent-purple); margin-bottom: 10px;">üî• Max Fat Burn Rate</h3>
                        <div class="nutrition-value">${Math.round(maxFatBurnCals)}</div>
                        <p style="font-size: 0.85em; color: var(--text-secondary); margin-top: 10px;">
                            Target: ~${maxFatBurnPerWeek.toFixed(2)} lbs/week loss (1% body weight)<br>
                            Deficit: ${Math.round(estimatedTDEE - maxFatBurnCals)} cals/day
                        </p>
                    </div>
                    
                    <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 10px;">
                        <h3 style="color: var(--accent-purple); margin-bottom: 10px;">üí™ Muscle Retention</h3>
                        <div class="nutrition-value">${Math.round(muscleRetentionCals)}</div>
                        <p style="font-size: 0.85em; color: var(--text-secondary); margin-top: 10px;">
                            Target: ~${muscleRetentionFatLoss.toFixed(2)} lbs/week loss (0.5% body weight)<br>
                            Deficit: ${Math.round(estimatedTDEE - muscleRetentionCals)} cals/day
                        </p>
                    </div>
                </div>
                
                <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 10px; margin-top: 15px;">
                    <h3 style="color: var(--accent-purple); margin-bottom: 10px;">ü•© Protein Recommendation</h3>
                    <div class="nutrition-value">${Math.round(proteinRec)}g/day</div>
                    <p style="font-size: 0.85em; color: var(--text-secondary); margin-top: 5px;">
                        Based on 1.0g per lb lean mass (${latest.lean_lbs?.toFixed(1)} lbs)
                    </p>
                </div>
            `;
            
            document.getElementById('recommendations').innerHTML = html;
        }
        
        function updateWhatIfCalculator() {
            const sorted = bodyData.slice().sort((a, b) => a.date.localeCompare(b.date));
            const latest = sorted[sorted.length - 1];
            
            if (!latest) {
                document.getElementById('whatIfCalc').innerHTML = '<p style="color: var(--text-secondary);">No data available</p>';
                return;
            }
            
            const currentFatLbs = latest.weight * latest.bf_percent / 100;
            const targetFatLbs = GOALS.target_bf_lbs;
            const fatToLose = currentFatLbs - targetFatLbs;
            
            // Calculate current rate
            const recent14 = sorted.slice(-14);
            let avgFatLossPerWeek = 0;
            if (recent14.length >= 2) {
                const first = recent14[0];
                const last = recent14[recent14.length - 1];
                const fatLost = (first.weight * first.bf_percent / 100) - (last.weight * last.bf_percent / 100);
                avgFatLossPerWeek = (fatLost / 14) * 7;
            }
            
            const weeksToGoal = avgFatLossPerWeek > 0 ? fatToLose / avgFatLossPerWeek : 0;
            const daysToGoal = weeksToGoal * 7;
            
            const goalDate = new Date(latest.date);
            goalDate.setDate(goalDate.getDate() + daysToGoal);
            
            // Different scenarios
            const scenarios = [
                { rate: 0.5, name: 'Conservative (0.5 lb/week)' },
                { rate: 1.0, name: 'Moderate (1.0 lb/week)' },
                { rate: 1.5, name: 'Aggressive (1.5 lb/week)' },
                { rate: 2.0, name: 'Very Aggressive (2.0 lb/week)' }
            ];
            
            let scenariosHtml = '';
            scenarios.forEach(scenario => {
                const weeks = fatToLose / scenario.rate;
                const date = new Date(latest.date);
                date.setDate(date.getDate() + (weeks * 7));
                
                scenariosHtml += `
                    <div style="background: var(--bg-tertiary); padding: 15px; border-radius: 8px;">
                        <div style="font-weight: 600; margin-bottom: 5px;">${scenario.name}</div>
                        <div style="font-size: 1.3em; font-family: 'Space Mono', monospace; color: var(--accent-cyan);">
                            ${date.toLocaleDateString()}
                        </div>
                        <div style="font-size: 0.85em; color: var(--text-secondary); margin-top: 5px;">
                            ${Math.round(weeks)} weeks (${Math.round(weeks * 7)} days)
                        </div>
                    </div>
                `;
            });
            
            const html = `
                <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 10px; margin-bottom: 15px;">
                    <h3 style="color: var(--accent-purple); margin-bottom: 10px;">Current Progress</h3>
                    <div class="grid grid-4">
                        <div>
                            <div class="nutrition-label">Current Fat Mass</div>
                            <div class="nutrition-value" style="font-size: 1.3em;">${currentFatLbs.toFixed(1)} lbs</div>
                        </div>
                        <div>
                            <div class="nutrition-label">Target Fat Mass</div>
                            <div class="nutrition-value" style="font-size: 1.3em;">${targetFatLbs.toFixed(1)} lbs</div>
                        </div>
                        <div>
                            <div class="nutrition-label">Fat to Lose</div>
                            <div class="nutrition-value" style="font-size: 1.3em;">${fatToLose.toFixed(1)} lbs</div>
                        </div>
                        <div>
                            <div class="nutrition-label">Current Rate</div>
                            <div class="nutrition-value" style="font-size: 1.3em;">${avgFatLossPerWeek.toFixed(2)} lb/wk</div>
                        </div>
                    </div>
                </div>
                
                <h3 style="margin-bottom: 15px;">Goal Date Scenarios</h3>
                <div class="grid grid-2">
                    ${scenariosHtml}
                </div>
                
                ${avgFatLossPerWeek > 0 ? `
                <div style="background: rgba(6, 182, 212, 0.1); padding: 20px; border-radius: 10px; margin-top: 15px; border-left: 4px solid var(--accent-cyan);">
                    <h3 style="color: var(--accent-cyan); margin-bottom: 10px;">At Your Current Rate</h3>
                    <div style="font-size: 1.5em; font-family: 'Space Mono', monospace; margin-bottom: 10px;">
                        ${goalDate.toLocaleDateString()}
                    </div>
                    <p style="color: var(--text-secondary);">
                        ${Math.round(weeksToGoal)} weeks (${Math.round(daysToGoal)} days) to reach ${GOALS.target_weight} lbs @ ${GOALS.target_bf_percent}% BF
                    </p>
                </div>
                ` : ''}
            `;
            
            document.getElementById('whatIfCalc').innerHTML = html;
        }
        
        // ===== MEASUREMENTS TAB =====
        
        let measurements = [];
        
        function loadMeasurements() {
            const stored = localStorage.getItem(MEASUREMENTS_KEY);
            if (stored) {
                measurements = JSON.parse(stored);
            }
        }
        
        function saveMeasurements() {
            localStorage.setItem(MEASUREMENTS_KEY, JSON.stringify(measurements));
        }
        
        function updateMeasurementsTab() {
            if (measurements.length === 0) {
                document.getElementById('measurementsContent').innerHTML = `
                    <div style="background: var(--bg-tertiary); padding: 30px; border-radius: 10px; text-align: center;">
                        <h3 style="color: var(--accent-purple); margin-bottom: 15px;">üìè No Measurements Yet</h3>
                        <p style="color: var(--text-secondary); margin-bottom: 20px;">
                            Start tracking body measurements like neck, chest, waist, hips, arms, thighs, and calves.
                        </p>
                        <button onclick="showAddMeasurement()" class="primary">+ Add First Measurement</button>
                    </div>
                `;
                return;
            }
            
            const sorted = measurements.slice().sort((a, b) => b.date.localeCompare(a.date));
            const latest = sorted[0];
            const oldest = sorted[sorted.length - 1];
            
            let tableRows = '';
            sorted.forEach(m => {
                tableRows += `
                    <tr onclick="editMeasurement('${m.date}')">
                        <td>${m.date}</td>
                        <td>${m.neck || '-'}</td>
                        <td>${m.chest || '-'}</td>
                        <td>${m.waist || '-'}</td>
                        <td>${m.hips || '-'}</td>
                        <td>${m.arms || '-'}</td>
                        <td>${m.thighs || '-'}</td>
                        <td>${m.calves || '-'}</td>
                        <td>
                            <button class="danger" onclick="event.stopPropagation(); deleteMeasurement('${m.date}')">√ó</button>
                        </td>
                    </tr>
                `;
            });
            
            const html = `
                <div style="margin-bottom: 20px;">
                    <h3 style="color: var(--accent-purple); margin-bottom: 15px;">Latest Measurements (${latest.date})</h3>
                    <div class="grid grid-4">
                        <div class="nutrition-card">
                            <div class="nutrition-label">Neck</div>
                            <div class="nutrition-value" style="font-size: 1.5em;">${latest.neck || '-'}"</div>
                        </div>
                        <div class="nutrition-card">
                            <div class="nutrition-label">Chest</div>
                            <div class="nutrition-value" style="font-size: 1.5em;">${latest.chest || '-'}"</div>
                        </div>
                        <div class="nutrition-card">
                            <div class="nutrition-label">Waist</div>
                            <div class="nutrition-value" style="font-size: 1.5em;">${latest.waist || '-'}"</div>
                        </div>
                        <div class="nutrition-card">
                            <div class="nutrition-label">Hips</div>
                            <div class="nutrition-value" style="font-size: 1.5em;">${latest.hips || '-'}"</div>
                        </div>
                        <div class="nutrition-card">
                            <div class="nutrition-label">Arms</div>
                            <div class="nutrition-value" style="font-size: 1.5em;">${latest.arms || '-'}"</div>
                        </div>
                        <div class="nutrition-card">
                            <div class="nutrition-label">Thighs</div>
                            <div class="nutrition-value" style="font-size: 1.5em;">${latest.thighs || '-'}"</div>
                        </div>
                        <div class="nutrition-card">
                            <div class="nutrition-label">Calves</div>
                            <div class="nutrition-value" style="font-size: 1.5em;">${latest.calves || '-'}"</div>
                        </div>
                    </div>
                </div>
                
                <h3 style="margin: 20px 0 15px 0;">Measurement History</h3>
                <div class="table-container" style="max-height: 400px;">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Neck</th>
                                <th>Chest</th>
                                <th>Waist</th>
                                <th>Hips</th>
                                <th>Arms</th>
                                <th>Thighs</th>
                                <th>Calves</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tableRows}
                        </tbody>
                    </table>
                </div>
            `;
            
            document.getElementById('measurementsContent').innerHTML = html;
        }
        
        function showAddMeasurement() {
            const modal = document.getElementById('measurementsModal');
            modal.innerHTML = `
                <div class="modal">
                    <h2>Add Body Measurements</h2>
                    <div class="form-section">
                        <h3>Date & Core Measurements</h3>
                        <div class="form-grid">
                            <div class="form-field">
                                <label class="required">Date</label>
                                <input type="date" id="measDate" value="${new Date().toISOString().split('T')[0]}">
                            </div>
                            <div class="form-field">
                                <label>Neck (inches)</label>
                                <input type="number" step="0.25" id="measNeck">
                            </div>
                            <div class="form-field">
                                <label>Chest (inches)</label>
                                <input type="number" step="0.25" id="measChest">
                            </div>
                            <div class="form-field">
                                <label>Waist (inches)</label>
                                <input type="number" step="0.25" id="measWaist">
                            </div>
                            <div class="form-field">
                                <label>Hips (inches)</label>
                                <input type="number" step="0.25" id="measHips">
                            </div>
                            <div class="form-field">
                                <label>Arms (inches)</label>
                                <input type="number" step="0.25" id="measArms">
                            </div>
                            <div class="form-field">
                                <label>Thighs (inches)</label>
                                <input type="number" step="0.25" id="measThighs">
                            </div>
                            <div class="form-field">
                                <label>Calves (inches)</label>
                                <input type="number" step="0.25" id="measCalves">
                            </div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button onclick="saveMeasurement()" class="primary">Save Measurements</button>
                        <button onclick="hideMeasurementsModal()">Cancel</button>
                    </div>
                </div>
            `;
            modal.classList.add('show');
        }
        
        function saveMeasurement() {
            const date = document.getElementById('measDate').value;
            if (!date) {
                showToast('Please enter a date', true);
                return;
            }
            
            const measurement = {
                date,
                neck: parseFloat(document.getElementById('measNeck').value) || null,
                chest: parseFloat(document.getElementById('measChest').value) || null,
                waist: parseFloat(document.getElementById('measWaist').value) || null,
                hips: parseFloat(document.getElementById('measHips').value) || null,
                arms: parseFloat(document.getElementById('measArms').value) || null,
                thighs: parseFloat(document.getElementById('measThighs').value) || null,
                calves: parseFloat(document.getElementById('measCalves').value) || null
            };
            
            measurements = measurements.filter(m => m.date !== date);
            measurements.push(measurement);
            measurements.sort((a, b) => a.date.localeCompare(b.date));
            
            saveMeasurements();
            updateMeasurementsTab();
            hideMeasurementsModal();
            showToast('Measurements saved!');
        }
        
        function editMeasurement(date) {
            const meas = measurements.find(m => m.date === date);
            if (!meas) return;
            
            const modal = document.getElementById('measurementsModal');
            modal.innerHTML = `
                <div class="modal">
                    <h2>Edit Measurements</h2>
                    <div class="form-section">
                        <h3>Date & Core Measurements</h3>
                        <div class="form-grid">
                            <div class="form-field">
                                <label class="required">Date</label>
                                <input type="date" id="measDate" value="${meas.date}">
                            </div>
                            <div class="form-field">
                                <label>Neck (inches)</label>
                                <input type="number" step="0.25" id="measNeck" value="${meas.neck || ''}">
                            </div>
                            <div class="form-field">
                                <label>Chest (inches)</label>
                                <input type="number" step="0.25" id="measChest" value="${meas.chest || ''}">
                            </div>
                            <div class="form-field">
                                <label>Waist (inches)</label>
                                <input type="number" step="0.25" id="measWaist" value="${meas.waist || ''}">
                            </div>
                            <div class="form-field">
                                <label>Hips (inches)</label>
                                <input type="number" step="0.25" id="measHips" value="${meas.hips || ''}">
                            </div>
                            <div class="form-field">
                                <label>Arms (inches)</label>
                                <input type="number" step="0.25" id="measArms" value="${meas.arms || ''}">
                            </div>
                            <div class="form-field">
                                <label>Thighs (inches)</label>
                                <input type="number" step="0.25" id="measThighs" value="${meas.thighs || ''}">
                            </div>
                            <div class="form-field">
                                <label>Calves (inches)</label>
                                <input type="number" step="0.25" id="measCalves" value="${meas.calves || ''}">
                            </div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button onclick="saveMeasurement()" class="primary">Save Changes</button>
                        <button onclick="hideMeasurementsModal()">Cancel</button>
                    </div>
                </div>
            `;
            modal.classList.add('show');
        }
        
        function deleteMeasurement(date) {
            if (!confirm(`Delete measurements from ${date}?`)) return;
            measurements = measurements.filter(m => m.date !== date);
            saveMeasurements();
            updateMeasurementsTab();
            showToast('Measurements deleted');
        }
        
        function hideMeasurementsModal() {
            document.getElementById('measurementsModal').classList.remove('show');
        }
        
        
        // ===== TRAINING TAB (V7) =====
        // Set-by-set logging + warmups + supersets + plan card + multiple sessions/day + templates + live mode + optional Gist sync

        const TRAINING_KEY = 'trainingLog_User1_v7';
        const EXERCISE_LIB_KEY = 'exerciseLibrary_User1_v7';
        const TEMPLATE_KEY = 'workoutTemplates_User1_v7';
        const SYNC_CONFIG_KEY = 'syncConfig_User1_v7';

        const EXERCISE_SEED = ["Bench Press", "Incline Bench Press", "Dumbbell Bench Press", "Overhead Press", "Dumbbell Shoulder Press", "Barbell Row", "Dumbbell Row", "Lat Pulldown", "Pull-Up", "Chin-Up", "Seated Cable Row", "Squat", "Front Squat", "Leg Press", "Romanian Deadlift", "Deadlift", "Hip Thrust", "Lunge", "Bulgarian Split Squat", "Leg Extension", "Leg Curl", "Calf Raise", "Bicep Curl", "Hammer Curl", "Tricep Pushdown", "Skull Crushers", "Dips", "Lateral Raise", "Rear Delt Fly", "Face Pull", "Plank", "Hanging Leg Raise", "Cable Crunch", "Treadmill", "Bike", "Row Erg", "Jump Rope"];

        let trainingLog = [];
        let exerciseLibrary = [];
        let workoutTemplates = [];
        let exerciseBlockCount = 0;

        // Live mode state
        let liveMode = {
            running: false,
            startTs: null,
            tickHandle: null,
            restRunning: false,
            restStartTs: null,
            restSeconds: 90,
            restHandle: null
        };

        function newId(prefix='x') {
            return `${prefix}_${Date.now()}_${Math.random().toString(16).slice(2)}`;
        }

        function getTodayISO() {
            return new Date().toISOString().split('T')[0];
        }

        // ----- Exercise Library -----
        function loadExerciseLibrary() {
            const stored = localStorage.getItem(EXERCISE_LIB_KEY);
            if (stored) {
                try { exerciseLibrary = JSON.parse(stored) || []; } catch { exerciseLibrary = []; }
            } else {
                exerciseLibrary = [];
            }
            if (!Array.isArray(exerciseLibrary)) exerciseLibrary = [];

            if (exerciseLibrary.length < 10) {
                const set = new Set(exerciseLibrary.map(x => (x||'').trim().toLowerCase()).filter(Boolean));
                EXERCISE_SEED.forEach(n => {
                    if (!set.has(n.toLowerCase())) exerciseLibrary.push(n);
                });
                saveExerciseLibrary();
            }
        }

        function saveExerciseLibrary() {
            localStorage.setItem(EXERCISE_LIB_KEY, JSON.stringify(exerciseLibrary.slice().sort((a,b)=>a.localeCompare(b))));
        }

        function upsertExerciseToLibrary(name) {
            const n = (name || '').toString().trim();
            if (!n) return;
            const lower = n.toLowerCase();
            const exists = exerciseLibrary.some(x => (x||'').toLowerCase() === lower);
            if (!exists) {
                exerciseLibrary.push(n);
                saveExerciseLibrary();
            }
        }

        function hydrateExerciseDatalist() {
            const existing = document.getElementById('exerciseOptions');
            if (existing) existing.remove();
            const dl = document.createElement('datalist');
            dl.id = 'exerciseOptions';
            exerciseLibrary.slice().sort((a,b)=>a.localeCompare(b)).forEach(name => {
                const opt = document.createElement('option');
                opt.value = name;
                dl.appendChild(opt);
            });
            document.body.appendChild(dl);
        }

        // ----- Templates -----
        function loadTemplates() {
            const stored = localStorage.getItem(TEMPLATE_KEY);
            if (stored) {
                try { workoutTemplates = JSON.parse(stored) || []; } catch { workoutTemplates = []; }
            } else workoutTemplates = [];
            if (!Array.isArray(workoutTemplates)) workoutTemplates = [];
        }

        function saveTemplates() {
            localStorage.setItem(TEMPLATE_KEY, JSON.stringify(workoutTemplates));
        }

        function templateFromWorkout(workout) {
            return {
                id: newId('tpl'),
                name: workout.title || workout.type || 'Template',
                type: workout.type || 'Workout',
                exercises: JSON.parse(JSON.stringify(workout.exercises || []))
            };
        }

        function openTemplateManager() {
            loadTemplates();
            const modal = document.getElementById('trainingModal');
            const list = workoutTemplates.slice().sort((a,b)=>a.name.localeCompare(b.name));
            const rows = list.map(t => `
                <div style="background: var(--bg-primary); border: 1px solid var(--border); padding: 12px; border-radius: 10px; margin-bottom: 10px;">
                    <div style="display:flex; justify-content: space-between; gap: 10px; align-items: start; flex-wrap: wrap;">
                        <div>
                            <div style="font-weight: 800; color: var(--accent-purple);">${escapeHTML(t.name)}</div>
                            <div style="color: var(--text-secondary); font-family:'Space Mono', monospace; font-size:0.85em;">
                                ${escapeHTML(t.type || 'Workout')} ‚Ä¢ ${(t.exercises||[]).length} exercises
                            </div>
                        </div>
                        <div style="display:flex; gap: 8px; flex-wrap: wrap;">
                            <button onclick="applyTemplateToNewWorkout('${t.id}')" class="primary" style="padding: 6px 10px;">Use Today</button>
                            <button onclick="renameTemplate('${t.id}')" style="padding: 6px 10px; background: var(--accent-cyan);">Rename</button>
                            <button class="danger" onclick="deleteTemplate('${t.id}')" style="padding: 6px 10px;">Delete</button>
                        </div>
                    </div>
                </div>
            `).join('');

            modal.innerHTML = `
                <div class="modal">
                    <h2>üìö Workout Templates</h2>
                    <div class="integrity-notice">
                        <h4>Templates</h4>
                        <p>Save a workout as a reusable template (Push/Pull/Legs etc.) then apply it to today.</p>
                    </div>
                    <div class="form-section">
                        <h3>Create Template</h3>
                        <div style="display:flex; gap: 10px; flex-wrap: wrap;">
                            <button class="primary" onclick="createBlankTemplate()">+ New Blank Template</button>
                            <button onclick="convertLatestWorkoutToTemplate()" style="background: var(--accent-purple);">Save Latest Workout as Template</button>
                        </div>
                    </div>
                    <div class="form-section">
                        <h3>Saved Templates (${list.length})</h3>
                        ${rows || `<div style="color: var(--text-secondary);">No templates yet.</div>`}
                    </div>
                    <div style="display:flex; gap: 10px; flex-wrap: wrap; margin-top: 10px;">
                        <button onclick="hideTrainingModal()">Close</button>
                    </div>
                </div>
            `;
            modal.classList.add('show');
        }

        function createBlankTemplate() {
            const name = prompt('Template name?', 'New Template');
            if (!name) return;
            loadTemplates();
            workoutTemplates.push({ id: newId('tpl'), name, type: 'Workout', exercises: [] });
            saveTemplates();
            showToast('Template created');
            openTemplateManager();
        }

        function convertLatestWorkoutToTemplate() {
            if (!trainingLog.length) { showToast('No workouts yet', true); return; }
            const sorted = trainingLog.slice().sort((a,b)=> b.date.localeCompare(a.date) || (b.startTime||'').localeCompare(a.startTime||''));
            const tpl = templateFromWorkout(sorted[0]);
            tpl.name = prompt('Template name?', tpl.name) || tpl.name;
            loadTemplates();
            workoutTemplates.push(tpl);
            saveTemplates();
            showToast('Template saved');
            openTemplateManager();
        }

        function renameTemplate(id) {
            loadTemplates();
            const tpl = workoutTemplates.find(t=>t.id===id);
            if (!tpl) return;
            const name = prompt('New template name:', tpl.name);
            if (!name) return;
            tpl.name = name;
            saveTemplates();
            openTemplateManager();
        }

        function deleteTemplate(id) {
            if (!confirm('Delete this template?')) return;
            loadTemplates();
            workoutTemplates = workoutTemplates.filter(t=>t.id!==id);
            saveTemplates();
            openTemplateManager();
        }

        function applyTemplateToNewWorkout(id) {
            loadTemplates();
            const tpl = workoutTemplates.find(t=>t.id===id);
            if (!tpl) return;
            showAddWorkout(getTodayISO(), tpl);
        }

        // ----- Training data -----
        function loadTraining() {
            const stored = localStorage.getItem(TRAINING_KEY);
            if (stored) {
                try { trainingLog = JSON.parse(stored) || []; } catch { trainingLog = []; }
            } else {
                trainingLog = [];
            }
            if (!Array.isArray(trainingLog)) trainingLog = [];
        }

        function saveTraining() {
            localStorage.setItem(TRAINING_KEY, JSON.stringify(trainingLog));
        }

        // ----- Volume helpers -----
        function sumWorkingVolumeForExercise(ex) {
            if (!ex || !Array.isArray(ex.sets)) return 0;
            return ex.sets.reduce((sum,s)=>{
                const warm = !!s.warmup;
                const done = (s.completed === undefined) ? true : !!s.completed;
                const reps = Number(s.reps);
                const wt = Number(s.weight);
                if (!warm && done && isFinite(reps) && isFinite(wt)) return sum + reps*wt;
                return sum;
            },0);
        }

        function sumWorkingSets(ex) {
            if (!ex || !Array.isArray(ex.sets)) return 0;
            return ex.sets.reduce((c,s)=>{
                const warm = !!s.warmup;
                const done = (s.completed === undefined) ? true : !!s.completed;
                return c + ((!warm && done) ? 1 : 0);
            },0);
        }

        function workoutSummary(session) {
            const exercises = session.exercises || [];
            const totalWorkingSets = exercises.reduce((sum, ex)=> sum + sumWorkingSets(ex), 0);
            const totalVolume = exercises.reduce((sum, ex)=> sum + sumWorkingVolumeForExercise(ex), 0);
            const supersetGroups = new Set(exercises.map(ex => (ex.superset || '').trim()).filter(Boolean));
            return { totalWorkingSets, totalVolume, supersetGroups: [...supersetGroups] };
        }

        // ----- Live Mode -----
        function formatTime(seconds) {
            const s = Math.max(0, Math.floor(seconds));
            const m = Math.floor(s / 60);
            const r = s % 60;
            return `${m}:${String(r).padStart(2,'0')}`;
        }

        function startLiveTimer() {
            if (liveMode.running) return;
            liveMode.running = true;
            liveMode.startTs = Date.now();
            liveMode.tickHandle = setInterval(()=> updateLiveBar(), 500);
            updateLiveBar();
        }

        function stopLiveTimer() {
            liveMode.running = false;
            liveMode.startTs = null;
            if (liveMode.tickHandle) clearInterval(liveMode.tickHandle);
            liveMode.tickHandle = null;
            updateLiveBar();
        }

        function startRestTimer(seconds=null) {
            if (seconds !== null && isFinite(seconds)) liveMode.restSeconds = Math.max(5, Math.floor(seconds));
            liveMode.restRunning = true;
            liveMode.restStartTs = Date.now();
            if (liveMode.restHandle) clearInterval(liveMode.restHandle);
            liveMode.restHandle = setInterval(()=> updateLiveBar(), 250);
            updateLiveBar();
        }

        function stopRestTimer() {
            liveMode.restRunning = false;
            liveMode.restStartTs = null;
            if (liveMode.restHandle) clearInterval(liveMode.restHandle);
            liveMode.restHandle = null;
            updateLiveBar();
        }

        function updateLiveBar() {
            const bar = document.getElementById('liveBar');
            if (!bar) return;

            const elapsed = liveMode.running && liveMode.startTs ? (Date.now() - liveMode.startTs)/1000 : 0;
            const restElapsed = liveMode.restRunning && liveMode.restStartTs ? (Date.now() - liveMode.restStartTs)/1000 : 0;
            const restRemaining = liveMode.restRunning ? Math.max(0, liveMode.restSeconds - restElapsed) : 0;

            const restText = liveMode.restRunning ? `Rest: ${formatTime(restRemaining)} / ${formatTime(liveMode.restSeconds)}` : `Rest: ‚Äî`;
            const elapsedText = liveMode.running ? `Elapsed: ${formatTime(elapsed)}` : `Elapsed: ‚Äî`;

            const restPct = liveMode.restRunning ? (restRemaining / liveMode.restSeconds) * 100 : 0;
            const pct = Math.max(0, Math.min(100, restPct));

            bar.innerHTML = `
              <div style="display:flex; justify-content: space-between; align-items: center; gap: 10px; flex-wrap: wrap;">
                <div style="display:flex; gap: 12px; align-items: center; flex-wrap: wrap;">
                  <span class="integrity-badge integrity-blue" title="Live workout mode">
                    <span class="integrity-dot dot-blue"></span><span>LIVE</span>
                  </span>
                  <span style="font-family:'Space Mono', monospace; color: var(--text-primary);">${elapsedText}</span>
                  <span style="font-family:'Space Mono', monospace; color: var(--text-primary);">${restText}</span>
                </div>
                <div style="display:flex; gap: 8px; flex-wrap: wrap; align-items: center;">
                  <label style="color: var(--text-secondary); font-size:0.85em;">Rest(s)</label>
                  <input type="number" id="restSecondsInput" value="${liveMode.restSeconds}" style="width:90px; background: var(--bg-secondary); border: 1px solid var(--border); color: var(--text-primary); padding: 6px; border-radius: 6px;">
                  <button onclick="startRestTimer(Number(document.getElementById('restSecondsInput').value))" style="background: var(--accent-warning);">‚è± Start Rest</button>
                  <button onclick="stopRestTimer()">Stop Rest</button>
                  <button onclick="${liveMode.running ? 'stopLiveTimer()' : 'startLiveTimer()'}" style="background: var(--accent-purple);">${liveMode.running ? 'Stop Timer' : 'Start Timer'}</button>
                </div>
              </div>
              <div style="margin-top:8px; background: var(--bg-primary); border-radius: 8px; overflow:hidden; height: 10px; border: 1px solid var(--border);">
                <div style="height: 100%; width: ${pct}%; background: var(--accent-warning); transition: width 0.2s linear;"></div>
              </div>
            `;

            if (liveMode.restRunning && restRemaining <= 0.05) {
                stopRestTimer();
                try { if (navigator.vibrate) navigator.vibrate([120, 60, 120]); } catch {}
                showToast('Rest finished');
            }
        }

        // ----- Training Tab UI -----
        function updateTrainingTab() {
            const today = getTodayISO();
            const sessionsToday = trainingLog.filter(w => w.date === today).sort((a,b)=> (a.startTime||'').localeCompare(b.startTime||''));

            const planCard = `
                <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <div style="display:flex; justify-content: space-between; align-items: center; gap: 10px; flex-wrap: wrap;">
                        <div>
                            <h3 style="color: var(--accent-cyan); margin-bottom: 6px;">üìå Workout for Today (${today})</h3>
                            <div style="color: var(--text-secondary); font-size: 0.9em;">Plan the work ‚Ä¢ Work the plan ‚Ä¢ Warmup sets excluded from volume</div>
                        </div>
                        <div style="display:flex; gap: 8px; flex-wrap: wrap;">
                            <button onclick="showAddWorkout('${today}')" class="primary">+ Plan Workout</button>
                            <button onclick="duplicateLastWorkoutToToday()" style="background: var(--accent-purple);">‚Ü©Ô∏é Duplicate Last</button>
                            <button onclick="openTemplateManager()" style="background: var(--accent-cyan);">üìö Templates</button>
                            <button onclick="openSyncModal()" style="background: var(--accent-warning);">‚òÅÔ∏è Sync</button>
                        </div>
                    </div>
                    ${sessionsToday.length === 0 ? `
                        <div style="margin-top: 15px; color: var(--text-secondary);">No workouts planned/logged for today yet.</div>
                    ` : `
                        <div style="margin-top: 15px; display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 12px;">
                            ${sessionsToday.map(s => renderWorkoutMiniCard(s)).join('')}
                        </div>
                    `}
                </div>
            `;

            if (trainingLog.length === 0) {
                document.getElementById('trainingContent').innerHTML = planCard + `
                    <div style="background: var(--bg-tertiary); padding: 30px; border-radius: 10px; text-align: center;">
                        <h3 style="color: var(--accent-purple); margin-bottom: 15px;">üèãÔ∏è No Workouts Logged Yet</h3>
                        <p style="color: var(--text-secondary); margin-bottom: 20px;">Track sessions with individual sets, warmups, supersets, templates, and Live Mode.</p>
                        <button onclick="showAddWorkout('${today}')" class="primary">+ Log First Workout</button>
                    </div>
                `;
                return;
            }

            const sorted = trainingLog.slice().sort((a,b)=> b.date.localeCompare(a.date) || (b.startTime||'').localeCompare(a.startTime||''));

            let workoutCards = '';
            sorted.forEach(workout => {
                const { totalWorkingSets, totalVolume, supersetGroups } = workoutSummary(workout);
                const exercises = workout.exercises || [];
                let exercisesHtml = '';

                if (exercises.length > 0) {
                    const groups = {};
                    exercises.forEach(ex => {
                        const k = (ex.superset || '').trim();
                        const key = k ? `Superset ${escapeHTML(k)}` : 'Exercises';
                        groups[key] = groups[key] || [];
                        groups[key].push(ex);
                    });
                    Object.keys(groups).sort().forEach(groupName => {
                        exercisesHtml += `<div style="margin-top: 10px;">
                            <div style="font-family:'Space Mono', monospace; color: var(--text-secondary); margin-bottom: 6px;">${groupName}</div>
                            ${groups[groupName].map(ex => renderExerciseSummary(ex)).join('')}
                        </div>`;
                    });
                } else {
                    exercisesHtml = '<p style="color: var(--text-secondary); font-style: italic;">No exercises logged</p>';
                }

                const label = workout.startTime ? `${workout.date} ‚Ä¢ ${workout.startTime}` : workout.date;

                workoutCards += `
                    <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 10px; margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px; gap: 10px;">
                            <div>
                                <h3 style="color: var(--accent-purple); margin-bottom: 5px;">${escapeHTML(workout.title || workout.type || 'Workout')}</h3>
                                <div style="font-size: 0.9em; color: var(--text-secondary); font-family:'Space Mono', monospace;">${label}</div>
                                <div style="font-size: 0.85em; color: var(--text-secondary); margin-top: 6px; font-family:'Space Mono', monospace;">
                                    Working Sets: ${totalWorkingSets} ‚Ä¢ Volume: ${Math.round(totalVolume).toLocaleString()} ‚Ä¢ Supersets: ${supersetGroups.length || 0}
                                </div>
                            </div>
                            <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                                <button onclick="editWorkoutById('${workout.id}')" style="padding: 5px 10px; font-size: 0.8em;">Edit</button>
                                <button onclick="duplicateWorkout('${workout.id}')" style="padding: 5px 10px; font-size: 0.8em; background: var(--accent-purple);">Duplicate</button>
                                <button onclick="saveWorkoutAsTemplate('${workout.id}')" style="padding: 5px 10px; font-size: 0.8em; background: var(--accent-cyan);">Save as Template</button>
                                <button class="danger" onclick="deleteWorkout('${workout.id}')">√ó</button>
                            </div>
                        </div>
                        ${exercisesHtml}
                        ${workout.notes ? `<div style="margin-top: 10px; padding: 10px; background: var(--bg-primary); border-radius: 6px; font-size: 0.9em; color: var(--text-secondary);">${escapeHTML(workout.notes)}</div>` : ''}
                    </div>
                `;
            });

            document.getElementById('trainingContent').innerHTML = planCard + workoutCards;
        }

        function renderWorkoutMiniCard(workout) {
            const { totalWorkingSets, totalVolume, supersetGroups } = workoutSummary(workout);
            const when = workout.startTime ? `${workout.startTime}` : '‚Äî';
            return `
                <div style="background: var(--bg-primary); padding: 14px; border-radius: 10px; border: 1px solid var(--border);">
                    <div style="display:flex; justify-content: space-between; gap: 10px; align-items: start;">
                        <div>
                            <div style="font-weight:700; color: var(--accent-purple);">${escapeHTML(workout.title || workout.type || 'Workout')}</div>
                            <div style="color: var(--text-secondary); font-family:'Space Mono', monospace; font-size:0.85em; margin-top:4px;">Start: ${when}</div>
                        </div>
                        <div style="display:flex; gap:6px; flex-wrap: wrap;">
                            <button onclick="editWorkoutById('${workout.id}')" style="padding: 6px 10px; font-size:0.8em;">Open</button>
                        </div>
                    </div>
                    <div style="margin-top:10px; color: var(--text-secondary); font-family:'Space Mono', monospace; font-size:0.85em;">
                        Sets: ${totalWorkingSets} ‚Ä¢ Vol: ${Math.round(totalVolume).toLocaleString()} ‚Ä¢ Supersets: ${supersetGroups.length || 0}
                    </div>
                </div>
            `;
        }

        function renderExerciseSummary(ex) {
            const sets = ex.sets || [];
            const warmups = sets.filter(s=>!!s.warmup).length;
            const work = sets.filter(s=>!s.warmup).length;
            const vol = Math.round(sumWorkingVolumeForExercise(ex)).toLocaleString();
            return `
                <div style="background: var(--bg-secondary); padding: 10px; border-radius: 8px; margin: 6px 0; border: 1px solid var(--border);">
                    <div style="display:flex; justify-content: space-between; gap: 10px; align-items: start;">
                        <div style="font-weight: 700;">${escapeHTML(ex.name || 'Exercise')}</div>
                        <div style="font-family:'Space Mono', monospace; color: var(--text-secondary); font-size:0.85em;">Vol: ${vol}</div>
                    </div>
                    <div style="font-size: 0.85em; color: var(--text-secondary); font-family: 'Space Mono', monospace; margin-top:6px;">
                        Sets: ${work} work ‚Ä¢ ${warmups} warmup
                    </div>
                </div>
            `;
        }

        // ----- Workout Modal + set-by-set inputs -----
        function showAddWorkout(defaultDate, template=null) {
            loadExerciseLibrary();
            loadTemplates();
            hydrateExerciseDatalist();
            exerciseBlockCount = 0;

            const date = defaultDate || getTodayISO();
            const baseExercises = template ? (template.exercises || []) : [];

            const modal = document.getElementById('trainingModal');
            modal.innerHTML = renderWorkoutModal({
                id: newId('w'),
                date,
                startTime: '',
                type: (template?.type || 'Workout'),
                title: (template?.name || ''),
                notes: '',
                exercises: JSON.parse(JSON.stringify(baseExercises))
            }, true);
            modal.classList.add('show');

            updateLiveBar();

            if (baseExercises.length) baseExercises.forEach(ex => addExerciseBlock(ex));
            else addExerciseBlock();
        }

        function editWorkoutById(id) {
            const w = trainingLog.find(x => x.id === id);
            if (!w) return;
            loadExerciseLibrary();
            loadTemplates();
            hydrateExerciseDatalist();
            exerciseBlockCount = 0;

            const modal = document.getElementById('trainingModal');
            modal.innerHTML = renderWorkoutModal(w, false);
            modal.classList.add('show');

            updateLiveBar();

            if (Array.isArray(w.exercises) && w.exercises.length) w.exercises.forEach(ex => addExerciseBlock(ex));
            else addExerciseBlock();
        }

        function renderWorkoutModal(workout, isNew) {
            const title = isNew ? 'Plan / Log Workout' : 'Edit Workout';
            const saveLabel = isNew ? 'Save Workout' : 'Save Changes';

            return `
                <div class="modal">
                    <h2>${title}</h2>

                    <div id="liveBar" style="background: rgba(6, 182, 212, 0.08); border: 1px solid var(--border); padding: 12px; border-radius: 12px; margin-top: 10px;"></div>

                    <div class="integrity-notice" style="margin-top: 10px;">
                        <h4>üèãÔ∏è Live Workout Mode</h4>
                        <p>Start the timer and hit <b>Rest</b> after each set. Warmups don‚Äôt count toward volume.</p>
                    </div>

                    <div class="form-section">
                        <h3>Workout Details</h3>
                        <div class="form-grid">
                            <div class="form-field">
                                <label class="required">Date</label>
                                <input type="date" id="workoutDate" value="${escapeHTML(workout.date)}">
                            </div>
                            <div class="form-field">
                                <label>Start Time (optional)</label>
                                <input type="time" id="workoutStartTime" value="${escapeHTML(workout.startTime || '')}">
                                <div style="font-size:0.75em; color: var(--text-secondary); margin-top:3px;">Use for two-a-days</div>
                            </div>
                            <div class="form-field">
                                <label>Workout Title</label>
                                <input type="text" id="workoutTitle" placeholder="e.g., Push Day A" value="${escapeHTML(workout.title || '')}">
                            </div>
                            <div class="form-field">
                                <label>Workout Type</label>
                                <select id="workoutType">
                                    ${['Upper Body','Lower Body','Full Body','Push','Pull','Legs','Cardio','Other']
                                        .map(opt => `<option ${(workout.type||'')===opt?'selected':''}>${opt}</option>`).join('')}
                                </select>
                            </div>
                        </div>
                        <div style="display:flex; gap: 10px; flex-wrap: wrap; margin-top: 10px;">
                            <button onclick="${liveMode.running ? 'stopLiveTimer()' : 'startLiveTimer()'}" style="background: var(--accent-purple);">
                                ${liveMode.running ? 'Stop Live Timer' : 'Start Live Timer'}
                            </button>
                            <button onclick="startRestTimer(Number(document.getElementById('restSecondsInput')?.value || 90))" style="background: var(--accent-warning);">‚è± Start Rest</button>
                            <button onclick="stopRestTimer()">Stop Rest</button>
                            <button onclick="saveCurrentModalAsTemplate()" style="background: var(--accent-cyan);">Save as Template</button>
                            <button onclick="openTemplateManager()" style="background: var(--accent-cyan);">üìö Templates</button>
                            <button onclick="openSyncModal()" style="background: var(--accent-warning);">‚òÅÔ∏è Sync</button>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>Exercises (with Sets)</h3>
                        <div id="exerciseBlocks"></div>
                        <div style="display:flex; gap:10px; flex-wrap: wrap; margin-top: 10px;">
                            <button onclick="addExerciseBlock()">+ Add Exercise</button>
                            <button onclick="addSupersetPair()" style="background: var(--accent-purple);">+ Superset (2)</button>
                        </div>
                    </div>

                    <div class="form-section">
                        <div class="form-field">
                            <label>Notes</label>
                            <textarea id="workoutNotes" rows="2" placeholder="How did it feel? Any PRs?">${escapeHTML(workout.notes || '')}</textarea>
                        </div>
                    </div>

                    <div style="display:flex; gap: 10px; margin-top: 20px; flex-wrap: wrap;">
                        <button onclick="saveWorkoutV7()" class="primary">${saveLabel}</button>
                        <button onclick="hideTrainingModal()">Cancel</button>
                    </div>

                    <input type="hidden" id="workoutId" value="${escapeHTML(workout.id)}">
                </div>
            `;
        }

        function addSupersetPair() {
            const used = new Set();
            for (let i=0; i<exerciseBlockCount; i++) {
                const el = document.getElementById(`exSuperset-${i}`);
                if (el && el.value.trim()) used.add(el.value.trim().toUpperCase());
            }
            const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');
            const next = letters.find(l => !used.has(l)) || 'A';
            addExerciseBlock({ id: newId('ex'), name:'', superset: next, notes:'', sets:[] });
            addExerciseBlock({ id: newId('ex'), name:'', superset: next, notes:'', sets:[] });
        }

        function addExerciseBlock(prefill=null) {
            const container = document.getElementById('exerciseBlocks');
            if (!container) return;
            const id = exerciseBlockCount++;
            const ex = prefill || { id: newId('ex'), name:'', superset:'', notes:'', sets:[] };

            const block = document.createElement('div');
            block.id = `exerciseBlock-${id}`;
            block.style.cssText = 'background: var(--bg-primary); padding: 15px; border-radius: 10px; margin-bottom: 12px; border: 1px solid var(--border);';

            block.innerHTML = `
                <div style="display:flex; justify-content: space-between; gap: 10px; align-items: start; margin-bottom: 10px;">
                    <div style="flex:1;">
                        <div style="display:flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                            <div style="font-weight: 700; color: var(--accent-cyan);">Exercise</div>
                            <input type="text" list="exerciseOptions" id="exName-${id}" placeholder="Start typing (e.g., Bench Press)" value="${escapeHTML(ex.name||'')}" style="flex: 1; min-width: 220px;">
                            <div style="display:flex; gap: 8px; align-items: center;">
                                <label style="font-size:0.85em; color: var(--text-secondary);">Superset</label>
                                <input type="text" id="exSuperset-${id}" placeholder="A" value="${escapeHTML(ex.superset||'')}" style="width: 70px;">
                            </div>
                        </div>
                        <div style="margin-top: 8px;">
                            <textarea id="exNotes-${id}" rows="1" placeholder="Exercise notes (optional)" style="width: 100%;">${escapeHTML(ex.notes||'')}</textarea>
                        </div>
                    </div>
                    <div style="display:flex; gap: 6px; flex-wrap: wrap;">
                        <button onclick="addSetRow(${id}, false)" style="padding: 6px 10px; font-size:0.85em;">+ Set</button>
                        <button onclick="addSetRow(${id}, true)" style="padding: 6px 10px; font-size:0.85em; background: var(--accent-warning);">+ Warmup</button>
                        <button class="danger" onclick="removeExerciseBlock(${id})" style="padding: 4px 10px;">√ó</button>
                    </div>
                </div>

                <div style="overflow-x:auto;">
                    <table style="width:100%; font-size: 0.85em;">
                        <thead>
                            <tr>
                                <th style="min-width:40px;">#</th>
                                <th style="min-width:80px;">Warm</th>
                                <th style="min-width:80px;">Reps</th>
                                <th style="min-width:120px;">Weight</th>
                                <th style="min-width:70px;">Done</th>
                                <th style="min-width:180px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="setRows-${id}"></tbody>
                    </table>
                </div>

                <input type="hidden" id="exId-${id}" value="${escapeHTML(ex.id || newId('ex'))}">
            `;

            container.appendChild(block);

            if (Array.isArray(ex.sets) && ex.sets.length) {
                ex.sets.forEach(s => addSetRow(id, !!s.warmup, s));
            } else {
                addSetRow(id, false); addSetRow(id, false); addSetRow(id, false);
            }

            setTimeout(()=>{
                const nameEl = document.getElementById(`exName-${id}`);
                if (nameEl) nameEl.addEventListener('change', ()=>{ upsertExerciseToLibrary(nameEl.value); hydrateExerciseDatalist(); });
            }, 0);
        }

        function removeExerciseBlock(id) {
            const block = document.getElementById(`exerciseBlock-${id}`);
            if (block) block.remove();
        }

        function addSetRow(exBlockId, isWarmup=false, prefill=null) {
            const tbody = document.getElementById(`setRows-${exBlockId}`);
            if (!tbody) return;
            const idx = tbody.children.length + 1;
            const s = prefill || { reps:'', weight:'', warmup:isWarmup, completed:true };
            const row = document.createElement('tr');
            row.innerHTML = `
                <td style="font-family:'Space Mono', monospace;">${idx}</td>
                <td><input type="checkbox" id="setWarm-${exBlockId}-${idx}" ${(!!s.warmup)?'checked':''}></td>
                <td><input type="number" step="1" id="setReps-${exBlockId}-${idx}" value="${(s.reps ?? '')}" style="width:100%;"></td>
                <td><input type="number" step="0.5" id="setWt-${exBlockId}-${idx}" value="${(s.weight ?? '')}" style="width:100%;"></td>
                <td><input type="checkbox" id="setDone-${exBlockId}-${idx}" ${(s.completed===undefined || s.completed)?'checked':''}></td>
                <td style="display:flex; gap: 6px; flex-wrap: wrap;">
                    <button onclick="startRestTimer(Number(document.getElementById('restSecondsInput')?.value || 90))" style="background: var(--accent-warning); padding: 4px 8px;">Rest</button>
                    <button onclick="removeSetRow(this)" class="danger" style="padding: 4px 8px;">√ó</button>
                </td>
            `;
            tbody.appendChild(row);
        }

        function removeSetRow(btn) {
            const tr = btn.closest('tr');
            if (!tr) return;
            const tbody = tr.parentElement;
            tr.remove();
            Array.from(tbody.children).forEach((r,i)=>{
                const td = r.querySelector('td');
                if (td) td.textContent = String(i+1);
            });
        }

        function collectWorkoutFromModal() {
            const id = document.getElementById('workoutId').value || newId('w');
            const date = document.getElementById('workoutDate').value;
            const startTime = document.getElementById('workoutStartTime').value || '';
            const title = document.getElementById('workoutTitle').value || '';
            const type = document.getElementById('workoutType').value || 'Workout';
            const notes = document.getElementById('workoutNotes').value || '';

            const exercises = [];
            for (let exBlockId=0; exBlockId<exerciseBlockCount; exBlockId++) {
                const block = document.getElementById(`exerciseBlock-${exBlockId}`);
                if (!block) continue;

                const exId = document.getElementById(`exId-${exBlockId}`)?.value || newId('ex');
                const name = (document.getElementById(`exName-${exBlockId}`)?.value || '').trim();
                const superset = (document.getElementById(`exSuperset-${exBlockId}`)?.value || '').trim().toUpperCase();
                const exNotes = document.getElementById(`exNotes-${exBlockId}`)?.value || '';

                const tbody = document.getElementById(`setRows-${exBlockId}`);
                const setCount = tbody ? tbody.children.length : 0;

                const sets = [];
                for (let i=1; i<=setCount; i++) {
                    const repsRaw = document.getElementById(`setReps-${exBlockId}-${i}`)?.value;
                    const wtRaw = document.getElementById(`setWt-${exBlockId}-${i}`)?.value;
                    const warmup = !!document.getElementById(`setWarm-${exBlockId}-${i}`)?.checked;
                    const completed = !!document.getElementById(`setDone-${exBlockId}-${i}`)?.checked;

                    const reps = (repsRaw === '' || repsRaw === undefined) ? null : Number(repsRaw);
                    const weight = (wtRaw === '' || wtRaw === undefined) ? null : Number(wtRaw);
                    if (reps === null && weight === null && !warmup) continue;
                    sets.push({ reps, weight, warmup, completed });
                }

                if (!name && sets.length === 0) continue;
                if (name) upsertExerciseToLibrary(name);

                exercises.push({ id: exId, name: name || 'Exercise', superset, notes: exNotes, sets });
            }

            return { id, date, startTime, title, type, notes, exercises };
        }

        function saveWorkoutV7() {
            const date = document.getElementById('workoutDate').value;
            if (!date) { showToast('Please enter a workout date', true); return; }

            const workout = collectWorkoutFromModal();
            const idx = trainingLog.findIndex(w => w.id === workout.id);
            if (idx >= 0) trainingLog[idx] = workout;
            else trainingLog.push(workout);

            trainingLog.sort((a,b)=> a.date.localeCompare(b.date) || (a.startTime||'').localeCompare(b.startTime||''));
            saveTraining();
            hideTrainingModal();
            updateTrainingTab();
            showToast('Workout saved!');
        }

        function saveCurrentModalAsTemplate() {
            loadTemplates();
            const w = collectWorkoutFromModal();
            const tpl = templateFromWorkout(w);
            tpl.name = prompt('Template name?', tpl.name) || tpl.name;
            workoutTemplates.push(tpl);
            saveTemplates();
            showToast('Template saved!');
        }

        function duplicateWorkout(id) {
            const w = trainingLog.find(x => x.id === id);
            if (!w) return;
            const copy = JSON.parse(JSON.stringify(w));
            copy.id = newId('w');
            copy.date = getTodayISO();
            copy.startTime = '';
            copy.title = (copy.title ? (copy.title + ' (Copy)') : 'Workout (Copy)');
            trainingLog.push(copy);
            trainingLog.sort((a,b)=> a.date.localeCompare(b.date) || (a.startTime||'').localeCompare(b.startTime||''));
            saveTraining();
            updateTrainingTab();
            showToast('Duplicated to today');
        }

        function duplicateLastWorkoutToToday() {
            if (trainingLog.length === 0) { showToast('No workouts to duplicate yet', true); return; }
            const sorted = trainingLog.slice().sort((a,b)=> b.date.localeCompare(a.date) || (b.startTime||'').localeCompare(a.startTime||''));
            duplicateWorkout(sorted[0].id);
        }

        function deleteWorkout(id) {
            if (!confirm('Delete this workout session?')) return;
            trainingLog = trainingLog.filter(w => w.id !== id);
            saveTraining();
            updateTrainingTab();
            showToast('Workout deleted');
        }

        function hideTrainingModal() {
            document.getElementById('trainingModal').classList.remove('show');
            exerciseBlockCount = 0;
            stopRestTimer();
            stopLiveTimer();
        }

        // ===== OPTIONAL CLOUD SYNC (GitHub Gist) =====
        function getSyncConfig() {
            const raw = localStorage.getItem(SYNC_CONFIG_KEY);
            if (!raw) return { enabled:false, gistId:'', token:'' };
            try { return JSON.parse(raw) || { enabled:false, gistId:'', token:'' }; } catch { return { enabled:false, gistId:'', token:'' }; }
        }

        function setSyncConfig(cfg) {
            localStorage.setItem(SYNC_CONFIG_KEY, JSON.stringify(cfg));
        }

        function openSyncModal() {
            const cfg = getSyncConfig();
            const modal = document.getElementById('syncModal');
            if (!modal) { showToast('Sync modal not found', true); return; }
            modal.innerHTML = `
              <div class="modal">
                <h2>‚òÅÔ∏è Cross-Device Sync (GitHub Gist)</h2>
                <div class="integrity-notice">
                  <h4>How Sync Works</h4>
                  <p>This is a static GitHub Pages app. LocalStorage does not automatically sync across devices.</p>
                  <p>Use a GitHub Gist as a small cloud store. You need a GitHub token with <b>gist</b> scope.</p>
                  <p style="margin-top:8px;"><b>Note:</b> The token is stored only in your browser (localStorage). Treat it like a password.</p>
                </div>

                <div class="form-section">
                  <h3>Sync Settings</h3>
                  <div class="form-grid">
                    <div class="form-field">
                      <label>Enable Sync</label>
                      <input type="checkbox" id="syncEnabled" style="width:auto;" ${cfg.enabled ? 'checked' : ''}>
                    </div>
                    <div class="form-field">
                      <label>Gist ID</label>
                      <input type="text" id="syncGistId" placeholder="e.g., a1b2c3d4..." value="${escapeHTML(cfg.gistId || '')}">
                      <div style="font-size:0.75em; color: var(--text-secondary); margin-top:3px;">Create a private gist (any file). We update body-tracker-sync.json inside it.</div>
                    </div>
                    <div class="form-field">
                      <label>GitHub Token (gist scope)</label>
                      <input type="password" id="syncToken" placeholder="ghp_..." value="${escapeHTML(cfg.token || '')}">
                    </div>
                  </div>
                </div>

                <div class="form-section">
                  <h3>Sync Actions</h3>
                  <div style="display:flex; gap:10px; flex-wrap: wrap;">
                    <button class="primary" onclick="saveSyncSettings()">Save Settings</button>
                    <button onclick="pushSync()">‚¨ÜÔ∏è Push to Gist</button>
                    <button onclick="pullSync()">‚¨áÔ∏è Pull from Gist</button>
                    <button onclick="closeSyncModal()">Close</button>
                  </div>
                  <div style="color: var(--text-secondary); font-size:0.85em; margin-top:10px;">
                    Push uploads body entries, measurements, training log, templates, and exercise library.<br>
                    Pull replaces your local data with what‚Äôs in the gist.
                  </div>
                </div>
              </div>
            `;
            modal.classList.add('show');
        }

        function closeSyncModal() {
            const modal = document.getElementById('syncModal');
            if (modal) modal.classList.remove('show');
        }

        function saveSyncSettings() {
            const enabled = !!document.getElementById('syncEnabled').checked;
            const gistId = (document.getElementById('syncGistId').value || '').trim();
            const token = (document.getElementById('syncToken').value || '').trim();
            setSyncConfig({ enabled, gistId, token });
            showToast('Sync settings saved');
        }

        function buildSyncPayload() {
            return {
                version: 'v7',
                exportDate: new Date().toISOString(),
                body: bodyData || [],
                measurements: measurements || [],
                training: trainingLog || [],
                templates: workoutTemplates || [],
                exerciseLibrary: exerciseLibrary || []
            };
        }

        async function pushSync() {
            const cfg = getSyncConfig();
            if (!cfg.enabled) { showToast('Enable sync first', true); return; }
            if (!cfg.gistId || !cfg.token) { showToast('Enter gist ID + token', true); return; }

            const payload = buildSyncPayload();
            const content = JSON.stringify(payload, null, 2);

            try {
                const res = await fetch(`https://api.github.com/gists/${cfg.gistId}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `token ${cfg.token}`,
                        'Accept': 'application/vnd.github+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        files: { 'body-tracker-sync.json': { content } }
                    })
                });
                if (!res.ok) {
                    const t = await res.text();
                    throw new Error(t || 'GitHub API error');
                }
                showToast('‚úÖ Pushed to Gist');
            } catch (err) {
                console.error(err);
                showToast('Sync push failed (see console)', true);
            }
        }

        async function pullSync() {
            const cfg = getSyncConfig();
            if (!cfg.enabled) { showToast('Enable sync first', true); return; }
            if (!cfg.gistId || !cfg.token) { showToast('Enter gist ID + token', true); return; }

            try {
                const res = await fetch(`https://api.github.com/gists/${cfg.gistId}`, {
                    headers: {
                        'Authorization': `token ${cfg.token}`,
                        'Accept': 'application/vnd.github+json'
                    }
                });
                if (!res.ok) {
                    const t = await res.text();
                    throw new Error(t || 'GitHub API error');
                }
                const gist = await res.json();
                const file = gist.files && gist.files['body-tracker-sync.json'];
                if (!file || !file.content) throw new Error('No body-tracker-sync.json found in gist');

                const payload = JSON.parse(file.content);
                if (payload.body) bodyData = payload.body;
                if (payload.measurements) measurements = payload.measurements;
                if (payload.training) trainingLog = payload.training;
                if (payload.templates) workoutTemplates = payload.templates;
                if (payload.exerciseLibrary) exerciseLibrary = payload.exerciseLibrary;

                saveData();
                saveMeasurements();
                saveTraining();
                saveTemplates();
                saveExerciseLibrary();

                loadData();
                updateStats();
                updateTable();
                updateChart();
                updateMeasurementsTab();
                updateTrainingTab();
                updateCorrelationsTab();

                showToast('‚úÖ Pulled from Gist');
            } catch (err) {
                console.error(err);
                showToast('Sync pull failed (see console)', true);
            }
        }


        // ===== CORRELATIONS TAB =====
        
        function updateCorrelationsTab() {
            const sorted = bodyData.slice().sort((a, b) => a.date.localeCompare(b.date));
            
            if (sorted.length < 14) {
                document.getElementById('correlationsContent').innerHTML = `
                    <div style="background: var(--bg-tertiary); padding: 30px; border-radius: 10px; text-align: center;">
                        <h3 style="color: var(--accent-purple); margin-bottom: 15px;">üîç Not Enough Data Yet</h3>
                        <p style="color: var(--text-secondary);">
                            Need at least 14 days of data to show meaningful correlations.<br>
                            You have ${sorted.length} days - keep tracking!
                        </p>
                    </div>
                `;
                return;
            }
            
            // Calculate correlations
            const withNutrition = sorted.filter(d => d.calories && d.protein);
            const recent30 = sorted.slice(-30);
            
            // Fat loss correlation with protein intake
            let proteinCorrelation = 'Unknown';
            if (withNutrition.length >= 14) {
                const avgProtein = withNutrition.reduce((sum, d) => sum + d.protein, 0) / withNutrition.length;
                const latest = withNutrition[withNutrition.length - 1];
                const proteinPerLb = latest.lean_lbs ? avgProtein / latest.lean_lbs : 0;
                
                if (proteinPerLb >= 1.0) {
                    proteinCorrelation = 'Excellent';
                } else if (proteinPerLb >= 0.8) {
                    proteinCorrelation = 'Good';
                } else if (proteinPerLb >= 0.6) {
                    proteinCorrelation = 'Fair';
                } else {
                    proteinCorrelation = 'Low';
                }
            }
            
            // Calculate fat loss rate
            const first = recent30[0];
            const last = recent30[recent30.length - 1];
            const fatLost = (first.weight * first.bf_percent / 100) - (last.weight * last.bf_percent / 100);
            const leanChange = last.lean_lbs - first.lean_lbs;
            const daysSpan = recent30.length;
            const fatLossRate = (fatLost / daysSpan) * 7;
            
            // Sleep correlation
            const withSleep = recent30.filter(d => d.sleep_duration_hrs);
            let avgSleep = 0;
            if (withSleep.length > 0) {
                avgSleep = withSleep.reduce((sum, d) => sum + d.sleep_duration_hrs, 0) / withSleep.length;
            }
            
            // Steps correlation
            const withSteps = recent30.filter(d => d.steps);
            let avgSteps = 0;
            if (withSteps.length > 0) {
                avgSteps = withSteps.reduce((sum, d) => sum + d.steps, 0) / withSteps.length;
            }
            
            const html = `
                <div class="grid grid-2">
                    <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 10px;">
                        <h3 style="color: var(--accent-purple); margin-bottom: 15px;">üìâ Fat Loss Progress (Last 30 Days)</h3>
                        <div class="nutrition-card">
                            <div class="nutrition-label">Fat Loss Rate</div>
                            <div class="nutrition-value">${fatLossRate.toFixed(2)} lbs/week</div>
                        </div>
                        <div class="nutrition-card">
                            <div class="nutrition-label">Total Fat Lost</div>
                            <div class="nutrition-value">${fatLost.toFixed(1)} lbs</div>
                        </div>
                        <div class="nutrition-card">
                            <div class="nutrition-label">Lean Mass Change</div>
                            <div class="nutrition-value" style="color: ${leanChange >= 0 ? 'var(--accent-success)' : 'var(--accent-danger)'}">
                                ${leanChange >= 0 ? '+' : ''}${leanChange.toFixed(1)} lbs
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 10px;">
                        <h3 style="color: var(--accent-purple); margin-bottom: 15px;">ü•© Protein Intake Analysis</h3>
                        <div class="nutrition-card">
                            <div class="nutrition-label">Protein Status</div>
                            <div class="nutrition-value" style="font-size: 1.3em; color: ${
                                proteinCorrelation === 'Excellent' ? 'var(--accent-success)' :
                                proteinCorrelation === 'Good' ? 'var(--accent-cyan)' :
                                proteinCorrelation === 'Fair' ? 'var(--accent-warning)' : 'var(--accent-danger)'
                            }">
                                ${proteinCorrelation}
                            </div>
                        </div>
                        <p style="color: var(--text-secondary); font-size: 0.9em; margin-top: 10px;">
                            ${proteinCorrelation === 'Excellent' ? 'Great job! Your protein intake is supporting lean mass retention.' :
                              proteinCorrelation === 'Good' ? 'Good protein intake. Consider increasing slightly for better muscle retention.' :
                              proteinCorrelation === 'Fair' ? 'Protein is adequate but could be higher for optimal muscle retention.' :
                              'Consider increasing protein intake to preserve lean mass during fat loss.'}
                        </p>
                    </div>
                </div>
                
                <div class="grid grid-2" style="margin-top: 20px;">
                    <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 10px;">
                        <h3 style="color: var(--accent-purple); margin-bottom: 15px;">üò¥ Sleep Analysis</h3>
                        <div class="nutrition-card">
                            <div class="nutrition-label">Average Sleep</div>
                            <div class="nutrition-value">${avgSleep > 0 ? avgSleep.toFixed(1) + ' hrs' : 'No data'}</div>
                        </div>
                        ${avgSleep > 0 ? `
                        <p style="color: var(--text-secondary); font-size: 0.9em; margin-top: 10px;">
                            ${avgSleep >= 7.5 ? '‚úÖ Excellent sleep duration supports recovery and fat loss.' :
                              avgSleep >= 6.5 ? '‚ö†Ô∏è Sleep is adequate but could be improved for better results.' :
                              '‚ùå Sleep duration is low. Aim for 7-9 hours for optimal recovery.'}
                        </p>
                        ` : ''}
                    </div>
                    
                    <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 10px;">
                        <h3 style="color: var(--accent-purple); margin-bottom: 15px;">üö∂ Activity Level</h3>
                        <div class="nutrition-card">
                            <div class="nutrition-label">Average Daily Steps</div>
                            <div class="nutrition-value">${avgSteps > 0 ? Math.round(avgSteps).toLocaleString() : 'No data'}</div>
                        </div>
                        ${avgSteps > 0 ? `
                        <p style="color: var(--text-secondary); font-size: 0.9em; margin-top: 10px;">
                            ${avgSteps >= 10000 ? '‚úÖ Excellent activity level! This supports your fat loss goals.' :
                              avgSteps >= 7500 ? 'üëç Good activity level. Consider increasing to 10k+ for faster progress.' :
                              avgSteps >= 5000 ? '‚ö†Ô∏è Moderate activity. Increasing steps could accelerate fat loss.' :
                              '‚ùå Low activity. Increasing daily movement would help with fat loss.'}
                        </p>
                        ` : ''}
                    </div>
                </div>
                
                ${trainingLog.length > 0 ? `
                <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 10px; margin-top: 20px;">
                    <h3 style="color: var(--accent-purple); margin-bottom: 15px;">üèãÔ∏è Training Frequency</h3>
                    <div class="nutrition-card">
                        <div class="nutrition-label">Total Workouts Logged</div>
                        <div class="nutrition-value">${trainingLog.length}</div>
                    </div>
                    <p style="color: var(--text-secondary); font-size: 0.9em; margin-top: 10px;">
                        ${trainingLog.length >= 20 ? 'üî• Excellent training consistency! Keep it up!' :
                          trainingLog.length >= 10 ? 'üí™ Good training frequency. Stay consistent!' :
                          'üìà Building training history. Consistency is key for results!'}
                    </p>
                </div>
                ` : `
                <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 10px; margin-top: 20px; text-align: center;">
                    <h3 style="color: var(--accent-purple); margin-bottom: 15px;">üèãÔ∏è No Training Data Yet</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 15px;">
                        Start logging workouts to see training correlations with body composition changes.
                    </p>
                    <button onclick="switchMainTab('training'); this.blur();" class="primary">Go to Training Log</button>
                </div>
                `}
                
                <div style="background: rgba(6, 182, 212, 0.1); padding: 20px; border-radius: 10px; margin-top: 20px; border-left: 4px solid var(--accent-cyan);">
                    <h3 style="color: var(--accent-cyan); margin-bottom: 10px;">üí° Key Insights</h3>
                    <ul style="color: var(--text-secondary); line-height: 1.8;">
                        <li>You're losing ${fatLossRate.toFixed(2)} lbs of fat per week on average</li>
                        <li>Lean mass change: ${leanChange >= 0 ? 'gaining' : 'losing'} ${Math.abs(leanChange).toFixed(1)} lbs (${leanChange >= -1 ? 'good retention' : 'consider increasing protein'})</li>
                        ${avgSleep > 0 ? `<li>Average sleep: ${avgSleep.toFixed(1)} hours (${avgSleep >= 7.5 ? 'optimal' : 'could improve'})</li>` : ''}
                        ${avgSteps > 0 ? `<li>Daily steps: ${Math.round(avgSteps).toLocaleString()} (${avgSteps >= 10000 ? 'excellent' : 'room for improvement'})</li>` : ''}
                        <li>Keep tracking consistently for more detailed correlations</li>
                    </ul>
                </div>
            `;
            
            document.getElementById('correlationsContent').innerHTML = html;
        }
        
        
        function escapeHTML(str) {
            if (str === null || str === undefined) return '';
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

// ===== UTILITY FUNCTIONS =====
        
        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast show';
            if (isError) toast.classList.add('error');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
        
        function debugData() {
            console.log('=== BODY TRACKER DEBUG ===');
            console.log('Total entries:', bodyData.length);
            console.log('Storage key:', STORAGE_KEY);
            console.log('Goals:', GOALS);
            console.log('Integrity config:', INTEGRITY_CONFIG);
            console.log('Data sample:', bodyData.slice(0, 3));
            console.log('Latest entry:', bodyData[bodyData.length - 1]);
            
            // Integrity distribution
            const integrityCount = bodyData.reduce((acc, e) => {
                acc[e.integrity_status || 'unknown'] = (acc[e.integrity_status || 'unknown'] || 0) + 1;
                return acc;
            }, {});
            console.log('Integrity distribution:', integrityCount);
            
            // Residual stats
            const residuals = bodyData.filter(e => e.residual !== undefined).map(e => e.residual);
            if (residuals.length > 0) {
                const avgResidual = residuals.reduce((sum, r) => sum + r, 0) / residuals.length;
                const minResidual = Math.min(...residuals);
                const maxResidual = Math.max(...residuals);
                console.log('Residual stats:', {
                    avg: avgResidual.toFixed(2),
                    min: minResidual.toFixed(2),
                    max: maxResidual.toFixed(2),
                    range: (maxResidual - minResidual).toFixed(2)
                });
            }
            
            showToast('Debug info logged to console\n(Press F12 to view)');
        }
        
        // ===== INITIALIZATION =====
        
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ Body Tracker Pro - Complete Ultimate Edition');
            console.log('‚ú® With All Features: Nutrition, Measurements, Training, Correlations, Integrity Validation');
            
            loadData();
            loadMeasurements();
            loadExerciseLibrary();
            loadTemplates();
            loadTraining();
            updateStats();
            updateTable();
            updateChart();
            
            console.log(`‚úÖ Loaded ${bodyData.length} body composition entries`);
            console.log(`‚úÖ Loaded ${measurements.length} measurement records`);
            console.log(`‚úÖ Loaded ${trainingLog.length} training sessions`);
            
            // Auto-update inputs on modal
            ['entryWeight', 'entryBfPercent', 'entryLeanLbs'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.addEventListener('input', updateModalDerivedFields);
            });
            
            // Show welcome message for first-time users
            const hasSeenWelcome = localStorage.getItem('hasSeenWelcome_v2');
            if (!hasSeenWelcome) {
                setTimeout(() => {
                    showToast(
                        'üéâ Welcome to Body Tracker Pro - Complete Edition!\n\n' +
                        '‚ú® 6 powerful tabs\n' +
                        'üìä Nutrition analysis & recommendations\n' +
                        'üìè Body measurements tracking\n' +
                        'üèãÔ∏è Training log\n' +
                        'üîç Correlations & insights\n' +
                        'üõ°Ô∏è Data integrity validation\n\n' +
                        'All 48 days pre-loaded!'
                    );
                    localStorage.setItem('hasSeenWelcome_v2', 'true');
                }, 500);
            }
        });
    </script>
</body>
</html>
