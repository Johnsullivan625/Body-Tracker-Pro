<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Body Tracker Pro v15 - Ultimate Edition</title>
    <link rel="manifest" href='data:application/manifest+json,{"name": "Body Tracker Pro", "short_name": "BodyTracker", "start_url": "./?pwa=1", "display": "standalone", "background_color": "#0f172a", "theme_color": "#06b6d4", "icons": []}'>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Work+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --accent-cyan: #06b6d4;
            --accent-purple: #8b5cf6;
            --accent-success: #10b981;
            --accent-danger: #ef4444;
            --accent-warning: #f59e0b;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border: #334155;
        }
        
        body {
            font-family: 'Work Sans', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container { max-width: 1600px; margin: 0 auto; }
        
        .header {
            background: var(--bg-secondary);
            padding: 30px;
            border-radius: 16px;
            margin-bottom: 30px;
            border: 1px solid var(--border);
        }
        
        .header h1 {
            font-size: 2.5em;
            font-weight: 700;
            font-family: 'Space Mono', monospace;
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }
        
        .header-subtitle {
            color: var(--text-secondary);
            font-family: 'Space Mono', monospace;
            font-size: 0.9em;
            margin-bottom: 5px;
        }
        
        .header-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        /* INTEGRITY BADGES */
        .integrity-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
            font-family: 'Space Mono', monospace;
        }
        
        .integrity-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        .integrity-green {
            background: rgba(16, 185, 129, 0.15);
            color: var(--accent-success);
            border: 1px solid var(--accent-success);
        }
        
        .integrity-yellow {
            background: rgba(245, 158, 11, 0.15);
            color: var(--accent-warning);
            border: 1px solid var(--accent-warning);
        }
        
        .integrity-red {
            background: rgba(239, 68, 68, 0.15);
            color: var(--accent-danger);
            border: 1px solid var(--accent-danger);
        }
        
        .integrity-blue {
            background: rgba(6, 182, 212, 0.15);
            color: var(--accent-cyan);
            border: 1px solid var(--accent-cyan);
        }
        
        .integrity-gray {
            background: rgba(148, 163, 184, 0.15);
            color: var(--text-secondary);
            border: 1px solid var(--border);
        }
        
        .dot-green { background: var(--accent-success); }
        .dot-yellow { background: var(--accent-warning); }
        .dot-red { background: var(--accent-danger); }
        .dot-blue { background: var(--accent-cyan); }
        .dot-gray { background: var(--text-secondary); }
        
        button {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border);
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 0.9em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        button:hover {
            background: var(--accent-cyan);
            border-color: var(--accent-cyan);
            transform: translateY(-2px);
        }
        
        button.primary {
            background: var(--accent-cyan);
            border-color: var(--accent-cyan);
        }
        
        button.danger {
            background: var(--accent-danger);
            border-color: var(--accent-danger);
            padding: 5px 10px;
            font-size: 0.8em;
        }
        
        .card {
            background: var(--bg-secondary);
            padding: 25px;
            border-radius: 12px;
            border: 1px solid var(--border);
            margin-bottom: 20px;
        }
        
        .card h2 {
            font-size: 1.5em;
            margin-bottom: 20px;
            color: var(--accent-cyan);
        }
        
        .grid { display: grid; gap: 20px; margin-bottom: 20px; }
        .grid-4 { grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); }
        
        .stat-card {
            background: var(--bg-tertiary);
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid var(--accent-cyan);
        }
        
        .stat-label {
            font-size: 0.85em;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: 700;
            font-family: 'Space Mono', monospace;
            margin: 10px 0;
        }
        
        .stat-change {
            font-size: 0.9em;
            font-family: 'Space Mono', monospace;
        }
        
        .positive { color: var(--accent-success); }
        .negative { color: var(--accent-danger); }
        
        .chart-wrapper {
            position: relative;
            height: 400px;
            width: 100%;
            margin-bottom: 20px;
        }
        
        canvas { max-height: 400px !important; }
        
        .chart-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .chart-tab {
            padding: 10px 20px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9em;
        }
        
        .chart-tab.active {
            background: var(--accent-cyan);
            border-color: var(--accent-cyan);
            font-weight: 600;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.75em;
        }
        
        th {
            background: var(--bg-tertiary);
            padding: 10px 6px;
            text-align: left;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.8em;
            letter-spacing: 0.5px;
            border-bottom: 2px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        td {
            padding: 8px 6px;
            border-bottom: 1px solid var(--border);
        }
        
        tbody tr:hover {
            background: var(--bg-tertiary);
            cursor: pointer;
        }
        
        tbody tr.editing {
            background: rgba(6, 182, 212, 0.15);
            outline: 2px solid var(--accent-cyan);
        }
        
        .refeed-row {
            background: rgba(239, 68, 68, 0.1);
        }
        
        .refeed-row:hover {
            background: rgba(239, 68, 68, 0.15);
        }
        
        td.editing input {
            width: 100%;
            background: var(--bg-primary);
            border: 1px solid var(--accent-cyan);
            color: var(--text-primary);
            padding: 4px 6px;
            border-radius: 4px;
            font-size: 0.95em;
        }
        
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            align-items: center;
            justify-content: center;
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
        }
        
        .modal-overlay.show { display: flex; }
        
        .modal {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 30px;
            max-width: 700px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid var(--border);
        }
        
        .form-section {
            background: var(--bg-tertiary);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        
        .form-section h3 {
            font-size: 1.1em;
            margin-bottom: 15px;
            color: var(--accent-cyan);
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
        }
        
        .form-field label {
            display: block;
            font-size: 0.85em;
            color: var(--text-secondary);
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .form-field input, .form-field textarea {
            width: 100%;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 8px;
            border-radius: 6px;
            font-size: 0.9em;
        }
        
        .form-field input:focus {
            outline: none;
            border-color: var(--accent-cyan);
        }
        
        .form-field input[readonly] {
            background: var(--bg-primary);
            color: var(--text-secondary);
            cursor: not-allowed;
        }
        
        .required::after {
            content: " *";
            color: var(--accent-danger);
        }
        
        .integrity-notice {
            background: rgba(6, 182, 212, 0.1);
            border-left: 4px solid var(--accent-cyan);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        .integrity-notice h4 {
            color: var(--accent-cyan);
            margin-bottom: 8px;
            font-size: 1em;
        }
        
        .integrity-notice p {
            font-size: 0.9em;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }
        
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--accent-success);
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 2000;
            display: none;
            animation: slideIn 0.3s ease;
            max-width: 500px;
            font-size: 0.9em;
            white-space: pre-line;
            font-family: 'Space Mono', monospace;
        }
        
        .toast.show { display: block; }
        .toast.error { background: var(--accent-danger); }
        .toast.warning { background: var(--accent-warning); }
        
        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .table-container {
            overflow-x: auto;
            max-height: 600px;
            overflow-y: auto;
        }
        
        .edit-actions {
            display: flex;
            gap: 5px;
        }
        
        .tab-button {
            padding: 12px 24px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1em;
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .tab-button:hover {
            background: var(--accent-cyan);
            border-color: var(--accent-cyan);
            transform: translateY(-2px);
        }
        
        .tab-button.active {
            background: var(--accent-cyan);
            border-color: var(--accent-cyan);
            font-weight: 600;
        }
        
        .main-tab-content {
            display: none;
        }
        
        .main-tab-content.active {
            display: block;
        }
        
        .grid-2 { grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); }
        
        .nutrition-card {
            background: var(--bg-tertiary);
            padding: 20px;
            border-radius: 10px;
            margin: 10px 0;
        }
        
        .nutrition-label {
            font-size: 0.9em;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }
        
        .nutrition-value {
            font-size: 1.8em;
            font-weight: 700;
            font-family: 'Space Mono', monospace;
            color: var(--accent-cyan);
        }
        
        @media (max-width: 768px) {
            .header h1 { font-size: 1.8em; }
            .grid-4, .grid-2 { grid-template-columns: 1fr; }
            .form-grid { grid-template-columns: 1fr; }
            table { font-size: 0.7em; }
            th, td { padding: 6px 3px; }
        }
    
        @media print {
            body { background: white !important; color: black !important; }
            .header-actions, .tab-button, button, .toast, .modal-overlay { display: none !important; }
            .card { page-break-inside: avoid; border: 1px solid #ddd !important; }
            th { position: static !important; }
        }
    
        .brand-section{margin-top:14px; display:flex; gap:14px; align-items:center; flex-wrap:wrap;}
        .brand-logo{width:56px; height:56px; border-radius:14px; background:linear-gradient(135deg, rgba(6,182,212,0.12), rgba(139,92,246,0.12)); border:1px solid var(--border); display:flex; align-items:center; justify-content:center; box-shadow:0 0 0 rgba(6,182,212,0); transition: all 0.25s ease;}
        .brand-title{font-family:'Space Mono', monospace; letter-spacing:0.06em; font-weight:800; font-size:0.95em;}
        .brand-gradient{background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple)); -webkit-background-clip:text; -webkit-text-fill-color:transparent;}
        .version-badge{display:inline-block; background:rgba(139,92,246,0.12); padding:6px 10px; border-radius:999px; font-weight:800; font-family:'Space Mono', monospace; font-size:0.8em; border:1px solid var(--accent-purple); margin-left:10px;}
        /* Celebration modal */
        .celebration-modal{position:relative; overflow:hidden;}
        .confetti-container{position:absolute; inset:0; pointer-events:none; overflow:hidden;}
        @keyframes confetti-fall{0%{transform:translateY(-100px) rotate(0deg); opacity:1;}100%{transform:translateY(110vh) rotate(720deg); opacity:0;}}
        .confetti-piece{position:absolute; width:10px; height:10px; border-radius:2px; animation: confetti-fall 3s ease-out forwards;}
        /* Heatmap */
        .heatmap-table th,.heatmap-table td{border:1px solid var(--border);}
        .heatmap-cell{padding:14px; cursor:pointer; text-align:center; font-family:'Space Mono', monospace; font-weight:700; border-radius:6px;}
        /* PR cards */
        .pr-cards-grid{display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px;}
        .pr-item{display:grid; grid-template-columns: 90px 1fr; gap:8px; padding:8px 0; border-bottom:1px dashed var(--border);}
        .pr-item:last-child{border-bottom:none;}
        .pr-label{color:var(--text-secondary); font-size:0.85em;}
        .pr-value{font-weight:800;}
        .pr-detail{color:var(--text-secondary); font-size:0.85em; grid-column:2;}
</style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üí™ BODY TRACKER PRO v15</h1>
            

<div class="brand-section">
  <div class="brand-logo">
    <svg width="56" height="56" viewBox="0 0 80 80" fill="none" xmlns="http://www.w3.org/2000/svg" aria-label="Rak Chazaq - Only Strong">
      <!-- Shield/badge background for strength and protection -->
      <path d="M40 5 L70 20 L70 50 Q70 65 40 75 Q10 65 10 50 L10 20 Z"
            fill="rgba(139,92,246,0.1)"
            stroke="url(#gradient1)"
            stroke-width="2"/>
      <!-- Hebrew letter: Chet (◊ó) -->
      <g transform="translate(15, 25)">
        <path d="M2 5 L2 25 M12 5 L12 25 M2 5 L12 5"
              stroke="url(#gradient1)"
              stroke-width="4"
              stroke-linecap="round"
              stroke-linejoin="round"/>
      </g>
      <!-- Hebrew letter: Zayin (◊ñ) -->
      <g transform="translate(33, 25)">
        <path d="M2 5 L12 5 M7 5 L7 25"
              stroke="url(#gradient2)"
              stroke-width="4"
              stroke-linecap="round"
              stroke-linejoin="round"/>
      </g>
      <!-- Hebrew letter: Kaph final (◊ö) -->
      <g transform="translate(51, 25)">
        <path d="M2 5 L12 5 M12 5 Q14 8 14 12 L14 30 Q14 35 10 35"
              stroke="url(#gradient1)"
              stroke-width="4"
              stroke-linecap="round"
              stroke-linejoin="round"/>
      </g>
      <!-- Barbell accent -->
      <g transform="translate(20, 55)">
        <rect x="0" y="0" width="6" height="10" rx="1" fill="url(#gradient2)"/>
        <rect x="9" y="2" width="22" height="6" rx="1" fill="url(#gradient1)"/>
        <rect x="34" y="0" width="6" height="10" rx="1" fill="url(#gradient2)"/>
      </g>
      <defs>
        <linearGradient id="gradient1" x1="0" y1="0" x2="80" y2="80" gradientUnits="userSpaceOnUse">
          <stop offset="0%" stop-color="#06b6d4"/>
          <stop offset="100%" stop-color="#8b5cf6"/>
        </linearGradient>
        <linearGradient id="gradient2" x1="0" y1="0" x2="80" y2="80" gradientUnits="userSpaceOnUse">
          <stop offset="0%" stop-color="#10b981"/>
          <stop offset="100%" stop-color="#06b6d4"/>
        </linearGradient>
      </defs>
    </svg>
  </div>
  <div style="min-width:220px;">
    <div class="brand-title">
      <span class="brand-gradient">RAK CHAZAQ</span>
      <span style="color: var(--text-secondary); font-weight:600; margin-left:8px;">(◊ó◊ñ◊ß ◊®◊ß)</span>
    </div>
    <div style="color: var(--text-secondary); font-size:0.9em; margin-top:2px;">
      Only Strong ‚Ä¢ Joshua 1:9 ‚Ä¢ Plan the work, work the plan ‚Ä¢ Built for Transformation
    </div>
  </div>
  <span class="version-badge">v15.0</span>
</div></div>
<script>
  document.addEventListener('DOMContentLoaded', ()=>{
    const logo = document.querySelector('.brand-logo');
    if(!logo) return;
    logo.addEventListener('mouseenter', ()=>{ logo.style.boxShadow='0 0 22px rgba(6,182,212,0.35)'; logo.style.transform='translateY(-1px)';});
    logo.addEventListener('mouseleave', ()=>{ logo.style.boxShadow='0 0 0 rgba(6,182,212,0)'; logo.style.transform='translateY(0)';});
  });
</script>

<p class="header-subtitle">‚ú® v15: Advanced analytics ‚Ä¢ PR tracking ‚Ä¢ Training insights ‚Ä¢ Enhanced mobile UX</p>
            <p style="color: var(--text-secondary); font-family: 'Space Mono', monospace;" id="headerStatus">Loading...</p>
            <div class="header-actions">
                <button onclick="showAddEntry()" class="primary">+ Add Entry</button>
                <button onclick="exportCSV()">üì• Export CSV</button>
                <button onclick="exportBackup()">üíæ Backup JSON</button>
                <button onclick="openBulkEdit()" style="background: var(--accent-purple);">üßæ Bulk Edit</button>
                <button onclick="reloadData()" style="background: var(--accent-purple);">üîÑ Reload Data</button>
                <button onclick="openSettings()" style="background: var(--accent-purple);">‚öôÔ∏è Settings</button>
                <button onclick="openFormulaDocs()" style="background: var(--accent-cyan);">‚ÑπÔ∏è Formulas</button>
                <button onclick="debugData()" style="background: var(--accent-warning);">üîß Debug Data</button>
            </div>
        </div>

        <!-- TAB NAVIGATION -->
        <div style="display: flex; gap: 10px; margin-bottom: 30px; flex-wrap: wrap; background: var(--bg-secondary); padding: 15px; border-radius: 12px; border: 1px solid var(--border);">
            <button class="tab-button active" onclick="switchMainTab('dashboard', this)">üìä Dashboard</button>
            <button class="tab-button" onclick="switchMainTab('nutrition', this)">üçΩÔ∏è Nutrition</button>
            <button class="tab-button" onclick="switchMainTab('measurements', this)">üìè Body Measurements</button>
            <button class="tab-button" onclick="switchMainTab('training', this)">üèãÔ∏è Training Log</button>
            <button class="tab-button" onclick="switchMainTab('correlations', this)">üîç Correlations</button>
            <button class="tab-button" onclick="switchMainTab('progressive', this)">üìà Progressive</button>
            <button class="tab-button" onclick="switchMainTab('analytics', this)">üß† Analytics</button>
            <button class="tab-button" onclick="switchMainTab('data', this)">üìã All Data</button>
        </div>

        <!-- DASHBOARD TAB -->
        <div id="dashboard-tab" class="main-tab-content active">
            <div class="grid grid-4" id="statsGrid"></div>

            <div class="card">
                <h2>üéØ Goal Projection</h2>
                <div id="goalContent"></div>
            </div>

            <div class="card">
                <h2>üìä Health Statistics</h2>
                <div id="healthStatsContent"></div>
            </div>

            <div class="card">
                <h2>üìä Body Composition Analysis</h2>
                <p style="color: var(--text-secondary); margin-bottom: 15px;">Choose a view to understand your transformation better</p>
                <div class="chart-tabs">
                    <div class="chart-tab active" onclick="switchChart('fatVsLean', this)">Fat vs Lean Breakdown</div>
                    <div class="chart-tab" onclick="switchChart('weightTrend', this)">Weight & BF% Trend</div>
                    <div class="chart-tab" onclick="switchChart('rateOfChange', this)">Daily Rate of Change</div>
                    <div class="chart-tab" onclick="switchChart('nutrition', this)">Nutrition Tracking</div>
                    <div class="chart-tab" onclick="switchChart('waterOverlay', this)">Body Water % Overlay</div>
                </div>
                <div class="chart-wrapper">
                    <canvas id="mainChart"></canvas>
                </div>
            </div>
        </div>

        <!-- NUTRITION TAB -->
        <div id="nutrition-tab" class="main-tab-content">
            <div class="card">
                <h2>üçΩÔ∏è Nutrition Goals & Analysis</h2>
                <div id="nutritionGoals"></div>
            </div>
            <div class="grid grid-2">
                <div class="card">
                    <h3>üìä Total Averages (All Time)</h3>
                    <div id="totalAverages"></div>
                </div>
                <div class="card">
                    <h3>üìà Rolling 7-Day Averages</h3>
                    <div id="rollingAverages"></div>
                </div>
            </div>
            <div class="card">
                <h2>üí° Calorie Recommendations</h2>
                <div id="recommendations"></div>
            </div>
            <div class="card">
                <h2>üéØ What-If Calculator</h2>
                <div id="whatIfCalc"></div>
            </div>
        </div>

        <!-- MEASUREMENTS TAB -->
        <div id="measurements-tab" class="main-tab-content">
            <div class="card">
                <h2>üìè Body Measurements</h2>
                <button onclick="showAddMeasurement()" class="primary" style="margin-bottom: 20px;">+ Add Measurement</button>
                <div id="measurementsContent"></div>
            </div>
        </div>

        <!-- TRAINING TAB -->
        <div id="training-tab" class="main-tab-content">
            <div class="card">
                <h2>üèãÔ∏è Training Log</h2>
                <button onclick="showAddWorkout()" class="primary" style="margin-bottom: 20px;">+ Add Workout</button>
                <div id="trainingContent"></div>
            </div>
        </div>

        <!-- CORRELATIONS TAB -->
        <div id="correlations-tab" class="main-tab-content">
            <div class="card">
                <h2>üîç Correlations & Insights</h2>
                <div id="correlationsContent"></div>
            </div>
        </div>

        
<!-- PROGRESSIVE OVERLOAD TAB -->
<div id="progressive-tab" class="main-tab-content">
    <div class="card">
        <h2>üìà Progressive Overload</h2>
        <div id="progressiveContent"></div>
    </div>
</div>


        <!-- ANALYTICS TAB -->
        <div id="analytics-tab" class="main-tab-content">
            <div class="card">
                <h2>üß† Advanced Analytics</h2>
                <div id="analyticsContent"></div>
            </div>
        </div>

<!-- DATA TAB -->
        <div id="data-tab" class="main-tab-content">
            <div class="card">
                <h2>üìã Complete Data Log (<span id="entryCount">0</span> entries)</h2>
                <p style="color: var(--text-secondary); margin-bottom: 15px;">Click any row to edit ‚Ä¢ Red rows = refeed days ‚Ä¢ Badges show data integrity</p>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>‚úì</th>
                                <th>Weight</th>
                                <th>BF%</th>
                                <th>BF lbs</th>
                                <th>Lean</th>
                                <th>Lean%</th>
                                <th>Water%</th>
                                <th>Cal</th>
                                <th>Pro</th>
                                <th>Fat</th>
                                <th>Carbs</th>
                                <th>Steps</th>
                                <th>RHR</th>
                                <th>Sleep</th>
                                <th>Sleep Hrs</th>
                                <th>Q</th>
                                <th>Refeed</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="dataTable"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- ADD ENTRY MODAL -->
    <div class="modal-overlay" id="addEntryModal">
        <div class="modal">
            <h2 id="modalTitle">Add New Entry</h2>
            
            <div class="integrity-notice">
                <h4>üõ°Ô∏è Intelligent Data Validation</h4>
                <p>This tracker automatically validates your entries to catch typos and errors.</p>
                <p>You'll be alerted if weight, body fat %, or lean mass don't align with your typical patterns.</p>
            </div>
            
            <div class="form-section">
                <h3>Body Composition (Required)</h3>
                <div class="form-grid">
                    <div class="form-field">
                        <label class="required">Date</label>
                        <input type="date" id="entryDate" required>
                    </div>
                    <div class="form-field">
                        <label class="required">Weight (lbs)</label>
                        <input type="number" step="0.1" id="entryWeight" required>
                    </div>
                    <div class="form-field">
                        <label class="required">Body Fat %</label>
                        <input type="number" step="0.1" id="entryBfPercent" required>
                    </div>
                    <div class="form-field">
                        <label class="required">Lean Mass (lbs)</label>
                        <input type="number" step="0.1" id="entryLeanLbs" required>
                    </div>
                    <div class="form-field">
                        <label>BF lbs (Auto)</label>
                        <input type="text" id="entryBfLbsAuto" readonly>
                    </div>
                    <div class="form-field">
                        <label>Lean % (Auto)</label>
                        <input type="text" id="entryLeanPercentAuto" readonly>
                    </div>
                    <div class="form-field">
                        <label>Residual (Auto)</label>
                        <input type="text" id="entryResidualAuto" readonly>
                        <div style="font-size: 0.75em; color: var(--text-secondary); margin-top: 3px;">Used for integrity check</div>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h3>Nutrition</h3>
                <div class="form-grid">
                    <div class="form-field">
                        <label>Calories</label>
                        <input type="number" id="entryCalories">
                    </div>
                    <div class="form-field">
                        <label>Protein (g)</label>
                        <input type="number" id="entryProtein">
                    </div>
                    <div class="form-field">
                        <label>Fat (g)</label>
                        <input type="number" id="entryFat">
                    </div>
                    <div class="form-field">
                        <label>Carbs (g)</label>
                        <input type="number" id="entryCarbs">
                    </div>
                    <div class="form-field">
                        <label><input type="checkbox" id="entryRefeed" style="width: auto; margin-right: 8px;">Refeed Day üî•</label>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h3>Activity & Wellness</h3>
                <div class="form-grid">
                    <div class="form-field">
                        <label>Steps</label>
                        <input type="number" id="entrySteps">
                    </div>
                    <div class="form-field">
                        <label>RHR (bpm)</label>
                        <input type="number" id="entryRhr">
                    </div>
                    <div class="form-field">
                        <label>Sleep Score (0-100)</label>
                        <input type="number" min="0" max="100" id="entrySleepScore">
                    </div>
                    <div class="form-field">
                        <label>Sleep Hours</label>
                        <input type="number" step="0.1" id="entrySleepHours">
                    </div>
                    <div class="form-field">
                        <label>Body Water % (Optional)</label>
                        <input type="number" step="0.1" id="entryBodyWater">
                    </div>
                </div>
            </div>

            <div class="form-section">
                <div class="form-field">
                    <label>Notes</label>
                    <textarea rows="2" id="entryNotes"></textarea>
                </div>
            </div>

            <!-- Integrity Status in Modal -->
            <div id="modalIntegrityStatus" style="margin: 15px 0;"></div>

            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button onclick="saveEntry()" class="primary" id="saveBtn">Save Entry</button>
                <button onclick="hideModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- MEASUREMENTS MODAL -->
    <div class="modal-overlay" id="measurementsModal"></div>

    <!-- TRAINING MODAL -->
    <div class="modal-overlay" id="trainingModal"></div>

    <!-- SETTINGS MODAL -->
    <div class="modal-overlay" id="settingsModal"></div>

    <!-- FORMULA DOCS MODAL -->
    <div class="modal-overlay" id="formulaModal"></div>

    <div class="toast" id="toast"></div>

    <div id="quickAddBar" style="position: fixed; left: 12px; right: 12px; bottom: 12px; z-index: 1500; display:none;">
        <div style="background: rgba(30,41,59,0.92); backdrop-filter: blur(8px); border: 1px solid var(--border); border-radius: 14px; padding: 10px; display:flex; gap:10px; justify-content: space-between; align-items:center;">
            <button class="primary" onclick="showAddEntry()" style="flex:1; min-height:44px;">+ Body Entry</button>
            <button onclick="switchMainTab('training'); showAddWorkout();" style="flex:1; min-height:44px;">+ Workout</button>
            <button onclick="switchMainTab('data')" style="min-width:54px; min-height:44px;">üìã</button>
        </div>
    </div>


    <script>

        // ===== GLOBAL CONFIGURATION =====
        const STORAGE_KEY = 'bodyTrackingData_User1';
        
        const MEASUREMENTS_KEY = 'bodyMeasurements_User1';
        const TRAINING_KEY_OLD = 'trainingLog_User1';
const GOALS = {
    // Body composition goals
    target_weight: 215,
    target_bf_percent: 10.0,
    // For projection logic: target fat lbs at 10% of 215 = 21.5
    target_bf_lbs: 21.5,

    // Nutrition targets (editable)
    target_calories: 1600,
    target_protein: 195,
    target_fat: 55,
    target_carbs: 120,

    // Cutting milestone
    cut_target_bf_lbs: 20.0
};
        
        // Integrity validation thresholds
        const INTEGRITY_CONFIG = {
            baselineWindow: 14,  // Days to use for baseline calculation
            greenThreshold: 1.0, // lbs - good integrity
            yellowThreshold: 2.0, // lbs - warning
            // Anything above yellowThreshold is red (error likely)
        };

        let bodyData = [];
        let currentChart = null;
        let currentChartType = 'fatVsLean';
        let editingRow = null;


        // ===== Chart.js safety (v15) =====
        function chartJsReady() {
            return (typeof window.Chart !== 'undefined');
        }
        function ensureChartJsOrWarn() {
            if (!chartJsReady()) {
                // Avoid runtime errors if CDN is blocked/offline
                showToast('Charts unavailable (Chart.js failed to load).', true);
                return false;
            }
            return true;
        }

        function SafeChart(ctx, config) {
            if (!ensureChartJsOrWarn()) return null;
            return new Chart(ctx, config);
        }
        // ===== INITIAL DATA (57 days: Oct 27 - Dec 22, 2025) =====
        const INITIAL_DATA = [{"date":"2025-10-27","weight":208.1,"bf_percent":20.5,"lean_lbs":156.3,"calories":1405.0,"protein":116.0,"fat":83.0,"carbs":40.0,"steps":7046.0,"rhr":48.0,"sleep_score":87.0,"sleep_duration_hrs":9.42,"water_percent":58.4,"refeed":false,"notes":"","bf_lbs":42.7,"lean_percent":75.1,"residual":9.14,"integrity_status":"yellow"},{"date":"2025-10-28","weight":208.9,"bf_percent":20.5,"lean_lbs":154.5,"calories":1565.0,"protein":139.0,"fat":92.0,"carbs":30.0,"steps":null,"rhr":null,"sleep_score":77.0,"sleep_duration_hrs":6.62,"water_percent":58.3,"refeed":false,"notes":"","bf_lbs":42.8,"lean_percent":74.0,"residual":11.58,"integrity_status":"yellow"},{"date":"2025-10-29","weight":203.4,"bf_percent":20.3,"lean_lbs":154.6,"calories":1577.0,"protein":151.0,"fat":79.0,"carbs":50.0,"steps":null,"rhr":null,"sleep_score":63.0,"sleep_duration_hrs":9.18,"water_percent":59.8,"refeed":false,"notes":"","bf_lbs":41.3,"lean_percent":76.0,"residual":7.51,"integrity_status":"red"},{"date":"2025-10-30","weight":202.6,"bf_percent":20.0,"lean_lbs":154.5,"calories":1555.0,"protein":142.0,"fat":95.0,"carbs":23.0,"steps":6480.0,"rhr":55.0,"sleep_score":null,"sleep_duration_hrs":null,"water_percent":59.8,"refeed":false,"notes":"","bf_lbs":40.5,"lean_percent":76.3,"residual":7.58,"integrity_status":"red"},{"date":"2025-10-31","weight":205.0,"bf_percent":19.7,"lean_lbs":154.2,"calories":1290.0,"protein":147.0,"fat":59.0,"carbs":35.0,"steps":9519.0,"rhr":54.0,"sleep_score":86.0,"sleep_duration_hrs":10.38,"water_percent":58.8,"refeed":false,"notes":"","bf_lbs":40.4,"lean_percent":75.2,"residual":10.42,"integrity_status":"green"},{"date":"2025-11-01","weight":204.4,"bf_percent":19.7,"lean_lbs":154.2,"calories":1735.0,"protein":146.0,"fat":41.0,"carbs":31.0,"steps":5231.0,"rhr":52.0,"sleep_score":66.0,"sleep_duration_hrs":7.0,"water_percent":59.3,"refeed":false,"notes":"","bf_lbs":40.3,"lean_percent":75.4,"residual":9.93,"integrity_status":"green"},{"date":"2025-11-02","weight":203.8,"bf_percent":19.5,"lean_lbs":154.3,"calories":1436.0,"protein":134.0,"fat":76.0,"carbs":29.0,"steps":2859.0,"rhr":51.0,"sleep_score":91.0,"sleep_duration_hrs":8.1,"water_percent":59.7,"refeed":false,"notes":"","bf_lbs":39.7,"lean_percent":75.7,"residual":9.76,"integrity_status":"green"},{"date":"2025-11-03","weight":204.0,"bf_percent":19.3,"lean_lbs":154.4,"calories":1981.0,"protein":207.0,"fat":76.0,"carbs":35.0,"steps":9321.0,"rhr":55.0,"sleep_score":67.0,"sleep_duration_hrs":7.53,"water_percent":59.8,"refeed":false,"notes":"","bf_lbs":39.4,"lean_percent":75.7,"residual":10.23,"integrity_status":"green"},{"date":"2025-11-04","weight":203.9,"bf_percent":19.2,"lean_lbs":154.4,"calories":1660.0,"protein":131.0,"fat":48.0,"carbs":50.0,"steps":7202.0,"rhr":54.0,"sleep_score":73.0,"sleep_duration_hrs":6.65,"water_percent":59.5,"refeed":false,"notes":"","bf_lbs":39.1,"lean_percent":75.7,"residual":10.35,"integrity_status":"green"},{"date":"2025-11-05","weight":200.8,"bf_percent":19.5,"lean_lbs":153.8,"calories":1525.0,"protein":161.0,"fat":85.0,"carbs":20.0,"steps":5753.0,"rhr":52.0,"sleep_score":87.0,"sleep_duration_hrs":9.1,"water_percent":59.1,"refeed":false,"notes":"","bf_lbs":39.2,"lean_percent":76.6,"residual":7.84,"integrity_status":"red"},{"date":"2025-11-06","weight":200.6,"bf_percent":19.6,"lean_lbs":153.3,"calories":1492.0,"protein":141.0,"fat":82.0,"carbs":39.0,"steps":10762.0,"rhr":50.0,"sleep_score":76.0,"sleep_duration_hrs":9.03,"water_percent":58.8,"refeed":false,"notes":"","bf_lbs":39.3,"lean_percent":76.4,"residual":7.98,"integrity_status":"red"},{"date":"2025-11-07","weight":200.2,"bf_percent":19.4,"lean_lbs":153.2,"calories":1724.0,"protein":179.0,"fat":71.0,"carbs":83.0,"steps":11448.0,"rhr":52.0,"sleep_score":65.0,"sleep_duration_hrs":6.48,"water_percent":60.0,"refeed":false,"notes":"","bf_lbs":38.8,"lean_percent":76.5,"residual":8.16,"integrity_status":"red"},{"date":"2025-11-08","weight":201.1,"bf_percent":19.1,"lean_lbs":153.3,"calories":2465.0,"protein":180.0,"fat":82.0,"carbs":197.0,"steps":4149.0,"rhr":49.0,"sleep_score":73.0,"sleep_duration_hrs":8.67,"water_percent":60.2,"refeed":true,"notes":"","bf_lbs":38.4,"lean_percent":76.2,"residual":9.39,"integrity_status":"green"},{"date":"2025-11-09","weight":202.8,"bf_percent":18.6,"lean_lbs":153.8,"calories":1710.0,"protein":203.0,"fat":57.0,"carbs":81.0,"steps":4673.0,"rhr":48.0,"sleep_score":85.0,"sleep_duration_hrs":7.17,"water_percent":61.0,"refeed":false,"notes":"","bf_lbs":37.7,"lean_percent":75.8,"residual":11.28,"integrity_status":"yellow"},{"date":"2025-11-10","weight":201.8,"bf_percent":18.4,"lean_lbs":154.2,"calories":1908.0,"protein":203.0,"fat":68.0,"carbs":100.0,"steps":7444.0,"rhr":51.0,"sleep_score":78.0,"sleep_duration_hrs":9.0,"water_percent":61.1,"refeed":false,"notes":"","bf_lbs":37.1,"lean_percent":76.4,"residual":10.47,"integrity_status":"green"},{"date":"2025-11-11","weight":200.3,"bf_percent":18.3,"lean_lbs":154.4,"calories":1199.0,"protein":150.0,"fat":26.0,"carbs":65.0,"steps":2327.0,"rhr":45.0,"sleep_score":56.0,"sleep_duration_hrs":4.88,"water_percent":61.1,"refeed":false,"notes":"","bf_lbs":36.6,"lean_percent":77.1,"residual":9.25,"integrity_status":"green"},{"date":"2025-11-12","weight":199.1,"bf_percent":18.3,"lean_lbs":154.2,"calories":1210.0,"protein":101.0,"fat":72.0,"carbs":28.0,"steps":3724.0,"rhr":46.0,"sleep_score":76.0,"sleep_duration_hrs":9.7,"water_percent":60.2,"refeed":false,"notes":"","bf_lbs":36.4,"lean_percent":77.5,"residual":8.46,"integrity_status":"yellow"},{"date":"2025-11-13","weight":199.5,"bf_percent":18.3,"lean_lbs":153.7,"calories":1756.0,"protein":133.0,"fat":112.0,"carbs":39.0,"steps":10266.0,"rhr":48.0,"sleep_score":83.0,"sleep_duration_hrs":8.78,"water_percent":59.6,"refeed":false,"notes":"","bf_lbs":36.5,"lean_percent":77.0,"residual":9.29,"integrity_status":"green"},{"date":"2025-11-14","weight":197.5,"bf_percent":18.4,"lean_lbs":153.5,"calories":2583.0,"protein":202.0,"fat":51.0,"carbs":270.0,"steps":6214.0,"rhr":47.0,"sleep_score":81.0,"sleep_duration_hrs":8.53,"water_percent":60.5,"refeed":true,"notes":"","bf_lbs":36.3,"lean_percent":77.7,"residual":7.66,"integrity_status":"red"},{"date":"2025-11-15","weight":199.1,"bf_percent":18.0,"lean_lbs":153.6,"calories":1960.0,"protein":219.0,"fat":84.0,"carbs":75.0,"steps":4173.0,"rhr":55.0,"sleep_score":62.0,"sleep_duration_hrs":6.62,"water_percent":61.0,"refeed":false,"notes":"","bf_lbs":35.8,"lean_percent":77.2,"residual":9.66,"integrity_status":"green"},{"date":"2025-11-16","weight":199.6,"bf_percent":17.8,"lean_lbs":153.8,"calories":1502.0,"protein":156.0,"fat":30.0,"carbs":128.0,"steps":4655.0,"rhr":54.0,"sleep_score":60.0,"sleep_duration_hrs":7.1,"water_percent":61.2,"refeed":false,"notes":"","bf_lbs":35.5,"lean_percent":77.0,"residual":10.27,"integrity_status":"green"},{"date":"2025-11-17","weight":198.3,"bf_percent":17.7,"lean_lbs":153.8,"calories":2165.0,"protein":207.0,"fat":127.0,"carbs":32.0,"steps":12478.0,"rhr":52.0,"sleep_score":67.0,"sleep_duration_hrs":8.88,"water_percent":61.0,"refeed":true,"notes":"","bf_lbs":35.1,"lean_percent":77.6,"residual":9.4,"integrity_status":"green"},{"date":"2025-11-18","weight":199.8,"bf_percent":17.8,"lean_lbs":153.4,"calories":1718.0,"protein":163.0,"fat":103.0,"carbs":26.0,"steps":4852.0,"rhr":50.0,"sleep_score":71.0,"sleep_duration_hrs":7.05,"water_percent":59.1,"refeed":false,"notes":"","bf_lbs":35.6,"lean_percent":76.8,"residual":10.84,"integrity_status":"green"},{"date":"2025-11-19","weight":199.8,"bf_percent":17.5,"lean_lbs":153.9,"calories":1715.0,"protein":169.0,"fat":60.0,"carbs":61.0,"steps":10165.0,"rhr":57.0,"sleep_score":null,"sleep_duration_hrs":null,"water_percent":61.9,"refeed":false,"notes":"","bf_lbs":35.0,"lean_percent":77.0,"residual":10.94,"integrity_status":"green"},{"date":"2025-11-20","weight":197.9,"bf_percent":17.2,"lean_lbs":154.4,"calories":2008.0,"protein":195.0,"fat":105.0,"carbs":50.0,"steps":4982.0,"rhr":54.0,"sleep_score":63.0,"sleep_duration_hrs":8.33,"water_percent":62.8,"refeed":true,"notes":"","bf_lbs":34.0,"lean_percent":78.0,"residual":9.46,"integrity_status":"green"},{"date":"2025-11-21","weight":197.2,"bf_percent":16.9,"lean_lbs":154.7,"calories":1275.0,"protein":207.0,"fat":48.0,"carbs":17.0,"steps":6988.0,"rhr":54.0,"sleep_score":85.0,"sleep_duration_hrs":9.3,"water_percent":62.4,"refeed":false,"notes":"","bf_lbs":33.3,"lean_percent":78.5,"residual":9.17,"integrity_status":"yellow"},{"date":"2025-11-22","weight":198.4,"bf_percent":16.4,"lean_lbs":155.3,"calories":1835.0,"protein":229.0,"fat":48.0,"carbs":114.0,"steps":4021.0,"rhr":48.0,"sleep_score":null,"sleep_duration_hrs":null,"water_percent":62.4,"refeed":false,"notes":"","bf_lbs":32.5,"lean_percent":78.3,"residual":10.56,"integrity_status":"green"},{"date":"2025-11-23","weight":200.2,"bf_percent":16.0,"lean_lbs":155.9,"calories":1501.0,"protein":132.0,"fat":37.0,"carbs":146.0,"steps":5803.0,"rhr":51.0,"sleep_score":72.0,"sleep_duration_hrs":7.35,"water_percent":62.8,"refeed":false,"notes":"","bf_lbs":32.0,"lean_percent":77.9,"residual":12.27,"integrity_status":"red"},{"date":"2025-11-24","weight":196.7,"bf_percent":16.6,"lean_lbs":154.9,"calories":1654.0,"protein":158.0,"fat":98.0,"carbs":21.0,"steps":7179.0,"rhr":49.0,"sleep_score":88.0,"sleep_duration_hrs":10.03,"water_percent":59.3,"refeed":false,"notes":"","bf_lbs":32.6,"lean_percent":78.8,"residual":9.15,"integrity_status":"yellow"},{"date":"2025-11-25","weight":199.7,"bf_percent":16.5,"lean_lbs":154.7,"calories":1431.0,"protein":110.0,"fat":23.0,"carbs":188.0,"steps":9946.0,"rhr":50.0,"sleep_score":76.0,"sleep_duration_hrs":7.98,"water_percent":60.6,"refeed":false,"notes":"","bf_lbs":33.0,"lean_percent":77.5,"residual":12.05,"integrity_status":"yellow"},{"date":"2025-11-26","weight":200.2,"bf_percent":16.5,"lean_lbs":154.8,"calories":1325.0,"protein":195.0,"fat":47.0,"carbs":25.0,"steps":10712.0,"rhr":48.0,"sleep_score":67.0,"sleep_duration_hrs":7.82,"water_percent":60.9,"refeed":false,"notes":"","bf_lbs":33.0,"lean_percent":77.3,"residual":12.37,"integrity_status":"red"},{"date":"2025-11-27","weight":196.0,"bf_percent":16.9,"lean_lbs":154.3,"calories":null,"protein":null,"fat":null,"carbs":null,"steps":7392.0,"rhr":49.0,"sleep_score":null,"sleep_duration_hrs":10.3,"water_percent":60.7,"refeed":true,"notes":"Thanksgiving","bf_lbs":33.1,"lean_percent":78.7,"residual":8.58,"integrity_status":"yellow"},{"date":"2025-11-28","weight":200.1,"bf_percent":16.4,"lean_lbs":154.7,"calories":967.0,"protein":133.0,"fat":40.0,"carbs":13.0,"steps":7310.0,"rhr":53.0,"sleep_score":78.0,"sleep_duration_hrs":10.3,"water_percent":61.8,"refeed":false,"notes":"","bf_lbs":32.8,"lean_percent":77.3,"residual":12.58,"integrity_status":"red"},{"date":"2025-11-29","weight":196.2,"bf_percent":16.7,"lean_lbs":154.6,"calories":1907.0,"protein":247.0,"fat":75.0,"carbs":84.0,"steps":4914.0,"rhr":50.0,"sleep_score":85.0,"sleep_duration_hrs":7.55,"water_percent":61.6,"refeed":false,"notes":"","bf_lbs":32.8,"lean_percent":78.8,"residual":8.83,"integrity_status":"yellow"},{"date":"2025-11-30","weight":196.3,"bf_percent":16.7,"lean_lbs":154.2,"calories":1410.0,"protein":206.0,"fat":46.0,"carbs":47.0,"steps":3947.0,"rhr":49.0,"sleep_score":89.0,"sleep_duration_hrs":7.63,"water_percent":60.8,"refeed":false,"notes":"","bf_lbs":32.8,"lean_percent":78.5,"residual":9.32,"integrity_status":"green"},{"date":"2025-12-01","weight":192.6,"bf_percent":16.7,"lean_lbs":154.0,"calories":1105.0,"protein":182.0,"fat":27.0,"carbs":46.0,"steps":5540.0,"rhr":49.0,"sleep_score":84.0,"sleep_duration_hrs":12.1,"water_percent":62.5,"refeed":false,"notes":"","bf_lbs":32.2,"lean_percent":80.0,"residual":6.44,"integrity_status":"red"},{"date":"2025-12-02","weight":194.1,"bf_percent":16.4,"lean_lbs":153.9,"calories":1442.0,"protein":201.0,"fat":36.0,"carbs":94.0,"steps":10665.0,"rhr":49.0,"sleep_score":73.0,"sleep_duration_hrs":7.2,"water_percent":62.1,"refeed":false,"notes":"Starting today (Dec 2), all carb entries are Total Carbs (not Net Carbs).","bf_lbs":31.8,"lean_percent":79.3,"residual":8.37,"integrity_status":"yellow"},{"date":"2025-12-03","weight":192.5,"bf_percent":16.1,"lean_lbs":154.1,"calories":1522.0,"protein":195.0,"fat":66.0,"carbs":45.0,"steps":6742.0,"rhr":51.0,"sleep_score":81.0,"sleep_duration_hrs":8.72,"water_percent":63.5,"refeed":false,"notes":"","bf_lbs":31.0,"lean_percent":80.0,"residual":7.41,"integrity_status":"red"},{"date":"2025-12-04","weight":192.9,"bf_percent":16.1,"lean_lbs":152.8,"calories":1817.0,"protein":219.0,"fat":61.0,"carbs":118.0,"steps":3050.0,"rhr":49.0,"sleep_score":85.0,"sleep_duration_hrs":7.5,"water_percent":61.0,"refeed":false,"notes":"","bf_lbs":31.1,"lean_percent":79.2,"residual":9.04,"integrity_status":"yellow"},{"date":"2025-12-05","weight":195.2,"bf_percent":15.6,"lean_lbs":154.1,"calories":1525.0,"protein":136.0,"fat":81.0,"carbs":159.0,"steps":8607.0,"rhr":48.0,"sleep_score":90.0,"sleep_duration_hrs":7.99,"water_percent":63.6,"refeed":false,"notes":"Traveled back from Tampa. Ate dinner at friend's house. Had sour dough bread and a cream of chicken dish. Difficult to accurately track nutrition.","bf_lbs":30.4,"lean_percent":78.9,"residual":10.65,"integrity_status":"green"},{"date":"2025-12-06","weight":194.4,"bf_percent":15.7,"lean_lbs":153.7,"calories":1837.0,"protein":168.0,"fat":81.0,"carbs":122.0,"steps":2662.0,"rhr":49.0,"sleep_score":85.0,"sleep_duration_hrs":8.27,"water_percent":61.2,"refeed":false,"notes":"Ate at a friends but had 2 helpings of instant mashed potatoes and had cheese when I came home. Picked a little and probably had a half of a potato skin w/cheese.","bf_lbs":30.5,"lean_percent":79.1,"residual":10.18,"integrity_status":"green"},{"date":"2025-12-07","weight":195.3,"bf_percent":15.5,"lean_lbs":153.9,"calories":1776.0,"protein":198.0,"fat":61.0,"carbs":118.0,"steps":5230.0,"rhr":53.0,"sleep_score":null,"sleep_duration_hrs":8.25,"water_percent":62.4,"refeed":false,"notes":"Diet was atrocious. Had crackers and dip around lunch time. Cleaned diet up in the afternoon and went to the gym and put in 1500 ropes to lessen the negative impact.","bf_lbs":30.3,"lean_percent":78.8,"residual":11.13,"integrity_status":"green"},{"date":"2025-12-08","weight":193.2,"bf_percent":16.2,"lean_lbs":152.8,"calories":1768.0,"protein":198.0,"fat":67.0,"carbs":114.0,"steps":7734.0,"rhr":47.0,"sleep_score":86.0,"sleep_duration_hrs":8.1,"water_percent":59.2,"refeed":false,"notes":"","bf_lbs":31.3,"lean_percent":79.1,"residual":9.1,"integrity_status":"yellow"},{"date":"2025-12-09","weight":193.2,"bf_percent":16.2,"lean_lbs":152.5,"calories":1330.0,"protein":185.0,"fat":36.0,"carbs":47.0,"steps":6809.0,"rhr":47.0,"sleep_score":78.0,"sleep_duration_hrs":6.62,"water_percent":61.3,"refeed":false,"notes":"","bf_lbs":31.3,"lean_percent":78.9,"residual":9.4,"integrity_status":"green"},{"date":"2025-12-10","weight":196.7,"bf_percent":16.1,"lean_lbs":152.3,"calories":1465.0,"protein":213.0,"fat":47.0,"carbs":48.0,"steps":9408.0,"rhr":47.0,"sleep_score":72.0,"sleep_duration_hrs":7.37,"water_percent":60.5,"refeed":false,"notes":"","bf_lbs":31.7,"lean_percent":77.4,"residual":12.73,"integrity_status":"red"},{"date":"2025-12-11","weight":192.5,"bf_percent":16.2,"lean_lbs":152.4,"calories":1604.0,"protein":194.0,"fat":66.0,"carbs":55.0,"steps":2821.0,"rhr":47.0,"sleep_score":90.0,"sleep_duration_hrs":9.48,"water_percent":62.5,"refeed":false,"notes":"","bf_lbs":31.2,"lean_percent":79.2,"residual":8.91,"integrity_status":"yellow"},{"date":"2025-12-12","weight":193.2,"bf_percent":16.2,"lean_lbs":152.1,"calories":1571.0,"protein":193.0,"fat":66.0,"carbs":59.0,"steps":4484.0,"rhr":52.0,"sleep_score":83.0,"sleep_duration_hrs":7.72,"water_percent":62.4,"refeed":false,"notes":"","bf_lbs":31.3,"lean_percent":78.7,"residual":9.8,"integrity_status":"green"},{"date":"2025-12-13","weight":193.8,"bf_percent":16.0,"lean_lbs":152.2,"calories":3097.0,"protein":224.0,"fat":138.0,"carbs":238.0,"steps":3626.0,"rhr":44.0,"sleep_score":82.0,"sleep_duration_hrs":6.43,"water_percent":61.9,"refeed":true,"notes":"","bf_lbs":31.0,"lean_percent":78.5,"residual":10.59,"integrity_status":"green"},{"date":"2025-12-14","weight":197.3,"bf_percent":15.5,"lean_lbs":152.9,"calories":1630.0,"protein":205.0,"fat":21.0,"carbs":178.0,"steps":5949.0,"rhr":47.0,"sleep_score":59.0,"sleep_duration_hrs":6.78,"water_percent":62.9,"refeed":false,"notes":"","bf_lbs":30.6,"lean_percent":77.5,"residual":13.82,"integrity_status":"red"},{"date":"2025-12-15","weight":194.1,"bf_percent":15.6,"lean_lbs":153.1,"calories":1533.0,"protein":211.0,"fat":56.0,"carbs":52.0,"steps":11492.0,"rhr":48.0,"sleep_score":84.0,"sleep_duration_hrs":7.92,"water_percent":62.4,"refeed":false,"notes":"","bf_lbs":30.3,"lean_percent":78.9,"residual":10.72,"integrity_status":"green"},{"date":"2025-12-16","weight":191.0,"bf_percent":15.8,"lean_lbs":152.8,"calories":1920.0,"protein":214.0,"fat":92.0,"carbs":60.0,"steps":6875.0,"rhr":49.0,"sleep_score":83.0,"sleep_duration_hrs":7.42,"water_percent":62.1,"refeed":false,"notes":"","bf_lbs":30.2,"lean_percent":80.0,"residual":8.02,"integrity_status":"red"},{"date":"2025-12-17","weight":191.4,"bf_percent":15.7,"lean_lbs":152.6,"calories":1650.0,"protein":247.0,"fat":40.0,"carbs":105.0,"steps":7391.0,"rhr":45.0,"sleep_score":87.0,"sleep_duration_hrs":9.95,"water_percent":62.2,"refeed":false,"notes":"","bf_lbs":30.1,"lean_percent":79.7,"residual":8.75,"integrity_status":"yellow"},{"date":"2025-12-18","weight":190.9,"bf_percent":15.6,"lean_lbs":152.4,"calories":null,"protein":null,"fat":null,"carbs":null,"steps":null,"rhr":50.0,"sleep_score":75.0,"sleep_duration_hrs":6.7,"water_percent":62.4,"refeed":false,"notes":"","bf_lbs":29.8,"lean_percent":79.8,"residual":8.72,"integrity_status":"yellow"},{"date":"2025-12-19","weight":191.3,"bf_percent":15.3,"lean_lbs":152.6,"calories":1628,"protein":208,"fat":70,"carbs":47,"steps":7716,"rhr":49,"sleep_score":94,"sleep_duration_hrs":8.3,"water_percent":null,"refeed":null,"notes":null,"bf_lbs":29.3,"lean_percent":79.8,"residual":9.4,"integrity_status":"building"},{"date":"2025-12-20","weight":194.2,"bf_percent":14.9,"lean_lbs":153.0,"calories":1956,"protein":207,"fat":49,"carbs":178,"steps":4541,"rhr":46,"sleep_score":88,"sleep_duration_hrs":8.0,"water_percent":null,"refeed":null,"notes":null,"bf_lbs":28.9,"lean_percent":78.8,"residual":12.3,"integrity_status":"building"},{"date":"2025-12-21","weight":192.9,"bf_percent":14.8,"lean_lbs":153.4,"calories":1557,"protein":241,"fat":52,"carbs":61,"steps":5602,"rhr":47,"sleep_score":68,"sleep_duration_hrs":8.9,"water_percent":null,"refeed":null,"notes":null,"bf_lbs":28.6,"lean_percent":79.5,"residual":10.9,"integrity_status":"building"},{"date":"2025-12-22","weight":191.6,"bf_percent":14.7,"lean_lbs":153.5,"calories":null,"protein":null,"fat":null,"carbs":null,"steps":null,"rhr":47,"sleep_score":69,"sleep_duration_hrs":5.3,"water_percent":null,"refeed":null,"notes":"Sleep hours seem low because I fell asleep at 1 but the app says 3:04. Not sure why.","bf_lbs":28.2,"lean_percent":80.1,"residual":9.9,"integrity_status":"building"}];

        // ===== INTEGRITY VALIDATION FUNCTIONS =====
        
        function computeDerivedFields(weight, bfPercent, leanMass) {
            if (!isFinite(weight) || !isFinite(bfPercent) || !isFinite(leanMass)) {
                return null;
            }
            
            const bfLbs = weight * (bfPercent / 100);
            const leanPercent = (leanMass / weight) * 100;
            const residual = weight - bfLbs - leanMass;
            
            return {
                bf_lbs: parseFloat(bfLbs.toFixed(2)),
                lean_percent: parseFloat(leanPercent.toFixed(2)),
                residual: parseFloat(residual.toFixed(2))
            };
        }
        
        function validateEntry(weight, bfPercent, leanMass) {
            // Sanity checks
            const errors = [];
            
            if (!isFinite(weight) || !isFinite(bfPercent) || !isFinite(leanMass)) {
                return { status: 'gray', message: 'Missing required fields', errors: ['Enter weight, body fat %, and lean mass'] };
            }
            
            if (weight <= 50 || weight >= 500) errors.push('Weight looks out of range (50-500 lbs)');
            if (bfPercent <= 2 || bfPercent >= 70) errors.push('Body fat % looks out of range (2-70%)');
            if (leanMass <= 50 || leanMass >= weight) errors.push('Lean mass must be less than weight and plausible');
            
            const derived = computeDerivedFields(weight, bfPercent, leanMass);
            if (!derived) {
                errors.push('Unable to compute derived fields');
                return { status: 'red', message: 'Validation failed', errors, derived: null };
            }
            
            if (derived.bf_lbs < 0 || derived.bf_lbs > weight) errors.push('Computed body fat lbs out of range');
            if (derived.lean_percent < 30 || derived.lean_percent > 95) errors.push('Computed lean % out of range (30-95%)');
            if (derived.residual < -5 || derived.residual > 80) errors.push('Residual out of plausible range');
            
            if (errors.length > 0) {
                return { status: 'red', message: errors[0], errors, derived };
            }
            
            return { status: 'valid', message: 'Entry passes sanity checks', errors: [], derived };
        }
        
        function computeIntegrityStatus(weight, bfPercent, leanMass) {
            const validation = validateEntry(weight, bfPercent, leanMass);
            
            if (validation.status === 'red' || validation.status === 'gray') {
                return validation;
            }
            
            // Get historical residuals for baseline
            const validEntries = bodyData.filter(e => 
                isFinite(e.weight) && isFinite(e.bf_percent) && isFinite(e.lean_lbs) && e.residual !== undefined
            ).sort((a, b) => a.date.localeCompare(b.date));
            
            const recent = validEntries.slice(-INTEGRITY_CONFIG.baselineWindow);
            
            if (recent.length < 7) {
                return {
                    status: 'blue',
                    message: 'Building baseline (need 7+ entries)',
                    errors: [],
                    derived: validation.derived,
                    baselineCount: recent.length
                };
            }
            
            const residuals = recent.map(e => e.residual);
            const baselineMean = residuals.reduce((sum, r) => sum + r, 0) / residuals.length;
            const residualDelta = Math.abs(validation.derived.residual - baselineMean);
            
            if (residualDelta <= INTEGRITY_CONFIG.greenThreshold) {
                return {
                    status: 'green',
                    message: 'Good - Values align with baseline',
                    errors: [],
                    derived: validation.derived,
                    baselineMean,
                    residualDelta
                };
            } else if (residualDelta <= INTEGRITY_CONFIG.yellowThreshold) {
                return {
                    status: 'yellow',
                    message: 'Warning - Slight variance detected',
                    errors: [],
                    derived: validation.derived,
                    baselineMean,
                    residualDelta
                };
            } else {
                return {
                    status: 'red',
                    message: `Check data - Residual shifted ${residualDelta.toFixed(1)} lbs from baseline`,
                    errors: ['Possible entry error - verify values from Hume app'],
                    derived: validation.derived,
                    baselineMean,
                    residualDelta
                };
            }
        }
        
        function createIntegrityBadge(status, message) {
            const badges = {
                green: { class: 'integrity-green', dot: 'dot-green', text: '‚úì Good' },
                yellow: { class: 'integrity-yellow', dot: 'dot-yellow', text: '‚ö† Warn' },
                red: { class: 'integrity-red', dot: 'dot-red', text: '‚úó Check' },
                blue: { class: 'integrity-blue', dot: 'dot-blue', text: '‚óã Build' },
                gray: { class: 'integrity-gray', dot: 'dot-gray', text: '‚Äî N/A' }
            };
            
            const badge = badges[status] || badges.gray;
            return `<span class="integrity-badge ${badge.class}" title="${message}">
                        <span class="integrity-dot ${badge.dot}"></span>
                        <span>${badge.text}</span>
                    </span>`;
        }

        // ===== DATA MANAGEMENT =====
        
        
        function migrateBodyDataV15(data) {
            if (!Array.isArray(data)) return [];
            return data.map(e => {
                const out = Object.assign({}, e);
                // v14 bulk CSV used water_percent; v14 table/export expected body_water_percent
                if (out.body_water_percent == null && out.water_percent != null) out.body_water_percent = out.water_percent;
                if (out.water_percent != null && out.body_water_percent != null) delete out.water_percent;
                // normalize numeric fields where possible
                const numFields = ['weight','bf_percent','bf_lbs','lean_lbs','lean_percent','calories','protein','fat','carbs','rhr','sleep_score','steps','sleep_duration_hrs','body_water_percent'];
                numFields.forEach(k=>{
                    if (out[k] === '' || out[k] === undefined) return;
                    if (out[k] != null && typeof out[k] === 'string' && out[k].trim() !== '' && !isNaN(out[k])) out[k] = Number(out[k]);
                });
                // ensure refeed boolean
                if (typeof out.refeed !== 'boolean') out.refeed = !!out.refeed;
                return out;
            });
        }

function loadData() {
            const stored = localStorage.getItem(STORAGE_KEY);
            if (stored) {
                bodyData = JSON.parse(stored);
                bodyData = migrateBodyDataV15(bodyData);
                console.log(`‚úÖ Loaded ${bodyData.length} entries from localStorage`);
            } else {
                // First time - load initial data
                bodyData = INITIAL_DATA.map(entry => {
                    const derived = computeDerivedFields(entry.weight, entry.bf_percent, entry.lean_lbs);
                    return {
                        ...entry,
                        bf_lbs: derived?.bf_lbs || (entry.weight * entry.bf_percent / 100),
                        lean_percent: derived?.lean_percent || ((entry.lean_lbs / entry.weight) * 100),
                        residual: derived?.residual || (entry.weight - (entry.weight * entry.bf_percent / 100) - entry.lean_lbs)
                    };
                });
                saveData();
                console.log(`‚úÖ Loaded ${bodyData.length} entries from INITIAL_DATA`);
            }
            
            // Recompute integrity for all entries
            bodyData = bodyData.map(entry => {
                const integrity = computeIntegrityStatus(entry.weight, entry.bf_percent, entry.lean_lbs);
                return {
                    ...entry,
                    integrity_status: integrity.status,
                    integrity_message: integrity.message
                };
            });
        }
        
        function saveData() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(bodyData));
        }
        
        function reloadData() {
            if (confirm('Reload original 48-day dataset? This will replace any new entries you added.')) {
                localStorage.removeItem(STORAGE_KEY);
                location.reload();
            }
        }
        
        // ===== UI UPDATE FUNCTIONS =====
        
        function updateStats() {
            if (bodyData.length === 0) {
                document.getElementById('headerStatus').textContent = 'No data yet - add your first entry!';
                return;
            }
            
            const sorted = bodyData.slice().sort((a, b) => a.date.localeCompare(b.date));
            const first = sorted[0];
            const latest = sorted[sorted.length - 1];
            
            const weightChange = latest.weight - first.weight;
            const bfChange = latest.bf_percent - first.bf_percent;
            const leanChange = latest.lean_lbs - first.lean_lbs;
            
            const fatLost = (first.weight * first.bf_percent / 100) - (latest.weight * latest.bf_percent / 100);
            
            document.getElementById('headerStatus').textContent = 
                `${bodyData.length} entries ‚Ä¢ ${first.date} to ${latest.date} ‚Ä¢ ` +
                `Weight: ${weightChange >= 0 ? '+' : ''}${weightChange.toFixed(1)} lbs ‚Ä¢ ` +
                `Fat Lost: ${fatLost.toFixed(1)} lbs`;
            
            document.getElementById('entryCount').textContent = bodyData.length;
            
            // Stats cards
            const statsHtml = `
                <div class="stat-card">
                    <div class="stat-label">Current Weight</div>
                    <div class="stat-value">${latest.weight.toFixed(1)}</div>
                    <div class="stat-change ${weightChange <= 0 ? 'positive' : 'negative'}">
                        ${weightChange >= 0 ? '+' : ''}${weightChange.toFixed(1)} lbs from start
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Body Fat %</div>
                    <div class="stat-value">${latest.bf_percent.toFixed(1)}%</div>
                    <div class="stat-change ${bfChange <= 0 ? 'positive' : 'negative'}">
                        ${bfChange >= 0 ? '+' : ''}${bfChange.toFixed(1)}% from start
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Fat Lost</div>
                    <div class="stat-value">${fatLost.toFixed(1)}</div>
                    <div class="stat-change positive">
                        lbs of pure fat
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Lean Mass</div>
                    <div class="stat-value">${latest.lean_lbs.toFixed(1)}</div>
                    <div class="stat-change ${leanChange >= 0 ? 'positive' : 'negative'}">
                        ${leanChange >= 0 ? '+' : ''}${leanChange.toFixed(1)} lbs from start
                    </div>
                </div>
            `;
            
            document.getElementById('statsGrid').innerHTML = statsHtml;
            
            // Goal projection
            updateGoalProjection(sorted, latest, fatLost);
            updateHealthStatsCard();
        }
        
        function updateGoalProjection(sorted, latest, fatLost) {
            const currentFatLbs = latest.weight * latest.bf_percent / 100;
            const targetFatLbs = GOALS.target_bf_lbs;
            const fatToLose = currentFatLbs - targetFatLbs;
            
            const days = sorted.length;
            const avgFatLossPerDay = days > 1 ? fatLost / days : 0;
            const daysToGoal = avgFatLossPerDay > 0 ? fatToLose / avgFatLossPerDay : 0;
            
            const goalDate = new Date(latest.date);
            goalDate.setDate(goalDate.getDate() + daysToGoal);
            
            const progress = Math.max(0, Math.min(100, (fatLost / (fatLost + fatToLose)) * 100));
            
            const goalHtml = `
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span style="font-family: 'Space Mono', monospace;">Current: ${currentFatLbs.toFixed(1)} lbs fat</span>
                        <span style="font-family: 'Space Mono', monospace;">Target: ${targetFatLbs.toFixed(1)} lbs fat</span>
                    </div>
                    <div style="background: var(--bg-tertiary); height: 30px; border-radius: 8px; overflow: hidden;">
                        <div style="background: linear-gradient(90deg, var(--accent-success), var(--accent-cyan)); height: 100%; width: ${progress}%; transition: width 0.5s ease;"></div>
                    </div>
                    <div style="text-align: center; margin-top: 10px; color: var(--text-secondary);">
                        ${progress.toFixed(1)}% to goal
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div>
                        <div style="color: var(--text-secondary); font-size: 0.85em;">Fat to Lose</div>
                        <div style="font-size: 1.5em; font-weight: 700; font-family: 'Space Mono', monospace;">${fatToLose.toFixed(1)} lbs</div>
                    </div>
                    <div>
                        <div style="color: var(--text-secondary); font-size: 0.85em;">Avg Loss Rate</div>
                        <div style="font-size: 1.5em; font-weight: 700; font-family: 'Space Mono', monospace;">${(avgFatLossPerDay * 7).toFixed(2)} lbs/week</div>
                    </div>
                    <div>
                        <div style="color: var(--text-secondary); font-size: 0.85em;">Estimated Goal Date</div>
                        <div style="font-size: 1.5em; font-weight: 700; font-family: 'Space Mono', monospace;">
                            ${daysToGoal > 0 ? goalDate.toLocaleDateString() : 'N/A'}
                        </div>
                    </div>
                    <div>
                        <div style="color: var(--text-secondary); font-size: 0.85em;">Days Remaining</div>
                        <div style="font-size: 1.5em; font-weight: 700; font-family: 'Space Mono', monospace;">
                            ${daysToGoal > 0 ? Math.ceil(daysToGoal) : 'N/A'}
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('goalContent').innerHTML = goalHtml;
        }
        
        function updateTable() {
            const tbody = document.getElementById('dataTable');
            tbody.innerHTML = '';
            
            const sorted = bodyData.slice().sort((a, b) => b.date.localeCompare(a.date));
            
            sorted.forEach((entry, idx) => {
                const row = document.createElement('tr');
                if (entry.refeed) row.classList.add('refeed-row');
                
                const integrityBadge = createIntegrityBadge(
                    entry.integrity_status || 'gray',
                    entry.integrity_message || 'No validation'
                );
                
                row.innerHTML = `
                    <td>${entry.date}</td>
                    <td>${integrityBadge}</td>
                    <td>${entry.weight?.toFixed(1) || ''}</td>
                    <td>${entry.bf_percent?.toFixed(1) || ''}%</td>
                    <td>${entry.bf_lbs?.toFixed(1) || ''}</td>
                    <td>${entry.lean_lbs?.toFixed(1) || ''}</td>
                    <td>${entry.lean_percent?.toFixed(1) || ''}%</td>
                    <td>${entry.body_water_percent?.toFixed(1) || ''}%</td>
                    <td>${entry.calories || ''}</td>
                    <td>${entry.protein || ''}</td>
                    <td>${entry.fat || ''}</td>
                    <td>${entry.carbs || ''}</td>
                    <td>${entry.steps || ''}</td>
                    <td>${entry.rhr || ''}</td>
                    <td>${entry.sleep_score || ''}</td>
                    <td>${entry.sleep_duration_hrs?.toFixed(1) || ''}</td>
                    <td>${computeQualityScore(entry)}%</td>
                    <td>${entry.refeed ? 'üî•' : ''}</td>
                    <td>
                        <div class="edit-actions">
                            <button class="danger" onclick="deleteEntry('${entry.date}')">√ó</button>
                        </div>
                    </td>
                `;
                
                row.onclick = (e) => {
                    if (!e.target.classList.contains('danger')) {
                        editEntry(entry.date);
                    }
                };
                
                tbody.appendChild(row);
            });
        }

        // ===== MODAL FUNCTIONS =====
        
        function showAddEntry() {
            document.getElementById('modalTitle').textContent = 'Add New Entry';
            document.getElementById('entryDate').value = new Date().toISOString().split('T')[0];
            clearForm();
            document.getElementById('addEntryModal').classList.add('show');
            updateModalDerivedFields();
        }
        
        function editEntry(date) {
            const entry = bodyData.find(e => e.date === date);
            if (!entry) return;
            
            document.getElementById('modalTitle').textContent = 'Edit Entry';
            document.getElementById('entryDate').value = entry.date;
            document.getElementById('entryWeight').value = entry.weight || '';
            document.getElementById('entryBfPercent').value = entry.bf_percent || '';
            document.getElementById('entryLeanLbs').value = entry.lean_lbs || '';
            document.getElementById('entryCalories').value = entry.calories || '';
            document.getElementById('entryProtein').value = entry.protein || '';
            document.getElementById('entryFat').value = entry.fat || '';
            document.getElementById('entryCarbs').value = entry.carbs || '';
            document.getElementById('entrySteps').value = entry.steps || '';
            document.getElementById('entryRhr').value = entry.rhr || '';
            document.getElementById('entrySleepScore').value = entry.sleep_score || '';
            document.getElementById('entrySleepHours').value = entry.sleep_duration_hrs || '';
            document.getElementById('entryBodyWater').value = entry.body_water_percent || '';
            document.getElementById('entryRefeed').checked = entry.refeed || false;
            document.getElementById('entryNotes').value = entry.notes || '';
            
            updateModalDerivedFields();
            document.getElementById('addEntryModal').classList.add('show');
        }
        
        function hideModal() {
            document.getElementById('addEntryModal').classList.remove('show');
            clearForm();
        }
        
        function clearForm() {
            document.getElementById('entryWeight').value = '';
            document.getElementById('entryBfPercent').value = '';
            document.getElementById('entryLeanLbs').value = '';
            document.getElementById('entryCalories').value = '';
            document.getElementById('entryProtein').value = '';
            document.getElementById('entryFat').value = '';
            document.getElementById('entryCarbs').value = '';
            document.getElementById('entrySteps').value = '';
            document.getElementById('entryRhr').value = '';
            document.getElementById('entrySleepScore').value = '';
            document.getElementById('entrySleepHours').value = '';
            document.getElementById('entryBodyWater').value = '';
            document.getElementById('entryRefeed').checked = false;
            document.getElementById('entryNotes').value = '';
            updateModalDerivedFields();
        }
        
        function updateModalDerivedFields() {
            const weight = parseFloat(document.getElementById('entryWeight').value);
            const bfPercent = parseFloat(document.getElementById('entryBfPercent').value);
            const leanLbs = parseFloat(document.getElementById('entryLeanLbs').value);
            
            const derived = computeDerivedFields(weight, bfPercent, leanLbs);
            
            if (derived) {
                document.getElementById('entryBfLbsAuto').value = derived.bf_lbs.toFixed(1);
                document.getElementById('entryLeanPercentAuto').value = derived.lean_percent.toFixed(1) + '%';
                document.getElementById('entryResidualAuto').value = derived.residual.toFixed(2);
            } else {
                document.getElementById('entryBfLbsAuto').value = '';
                document.getElementById('entryLeanPercentAuto').value = '';
                document.getElementById('entryResidualAuto').value = '';
            }
            
            // Update integrity status in modal
            const integrity = computeIntegrityStatus(weight, bfPercent, leanLbs);
            const statusDiv = document.getElementById('modalIntegrityStatus');
            
            if (integrity.status === 'gray') {
                statusDiv.innerHTML = '';
            } else {
                const badge = createIntegrityBadge(integrity.status, integrity.message);
                let details = `<p style="margin: 5px 0; font-size: 0.9em; color: var(--text-secondary);">${integrity.message}</p>`;
                
                if (integrity.residualDelta !== undefined) {
                    details += `<p style="margin: 5px 0; font-size: 0.85em; font-family: 'Space Mono', monospace; color: var(--text-secondary);">
                        Residual: ${integrity.derived.residual.toFixed(2)} lbs | 
                        Baseline: ${integrity.baselineMean?.toFixed(2) || 'N/A'} lbs | 
                        Delta: ${integrity.residualDelta.toFixed(2)} lbs
                    </p>`;
                }
                
                statusDiv.innerHTML = `
                    <div style="background: rgba(6, 182, 212, 0.05); border: 1px solid var(--border); padding: 15px; border-radius: 8px;">
                        <div style="margin-bottom: 8px;">${badge}</div>
                        ${details}
                    </div>
                `;
            }
        }
        
        // Auto-update when user types
        ['entryWeight', 'entryBfPercent', 'entryLeanLbs'].forEach(id => {
            document.addEventListener('DOMContentLoaded', () => {
                document.getElementById(id)?.addEventListener('input', updateModalDerivedFields);
            });
        });
        
        function saveEntry() {
            const date = document.getElementById('entryDate').value;
            const weight = parseFloat(document.getElementById('entryWeight').value);
            const bf_percent = parseFloat(document.getElementById('entryBfPercent').value);
            const lean_lbs = parseFloat(document.getElementById('entryLeanLbs').value);
            
            if (!date || !isFinite(weight) || !isFinite(bf_percent) || !isFinite(lean_lbs)) {
                showToast('Please fill in required fields: Date, Weight, BF%, Lean Mass', true);
                return;
            }
            
            // Validate integrity
            const integrity = computeIntegrityStatus(weight, bf_percent, lean_lbs);
            
            // Show warning for yellow or red status
            if (integrity.status === 'red') {
                const confirm = window.confirm(
                    `‚ö†Ô∏è DATA INTEGRITY WARNING\n\n` +
                    `${integrity.message}\n\n` +
                    `${integrity.errors.join('\n')}\n\n` +
                    `This may indicate a data entry error.\n` +
                    `Please double-check your values from the Hume app.\n\n` +
                    `Save anyway?`
                );
                if (!confirm) return;
            } else if (integrity.status === 'yellow') {
                const confirm = window.confirm(
                    `‚ö†Ô∏è Slight Variance Detected\n\n` +
                    `${integrity.message}\n\n` +
                    `Residual: ${integrity.derived.residual.toFixed(2)} lbs\n` +
                    `Baseline: ${integrity.baselineMean.toFixed(2)} lbs\n` +
                    `Delta: ${integrity.residualDelta.toFixed(2)} lbs\n\n` +
                    `This is usually normal day-to-day variance.\n` +
                    `Continue saving?`
                );
                if (!confirm) return;
            }
            
            const entry = {
                date,
                weight,
                bf_percent,
                lean_lbs,
                bf_lbs: integrity.derived.bf_lbs,
                lean_percent: integrity.derived.lean_percent,
                residual: integrity.derived.residual,
                calories: parseFloat(document.getElementById('entryCalories').value) || null,
                protein: parseFloat(document.getElementById('entryProtein').value) || null,
                fat: parseFloat(document.getElementById('entryFat').value) || null,
                carbs: parseFloat(document.getElementById('entryCarbs').value) || null,
                steps: parseFloat(document.getElementById('entrySteps').value) || null,
                rhr: parseFloat(document.getElementById('entryRhr').value) || null,
                sleep_score: parseFloat(document.getElementById('entrySleepScore').value) || null,
                sleep_duration_hrs: parseFloat(document.getElementById('entrySleepHours').value) || null,
                body_water_percent: parseFloat(document.getElementById('entryBodyWater').value) || null,
                refeed: document.getElementById('entryRefeed').checked,
                notes: document.getElementById('entryNotes').value,
                integrity_status: integrity.status,
                integrity_message: integrity.message
            };
            
            // Remove existing entry with same date
            bodyData = bodyData.filter(e => e.date !== date);
            bodyData.push(entry);
            bodyData.sort((a, b) => a.date.localeCompare(b.date));
            
            saveData();
            updateStats();
            updateTable();
            updateChart();
            // Mobile helpers
            if (window.innerWidth <= 768) { const qb=document.getElementById('quickAddBar'); if(qb) qb.style.display='block'; }
            if (typeof enableSwipeNav==='function') enableSwipeNav();
            if (typeof updateProgressiveTabV13==='function') updateProgressiveTabV13();
            hideModal();
            
            showToast(`Entry saved for ${date}\nIntegrity: ${integrity.message}`);
        }
        
        function deleteEntry(date) {
            if (!confirm(`Delete entry for ${date}?`)) return;
            
            bodyData = bodyData.filter(e => e.date !== date);
            saveData();
            updateStats();
            updateTable();
            updateChart();
            showToast(`Deleted entry for ${date}`);
        }

        // ===== CHART FUNCTIONS =====
        
        function switchChart(chartType, el) {
            currentChartType = chartType;

            // Update active tab
            document.querySelectorAll('.chart-tab').forEach(tab => tab.classList.remove('active'));
            if (el && el.classList) {
                el.classList.add('active');
            } else {
                const map = {
                    fatVsLean: 'Fat vs Lean Breakdown',
                    weightTrend: 'Weight & BF% Trend',
                    rateOfChange: 'Daily Rate of Change',
                    nutrition: 'Nutrition Tracking',
                    waterOverlay: 'Body Water % Overlay'
                };
                const label = map[chartType];
                if (label) {
                    document.querySelectorAll('.chart-tab').forEach(tab => {
                        if ((tab.textContent || '').trim() === label) tab.classList.add('active');
                    });
                }
            }

            updateChart();
        }
        
        function updateChart() {
            if (!ensureChartJsOrWarn()) return;
            if (currentChart) {
                currentChart.destroy();
            }
            
            const sorted = bodyData.slice().sort((a, b) => a.date.localeCompare(b.date));
            
            if (sorted.length === 0) return;
            
            const ctx = document.getElementById('mainChart').getContext('2d');
            
            switch (currentChartType) {
                case 'fatVsLean':
                    currentChart = createFatVsLeanChart(ctx, sorted);
                    break;
                case 'weightTrend':
                    currentChart = createWeightTrendChart(ctx, sorted);
                    break;
                case 'rateOfChange':
                    currentChart = createRateOfChangeChart(ctx, sorted);
                    break;
                case 'nutrition':
                    currentChart = createNutritionChart(ctx, sorted);
                    break;
            
                case 'waterOverlay':
                    currentChart = createWaterOverlayChart(ctx, sorted);
                    break;
}
        }
        
        function createFatVsLeanChart(ctx, data) {
            return SafeChart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [
                        {
                            label: 'Fat Mass',
                            data: data.map(d => d.bf_lbs),
                            backgroundColor: 'rgba(239, 68, 68, 0.3)',
                            borderColor: 'rgba(239, 68, 68, 1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.3
                        },
                        {
                            label: 'Lean Mass',
                            data: data.map(d => d.lean_lbs),
                            backgroundColor: 'rgba(16, 185, 129, 0.3)',
                            borderColor: 'rgba(16, 185, 129, 1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Body Composition: Fat vs Lean Mass',
                            color: '#f1f5f9',
                            font: { size: 16 }
                        },
                        legend: {
                            labels: { color: '#f1f5f9' }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(51, 65, 85, 0.3)' }
                        },
                        y: {
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(51, 65, 85, 0.3)' },
                            title: {
                                display: true,
                                text: 'Mass (lbs)',
                                color: '#f1f5f9'
                            }
                        }
                    }
                }
            });
        }
        
        function createWeightTrendChart(ctx, data) {
            return SafeChart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [
                        {
                            label: 'Weight (lbs)',
                            data: data.map(d => d.weight),
                            backgroundColor: 'rgba(6, 182, 212, 0.1)',
                            borderColor: 'rgba(6, 182, 212, 1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.3,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Body Fat %',
                            data: data.map(d => d.bf_percent),
                            backgroundColor: 'rgba(139, 92, 246, 0.1)',
                            borderColor: 'rgba(139, 92, 246, 1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.3,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Weight & Body Fat % Trend',
                            color: '#f1f5f9',
                            font: { size: 16 }
                        },
                        legend: {
                            labels: { color: '#f1f5f9' }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(51, 65, 85, 0.3)' }
                        },
                        y: {
                            type: 'linear',
                            position: 'left',
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(51, 65, 85, 0.3)' },
                            title: {
                                display: true,
                                text: 'Weight (lbs)',
                                color: '#06b6d4'
                            }
                        },
                        y1: {
                            type: 'linear',
                            position: 'right',
                            ticks: { color: '#94a3b8' },
                            grid: { display: false },
                            title: {
                                display: true,
                                text: 'Body Fat %',
                                color: '#8b5cf6'
                            }
                        }
                    }
                }
            });
        }
        
        function createRateOfChangeChart(ctx, data) {
            const changes = data.slice(1).map((d, i) => ({
                date: d.date,
                weightChange: d.weight - data[i].weight,
                fatChange: d.bf_lbs - data[i].bf_lbs,
                leanChange: d.lean_lbs - data[i].lean_lbs
            }));
            
            return SafeChart(ctx, {
                type: 'bar',
                data: {
                    labels: changes.map(d => d.date),
                    datasets: [
                        {
                            label: 'Weight Œî',
                            data: changes.map(d => d.weightChange),
                            backgroundColor: 'rgba(6, 182, 212, 0.7)',
                            borderColor: 'rgba(6, 182, 212, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Fat Œî',
                            data: changes.map(d => d.fatChange),
                            backgroundColor: 'rgba(239, 68, 68, 0.7)',
                            borderColor: 'rgba(239, 68, 68, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Lean Œî',
                            data: changes.map(d => d.leanChange),
                            backgroundColor: 'rgba(16, 185, 129, 0.7)',
                            borderColor: 'rgba(16, 185, 129, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Daily Rate of Change',
                            color: '#f1f5f9',
                            font: { size: 16 }
                        },
                        legend: {
                            labels: { color: '#f1f5f9' }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(51, 65, 85, 0.3)' }
                        },
                        y: {
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(51, 65, 85, 0.3)' },
                            title: {
                                display: true,
                                text: 'Change (lbs)',
                                color: '#f1f5f9'
                            }
                        }
                    }
                }
            });
        }
        
        function createNutritionChart(ctx, data) {
            const withNutrition = data.filter(d => d.calories);
            
            return SafeChart(ctx, {
                type: 'line',
                data: {
                    labels: withNutrition.map(d => d.date),
                    datasets: [
                        {
                            label: 'Calories',
                            data: withNutrition.map(d => d.calories),
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            borderColor: 'rgba(245, 158, 11, 1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.3,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Protein (g)',
                            data: withNutrition.map(d => d.protein),
                            backgroundColor: 'rgba(6, 182, 212, 0.1)',
                            borderColor: 'rgba(6, 182, 212, 1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.3,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Nutrition Tracking',
                            color: '#f1f5f9',
                            font: { size: 16 }
                        },
                        legend: {
                            labels: { color: '#f1f5f9' }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(51, 65, 85, 0.3)' }
                        },
                        y: {
                            type: 'linear',
                            position: 'left',
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(51, 65, 85, 0.3)' },
                            title: {
                                display: true,
                                text: 'Calories',
                                color: '#f59e0b'
                            }
                        },
                        y1: {
                            type: 'linear',
                            position: 'right',
                            ticks: { color: '#94a3b8' },
                            grid: { display: false },
                            title: {
                                display: true,
                                text: 'Protein (g)',
                                color: '#06b6d4'
                            }
                        }
                    }
                }
            });
        }

        
        
        function createWaterOverlayChart(ctx, data) {
            const withWater = data.filter(d => d.body_water_percent != null && isFinite(d.body_water_percent));
            if (withWater.length < 2) {
                return createWeightTrendChart(ctx, data);
            }
            return SafeChart(ctx, {
                type: 'line',
                data: {
                    labels: withWater.map(d => d.date),
                    datasets: [
                        {
                            label: 'Weight (lbs)',
                            data: withWater.map(d => d.weight),
                            backgroundColor: 'rgba(6, 182, 212, 0.1)',
                            borderColor: 'rgba(6, 182, 212, 1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.3,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Body Water %',
                            data: withWater.map(d => d.body_water_percent),
                            backgroundColor: 'rgba(16, 185, 129, 0.08)',
                            borderColor: 'rgba(16, 185, 129, 1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.3,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Weight with Body Water % Overlay',
                            color: '#f1f5f9',
                            font: { size: 16 }
                        },
                        legend: {
                            labels: { color: '#f1f5f9' }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.dataset.label || '';
                                    const v = context.parsed.y;
                                    if (label.includes('%')) return `${label}: ${v.toFixed(1)}%`;
                                    return `${label}: ${v.toFixed(1)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(51, 65, 85, 0.3)' }
                        },
                        y: {
                            type: 'linear',
                            position: 'left',
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(51, 65, 85, 0.3)' },
                            title: {
                                display: true,
                                text: 'Weight (lbs)',
                                color: '#06b6d4'
                            }
                        },
                        y1: {
                            type: 'linear',
                            position: 'right',
                            ticks: { color: '#94a3b8' },
                            grid: { display: false },
                            title: {
                                display: true,
                                text: 'Body Water %',
                                color: '#10b981'
                            }
                        }
                    }
                }
            });
        }


        
        function computeQualityScore(entry) {
            // 100% = all optional fields present; penalize missing nutrition/activity/recovery metrics
            if (!entry) return 0;
            const fields = ['calories','protein','fat','carbs','steps','rhr','sleep_score','sleep_duration_hrs','water_percent'];
            let present = 0;
            fields.forEach(f=>{ if (isFinite(entry[f])) present++; });
            return Math.round((present / fields.length) * 100);
        }

// ===== EXPORT FUNCTIONS =====
        
        function exportCSV() {
            if (bodyData.length === 0) {
                showToast('No data to export', true);
                return;
            }
            
            const headers = [
                'Date', 'Weight', 'BF%', 'BF lbs', 'Lean lbs', 'Lean%', 'Residual',
                'Calories', 'Protein', 'Fat', 'Carbs', 'Steps', 'RHR', 
                'Sleep Score', 'Sleep Hrs', 'Water %', 'Refeed', 'Integrity', 'Notes'
            ];
            
            const rows = bodyData
                .slice()
                .sort((a, b) => a.date.localeCompare(b.date))
                .map(d => [
                    d.date,
                    d.weight?.toFixed(1) || '',
                    d.bf_percent?.toFixed(1) || '',
                    d.bf_lbs?.toFixed(1) || '',
                    d.lean_lbs?.toFixed(1) || '',
                    d.lean_percent?.toFixed(1) || '',
                    d.residual?.toFixed(2) || '',
                    d.calories || '',
                    d.protein || '',
                    d.fat || '',
                    d.carbs || '',
                    d.steps || '',
                    d.rhr || '',
                    d.sleep_score || '',
                    d.sleep_duration_hrs?.toFixed(2) || '',
                    d.body_water_percent?.toFixed(1) || '',
                    d.refeed ? 'Yes' : 'No',
                    d.integrity_status || '',
                    `"${(d.notes || '').replace(/"/g, '""')}"`
                ]);
            
            const csv = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `body-tracker-export-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            
            showToast('CSV exported successfully!');
        }
        
        function exportBackup() {
            if (bodyData.length === 0) {
                showToast('No data to backup', true);
                return;
            }
            
            const backup = {
                version: '2.0',
                exportDate: new Date().toISOString(),
                entries: bodyData.length,
                goals: GOALS,
                data: bodyData
            };
            
            const json = JSON.stringify(backup, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `body-tracker-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showToast('Backup created successfully!');
        }
        
        
        // ===== TAB NAVIGATION =====
        
        function switchMainTab(tabName, el) {
            // Hide all tabs
            document.querySelectorAll('.main-tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active from all buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // Set button active
            if (el) {
                el.classList.add('active');
            } else {
                const btn = Array.from(document.querySelectorAll('.tab-button')).find(b => (b.getAttribute('onclick') || '').includes("switchMainTab('" + tabName + "'"));
                if (btn) btn.classList.add('active');
            }
            
            // Update content for specific tabs
            if (tabName === 'nutrition') updateNutritionTab();
            if (tabName === 'measurements') updateMeasurementsTab();
            if (tabName === 'training') updateTrainingTab();
            if (tabName === 'correlations') updateCorrelationsTab();
            if (tabName === 'progressive') { if (typeof updateProgressiveTabV13==='function') updateProgressiveTabV13(); if (typeof updateProgressiveTabV15==='function') updateProgressiveTabV15(); }
            if (tabName === 'analytics') { updateAnalyticsTab(); if (typeof updateAnalyticsTabV15==='function') updateAnalyticsTabV15(); }
        }
        
        // ===== NUTRITION TAB FUNCTIONS =====
        
        function updateNutritionTab() {
            updateNutritionGoals();
            updateTotalAverages();
            updateRollingAverages();
            updateRecommendations();
            updateWhatIfCalculator();
        }
        
        function updateNutritionGoals() {
            const html = `
                <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 10px;">
                    <h3 style="color: var(--accent-purple); margin-bottom: 15px;">Your Nutrition Targets</h3>
                    <div class="grid grid-4">
                        <div>
                            <div class="nutrition-label">Target Calories</div>
                            <div class="nutrition-value">${GOALS.target_calories}</div>
                        </div>
                        <div>
                            <div class="nutrition-label">Target Protein (g)</div>
                            <div class="nutrition-value">${GOALS.target_protein}</div>
                        </div>
                        <div>
                            <div class="nutrition-label">Target Fat (g)</div>
                            <div class="nutrition-value">${GOALS.target_fat}</div>
                        </div>
                        <div>
                            <div class="nutrition-label">Target Carbs (g)</div>
                            <div class="nutrition-value">${GOALS.target_carbs}</div>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('nutritionGoals').innerHTML = html;
        }
        
        function updateTotalAverages() {
            const withNutrition = bodyData.filter(d => d.calories && d.protein);
            
            if (withNutrition.length === 0) {
                document.getElementById('totalAverages').innerHTML = '<p style="color: var(--text-secondary);">No nutrition data yet</p>';
                return;
            }
            
            const avgCals = withNutrition.reduce((sum, d) => sum + (d.calories || 0), 0) / withNutrition.length;
            const avgProtein = withNutrition.reduce((sum, d) => sum + (d.protein || 0), 0) / withNutrition.length;
            const avgFat = withNutrition.reduce((sum, d) => sum + (d.fat || 0), 0) / withNutrition.length;
            const avgCarbs = withNutrition.reduce((sum, d) => sum + (d.carbs || 0), 0) / withNutrition.length;
            
            const latest = bodyData[bodyData.length - 1];
            const avgProteinPerLb = latest.lean_lbs ? avgProtein / latest.lean_lbs : 0;
            
            const html = `
                <div class="nutrition-card">
                    <div class="nutrition-label">Average Calories</div>
                    <div class="nutrition-value">${Math.round(avgCals)}</div>
                    <div style="font-size: 0.85em; color: var(--text-secondary); margin-top: 5px;">
                        Based on ${withNutrition.length} days
                    </div>
                </div>
                <div class="nutrition-card">
                    <div class="nutrition-label">Average Protein</div>
                    <div class="nutrition-value">${Math.round(avgProtein)}g</div>
                    <div style="font-size: 0.85em; color: var(--text-secondary); margin-top: 5px;">
                        ${avgProteinPerLb.toFixed(2)}g per lb lean mass
                    </div>
                </div>
                <div class="nutrition-card">
                    <div class="nutrition-label">Average Fat</div>
                    <div class="nutrition-value">${Math.round(avgFat)}g</div>
                </div>
                <div class="nutrition-card">
                    <div class="nutrition-label">Average Carbs</div>
                    <div class="nutrition-value">${Math.round(avgCarbs)}g</div>
                </div>
            `;
            
            document.getElementById('totalAverages').innerHTML = html;
        }
        
        function updateRollingAverages() {
            const sorted = bodyData.slice().sort((a, b) => a.date.localeCompare(b.date));
            const recent7 = sorted.slice(-7).filter(d => d.calories && d.protein);
            
            if (recent7.length === 0) {
                document.getElementById('rollingAverages').innerHTML = '<p style="color: var(--text-secondary);">Need at least 7 days of nutrition data</p>';
                return;
            }
            
            const avgCals = recent7.reduce((sum, d) => sum + (d.calories || 0), 0) / recent7.length;
            const avgProtein = recent7.reduce((sum, d) => sum + (d.protein || 0), 0) / recent7.length;
            const avgFat = recent7.reduce((sum, d) => sum + (d.fat || 0), 0) / recent7.length;
            const avgCarbs = recent7.reduce((sum, d) => sum + (d.carbs || 0), 0) / recent7.length;
            
            const html = `
                <div class="nutrition-card">
                    <div class="nutrition-label">7-Day Avg Calories</div>
                    <div class="nutrition-value">${Math.round(avgCals)}</div>
                    <div style="font-size: 0.85em; color: var(--text-secondary); margin-top: 5px;">
                        Last ${recent7.length} days
                    </div>
                </div>
                <div class="nutrition-card">
                    <div class="nutrition-label">7-Day Avg Protein</div>
                    <div class="nutrition-value">${Math.round(avgProtein)}g</div>
                </div>
                <div class="nutrition-card">
                    <div class="nutrition-label">7-Day Avg Fat</div>
                    <div class="nutrition-value">${Math.round(avgFat)}g</div>
                </div>
                <div class="nutrition-card">
                    <div class="nutrition-label">7-Day Avg Carbs</div>
                    <div class="nutrition-value">${Math.round(avgCarbs)}g</div>
                </div>
            `;
            
            document.getElementById('rollingAverages').innerHTML = html;
        }
        
        function updateRecommendations() {
            const sorted = bodyData.slice().sort((a, b) => a.date.localeCompare(b.date));
            const latest = sorted[sorted.length - 1];
            
            if (!latest) {
                document.getElementById('recommendations').innerHTML = '<p style="color: var(--text-secondary);">No data available</p>';
                return;
            }
            
            // Calculate TDEE estimate based on recent fat loss
            const recent14 = sorted.slice(-14);
            if (recent14.length < 2) {
                document.getElementById('recommendations').innerHTML = '<p style="color: var(--text-secondary);">Need at least 14 days of data for recommendations</p>';
                return;
            }
            
            const first14 = recent14[0];
            const last14 = recent14[recent14.length - 1];
            const days = 14;
            
            const fatLost = (first14.weight * first14.bf_percent / 100) - (last14.weight * last14.bf_percent / 100);
            const fatLostPerDay = fatLost / days;
            const fatLostPerWeek = fatLostPerDay * 7;
            
            // 1 lb fat = 3500 calories
            const calorieDeficit = fatLostPerDay * 3500;
            
            const avgCals = recent14.filter(d => d.calories).reduce((sum, d) => sum + d.calories, 0) / recent14.filter(d => d.calories).length;
            const estimatedTDEE = avgCals + calorieDeficit;
            
            // Max fat burn = 1% body weight per week
            const maxFatBurnPerWeek = latest.weight * 0.01;
            const maxFatBurnCals = estimatedTDEE - (maxFatBurnPerWeek * 3500 / 7);
            
            // Muscle retention = 0.5% body weight per week
            const muscleRetentionFatLoss = latest.weight * 0.005;
            const muscleRetentionCals = estimatedTDEE - (muscleRetentionFatLoss * 3500 / 7);
            
            const proteinRec = latest.lean_lbs ? latest.lean_lbs * 1.0 : 180;
            
            const html = `
                <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 10px; margin-bottom: 15px;">
                    <h3 style="color: var(--accent-purple); margin-bottom: 10px;">Estimated TDEE</h3>
                    <div class="nutrition-value" style="color: var(--accent-success);">${Math.round(estimatedTDEE)} cals/day</div>
                    <p style="font-size: 0.85em; color: var(--text-secondary); margin-top: 5px;">
                        Based on ${fatLostPerWeek.toFixed(2)} lbs/week fat loss
                    </p>
                </div>
                
                <div class="grid grid-2">
                    <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 10px;">
                        <h3 style="color: var(--accent-purple); margin-bottom: 10px;">üî• Max Fat Burn Rate</h3>
                        <div class="nutrition-value">${Math.round(maxFatBurnCals)}</div>
                        <p style="font-size: 0.85em; color: var(--text-secondary); margin-top: 10px;">
                            Target: ~${maxFatBurnPerWeek.toFixed(2)} lbs/week loss (1% body weight)<br>
                            Deficit: ${Math.round(estimatedTDEE - maxFatBurnCals)} cals/day
                        </p>
                    </div>
                    
                    <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 10px;">
                        <h3 style="color: var(--accent-purple); margin-bottom: 10px;">üí™ Muscle Retention</h3>
                        <div class="nutrition-value">${Math.round(muscleRetentionCals)}</div>
                        <p style="font-size: 0.85em; color: var(--text-secondary); margin-top: 10px;">
                            Target: ~${muscleRetentionFatLoss.toFixed(2)} lbs/week loss (0.5% body weight)<br>
                            Deficit: ${Math.round(estimatedTDEE - muscleRetentionCals)} cals/day
                        </p>
                    </div>
                </div>
                
                <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 10px; margin-top: 15px;">
                    <h3 style="color: var(--accent-purple); margin-bottom: 10px;">ü•© Protein Recommendation</h3>
                    <div class="nutrition-value">${Math.round(proteinRec)}g/day</div>
                    <p style="font-size: 0.85em; color: var(--text-secondary); margin-top: 5px;">
                        Based on 1.0g per lb lean mass (${latest.lean_lbs?.toFixed(1)} lbs)
                    </p>
                </div>
            `;
            
            document.getElementById('recommendations').innerHTML = html;
        }
        
        function updateWhatIfCalculator() {
            const sorted = bodyData.slice().sort((a, b) => a.date.localeCompare(b.date));
            const latest = sorted[sorted.length - 1];
            
            if (!latest) {
                document.getElementById('whatIfCalc').innerHTML = '<p style="color: var(--text-secondary);">No data available</p>';
                return;
            }
            
            const currentFatLbs = latest.weight * latest.bf_percent / 100;
            const targetFatLbs = GOALS.target_bf_lbs;
            const fatToLose = currentFatLbs - targetFatLbs;
            
            // Calculate current rate
            const recent14 = sorted.slice(-14);
            let avgFatLossPerWeek = 0;
            if (recent14.length >= 2) {
                const first = recent14[0];
                const last = recent14[recent14.length - 1];
                const fatLost = (first.weight * first.bf_percent / 100) - (last.weight * last.bf_percent / 100);
                avgFatLossPerWeek = (fatLost / 14) * 7;
            }
            
            const weeksToGoal = avgFatLossPerWeek > 0 ? fatToLose / avgFatLossPerWeek : 0;
            const daysToGoal = weeksToGoal * 7;
            
            const goalDate = new Date(latest.date);
            goalDate.setDate(goalDate.getDate() + daysToGoal);
            
            // Different scenarios
            const scenarios = [
                { rate: 0.5, name: 'Conservative (0.5 lb/week)' },
                { rate: 1.0, name: 'Moderate (1.0 lb/week)' },
                { rate: 1.5, name: 'Aggressive (1.5 lb/week)' },
                { rate: 2.0, name: 'Very Aggressive (2.0 lb/week)' }
            ];
            
            let scenariosHtml = '';
            scenarios.forEach(scenario => {
                const weeks = fatToLose / scenario.rate;
                const date = new Date(latest.date);
                date.setDate(date.getDate() + (weeks * 7));
                
                scenariosHtml += `
                    <div style="background: var(--bg-tertiary); padding: 15px; border-radius: 8px;">
                        <div style="font-weight: 600; margin-bottom: 5px;">${scenario.name}</div>
                        <div style="font-size: 1.3em; font-family: 'Space Mono', monospace; color: var(--accent-cyan);">
                            ${date.toLocaleDateString()}
                        </div>
                        <div style="font-size: 0.85em; color: var(--text-secondary); margin-top: 5px;">
                            ${Math.round(weeks)} weeks (${Math.round(weeks * 7)} days)
                        </div>
                    </div>
                `;
            });
            
            const html = `
                <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 10px; margin-bottom: 15px;">
                    <h3 style="color: var(--accent-purple); margin-bottom: 10px;">Current Progress</h3>
                    <div class="grid grid-4">
                        <div>
                            <div class="nutrition-label">Current Fat Mass</div>
                            <div class="nutrition-value" style="font-size: 1.3em;">${currentFatLbs.toFixed(1)} lbs</div>
                        </div>
                        <div>
                            <div class="nutrition-label">Target Fat Mass</div>
                            <div class="nutrition-value" style="font-size: 1.3em;">${targetFatLbs.toFixed(1)} lbs</div>
                        </div>
                        <div>
                            <div class="nutrition-label">Fat to Lose</div>
                            <div class="nutrition-value" style="font-size: 1.3em;">${fatToLose.toFixed(1)} lbs</div>
                        </div>
                        <div>
                            <div class="nutrition-label">Current Rate</div>
                            <div class="nutrition-value" style="font-size: 1.3em;">${avgFatLossPerWeek.toFixed(2)} lb/wk</div>
                        </div>
                    </div>
                </div>
                
                <h3 style="margin-bottom: 15px;">Goal Date Scenarios</h3>
                <div class="grid grid-2">
                    ${scenariosHtml}
                </div>
                
                ${avgFatLossPerWeek > 0 ? `
                <div style="background: rgba(6, 182, 212, 0.1); padding: 20px; border-radius: 10px; margin-top: 15px; border-left: 4px solid var(--accent-cyan);">
                    <h3 style="color: var(--accent-cyan); margin-bottom: 10px;">At Your Current Rate</h3>
                    <div style="font-size: 1.5em; font-family: 'Space Mono', monospace; margin-bottom: 10px;">
                        ${goalDate.toLocaleDateString()}
                    </div>
                    <p style="color: var(--text-secondary);">
                        ${Math.round(weeksToGoal)} weeks (${Math.round(daysToGoal)} days) to reach ${GOALS.target_weight} lbs @ ${GOALS.target_bf_percent}% BF
                    </p>
                </div>
                ` : ''}
            `;
            
            document.getElementById('whatIfCalc').innerHTML = html;
        }
        
        // ===== MEASUREMENTS TAB =====
        
        let measurements = [];
        
        function loadMeasurements() {
            const stored = localStorage.getItem(MEASUREMENTS_KEY);
            if (stored) {
                measurements = JSON.parse(stored);
            }
        }
        
        function saveMeasurements() {
            localStorage.setItem(MEASUREMENTS_KEY, JSON.stringify(measurements));
        }
        
        function updateMeasurementsTab() {
            if (measurements.length === 0) {
                document.getElementById('measurementsContent').innerHTML = `
                    <div style="background: var(--bg-tertiary); padding: 30px; border-radius: 10px; text-align: center;">
                        <h3 style="color: var(--accent-purple); margin-bottom: 15px;">üìè No Measurements Yet</h3>
                        <p style="color: var(--text-secondary); margin-bottom: 20px;">
                            Start tracking body measurements like neck, chest, waist, hips, arms, thighs, and calves.
                        </p>
                        <button onclick="showAddMeasurement()" class="primary">+ Add First Measurement</button>
                    </div>
                `;
                return;
            }
            
            const sorted = measurements.slice().sort((a, b) => b.date.localeCompare(a.date));
            const latest = sorted[0];
            const oldest = sorted[sorted.length - 1];
            
            let tableRows = '';
            sorted.forEach(m => {
                tableRows += `
                    <tr onclick="editMeasurement('${m.date}')">
                        <td>${m.date}</td>
                        <td>${m.neck || '-'}</td>
                        <td>${m.chest || '-'}</td>
                        <td>${m.waist || '-'}</td>
                        <td>${m.hips || '-'}</td>
                        <td>${m.arms || '-'}</td>
                        <td>${m.thighs || '-'}</td>
                        <td>${m.calves || '-'}</td>
                        <td>
                            <button class="danger" onclick="event.stopPropagation(); deleteMeasurement('${m.date}')">√ó</button>
                        </td>
                    </tr>
                `;
            });
            
            const html = `
                <div style="margin-bottom: 20px;">
                    <h3 style="color: var(--accent-purple); margin-bottom: 15px;">Latest Measurements (${latest.date})</h3>
                    <div class="grid grid-4">
                        <div class="nutrition-card">
                            <div class="nutrition-label">Neck</div>
                            <div class="nutrition-value" style="font-size: 1.5em;">${latest.neck || '-'}"</div>
                        </div>
                        <div class="nutrition-card">
                            <div class="nutrition-label">Chest</div>
                            <div class="nutrition-value" style="font-size: 1.5em;">${latest.chest || '-'}"</div>
                        </div>
                        <div class="nutrition-card">
                            <div class="nutrition-label">Waist</div>
                            <div class="nutrition-value" style="font-size: 1.5em;">${latest.waist || '-'}"</div>
                        </div>
                        <div class="nutrition-card">
                            <div class="nutrition-label">Hips</div>
                            <div class="nutrition-value" style="font-size: 1.5em;">${latest.hips || '-'}"</div>
                        </div>
                        <div class="nutrition-card">
                            <div class="nutrition-label">Arms</div>
                            <div class="nutrition-value" style="font-size: 1.5em;">${latest.arms || '-'}"</div>
                        </div>
                        <div class="nutrition-card">
                            <div class="nutrition-label">Thighs</div>
                            <div class="nutrition-value" style="font-size: 1.5em;">${latest.thighs || '-'}"</div>
                        </div>
                        <div class="nutrition-card">
                            <div class="nutrition-label">Calves</div>
                            <div class="nutrition-value" style="font-size: 1.5em;">${latest.calves || '-'}"</div>
                        </div>
                    </div>
                </div>
                
                <h3 style="margin: 20px 0 15px 0;">Measurement History</h3>
                <div class="table-container" style="max-height: 400px;">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Neck</th>
                                <th>Chest</th>
                                <th>Waist</th>
                                <th>Hips</th>
                                <th>Arms</th>
                                <th>Thighs</th>
                                <th>Calves</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tableRows}
                        </tbody>
                    </table>
                </div>
            `;
            
            document.getElementById('measurementsContent').innerHTML = html;
        }
        
        function showAddMeasurement() {
            const modal = document.getElementById('measurementsModal');
            modal.innerHTML = `
                <div class="modal">
                    <h2>Add Body Measurements</h2>
                    <div class="form-section">
                        <h3>Date & Core Measurements</h3>
                        <div class="form-grid">
                            <div class="form-field">
                                <label class="required">Date</label>
                                <input type="date" id="measDate" value="${new Date().toISOString().split('T')[0]}">
                            </div>
                            <div class="form-field">
                                <label>Neck (inches)</label>
                                <input type="number" step="0.25" id="measNeck">
                            </div>
                            <div class="form-field">
                                <label>Chest (inches)</label>
                                <input type="number" step="0.25" id="measChest">
                            </div>
                            <div class="form-field">
                                <label>Waist (inches)</label>
                                <input type="number" step="0.25" id="measWaist">
                            </div>
                            <div class="form-field">
                                <label>Hips (inches)</label>
                                <input type="number" step="0.25" id="measHips">
                            </div>
                            <div class="form-field">
                                <label>Arms (inches)</label>
                                <input type="number" step="0.25" id="measArms">
                            </div>
                            <div class="form-field">
                                <label>Thighs (inches)</label>
                                <input type="number" step="0.25" id="measThighs">
                            </div>
                            <div class="form-field">
                                <label>Calves (inches)</label>
                                <input type="number" step="0.25" id="measCalves">
                            </div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button onclick="saveMeasurement()" class="primary">Save Measurements</button>
                        <button onclick="hideMeasurementsModal()">Cancel</button>
                    </div>
                </div>
            `;
            modal.classList.add('show');
        }
        
        function saveMeasurement() {
            const date = document.getElementById('measDate').value;
            if (!date) {
                showToast('Please enter a date', true);
                return;
            }
            
            const measurement = {
                date,
                neck: parseFloat(document.getElementById('measNeck').value) || null,
                chest: parseFloat(document.getElementById('measChest').value) || null,
                waist: parseFloat(document.getElementById('measWaist').value) || null,
                hips: parseFloat(document.getElementById('measHips').value) || null,
                arms: parseFloat(document.getElementById('measArms').value) || null,
                thighs: parseFloat(document.getElementById('measThighs').value) || null,
                calves: parseFloat(document.getElementById('measCalves').value) || null
            };
            
            measurements = measurements.filter(m => m.date !== date);
            measurements.push(measurement);
            measurements.sort((a, b) => a.date.localeCompare(b.date));
            
            saveMeasurements();
            updateMeasurementsTab();
            hideMeasurementsModal();
            showToast('Measurements saved!');
        }
        
        function editMeasurement(date) {
            const meas = measurements.find(m => m.date === date);
            if (!meas) return;
            
            const modal = document.getElementById('measurementsModal');
            modal.innerHTML = `
                <div class="modal">
                    <h2>Edit Measurements</h2>
                    <div class="form-section">
                        <h3>Date & Core Measurements</h3>
                        <div class="form-grid">
                            <div class="form-field">
                                <label class="required">Date</label>
                                <input type="date" id="measDate" value="${meas.date}">
                            </div>
                            <div class="form-field">
                                <label>Neck (inches)</label>
                                <input type="number" step="0.25" id="measNeck" value="${meas.neck || ''}">
                            </div>
                            <div class="form-field">
                                <label>Chest (inches)</label>
                                <input type="number" step="0.25" id="measChest" value="${meas.chest || ''}">
                            </div>
                            <div class="form-field">
                                <label>Waist (inches)</label>
                                <input type="number" step="0.25" id="measWaist" value="${meas.waist || ''}">
                            </div>
                            <div class="form-field">
                                <label>Hips (inches)</label>
                                <input type="number" step="0.25" id="measHips" value="${meas.hips || ''}">
                            </div>
                            <div class="form-field">
                                <label>Arms (inches)</label>
                                <input type="number" step="0.25" id="measArms" value="${meas.arms || ''}">
                            </div>
                            <div class="form-field">
                                <label>Thighs (inches)</label>
                                <input type="number" step="0.25" id="measThighs" value="${meas.thighs || ''}">
                            </div>
                            <div class="form-field">
                                <label>Calves (inches)</label>
                                <input type="number" step="0.25" id="measCalves" value="${meas.calves || ''}">
                            </div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button onclick="saveMeasurement()" class="primary">Save Changes</button>
                        <button onclick="hideMeasurementsModal()">Cancel</button>
                    </div>
                </div>
            `;
            modal.classList.add('show');
        }
        
        function deleteMeasurement(date) {
            if (!confirm(`Delete measurements from ${date}?`)) return;
            measurements = measurements.filter(m => m.date !== date);
            saveMeasurements();
            updateMeasurementsTab();
            showToast('Measurements deleted');
        }
        
        function hideMeasurementsModal() {
            document.getElementById('measurementsModal').classList.remove('show');
        }
        
        
// ===== TRAINING TAB (v12) =====
// Goals:
// - Set-by-set tracking (variable reps/weight per set)
// - Set types: Standard, Drop Set, Rest-Pause, Warm-up
// - Warm-up sets excluded from "working volume"
// - Superset designation (tag)
// - Plan-ahead: "Workout for Today" card + templates
// - Multiple workouts per day (two-a-days)
// - Exercise library (preset + learns new exercises)
// - Progressive overload analysis tab (PRs + suggestions)
// - Reliable save button + Ctrl/Cmd+S
// - Auto-save with debounce + saved indicator
// - Data schema versioning + migrations so upgrades won't break data

const TRAINING_SCHEMA_VERSION = 2;
const TRAINING_KEY = 'rakChazaq_training_v12';
const TRAINING_TEMPLATES_KEY = 'rakChazaq_training_templates_v12';
const EXERCISE_LIBRARY_KEY = 'rakChazaq_exercise_library_v12';

// Auto-save status
let __dirty = false;
let __saveTimer = null;
let __lastSavedAt = null;

// Training data in-memory
let trainingStore = { schema_version: TRAINING_SCHEMA_VERSION, exported_at: null, workouts: [] };
let workoutTemplates = { schema_version: 1, templates: [] };
let exerciseLibrary = { schema_version: 1, items: [] };

// Live mode (timer + rest)
let liveMode = { running:false, startTs:null, elapsedSec:0, restUntil:null, restTimer:null, elapsedTimer:null };

function _nowIso() { return new Date().toISOString(); }
function newId(prefix='id') { return `${prefix}_${Math.random().toString(16).slice(2)}_${Date.now()}`; }

function markDirty() {
    __dirty = true;
    scheduleAutosave();
    updateSaveIndicator('Saving‚Ä¶');
}

function scheduleAutosave() {
    if (__saveTimer) clearTimeout(__saveTimer);
    __saveTimer = setTimeout(() => {
        persistAll();
    }, 2000);
}

function updateSaveIndicator(stateText) {
    // Header line already exists: #headerStatus, keep it; we add a small status on the right via a badge
    let el = document.getElementById('saveStatusBadge');
    if (!el) {
        const header = document.querySelector('.header-actions');
        if (header) {
            const span = document.createElement('span');
            span.id = 'saveStatusBadge';
            span.style.cssText = 'margin-left:auto;align-self:center;font-family:Space Mono, monospace;font-size:0.85em;color:var(--text-secondary);';
            header.appendChild(span);
            el = span;
        }
    }
    if (el) {
        const ts = __lastSavedAt ? ` ‚Ä¢ Last saved: ${__lastSavedAt.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}` : '';
        el.textContent = `${stateText}${(stateText.startsWith('Saved') ? ts : '')}`;
    }
}

window.addEventListener('beforeunload', (e) => {
    if (__dirty) {
        e.preventDefault();
        e.returnValue = '';
    }
});

function safeJsonParse(str) {
    try { return JSON.parse(str); } catch { return null; }
}

function loadExerciseLibrary() {
    const stored = safeJsonParse(localStorage.getItem(EXERCISE_LIBRARY_KEY));
    const defaults = [
        'Bench Press','Incline Bench Press','Dumbbell Bench Press','Overhead Press','Dumbbell Shoulder Press',
        'Back Squat','Front Squat','Deadlift','Romanian Deadlift','Leg Press',
        'Pull-up','Lat Pulldown','Barbell Row','Dumbbell Row','Cable Row',
        'Bicep Curl','Hammer Curl','Tricep Pushdown','Dips',
        'Lateral Raise','Rear Delt Fly','Chest Fly','Calf Raise','Plank'
    ];
    if (stored && stored.items) {
        exerciseLibrary = stored;
    } else {
        exerciseLibrary = { schema_version: 1, items: defaults };
        localStorage.setItem(EXERCISE_LIBRARY_KEY, JSON.stringify(exerciseLibrary));
    }
}

function learnExercise(name) {
    if (!name) return;
    const n = name.trim();
    if (!n) return;
    if (!exerciseLibrary.items.some(x => x.toLowerCase() === n.toLowerCase())) {
        exerciseLibrary.items.push(n);
        exerciseLibrary.items.sort((a,b)=>a.localeCompare(b));
        localStorage.setItem(EXERCISE_LIBRARY_KEY, JSON.stringify(exerciseLibrary));
    }
}

// --- Migrations ---
function migrateTrainingPayload(raw) {
    // Accept:
    // 1) Array of workouts (legacy)
    // 2) { trainingLog: [...] } (legacy)
    // 3) { schema_version, workouts: [...] } (current)
    if (!raw) return { schema_version: TRAINING_SCHEMA_VERSION, exported_at: _nowIso(), workouts: [] };

    // Backup old payload once
    try {
        localStorage.setItem(`${TRAINING_KEY}__backup__${Date.now()}`, JSON.stringify(raw));
    } catch {}

    // Normalize to object with workouts[]
    let obj = null;
    if (Array.isArray(raw)) obj = { schema_version: 0, workouts: raw };
    else if (raw.workouts && Array.isArray(raw.workouts)) obj = raw;
    else if (raw.trainingLog && Array.isArray(raw.trainingLog)) obj = { schema_version: 0, workouts: raw.trainingLog };
    else obj = { schema_version: 0, workouts: [] };

    const fromV = Number(obj.schema_version || 0);
    let migrated = obj;

    // v0 -> v1: ensure ids, sets arrays, date+time fields, exercise fields
    if (fromV < 1) {
        migrated = {
            schema_version: 1,
            exported_at: _nowIso(),
            workouts: (migrated.workouts || []).map(w => {
                const wid = w.id || newId('w');
                const date = w.date || w.workoutDate || w.day || new Date().toISOString().split('T')[0];
                const startTime = w.startTime || w.time || null;
                const type = w.type || w.workoutType || 'Workout';
                const notes = w.notes || '';
                const exercises = (w.exercises || w.blocks || []).map(ex => {
                    const exid = ex.id || newId('ex');
                    const name = ex.name || ex.exercise || '';
                    const isDumbbell = !!ex.isDumbbell;
                    const isBodyweight = !!ex.isBodyweight;
                    const superset = ex.superset || null;
                    const exNotes = ex.notes || '';
                    // Legacy might have sets/reps/weight at exercise level:
                    const legacySets = ex.sets || [];
                    let sets = [];
                    if (Array.isArray(legacySets) && legacySets.length) {
                        sets = legacySets.map(s => ({
                            id: s.id || newId('s'),
                            type: s.type || (s.warmup ? 'Warm-up' : 'Standard'),
                            reps: Number(s.reps || 0),
                            weight: s.weight !== undefined ? Number(s.weight) : null,
                            db_weight: s.db_weight !== undefined ? Number(s.db_weight) : null,
                            drops: Array.isArray(s.drops) ? s.drops : null,
                            rest_pause: s.rest_pause || null,
                            assistance: s.assistance !== undefined ? Number(s.assistance) : null,
                            added: s.added !== undefined ? Number(s.added) : null,
                            completed: s.completed !== undefined ? !!s.completed : true
                        }));
                    } else {
                        // If old schema had ex.setsCount/ex.reps/ex.weight
                        const reps = Number(ex.reps || 0);
                        const weight = ex.weight !== undefined ? Number(ex.weight) : null;
                        if (reps || weight) {
                            sets = [{ id: newId('s'), type: 'Standard', reps, weight, completed: true }];
                        } else {
                            sets = [{ id: newId('s'), type: 'Standard', reps: 0, weight: null, completed: false }];
                        }
                    }
                    return { id: exid, name, isDumbbell, isBodyweight, superset, notes: exNotes, sets };
                });
                return { id: wid, date, startTime, type, notes, exercises };
            })
        };
    }

    // v1 -> v2: add template linkage + allow multiple workouts/day: enforce date+id uniqueness
    if (migrated.schema_version < 2) {
        migrated = {
            schema_version: 2,
            exported_at: _nowIso(),
            workouts: (migrated.workouts || []).map(w => ({
                id: w.id || newId('w'),
                date: w.date,
                startTime: w.startTime || null,
                type: w.type || 'Workout',
                title: w.title || null,
                template_id: w.template_id || null,
                notes: w.notes || '',
                exercises: (w.exercises || []).map(ex => ({
                    id: ex.id || newId('ex'),
                    name: ex.name || '',
                    isDumbbell: !!ex.isDumbbell,
                    isBodyweight: !!ex.isBodyweight,
                    superset: ex.superset || null,
                    notes: ex.notes || '',
                    sets: (ex.sets || []).map(s => ({
                        id: s.id || newId('s'),
                        type: s.type || 'Standard',
                        reps: Number(s.reps || 0),
                        weight: s.weight !== null && s.weight !== undefined ? Number(s.weight) : null,
                        db_weight: s.db_weight !== null && s.db_weight !== undefined ? Number(s.db_weight) : null,
                        drops: s.drops || null,
                        rest_pause: s.rest_pause || null,
                        assistance: s.assistance !== null && s.assistance !== undefined ? Number(s.assistance) : null,
                        added: s.added !== null && s.added !== undefined ? Number(s.added) : null,
                        completed: s.completed !== undefined ? !!s.completed : true
                    }))
                }))
            }))
        };
    }

    return migrated;
}

function loadTraining() {
    const raw = safeJsonParse(localStorage.getItem(TRAINING_KEY));
    trainingStore = migrateTrainingPayload(raw);
    localStorage.setItem(TRAINING_KEY, JSON.stringify(trainingStore));
}

function saveTraining() {
    trainingStore.exported_at = _nowIso();
    localStorage.setItem(TRAINING_KEY, JSON.stringify(trainingStore));
}

function loadTemplates() {
    const raw = safeJsonParse(localStorage.getItem(TRAINING_TEMPLATES_KEY));
    if (raw && raw.templates) workoutTemplates = raw;
    else {
        workoutTemplates = { schema_version: 1, templates: [] };
        localStorage.setItem(TRAINING_TEMPLATES_KEY, JSON.stringify(workoutTemplates));
    }
}

function saveTemplates() {
    localStorage.setItem(TRAINING_TEMPLATES_KEY, JSON.stringify(workoutTemplates));
}

// Persist everything (body data + training + measurements + templates + library)
function persistAll() {
    try {
        saveData(); // existing body data saver
    } catch {}
    try {
        saveTraining();
        saveTemplates();
        localStorage.setItem(EXERCISE_LIBRARY_KEY, JSON.stringify(exerciseLibrary));
    } catch {}
    __dirty = false;
    __lastSavedAt = new Date();
    updateSaveIndicator('Saved ‚úì');
}

// ----- Volume + 1RM -----
function epley1RM(weight, reps) {
    if (!isFinite(weight) || !isFinite(reps) || reps <= 0) return null;
    return weight * (1 + (reps / 30));
}

function latestBodyweight() {
    // Use most recent bodyData weight
    try {
        const sorted = bodyData.slice().sort((a,b)=>a.date.localeCompare(b.date));
        const latest = sorted[sorted.length-1];
        return isFinite(latest?.weight) ? latest.weight : null;
    } catch { return null; }
}

function effectiveSetWeight(ex, set) {
    // Dumbbell: use total = db_weight*2, but preserve set.weight if user enters total weight
    let w = null;
    if (ex.isDumbbell) {
        const dbw = (set.db_weight !== null && set.db_weight !== undefined) ? Number(set.db_weight) : null;
        if (isFinite(dbw)) w = dbw * 2;
    }
    if (w === null) {
        if (set.weight !== null && set.weight !== undefined && isFinite(set.weight)) w = Number(set.weight);
    }

    if (ex.isBodyweight) {
        const bw = latestBodyweight();
        if (!isFinite(bw)) return w; // fallback
        const assistance = isFinite(set.assistance) ? Number(set.assistance) : 0;
        const added = isFinite(set.added) ? Number(set.added) : 0;
        w = (bw - assistance + added);
    }
    return w;
}

function setVolume(ex, set) {
    // Drop set: parse drops array: [{weight,reps}, ...] OR "225x8 -> 185x6"
    const type = (set.type || 'Standard');
    if (type === 'Warm-up') return 0; // do not count towards working volume
    if (type === 'Drop Set' && set.drops && Array.isArray(set.drops)) {
        return set.drops.reduce((sum, d) => {
            const w = effectiveSetWeight(ex, { ...set, weight: d.weight, db_weight: d.db_weight ?? set.db_weight, assistance: set.assistance, added: set.added, type: 'Standard' });
            const r = Number(d.reps || 0);
            return sum + (isFinite(w) ? w : 0) * (isFinite(r) ? r : 0);
        }, 0);
    }
    if (type === 'Rest-Pause' && set.rest_pause) {
        // rest_pause example: "8+3+2" total reps
        const parts = String(set.rest_pause).split('+').map(x=>Number(x.trim())).filter(x=>isFinite(x) && x>0);
        const reps = parts.reduce((a,b)=>a+b,0);
        const w = effectiveSetWeight(ex, set);
        return (isFinite(w) ? w : 0) * reps;
    }
    const reps = Number(set.reps || 0);
    const w = effectiveSetWeight(ex, set);
    return (isFinite(w) ? w : 0) * (isFinite(reps) ? reps : 0);
}

function exerciseVolume(ex) {
    return (ex.sets || []).reduce((sum,s)=>sum + setVolume(ex,s), 0);
}

// ----- UI: Training tab -----
function updateTrainingTab() {
    const container = document.getElementById('trainingContent');
    if (!container) return;

    const workouts = (trainingStore.workouts || []).slice().sort((a,b)=>{
        const da = (a.date||'') + (a.startTime||'');
        const db = (b.date||'') + (b.startTime||'');
        return db.localeCompare(da);
    });

    if (workouts.length === 0) {
        container.innerHTML = `
            <div style="background: var(--bg-tertiary); padding: 30px; border-radius: 10px; text-align: center;">
                <h3 style="color: var(--accent-purple); margin-bottom: 15px;">üèãÔ∏è No Workouts Logged Yet</h3>
                <p style="color: var(--text-secondary); margin-bottom: 20px;">Log your first workout (set-by-set), plan ahead, and track progressive overload.</p>
                <button onclick="showAddWorkout()" class="primary">+ Log First Workout</button>
            </div>
        `;
        return;
    }

    // Workout for Today card
    const today = new Date().toISOString().split('T')[0];
    const todays = workouts.filter(w => w.date === today);

    let todayHtml = `
        <div style="background: rgba(6, 182, 212, 0.08); border: 1px solid var(--border); padding: 18px; border-radius: 12px; margin-bottom: 15px;">
            <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
                <div>
                    <div style="font-family:'Space Mono', monospace; color: var(--accent-cyan); font-weight:700;">Workout for Today</div>
                    <div style="color: var(--text-secondary); font-size:0.9em;">Plan the work ‚Ä¢ Work the plan</div>
                </div>
                <div style="display:flex; gap:10px; flex-wrap:wrap;">
                    <button onclick="showAddWorkout('${today}')" class="primary">+ New Session</button>
                    <button onclick="openTemplateManager()" style="background: var(--accent-purple);">Templates</button>
                    <button onclick="toggleLiveMode()" style="background: var(--accent-warning);">‚è± Live Mode</button>
                </div>
            </div>
            <div id="liveModeBar" style="margin-top:12px;"></div>
            <div style="margin-top:12px; color: var(--text-secondary); font-size:0.9em;">
                ${todays.length ? `Today's sessions logged: <b>${todays.length}</b>` : `No sessions logged today yet.`}
            </div>
        </div>
    `;

    // Recent workout cards
    let cards = '';
    workouts.slice(0, 30).forEach(w => {
        let exHtml = '';
        (w.exercises || []).forEach(ex => {
            const vol = exerciseVolume(ex);
            const pr1rm = getExercisePR(ex.name).pr_1rm;
            const bwTag = ex.isBodyweight ? 'ü§∏ BW' : '';
            const dbTag = ex.isDumbbell ? 'üèãÔ∏è DB' : '';
            const ssTag = ex.superset ? `üîó SS:${escapeHtml(ex.superset)}` : '';
            exHtml += `
                <div style="background: var(--bg-primary); padding: 10px; border-radius: 8px; margin: 8px 0;">
                    <div style="display:flex; justify-content:space-between; gap:10px; align-items:start;">
                        <div>
                            <div style="font-weight:700;">${escapeHtml(ex.name)} <span style="color:var(--text-secondary); font-size:0.85em;">${bwTag} ${dbTag} ${ssTag}</span></div>
                            <div style="font-family:'Space Mono', monospace; font-size:0.85em; color: var(--text-secondary); margin-top:3px;">
                                Working Volume: ${Math.round(vol).toLocaleString()} lbs ${pr1rm ? `‚Ä¢ PR 1RM: ${Math.round(pr1rm)} lbs` : ''}
                            </div>
                        </div>
                        <div style="display:flex; gap:6px;">
                            <button onclick="openProgressiveForExercise('${escapeAttr(ex.name)}')" style="padding:6px 10px; font-size:0.8em;">Overload</button>
                        </div>
                    </div>
                    ${(ex.notes ? `<details style="margin-top:8px;"><summary style="cursor:pointer;color:var(--accent-cyan); font-size:0.85em;">Notes</summary><div style="color:var(--text-secondary); font-size:0.9em; padding-top:8px;">${escapeHtml(ex.notes)}</div></details>` : '')}
                </div>
            `;
        });

        const title = w.title || w.type || 'Workout';
        const time = w.startTime ? ` ‚Ä¢ ${w.startTime}` : '';
        cards += `
            <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 12px; margin-bottom: 15px;">
                <div style="display:flex; justify-content:space-between; align-items:start; gap:10px;">
                    <div>
                        <h3 style="color: var(--accent-purple); margin-bottom: 4px;">${escapeHtml(title)}</h3>
                        <div style="color: var(--text-secondary); font-size:0.9em; font-family:'Space Mono', monospace;">${w.date}${time}</div>
                    </div>
                    <div style="display:flex; gap:8px; flex-wrap:wrap;">
                        <button onclick="editWorkout('${w.id}')" style="padding:6px 12px;">Edit</button>
                        <button class="danger" onclick="deleteWorkout('${w.id}')">√ó</button>
                    </div>
                </div>
                <div style="margin-top:10px;">${exHtml || `<p style="color:var(--text-secondary); font-style:italic;">No exercises logged</p>`}</div>
                ${w.notes ? `<div style="margin-top:10px; padding:10px; background: var(--bg-primary); border-radius:8px; color:var(--text-secondary);">${escapeHtml(w.notes)}</div>` : ''}
            </div>
        `;
    });

    container.innerHTML = todayHtml + cards;
    renderLiveModeBar();
}

// ----- Progressive Overload Tab -----
function getExerciseHistory(name) {
    const workouts = (trainingStore.workouts || []).slice().sort((a,b)=>a.date.localeCompare(b.date));
    const history = [];
    workouts.forEach(w => {
        (w.exercises || []).forEach(ex => {
            if ((ex.name||'').toLowerCase() === (name||'').toLowerCase()) {
                history.push({ workout: w, ex });
            }
        });
    });
    return history;
}

function getExercisePR(name) {
    // PR: max 1RM and max working volume
    let pr1 = null, prVol = null, prDate1=null, prDateVol=null;
    const hist = getExerciseHistory(name);
    hist.forEach(h => {
        const ex = h.ex;
        const vol = exerciseVolume(ex);
        if (prVol === null || vol > prVol) { prVol = vol; prDateVol = h.workout.date; }
        (ex.sets||[]).forEach(s => {
            const wgt = effectiveSetWeight(ex, s);
            const reps = (s.type==='Rest-Pause' && s.rest_pause) ? String(s.rest_pause).split('+').map(x=>Number(x)).filter(x=>isFinite(x)).reduce((a,b)=>a+b,0) : Number(s.reps||0);
            const one = epley1RM(wgt, reps);
            if (one && (pr1===null || one>pr1)) { pr1 = one; prDate1 = h.workout.date; }
        });
    });
    return { pr_1rm: pr1, pr_1rm_date: prDate1, pr_volume: prVol, pr_volume_date: prDateVol };
}

function updateProgressiveTab(focusExercise=null) {
    const el = document.getElementById('progressiveContent');
    if (!el) return;

    // collect unique exercise names
    const names = new Set();
    (trainingStore.workouts||[]).forEach(w => (w.exercises||[]).forEach(ex => names.add(ex.name)));
    const list = Array.from(names).filter(Boolean).sort((a,b)=>a.localeCompare(b));

    const pct = Number(localStorage.getItem('po_pct') || 2.5);
    const pctHtml = `
        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:15px;">
            <div style="font-family:'Space Mono', monospace; color: var(--text-secondary);">Default increase %:</div>
            <input id="poPct" type="number" step="0.1" value="${pct}" style="width:90px; padding:8px; border-radius:8px; border:1px solid var(--border); background:var(--bg-secondary); color:var(--text-primary);">
            <button onclick="savePoPct()" class="primary">Save</button>
            <div style="margin-left:auto; color: var(--text-secondary); font-size:0.9em;">Tip: Use 1‚Äì3% for barbell, 2‚Äì5% for dumbbells.</div>
        </div>
    `;

    if (list.length===0) {
        el.innerHTML = `<p style="color:var(--text-secondary);">Log workouts to see progressive overload suggestions.</p>`;
        return;
    }

    const focus = focusExercise || list[0];
    const options = list.map(n => `<option ${n===focus?'selected':''}>${escapeHtml(n)}</option>`).join('');
    const picker = `
        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:15px;">
            <div style="font-family:'Space Mono', monospace; color: var(--text-secondary);">Exercise:</div>
            <select id="poExercise" style="min-width:220px; padding:10px; border-radius:8px; border:1px solid var(--border); background:var(--bg-secondary); color:var(--text-primary);">
                ${options}
            </select>
            <button onclick="renderPoSelected()" style="background: var(--accent-purple);">Show</button>
        </div>
    `;

    el.innerHTML = pctHtml + picker + `<div id="poDetail"></div>`;
    renderPoExercise(focus);
}

function savePoPct() {
    const v = Number(document.getElementById('poPct').value);
    if (!isFinite(v) || v<=0) return;
    localStorage.setItem('po_pct', String(v));
    showToast('Progressive overload % saved!');
    renderPoSelected();
}

function renderPoSelected() {
    const name = document.getElementById('poExercise').value;
    renderPoExercise(name);
}

function renderPoExercise(name) {
    const detail = document.getElementById('poDetail');
    if (!detail) return;
    const hist = getExerciseHistory(name);
    const pct = Number(localStorage.getItem('po_pct') || 2.5);
    const pr = getExercisePR(name);

    if (hist.length === 0) {
        detail.innerHTML = `<p style="color:var(--text-secondary);">No history for ${escapeHtml(name)}</p>`;
        return;
    }

    const last = hist[hist.length-1];
    const ex = last.ex;
    const vol = exerciseVolume(ex);

    // find last working weight (first non-warmup standard set)
    const firstWork = (ex.sets||[]).find(s => (s.type||'Standard') !== 'Warm-up' && (effectiveSetWeight(ex,s) !== null));
    const lastWeight = firstWork ? effectiveSetWeight(ex, firstWork) : null;
    const suggested = isFinite(lastWeight) ? (lastWeight * (1 + pct/100)) : null;

    // show last workout sets
    const setsLines = (ex.sets||[]).map((s,i)=>{
        const type = s.type || 'Standard';
        if (type === 'Drop Set' && s.drops && Array.isArray(s.drops)) {
            const parts = s.drops.map(d=>`${d.reps}√ó${d.weight}`).join(' ‚Üí ');
            return `Set ${i+1}: ${parts} (Drop Set)`;
        }
        if (type === 'Rest-Pause' && s.rest_pause) {
            const w = effectiveSetWeight(ex,s);
            return `Set ${i+1}: ${s.rest_pause} reps √ó ${w?.toFixed(0) || ''} lbs (Rest-Pause)`;
        }
        const w = effectiveSetWeight(ex,s);
        const r = s.reps || 0;
        return `Set ${i+1}: ${r} reps √ó ${w?.toFixed(0) || ''} lbs${type==='Warm-up'?' (Warm-up)':''}`;
    }).join('<br>');

    const calc = (isFinite(lastWeight) && isFinite(suggested))
        ? `${Math.round(suggested)} lbs (${Math.round(lastWeight)} √ó ${(1 + pct/100).toFixed(3)})`
        : 'N/A';

    detail.innerHTML = `
        <div style="background: var(--bg-tertiary); padding: 18px; border-radius: 12px;">
            <div style="display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;">
                <div>
                    <div style="font-family:'Space Mono', monospace; color: var(--accent-cyan); font-weight:700;">Exercise: ${escapeHtml(name)}</div>
                    <div style="color: var(--text-secondary); font-size:0.9em;">Last Workout (${last.workout.date}${last.workout.startTime?(' '+last.workout.startTime):''})</div>
                </div>
                <div style="text-align:right;">
                    <div style="color: var(--text-secondary); font-size:0.85em;">PR 1RM (Epley)</div>
                    <div style="font-family:'Space Mono', monospace; font-size:1.1em;">${pr.pr_1rm?Math.round(pr.pr_1rm):'‚Äî'} ${pr.pr_1rm_date?`<span style="color:var(--text-secondary); font-size:0.85em;">(${pr.pr_1rm_date})</span>`:''}</div>
                </div>
            </div>
            <div style="margin-top:12px; font-family:'Space Mono', monospace; color: var(--text-secondary); font-size:0.9em; line-height:1.6;">
                ${setsLines}
                <br><br><b>Total Working Volume:</b> ${Math.round(vol).toLocaleString()} lbs
            </div>
            <div style="margin-top:14px; padding: 12px; background: rgba(139,92,246,0.12); border:1px solid var(--border); border-radius: 10px;">
                <div style="font-weight:700; color: var(--accent-purple); margin-bottom:8px;">Progressive Overload Suggestion (${pct}%)</div>
                <div style="font-family:'Space Mono', monospace;">Suggested Weight: <b>${calc}</b></div>
                <div style="color: var(--text-secondary); margin-top:8px;">
                    OR: Add <b>1 rep per set</b> ‚Ä¢ OR: Add <b>1 additional set</b>
                </div>
            </div>
        </div>
    `;
}

function openProgressiveForExercise(name) {
    switchMainTab('progressive');
    // ensure tab rendered
    setTimeout(()=>updateProgressiveTab(name), 50);
}

// ----- Workout Modal -----
function showAddWorkout(prefillDate=null) {
    const date = prefillDate || new Date().toISOString().split('T')[0];
    const modal = document.getElementById('trainingModal');
    modal.innerHTML = '';
    const workoutId = newId('w');
    renderWorkoutModal({ id: workoutId, date, startTime: null, type: 'Workout', title: null, notes:'', exercises: [] }, true);
    modal.classList.add('show');
}

function editWorkout(workoutId) {
    const w = (trainingStore.workouts||[]).find(x=>x.id===workoutId);
    if (!w) return;
    const modal = document.getElementById('trainingModal');
    modal.innerHTML = '';
    renderWorkoutModal(JSON.parse(JSON.stringify(w)), false);
    modal.classList.add('show');
}

function hideTrainingModal() {
    const modal = document.getElementById('trainingModal');
    modal.classList.remove('show');
    modal.innerHTML = '';
}

function renderWorkoutModal(workout, isNew) {
    const modal = document.getElementById('trainingModal');
    const startTimeDefault = workout.startTime || new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    const titleDefault = workout.title || '';
    const typeDefault = workout.type || 'Workout';

    modal.innerHTML = `
        <div class="modal">
            <h2>${isNew ? 'Log Workout' : 'Edit Workout'}</h2>

            <div class="form-section">
                <h3>Workout Details</h3>
                <div class="form-grid">
                    <div class="form-field">
                        <label class="required">Date</label>
                        <input type="date" id="wDate" value="${workout.date}">
                    </div>
                    <div class="form-field">
                        <label>Start Time (optional)</label>
                        <input type="text" id="wTime" value="${escapeAttr(startTimeDefault)}" placeholder="e.g., 06:15 AM">
                    </div>
                    <div class="form-field">
                        <label>Title (optional)</label>
                        <input type="text" id="wTitle" value="${escapeAttr(titleDefault)}" placeholder="e.g., Upper 1 (Strength)">
                    </div>
                    <div class="form-field">
                        <label>Workout Type</label>
                        <select id="wType">
                            ${['Upper Body','Lower Body','Full Body','Push','Pull','Legs','Cardio','Other','Workout'].map(t=>`<option ${t===typeDefault?'selected':''}>${t}</option>`).join('')}
                        </select>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h3>Exercises <span style="color:var(--text-secondary); font-size:0.85em;">(drag to reorder or use arrows)</span></h3>
                <div id="exerciseBlocks"></div>
                <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
                    <button onclick="addExerciseBlock()" class="primary">+ Add Exercise</button>
                    <button onclick="addSupersetPair()" style="background: var(--accent-purple);">+ Superset Pair</button>
                </div>
            </div>

            <div class="form-section">
                <div class="form-field">
                    <label>Workout Notes</label>
                    <textarea id="wNotes" rows="2" maxlength="1200" placeholder="Overall notes...">${escapeHtml(workout.notes||'')}</textarea>
                </div>
            </div>

            <div id="workoutSaveHint" style="margin-top:10px;color:var(--text-secondary); font-family:'Space Mono', monospace;"></div>

            <div style="display:flex; gap:10px; margin-top: 18px; flex-wrap:wrap;">
                <button id="saveWorkoutBtn" onclick="saveWorkoutFromModal('${workout.id}')" class="primary">Save Workout</button>
                <button onclick="hideTrainingModal()">Cancel</button>
                <button onclick="saveWorkoutAsTemplate('${workout.id}')" style="background: var(--accent-warning);">Save as Template</button>
            </div>
        </div>
    `;

    // store draft in modal dataset
    modal.dataset.workoutId = workout.id;
    modal.dataset.isNew = isNew ? '1' : '0';
    modal.dataset.draft = JSON.stringify(workout);

    // wire autosave
    ['wDate','wTime','wTitle','wType','wNotes'].forEach(id=>{
        const el = document.getElementById(id);
        if (el) el.addEventListener('input', ()=>{ markDirty(); updateWorkoutSaveHint('Unsaved changes‚Ä¶'); });
    });

    // Render existing exercises
    (workout.exercises||[]).forEach(ex => appendExerciseBlock(ex));

    if ((workout.exercises||[]).length === 0) addExerciseBlock();

    updateWorkoutSaveHint('Ready');
    installWorkoutKeyboardShortcut();
}

function updateWorkoutSaveHint(msg) {
    const el = document.getElementById('workoutSaveHint');
    if (el) el.textContent = msg;
}

function installWorkoutKeyboardShortcut() {
    const modal = document.getElementById('trainingModal');
    modal.onkeydown = (e) => {
        const isSave = (e.key === 's' || e.key === 'S') && (e.ctrlKey || e.metaKey);
        if (isSave) {
            e.preventDefault();
            const wid = modal.dataset.workoutId;
            if (wid) saveWorkoutFromModal(wid);
        }
    };
}

function addExerciseBlock() {
    const ex = {
        id: newId('ex'),
        name: '',
        isDumbbell: false,
        isBodyweight: false,
        superset: null,
        notes: '',
        sets: [{ id: newId('s'), type: 'Standard', reps: 0, weight: null, db_weight: null, completed: false }]
    };
    appendExerciseBlock(ex);
    markDirty();
}

function addSupersetPair() {
    const tag = prompt('Superset tag (e.g., A, B, C)?', 'A') || 'A';
    const ex1 = { id:newId('ex'), name:'', isDumbbell:false, isBodyweight:false, superset:tag, notes:'', sets:[{id:newId('s'), type:'Standard', reps:0, weight:null, completed:false}]};
    const ex2 = { id:newId('ex'), name:'', isDumbbell:false, isBodyweight:false, superset:tag, notes:'', sets:[{id:newId('s'), type:'Standard', reps:0, weight:null, completed:false}]};
    appendExerciseBlock(ex1);
    appendExerciseBlock(ex2);
    markDirty();
}

function appendExerciseBlock(ex) {
    const list = document.getElementById('exerciseBlocks');
    if (!list) return;

    const block = document.createElement('div');
    block.className = 'form-section';
    block.style.cssText = 'background: var(--bg-primary); border:1px solid var(--border); border-radius:12px; padding: 14px; margin-bottom:12px;';
    block.draggable = true;
    block.dataset.exId = ex.id;

    block.addEventListener('dragstart', (e)=>{ e.dataTransfer.setData('text/plain', ex.id); block.style.opacity='0.6'; });
    block.addEventListener('dragend', ()=>{ block.style.opacity='1'; });
    block.addEventListener('dragover', (e)=>{ e.preventDefault(); });
    block.addEventListener('drop', (e)=>{
        e.preventDefault();
        const fromId = e.dataTransfer.getData('text/plain');
        const toId = ex.id;
        if (fromId && toId && fromId !== toId) {
            reorderExerciseBlocks(fromId, toId);
            markDirty();
        }
    });

    const nameOptions = exerciseLibrary.items.map(n=>`<option value="${escapeAttr(n)}"></option>`).join('');
    const supersetVal = ex.superset ? escapeAttr(ex.superset) : '';

    block.innerHTML = `
        <div style="display:flex; justify-content:space-between; gap:10px; align-items:start; margin-bottom:10px;">
            <div style="flex:1;">
                <label class="required">Exercise</label>
                <input list="exerciseDatalist" type="text" id="exName_${ex.id}" value="${escapeAttr(ex.name||'')}" placeholder="Start typing‚Ä¶">
                <datalist id="exerciseDatalist">${nameOptions}</datalist>
                <div style="display:flex; gap:12px; flex-wrap:wrap; margin-top:8px; align-items:center;">
                    <label style="display:flex; gap:8px; align-items:center; color:var(--text-secondary); font-size:0.9em;">
                        <input type="checkbox" id="exDB_${ex.id}" ${ex.isDumbbell?'checked':''} style="width:auto;"> Dumbbell Exercise
                    </label>
                    <label style="display:flex; gap:8px; align-items:center; color:var(--text-secondary); font-size:0.9em;">
                        <input type="checkbox" id="exBW_${ex.id}" ${ex.isBodyweight?'checked':''} style="width:auto;"> Bodyweight Exercise
                    </label>
                    <label style="display:flex; gap:8px; align-items:center; color:var(--text-secondary); font-size:0.9em;">
                        Superset:
                        <input type="text" id="exSS_${ex.id}" value="${supersetVal}" placeholder="A" style="width:70px;">
                    </label>
                </div>
            </div>
            <div style="display:flex; gap:6px; align-items:center;">
                <button onclick="moveExerciseUp('${ex.id}')" style="padding:6px 10px;">‚Üë</button>
                <button onclick="moveExerciseDown('${ex.id}')" style="padding:6px 10px;">‚Üì</button>
                <button class="danger" onclick="removeExerciseBlock('${ex.id}')" style="padding:6px 10px;">√ó</button>
            </div>
        </div>

        <div>
            <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
                <h4 style="color: var(--accent-cyan);">Sets</h4>
                <button onclick="addSetRow('${ex.id}')" style="padding:6px 12px;">+ Set</button>
            </div>
            <div id="sets_${ex.id}" style="margin-top:8px;"></div>

            <div style="margin-top:10px;">
                <button onclick="toggleExerciseNotes('${ex.id}')" style="padding:6px 12px; background: var(--bg-tertiary);">üìù Notes</button>
                <div id="notes_${ex.id}" style="display:none; margin-top:10px;">
                    <textarea id="exNotes_${ex.id}" maxlength="500" rows="2" placeholder="Form cues, equipment, how it felt‚Ä¶">${escapeHtml(ex.notes||'')}</textarea>
                    <div style="color:var(--text-secondary); font-size:0.85em; margin-top:4px;">Max 500 chars ‚Ä¢ searchable in Overload tab (coming next)</div>
                </div>
            </div>
        </div>
    `;

    list.appendChild(block);

    // Render sets
    (ex.sets||[]).forEach(s => appendSetRow(ex.id, ex, s));

    // Hook changes
    document.getElementById(`exName_${ex.id}`).addEventListener('input', ()=>{ markDirty(); });
    document.getElementById(`exDB_${ex.id}`).addEventListener('change', ()=>{ markDirty(); rerenderSets(ex.id); });
    document.getElementById(`exBW_${ex.id}`).addEventListener('change', ()=>{ markDirty(); rerenderSets(ex.id); });
    document.getElementById(`exSS_${ex.id}`).addEventListener('input', ()=>{ markDirty(); });
    document.getElementById(`exNotes_${ex.id}`).addEventListener('input', ()=>{ markDirty(); });

    // Show previous session preview
    const name = ex.name || '';
    if (name) learnExercise(name);
}

function toggleExerciseNotes(exId) {
    const d = document.getElementById(`notes_${exId}`);
    if (!d) return;
    d.style.display = (d.style.display === 'none') ? 'block' : 'none';
}

function rerenderSets(exId) {
    // re-read block values then re-render set rows display hints (DB/BW fields)
    const block = document.querySelector(`[data-ex-id="${exId}"]`);
    if (!block) return;
    const setsDiv = document.getElementById(`sets_${exId}`);
    if (!setsDiv) return;

    // Collect current set DOM into draft then rerender
    const draft = collectExerciseFromDOM(exId);
    setsDiv.innerHTML = '';
    draft.sets.forEach(s => appendSetRow(exId, draft, s));
}

function appendSetRow(exId, exDraft, set) {
    const setsDiv = document.getElementById(`sets_${exId}`);
    if (!setsDiv) return;

    const row = document.createElement('div');
    row.dataset.setId = set.id;
    row.style.cssText = 'display:grid; grid-template-columns: 120px 1fr 1fr 1fr 110px 60px; gap:10px; align-items:center; margin-bottom:8px;';

    const type = set.type || 'Standard';
    const isDB = !!exDraft.isDumbbell;
    const isBW = !!exDraft.isBodyweight;

    // weight UI
    let weightCell = '';
    if (type === 'Drop Set') {
        weightCell = `<input type="text" id="sDrops_${set.id}" placeholder="225x8 -> 185x6 -> 135x10" value="${escapeAttr(formatDrops(set))}">`;
    } else if (type === 'Rest-Pause') {
        weightCell = `<input type="number" id="sWeight_${set.id}" step="0.5" placeholder="Weight" value="${set.weight ?? ''}">`;
    } else {
        if (isDB) {
            weightCell = `
                <div>
                    <input type="number" id="sDb_${set.id}" step="0.5" placeholder="Per DB" value="${set.db_weight ?? ''}">
                    <div style="font-size:0.75em; color:var(--text-secondary); margin-top:2px;">
                        Total: <span id="sTotal_${set.id}">‚Äî</span>
                    </div>
                </div>`;
        } else if (isBW) {
            const bw = latestBodyweight();
            weightCell = `
                <div>
                    <input type="text" disabled value="${bw ? ('BW ' + bw.toFixed(1)) : 'BW'}">
                    <div style="display:flex; gap:6px; margin-top:6px;">
                        <input type="number" id="sAssist_${set.id}" step="1" placeholder="Assist" value="${set.assistance ?? ''}">
                        <input type="number" id="sAdded_${set.id}" step="1" placeholder="+Wt" value="${set.added ?? ''}">
                    </div>
                </div>`;
        } else {
            weightCell = `<input type="number" id="sWeight_${set.id}" step="0.5" placeholder="Weight" value="${set.weight ?? ''}">`;
        }
    }

    // reps UI
    let repsCell = '';
    if (type === 'Rest-Pause') {
        repsCell = `<input type="text" id="sRP_${set.id}" placeholder="8+3+2" value="${escapeAttr(set.rest_pause || '')}">`;
    } else if (type === 'Drop Set') {
        repsCell = `<span style="color:var(--text-secondary); font-family:'Space Mono', monospace; font-size:0.85em;">(in drop string)</span>`;
    } else {
        repsCell = `<input type="number" id="sReps_${set.id}" step="1" placeholder="Reps" value="${set.reps ?? ''}">`;
    }

    row.innerHTML = `
        <select id="sType_${set.id}">
            ${['Standard','Drop Set','Rest-Pause','Warm-up'].map(t=>`<option ${t===type?'selected':''}>${t}</option>`).join('')}
        </select>
        ${repsCell}
        ${weightCell}
        <button onclick="startRest(90)" style="padding:6px 10px;">Rest</button>
        <label style="display:flex; gap:6px; align-items:center; color:var(--text-secondary); font-size:0.9em;">
            <input type="checkbox" id="sDone_${set.id}" ${set.completed!==false?'checked':''} style="width:auto;">Done
        </label>
        <button class="danger" onclick="removeSetRow('${exId}','${set.id}')" style="padding:6px 10px;">√ó</button>
    `;
    setsDiv.appendChild(row);

    // Wire change handlers
    const setTypeEl = document.getElementById(`sType_${set.id}`);
    setTypeEl.addEventListener('change', ()=>{ markDirty(); rerenderSets(exId); });

    ['sReps_','sWeight_','sDb_','sDrops_','sRP_','sAssist_','sAdded_','sDone_'].forEach(prefix=>{
        const el = document.getElementById(prefix + set.id);
        if (el) el.addEventListener('input', ()=>{ markDirty(); updateSetTotals(set.id); });
        if (el && el.type === 'checkbox') el.addEventListener('change', ()=>{ markDirty(); });
    });

    updateSetTotals(set.id);
}

function formatDrops(set) {
    if (!set.drops || !Array.isArray(set.drops)) return '';
    return set.drops.map(d=>`${d.weight}x${d.reps}`).join(' -> ');
}

function parseDrops(str) {
    // "225x8 -> 185x6 -> 135x10"
    const parts = String(str||'').split('->').map(s=>s.trim()).filter(Boolean);
    const drops = [];
    parts.forEach(p=>{
        const m = p.match(/(\d+(\.\d+)?)\s*x\s*(\d+)/i);
        if (m) drops.push({ weight: Number(m[1]), reps: Number(m[3]) });
    });
    return drops.length ? drops : null;
}

function updateSetTotals(setId) {
    const totalEl = document.getElementById(`sTotal_${setId}`);
    if (!totalEl) return;
    const db = Number(document.getElementById(`sDb_${setId}`)?.value);
    if (isFinite(db)) totalEl.textContent = (db*2).toFixed(1) + ' lbs';
    else totalEl.textContent = '‚Äî';
}

function addSetRow(exId) {
    const block = document.querySelector(`[data-ex-id="${exId}"]`);
    if (!block) return;
    const setsDiv = document.getElementById(`sets_${exId}`);
    if (!setsDiv) return;

    // append DOM row by re-render: collect existing exercise, add set, rerender
    const draft = collectExerciseFromDOM(exId);
    draft.sets.push({ id:newId('s'), type:'Standard', reps:0, weight:null, db_weight:null, completed:false });
    setsDiv.innerHTML = '';
    draft.sets.forEach(s=>appendSetRow(exId, draft, s));
    markDirty();
}

function removeSetRow(exId, setId) {
    const draft = collectExerciseFromDOM(exId);
    draft.sets = draft.sets.filter(s=>s.id!==setId);
    if (draft.sets.length===0) draft.sets=[{id:newId('s'), type:'Standard', reps:0, weight:null, completed:false}];
    const setsDiv = document.getElementById(`sets_${exId}`);
    setsDiv.innerHTML = '';
    draft.sets.forEach(s=>appendSetRow(exId, draft, s));
    markDirty();
}

function removeExerciseBlock(exId) {
    const el = document.querySelector(`[data-ex-id="${exId}"]`);
    if (el) el.remove();
    markDirty();
}

function moveExerciseUp(exId) {
    const el = document.querySelector(`[data-ex-id="${exId}"]`);
    if (!el || !el.previousElementSibling) return;
    el.parentElement.insertBefore(el, el.previousElementSibling);
    markDirty();
}

function moveExerciseDown(exId) {
    const el = document.querySelector(`[data-ex-id="${exId}"]`);
    if (!el || !el.nextElementSibling) return;
    el.parentElement.insertBefore(el.nextElementSibling, el);
    markDirty();
}

function reorderExerciseBlocks(fromId, toId) {
    const fromEl = document.querySelector(`[data-ex-id="${fromId}"]`);
    const toEl = document.querySelector(`[data-ex-id="${toId}"]`);
    if (!fromEl || !toEl) return;
    toEl.parentElement.insertBefore(fromEl, toEl);
}

function collectExerciseFromDOM(exId) {
    const name = document.getElementById(`exName_${exId}`)?.value || '';
    const isDumbbell = !!document.getElementById(`exDB_${exId}`)?.checked;
    const isBodyweight = !!document.getElementById(`exBW_${exId}`)?.checked;
    const superset = document.getElementById(`exSS_${exId}`)?.value || null;
    const notes = document.getElementById(`exNotes_${exId}`)?.value || '';
    learnExercise(name);

    const setsDiv = document.getElementById(`sets_${exId}`);
    const sets = [];
    if (setsDiv) {
        setsDiv.querySelectorAll('[data-set-id]').forEach(row=>{
            const sid = row.dataset.setId;
            const type = document.getElementById(`sType_${sid}`)?.value || 'Standard';
            const completed = document.getElementById(`sDone_${sid}`)?.checked ?? true;

            let reps = Number(document.getElementById(`sReps_${sid}`)?.value || 0);
            let weight = document.getElementById(`sWeight_${sid}`)?.value;
            weight = (weight === '' || weight === undefined) ? null : Number(weight);
            let db_weight = document.getElementById(`sDb_${sid}`)?.value;
            db_weight = (db_weight === '' || db_weight === undefined) ? null : Number(db_weight);

            const rest_pause = document.getElementById(`sRP_${sid}`)?.value || null;
            const dropsStr = document.getElementById(`sDrops_${sid}`)?.value || null;
            const drops = dropsStr ? parseDrops(dropsStr) : null;

            let assistance = document.getElementById(`sAssist_${sid}`)?.value;
            assistance = (assistance === '' || assistance === undefined) ? null : Number(assistance);

            let added = document.getElementById(`sAdded_${sid}`)?.value;
            added = (added === '' || added === undefined) ? null : Number(added);

            sets.push({ id: sid, type, reps, weight, db_weight, rest_pause, drops, assistance, added, completed });
        });
    }

    return { id: exId, name, isDumbbell, isBodyweight, superset: superset || null, notes, sets };
}

function saveWorkoutFromModal(existingId) {
    const btn = document.getElementById('saveWorkoutBtn');
    if (btn) { btn.disabled = true; btn.textContent = 'Saving‚Ä¶'; }

    try {
        const modal = document.getElementById('trainingModal');
        const date = document.getElementById('wDate')?.value;
        if (!date) throw new Error('Date is required.');

        // collect workout
        const w = {
            id: existingId || newId('w'),
            date,
            startTime: (document.getElementById('wTime')?.value || '').trim() || null,
            title: (document.getElementById('wTitle')?.value || '').trim() || null,
            type: document.getElementById('wType')?.value || 'Workout',
            notes: (document.getElementById('wNotes')?.value || '').trim(),
            exercises: []
        };

        document.querySelectorAll('#exerciseBlocks [data-ex-id]').forEach(block=>{
            const exId = block.dataset.exId;
            const ex = collectExerciseFromDOM(exId);
            if (!ex.name.trim()) return;
            // validation: at least one set with reps
            w.exercises.push(ex);
        });

        if (w.exercises.length === 0) throw new Error('Add at least 1 exercise with a name.');

        // Save into store (allow multiple per day)
        trainingStore.workouts = (trainingStore.workouts || []).filter(x=>x.id !== w.id);
        trainingStore.workouts.push(w);
        trainingStore.workouts.sort((a,b)=> (a.date + (a.startTime||'' )).localeCompare(b.date + (b.startTime||'')));

        saveTraining();
        markDirty(); // ensures persistAll also saves body data status badge
        __dirty = false;
        __lastSavedAt = new Date();
        updateSaveIndicator('Saved ‚úì');

        showToast('Workout Saved Successfully ‚úì');
        hideTrainingModal();
        updateTrainingTab();
        updateProgressiveTab(); // refresh overload insights
    } catch (err) {
        showToast(`Save failed: ${err.message || err}`, true);
    } finally {
        if (btn) { btn.disabled = false; btn.textContent = 'Save Workout'; }
    }
}

function deleteWorkout(id) {
    if (!confirm('Delete this workout?')) return;
    trainingStore.workouts = (trainingStore.workouts || []).filter(w=>w.id!==id);
    saveTraining();
    markDirty();
    updateTrainingTab();
    updateProgressiveTab();
    showToast('Workout deleted');
}

// ----- Templates -----
function saveWorkoutAsTemplate(workoutId) {
    try {
        // collect current modal workout as template
        const name = prompt('Template name?', 'My Template');
        if (!name) return;

        const w = {
            id: newId('tpl'),
            name: name.trim(),
            created_at: _nowIso(),
            workout: {
                title: (document.getElementById('wTitle')?.value || '').trim() || null,
                type: document.getElementById('wType')?.value || 'Workout',
                exercises: []
            }
        };

        document.querySelectorAll('#exerciseBlocks [data-ex-id]').forEach(block=>{
            const exId = block.dataset.exId;
            const ex = collectExerciseFromDOM(exId);
            if (!ex.name.trim()) return;
            // remove set completion state for template
            ex.sets = (ex.sets||[]).map(s=>({ ...s, completed:false }));
            w.workout.exercises.push(ex);
        });

        workoutTemplates.templates.push(w);
        saveTemplates();
        markDirty();
        showToast('Template saved ‚úì');
    } catch (e) {
        showToast('Template save failed', true);
    }
}

function openTemplateManager() {
    const modal = document.getElementById('trainingModal');
    const rows = workoutTemplates.templates.map(t=>`
        <div style="background: var(--bg-tertiary); padding: 12px; border-radius: 10px; margin-bottom: 10px; display:flex; justify-content:space-between; align-items:center; gap:10px;">
            <div>
                <div style="font-weight:700; color: var(--accent-cyan);">${escapeHtml(t.name)}</div>
                <div style="color: var(--text-secondary); font-size:0.85em; font-family:'Space Mono', monospace;">${t.created_at?.slice(0,10) || ''}</div>
            </div>
            <div style="display:flex; gap:8px; flex-wrap:wrap;">
                <button onclick="applyTemplate('${t.id}')" class="primary" style="padding:6px 12px;">Apply</button>
                <button onclick="renameTemplate('${t.id}')" style="padding:6px 12px;">Rename</button>
                <button class="danger" onclick="deleteTemplate('${t.id}')" style="padding:6px 12px;">√ó</button>
            </div>
        </div>
    `).join('');

    modal.innerHTML = `
        <div class="modal">
            <h2>Workout Templates</h2>
            <p style="color: var(--text-secondary); margin-bottom: 12px;">Apply templates to plan today‚Äôs workout. Templates store exercises + set structure.</p>
            <div style="max-height:55vh; overflow:auto;">${rows || `<p style="color:var(--text-secondary);">No templates yet. Save one from a workout.</p>`}</div>
            <div style="display:flex; gap:10px; margin-top: 18px;">
                <button onclick="hideTrainingModal()">Close</button>
            </div>
        </div>
    `;
    modal.classList.add('show');
}

function applyTemplate(tplId) {
    const t = workoutTemplates.templates.find(x=>x.id===tplId);
    if (!t) return;
    hideTrainingModal();
    const date = new Date().toISOString().split('T')[0];
    const w = {
        id: newId('w'),
        date,
        startTime: null,
        title: t.workout.title || t.name,
        type: t.workout.type || 'Workout',
        notes: '',
        exercises: (t.workout.exercises||[]).map(ex=>({
            ...ex,
            id: newId('ex'),
            sets: (ex.sets||[]).map(s=>({ ...s, id:newId('s'), completed:false }))
        }))
    };
    const modal = document.getElementById('trainingModal');
    modal.innerHTML='';
    renderWorkoutModal(w, true);
    modal.classList.add('show');
}

function renameTemplate(tplId) {
    const t = workoutTemplates.templates.find(x=>x.id===tplId);
    if (!t) return;
    const name = prompt('New template name:', t.name);
    if (!name) return;
    t.name = name.trim();
    saveTemplates();
    markDirty();
    openTemplateManager();
}

function deleteTemplate(tplId) {
    if (!confirm('Delete template?')) return;
    workoutTemplates.templates = workoutTemplates.templates.filter(x=>x.id!==tplId);
    saveTemplates();
    markDirty();
    openTemplateManager();
}

// ----- Live Mode -----
function toggleLiveMode() {
    liveMode.running = !liveMode.running;
    if (liveMode.running) {
        liveMode.startTs = Date.now();
        liveMode.elapsedTimer = setInterval(()=>{
            liveMode.elapsedSec = Math.floor((Date.now() - liveMode.startTs)/1000);
            renderLiveModeBar();
        }, 1000);
        showToast('Live Mode started');
    } else {
        if (liveMode.elapsedTimer) clearInterval(liveMode.elapsedTimer);
        liveMode.elapsedTimer = null;
        liveMode.elapsedSec = 0;
        liveMode.startTs = null;
        showToast('Live Mode stopped');
        renderLiveModeBar();
    }
}

function startRest(seconds) {
    const sec = Number(seconds||90);
    liveMode.restUntil = Date.now() + (sec*1000);
    if (liveMode.restTimer) clearInterval(liveMode.restTimer);
    liveMode.restTimer = setInterval(()=>{
        const left = Math.max(0, Math.ceil((liveMode.restUntil - Date.now())/1000));
        if (left <= 0) {
            clearInterval(liveMode.restTimer);
            liveMode.restTimer = null;
            liveMode.restUntil = null;
            if (navigator.vibrate) navigator.vibrate([200,100,200]);
            showToast('Rest complete ‚úì');
        }
        renderLiveModeBar();
    }, 500);
    renderLiveModeBar();
}

function renderLiveModeBar() {
    const el = document.getElementById('liveModeBar');
    if (!el) return;
    const fmt = (s)=>`${Math.floor(s/60)}:${String(s%60).padStart(2,'0')}`;
    const elapsed = liveMode.running ? fmt(liveMode.elapsedSec) : '0:00';
    let rest = '';
    if (liveMode.restUntil) {
        const left = Math.max(0, Math.ceil((liveMode.restUntil - Date.now())/1000));
        rest = ` ‚Ä¢ Rest: <b>${fmt(left)}</b>`;
    }
    el.innerHTML = `<div style="font-family:'Space Mono', monospace; color: var(--text-secondary);">
        ‚è± Elapsed: <b>${elapsed}</b>${rest}
    </div>`;
}

// ----- Health stats card (dashboard) -----
function updateHealthStatsCard() {
    const el = document.getElementById('healthStatsContent');
    if (!el) return;
    const sorted = bodyData.slice().sort((a,b)=>a.date.localeCompare(b.date));
    const last7 = sorted.slice(-7);
    const avg = (arr, key) => {
        const vals = arr.map(x=>x[key]).filter(v=>isFinite(v));
        if (!vals.length) return null;
        return vals.reduce((a,b)=>a+b,0)/vals.length;
    };
    const metrics = [
        { key:'steps', label:'Steps', fmt:(v)=>v?Math.round(v).toLocaleString():'‚Äî' },
        { key:'rhr', label:'RHR (bpm)', fmt:(v)=>v?Math.round(v).toString():'‚Äî' },
        { key:'sleep_score', label:'Sleep Score', fmt:(v)=>v?Math.round(v).toString():'‚Äî' },
        { key:'sleep_duration_hrs', label:'Sleep (hrs)', fmt:(v)=>v?v.toFixed(1):'‚Äî' },
    ];
    const rows = metrics.map(m=>{
        const all = avg(sorted, m.key);
        const r7 = avg(last7, m.key);
        const trend = (all && r7) ? ((r7 - all)/all) : null;
        const good = trend !== null && ((m.key==='rhr') ? (r7 < all) : (r7 > all));
        const equal = trend !== null && Math.abs(trend) <= 0.02;
        const icon = trend===null ? '‚Üí' : (equal ? '‚Üí' : (good ? '‚úì' : '‚Üì'));
        const color = trend===null ? 'var(--text-secondary)' : (equal ? 'var(--text-secondary)' : (good ? 'var(--accent-success)' : 'var(--accent-danger)'));
        return `<tr>
            <td>${m.label}</td>
            <td style="font-family:'Space Mono', monospace;">${all!==null?m.fmt(all):'‚Äî'}</td>
            <td style="font-family:'Space Mono', monospace; color:${color};">${r7!==null?m.fmt(r7):'‚Äî'} ${icon}</td>
        </tr>`;
    }).join('');
    el.innerHTML = `
        <div class="table-container" style="max-height:none;">
            <table>
                <thead><tr><th>Metric</th><th>All-Time</th><th>Last 7 Days</th></tr></thead>
                <tbody>${rows}</tbody>
            </table>
        </div>
        <div style="margin-top:10px; color: var(--text-secondary); font-size:0.85em;">
            ‚úì indicates improvement (lower RHR is better; higher steps/sleep is better). Within ¬±2% shows ‚Üí.
        </div>
    `;
}

// Hook training functions into existing tab navigation
const __oldSwitchMainTab = window.switchMainTab;
window.switchMainTab = function(tabName) {
    __oldSwitchMainTab(tabName);
    if (tabName === 'training') updateTrainingTab();
    if (tabName === 'progressive') updateProgressiveTab();
};

// ===== END TRAINING TAB (v12) =====

        // ===== CORRELATIONS TAB =====
        
        function updateCorrelationsTab() {
            const el = document.getElementById('correlationsContent');
            if (!el) return;
            // Ensure training data exists in this view (v15 stores workouts in trainingStore.workouts)
            const trainingLog = (typeof trainingStore !== 'undefined' && trainingStore && Array.isArray(trainingStore.workouts))
                ? trainingStore.workouts
                : ((typeof window !== 'undefined' && Array.isArray(window.trainingLog)) ? window.trainingLog : []);
            try {

            const sorted = bodyData.slice().sort((a, b) => a.date.localeCompare(b.date));
            
            if (sorted.length < 14) {
                document.getElementById('correlationsContent').innerHTML = `
                    <div style="background: var(--bg-tertiary); padding: 30px; border-radius: 10px; text-align: center;">
                        <h3 style="color: var(--accent-purple); margin-bottom: 15px;">üîç Not Enough Data Yet</h3>
                        <p style="color: var(--text-secondary);">
                            Need at least 14 days of data to show meaningful correlations.<br>
                            You have ${sorted.length} days - keep tracking!
                        </p>
                    </div>
                `;
                return;
            }
            
            // Calculate correlations
            const withNutrition = sorted.filter(d => d.calories && d.protein);
            const recent30 = sorted.slice(-30);
            
            // Fat loss correlation with protein intake
            let proteinCorrelation = 'Unknown';
            if (withNutrition.length >= 14) {
                const avgProtein = withNutrition.reduce((sum, d) => sum + d.protein, 0) / withNutrition.length;
                const latest = withNutrition[withNutrition.length - 1];
                const proteinPerLb = latest.lean_lbs ? avgProtein / latest.lean_lbs : 0;
                
                if (proteinPerLb >= 1.0) {
                    proteinCorrelation = 'Excellent';
                } else if (proteinPerLb >= 0.8) {
                    proteinCorrelation = 'Good';
                } else if (proteinPerLb >= 0.6) {
                    proteinCorrelation = 'Fair';
                } else {
                    proteinCorrelation = 'Low';
                }
            }
            
            // Calculate fat loss rate
            const first = recent30[0];
            const last = recent30[recent30.length - 1];
            const fatLost = (first.weight * first.bf_percent / 100) - (last.weight * last.bf_percent / 100);
            const leanChange = last.lean_lbs - first.lean_lbs;
            const daysSpan = recent30.length;
            const fatLossRate = (fatLost / daysSpan) * 7;
            
            // Sleep correlation
            const withSleep = recent30.filter(d => d.sleep_duration_hrs);
            let avgSleep = 0;
            if (withSleep.length > 0) {
                avgSleep = withSleep.reduce((sum, d) => sum + d.sleep_duration_hrs, 0) / withSleep.length;
            }
            
            // Steps correlation
            const withSteps = recent30.filter(d => d.steps);
            let avgSteps = 0;
            if (withSteps.length > 0) {
                avgSteps = withSteps.reduce((sum, d) => sum + d.steps, 0) / withSteps.length;
            }
            
            const html = `
                <div class="grid grid-2">
                    <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 10px;">
                        <h3 style="color: var(--accent-purple); margin-bottom: 15px;">üìâ Fat Loss Progress (Last 30 Days)</h3>
                        <div class="nutrition-card">
                            <div class="nutrition-label">Fat Loss Rate</div>
                            <div class="nutrition-value">${fatLossRate.toFixed(2)} lbs/week</div>
                        </div>
                        <div class="nutrition-card">
                            <div class="nutrition-label">Total Fat Lost</div>
                            <div class="nutrition-value">${fatLost.toFixed(1)} lbs</div>
                        </div>
                        <div class="nutrition-card">
                            <div class="nutrition-label">Lean Mass Change</div>
                            <div class="nutrition-value" style="color: ${leanChange >= 0 ? 'var(--accent-success)' : 'var(--accent-danger)'}">
                                ${leanChange >= 0 ? '+' : ''}${leanChange.toFixed(1)} lbs
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 10px;">
                        <h3 style="color: var(--accent-purple); margin-bottom: 15px;">ü•© Protein Intake Analysis</h3>
                        <div class="nutrition-card">
                            <div class="nutrition-label">Protein Status</div>
                            <div class="nutrition-value" style="font-size: 1.3em; color: ${
                                proteinCorrelation === 'Excellent' ? 'var(--accent-success)' :
                                proteinCorrelation === 'Good' ? 'var(--accent-cyan)' :
                                proteinCorrelation === 'Fair' ? 'var(--accent-warning)' : 'var(--accent-danger)'
                            }">
                                ${proteinCorrelation}
                            </div>
                        </div>
                        <p style="color: var(--text-secondary); font-size: 0.9em; margin-top: 10px;">
                            ${proteinCorrelation === 'Excellent' ? 'Great job! Your protein intake is supporting lean mass retention.' :
                              proteinCorrelation === 'Good' ? 'Good protein intake. Consider increasing slightly for better muscle retention.' :
                              proteinCorrelation === 'Fair' ? 'Protein is adequate but could be higher for optimal muscle retention.' :
                              'Consider increasing protein intake to preserve lean mass during fat loss.'}
                        </p>
                    </div>
                </div>
                
                <div class="grid grid-2" style="margin-top: 20px;">
                    <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 10px;">
                        <h3 style="color: var(--accent-purple); margin-bottom: 15px;">üò¥ Sleep Analysis</h3>
                        <div class="nutrition-card">
                            <div class="nutrition-label">Average Sleep</div>
                            <div class="nutrition-value">${avgSleep > 0 ? avgSleep.toFixed(1) + ' hrs' : 'No data'}</div>
                        </div>
                        ${avgSleep > 0 ? `
                        <p style="color: var(--text-secondary); font-size: 0.9em; margin-top: 10px;">
                            ${avgSleep >= 7.5 ? '‚úÖ Excellent sleep duration supports recovery and fat loss.' :
                              avgSleep >= 6.5 ? '‚ö†Ô∏è Sleep is adequate but could be improved for better results.' :
                              '‚ùå Sleep duration is low. Aim for 7-9 hours for optimal recovery.'}
                        </p>
                        ` : ''}
                    </div>
                    
                    <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 10px;">
                        <h3 style="color: var(--accent-purple); margin-bottom: 15px;">üö∂ Activity Level</h3>
                        <div class="nutrition-card">
                            <div class="nutrition-label">Average Daily Steps</div>
                            <div class="nutrition-value">${avgSteps > 0 ? Math.round(avgSteps).toLocaleString() : 'No data'}</div>
                        </div>
                        ${avgSteps > 0 ? `
                        <p style="color: var(--text-secondary); font-size: 0.9em; margin-top: 10px;">
                            ${avgSteps >= 10000 ? '‚úÖ Excellent activity level! This supports your fat loss goals.' :
                              avgSteps >= 7500 ? 'üëç Good activity level. Consider increasing to 10k+ for faster progress.' :
                              avgSteps >= 5000 ? '‚ö†Ô∏è Moderate activity. Increasing steps could accelerate fat loss.' :
                              '‚ùå Low activity. Increasing daily movement would help with fat loss.'}
                        </p>
                        ` : ''}
                    </div>
                </div>
                
                ${trainingLog.length > 0 ? `
                <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 10px; margin-top: 20px;">
                    <h3 style="color: var(--accent-purple); margin-bottom: 15px;">üèãÔ∏è Training Frequency</h3>
                    <div class="nutrition-card">
                        <div class="nutrition-label">Total Workouts Logged</div>
                        <div class="nutrition-value">${trainingLog.length}</div>
                    </div>
                    <p style="color: var(--text-secondary); font-size: 0.9em; margin-top: 10px;">
                        ${trainingLog.length >= 20 ? 'üî• Excellent training consistency! Keep it up!' :
                          trainingLog.length >= 10 ? 'üí™ Good training frequency. Stay consistent!' :
                          'üìà Building training history. Consistency is key for results!'}
                    </p>
                </div>
                ` : `
                <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 10px; margin-top: 20px; text-align: center;">
                    <h3 style="color: var(--accent-purple); margin-bottom: 15px;">üèãÔ∏è No Training Data Yet</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 15px;">
                        Start logging workouts to see training correlations with body composition changes.
                    </p>
                    <button onclick="switchMainTab('training'); this.blur();" class="primary">Go to Training Log</button>
                </div>
                `}
                
                <div style="background: rgba(6, 182, 212, 0.1); padding: 20px; border-radius: 10px; margin-top: 20px; border-left: 4px solid var(--accent-cyan);">
                    <h3 style="color: var(--accent-cyan); margin-bottom: 10px;">üí° Key Insights</h3>
                    <ul style="color: var(--text-secondary); line-height: 1.8;">
                        <li>You're losing ${fatLossRate.toFixed(2)} lbs of fat per week on average</li>
                        <li>Lean mass change: ${leanChange >= 0 ? 'gaining' : 'losing'} ${Math.abs(leanChange).toFixed(1)} lbs (${leanChange >= -1 ? 'good retention' : 'consider increasing protein'})</li>
                        ${avgSleep > 0 ? `<li>Average sleep: ${avgSleep.toFixed(1)} hours (${avgSleep >= 7.5 ? 'optimal' : 'could improve'})</li>` : ''}
                        ${avgSteps > 0 ? `<li>Daily steps: ${Math.round(avgSteps).toLocaleString()} (${avgSteps >= 10000 ? 'excellent' : 'room for improvement'})</li>` : ''}
                        <li>Keep tracking consistently for more detailed correlations</li>
                    </ul>
                </div>
            `;
            
            document.getElementById('correlationsContent').innerHTML = html;
        
            } catch (e) {
                console.error('Correlations & Insights error:', e);

                el.innerHTML = `
                    <div style="background: var(--bg-tertiary); padding: 24px; border-radius: 12px; border-left: 4px solid var(--accent-danger);">
                        <h3 style="margin:0 0 8px 0; color: var(--accent-danger);">‚ö†Ô∏è Correlations temporarily unavailable</h3>
                        <div style="color: var(--text-secondary); line-height: 1.5;">
                            Something went wrong while building this view. Your data is safe.
                            <br><span style="opacity:.9;">Open the browser console to see details.</span>
                        </div>
                    </div>
                `;
            }
        }

function escapeHTML(str) {
            if (str === null || str === undefined) return '';
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

// ===== UTILITY FUNCTIONS =====

function escapeHtml(str) {
    return String(str ?? '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}
function escapeAttr(str) {
    return escapeHtml(str).replace(/`/g,'&#96;');
}

        
        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast show';
            if (isError) toast.classList.add('error');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
        
        function debugData() {
            console.log('=== BODY TRACKER DEBUG ===');
            console.log('Total entries:', bodyData.length);
            console.log('Storage key:', STORAGE_KEY);
            console.log('Goals:', GOALS);
            console.log('Integrity config:', INTEGRITY_CONFIG);
            console.log('Data sample:', bodyData.slice(0, 3));
            console.log('Latest entry:', bodyData[bodyData.length - 1]);
            
            // Integrity distribution
            const integrityCount = bodyData.reduce((acc, e) => {
                acc[e.integrity_status || 'unknown'] = (acc[e.integrity_status || 'unknown'] || 0) + 1;
                return acc;
            }, {});
            console.log('Integrity distribution:', integrityCount);
            
            // Residual stats
            const residuals = bodyData.filter(e => e.residual !== undefined).map(e => e.residual);
            if (residuals.length > 0) {
                const avgResidual = residuals.reduce((sum, r) => sum + r, 0) / residuals.length;
                const minResidual = Math.min(...residuals);
                const maxResidual = Math.max(...residuals);
                console.log('Residual stats:', {
                    avg: avgResidual.toFixed(2),
                    min: minResidual.toFixed(2),
                    max: maxResidual.toFixed(2),
                    range: (maxResidual - minResidual).toFixed(2)
                });
            }
            
            showToast('Debug info logged to console\n(Press F12 to view)');
        }
        
        
        // ===== SETTINGS + FORMULA DOCS + ANALYTICS (V13) =====
        const SETTINGS_KEY = 'btpSettings';
        const PR_KEY = 'btpPersonalRecords_v1';

        const DEFAULT_SETTINGS = {
            nutrition: { target_calories: 1800, target_protein: 195, target_fat: 60, target_carbs: 80 },
            body: { target_bf_lbs: 20.0, target_bf_percent: 10.0, target_weight: 215.0 },
            workout: { default_rest_seconds: 90, warmup_excluded: true, show_est_1rm: true },
            display: { units: 'lbs', date_format: 'YYYY-MM-DD', compact_tables: false, show_water_overlay: true },
            sync: { auto_pull_seconds: 60, auto_push: false }
        };

        let appSettings = null;
        let personalRecords = null;

        function loadSettings() {
            const stored = localStorage.getItem(SETTINGS_KEY);
            if (stored) {
                try { appSettings = JSON.parse(stored); } catch { appSettings = null; }
            }
            if (!appSettings) appSettings = JSON.parse(JSON.stringify(DEFAULT_SETTINGS));
            // merge defaults
            appSettings = deepMerge(JSON.parse(JSON.stringify(DEFAULT_SETTINGS)), appSettings);
            saveSettings(false);
        }

        function saveSettings(showToastMsg=true) {
            localStorage.setItem(SETTINGS_KEY, JSON.stringify(appSettings));
            // Apply to GOALS object if those fields exist
            GOALS.target_weight = appSettings.body.target_weight;
            GOALS.target_bf_percent = appSettings.body.target_bf_percent;
            GOALS.target_bf_lbs = appSettings.body.target_bf_lbs;
            GOALS.target_calories = appSettings.nutrition.target_calories;
            GOALS.target_protein = appSettings.nutrition.target_protein;
            GOALS.target_fat = appSettings.nutrition.target_fat;
            GOALS.target_carbs = appSettings.nutrition.target_carbs;
            if (showToastMsg) showToast('Settings saved');
        }

        function deepMerge(target, source) {
            if (typeof target !== 'object' || target === null) return source;
            if (typeof source !== 'object' || source === null) return target;
            for (const k of Object.keys(source)) {
                if (source[k] && typeof source[k] === 'object' && !Array.isArray(source[k])) {
                    target[k] = deepMerge(target[k] || {}, source[k]);
                } else {
                    target[k] = source[k];
                }
            }
            return target;
        }

        function openSettings() {
            loadSettings();
            const modal = document.getElementById('settingsModal');
            modal.innerHTML = `
              <div class="modal">
                <h2>‚öôÔ∏è Settings & Preferences</h2>
                <div class="integrity-notice">
                  <h4>Persistent Settings</h4>
                  <p>These preferences are stored locally (btpSettings) and apply immediately.</p>
                </div>

                <div class="form-section">
                  <h3>Nutrition Targets</h3>
                  <div class="form-grid">
                    <div class="form-field"><label>Target Calories</label><input type="number" id="setCals" value="${appSettings.nutrition.target_calories}"></div>
                    <div class="form-field"><label>Target Protein (g)</label><input type="number" id="setPro" value="${appSettings.nutrition.target_protein}"></div>
                    <div class="form-field"><label>Target Fat (g)</label><input type="number" id="setFat" value="${appSettings.nutrition.target_fat}"></div>
                    <div class="form-field"><label>Target Carbs (g)</label><input type="number" id="setCarb" value="${appSettings.nutrition.target_carbs}"></div>
                  </div>
                </div>

                <div class="form-section">
                  <h3>Body Composition Goals</h3>
                  <div class="form-grid">
                    <div class="form-field"><label>Target BF lbs</label><input type="number" step="0.1" id="setBfLbs" value="${appSettings.body.target_bf_lbs}"></div>
                    <div class="form-field"><label>Target BF %</label><input type="number" step="0.1" id="setBfPct" value="${appSettings.body.target_bf_percent}"></div>
                    <div class="form-field"><label>Target Weight</label><input type="number" step="0.1" id="setWgt" value="${appSettings.body.target_weight}"></div>
                  </div>
                </div>

                <div class="form-section">
                  <h3>Workout Preferences</h3>
                  <div class="form-grid">
                    <div class="form-field"><label>Default Rest (sec)</label><input type="number" id="setRest" value="${appSettings.workout.default_rest_seconds}"></div>
                    <div class="form-field"><label><input type="checkbox" id="setShow1rm" ${appSettings.workout.show_est_1rm?'checked':''} style="width:auto; margin-right:8px;">Show estimated 1RM</label></div>
                  </div>
                </div>

                <div class="form-section">
                  <h3>Display Preferences</h3>
                  <div class="form-grid">
                    <div class="form-field"><label><input type="checkbox" id="setWater" ${appSettings.display.show_water_overlay?'checked':''} style="width:auto; margin-right:8px;">Show Water % overlay tab</label></div>
                    <div class="form-field"><label><input type="checkbox" id="setCompact" ${appSettings.display.compact_tables?'checked':''} style="width:auto; margin-right:8px;">Compact tables</label></div>
                  </div>
                </div>

                <div class="form-section">
                  <h3>Data Management</h3>
                  <div style="display:flex; gap:10px; flex-wrap: wrap;">
                    <button onclick="exportBackup()" style="background: var(--accent-cyan);">üíæ Backup JSON</button>
                    <button onclick="exportCSV()">üì• Export CSV</button>
                    <button class="danger" onclick="resetTrainingOnly()">Reset Training Only</button>
                    <button class="danger" onclick="resetAllAppData()">Reset ALL Data</button>
                  </div>
                  <div style="font-size:0.85em; color: var(--text-secondary); margin-top: 8px;">
                    Reset actions affect only this device unless you use Sync.
                  </div>
                </div>

                <div style="display:flex; gap: 10px; flex-wrap:wrap; margin-top: 18px;">
                  <button class="primary" onclick="applySettings()">Save & Apply</button>
                  <button onclick="closeSettings()">Close</button>
                </div>
              </div>
            `;
            modal.classList.add('show');
          }

        function applySettings() {
            appSettings.nutrition.target_calories = Number(document.getElementById('setCals').value) || DEFAULT_SETTINGS.nutrition.target_calories;
            appSettings.nutrition.target_protein = Number(document.getElementById('setPro').value) || DEFAULT_SETTINGS.nutrition.target_protein;
            appSettings.nutrition.target_fat = Number(document.getElementById('setFat').value) || DEFAULT_SETTINGS.nutrition.target_fat;
            appSettings.nutrition.target_carbs = Number(document.getElementById('setCarb').value) || DEFAULT_SETTINGS.nutrition.target_carbs;
            appSettings.body.target_bf_lbs = Number(document.getElementById('setBfLbs').value) || DEFAULT_SETTINGS.body.target_bf_lbs;
            appSettings.body.target_bf_percent = Number(document.getElementById('setBfPct').value) || DEFAULT_SETTINGS.body.target_bf_percent;
            appSettings.body.target_weight = Number(document.getElementById('setWgt').value) || DEFAULT_SETTINGS.body.target_weight;
            appSettings.workout.default_rest_seconds = Number(document.getElementById('setRest').value) || DEFAULT_SETTINGS.workout.default_rest_seconds;
            appSettings.workout.show_est_1rm = !!document.getElementById('setShow1rm').checked;
            appSettings.display.show_water_overlay = !!document.getElementById('setWater').checked;
            appSettings.display.compact_tables = !!document.getElementById('setCompact').checked;
            saveSettings(true);
            updateStats(); updateTable(); updateChart();
            closeSettings();
        }

        function closeSettings() { document.getElementById('settingsModal').classList.remove('show'); }

        function resetTrainingOnly() {
            if (!confirm('Reset training only on this device?')) return;
            try { localStorage.removeItem(TRAINING_KEY); } catch {}
            try { localStorage.removeItem('workoutTemplates_User1_v6'); } catch {}
            try { localStorage.removeItem('exerciseLibrary_User1_v7'); } catch {}
            trainingLog = [];
            updateTrainingTab();
            showToast('Training reset');
        }

        function resetAllAppData() {
            if (!confirm('Reset ALL tracker data on this device?')) return;
            localStorage.clear();
            location.reload();
        }

        
        // ===== BULK EDIT / IMPORT (V13) =====
        function openBulkEdit() {
            const modal = document.getElementById('settingsModal');
            if (!modal) { showToast('Settings modal not available', true); return; }
            const sorted = bodyData.slice().sort((a,b)=>a.date.localeCompare(b.date));
            const header = ['date','weight','bf_percent','lean_lbs','water_percent','calories','protein','fat','carbs','steps','rhr','sleep_score','sleep_duration_hrs','refeed','notes'];
            const lines = [header.join(',')].concat(sorted.map(e=>header.map(k=>{
                const v = e[k];
                if (k==='notes') return `"${String(v||'').replace(/"/g,'""')}"`;
                if (k==='refeed') return e.refeed ? 'Yes' : 'No';
                return (v==null || v===undefined) ? '' : v;
            }).join(',')));
            modal.innerHTML = `
              <div class="modal">
                <h2>üßæ Bulk Edit Body Data</h2>
                <div class="integrity-notice">
                  <h4>Paste / Edit CSV</h4>
                  <p>Edit the CSV below and click Apply. Your data will be re-parsed and validated.</p>
                </div>
                <div class="form-section">
                  <textarea id="bulkCsv" rows="14" style="width:100%; background: var(--bg-primary); color: var(--text-primary); border:1px solid var(--border); border-radius:10px; padding:12px; font-family:'Space Mono', monospace; font-size:0.8em;">${lines.join('\n')}</textarea>
                  <div style="color: var(--text-secondary); font-size:0.85em; margin-top:8px;">
                    Tip: Leave blanks for unknown values. Dates must be YYYY-MM-DD.
                  </div>
                </div>
                <div style="display:flex; gap:10px; flex-wrap:wrap;">
                  <button class="primary" onclick="applyBulkCsv()">Apply CSV</button>
                  <button onclick="closeSettings()">Close</button>
                </div>
              </div>
            `;
            modal.classList.add('show');
        }

        function parseCsvLine(line) {
            // basic CSV parser handling quotes
            const out=[]; let cur=''; let inQ=false;
            for (let i=0;i<line.length;i++){
                const ch=line[i];
                if (ch === '"') {
                    if (inQ && line[i+1]==='"') { cur+='"'; i++; }
                    else inQ=!inQ;
                } else if (ch===',' && !inQ) { out.push(cur); cur=''; }
                else cur+=ch;
            }
            out.push(cur);
            return out;
        }

        function applyBulkCsv() {
            const ta = document.getElementById('bulkCsv');
            if (!ta) return;
            const text = ta.value.trim();
            const lines = text.split(/\r?\n/).filter(l=>l.trim().length);
            if (lines.length < 2) { showToast('CSV needs header + rows', true); return; }
            const header = parseCsvLine(lines[0]).map(h=>h.trim());
            const required = ['date','weight','bf_percent','lean_lbs'];
            for (const r of required){ if (!header.includes(r)) { showToast(`Missing required column: ${r}`, true); return; } }
            const rows = [];
            for (let i=1;i<lines.length;i++){
                const cols = parseCsvLine(lines[i]);
                const row = {};
                header.forEach((h, idx)=> row[h] = (cols[idx]!==undefined ? cols[idx] : ''));
                const e = {
                    date: row.date.trim(),
                    weight: row.weight===''? null : Number(row.weight),
                    bf_percent: row.bf_percent===''? null : Number(row.bf_percent),
                    lean_lbs: row.lean_lbs===''? null : Number(row.lean_lbs),
                    water_percent: row.water_percent===''? null : Number(row.water_percent),
                    calories: row.calories===''? null : Number(row.calories),
                    protein: row.protein===''? null : Number(row.protein),
                    fat: row.fat===''? null : Number(row.fat),
                    carbs: row.carbs===''? null : Number(row.carbs),
                    steps: row.steps===''? null : Number(row.steps),
                    rhr: row.rhr===''? null : Number(row.rhr),
                    sleep_score: row.sleep_score===''? null : Number(row.sleep_score),
                    sleep_duration_hrs: row.sleep_duration_hrs===''? null : Number(row.sleep_duration_hrs),
                    refeed: ['yes','true','1','y','üî•'].includes(String(row.refeed||'').trim().toLowerCase()),
                    notes: (row.notes||'').replace(/^"|"$/g,'')
                };
                if (!/^\d{4}-\d{2}-\d{2}$/.test(e.date)) continue;
                const derived = computeDerivedFields(e.weight, e.bf_percent, e.lean_lbs);
                if (derived) { e.bf_lbs = derived.bf_lbs; e.lean_percent = derived.lean_percent; e.residual = derived.residual; }
                const integrity = computeIntegrityStatus(e.weight, e.bf_percent, e.lean_lbs);
                e.integrity_status = integrity.status;
                e.integrity_message = integrity.message;
                rows.push(e);
            }
            if (!rows.length) { showToast('No valid rows parsed', true); return; }
            bodyData = rows.sort((a,b)=>a.date.localeCompare(b.date));
            saveData();
            updateStats(); updateTable(); updateChart();
            showToast(`Bulk update applied (${rows.length} rows)`);
            closeSettings();
        }

// ----- Formula Documentation -----
        function openFormulaDocs() {
            const modal = document.getElementById('formulaModal');
            modal.innerHTML = `
              <div class="modal">
                <h2>‚ÑπÔ∏è Formula Documentation with Scientific References</h2>
                
                <div class="form-section">
                  <h3>Body Composition Calculations</h3>
                  <p style="color: var(--text-secondary); margin-bottom:10px;"><strong>BF lbs = Weight √ó (BF% √∑ 100)</strong></p>
                  <p style="color: var(--text-secondary); font-size:0.85em;">Direct calculation of fat mass from body fat percentage.</p>
                  
                  <p style="color: var(--text-secondary); margin:15px 0 10px;"><strong>Lean % = (Lean lbs √∑ Weight) √ó 100</strong></p>
                  <p style="color: var(--text-secondary); font-size:0.85em;">Percentage of total body weight that is lean mass (muscle, organs, bone, water).</p>
                  
                  <p style="color: var(--text-secondary); margin:15px 0 10px;"><strong>Residual = Weight ‚àí BF lbs ‚àí Lean lbs</strong></p>
                  <p style="color: var(--text-secondary); font-size:0.85em;"><strong>Note:</strong> This is device-specific and represents components measured separately by your body composition scale (bone density, intracellular vs extracellular water, etc.). This is NOT an error.</p>
                </div>

                <div class="form-section">
                  <h3>Fat Loss Rate & Energy Balance</h3>
                  <p style="color: var(--text-secondary); margin-bottom:10px;"><strong>Fat Loss (period) = BF lbs(start) ‚àí BF lbs(end)</strong></p>
                  <p style="color: var(--text-secondary); margin-bottom:10px;"><strong>Weekly Rate = (Fat Loss √∑ Days) √ó 7</strong></p>
                  <p style="color: var(--text-secondary); margin-bottom:10px;"><strong>Energy Deficit = Fat Loss per day √ó 3,500 calories</strong></p>
                  <p style="color: var(--text-secondary); font-size:0.85em;"><strong>Reference:</strong> Traditional "3,500 calorie rule" from Wishnofsky (1958). While this is a simplification, it provides a reasonable approximation for tracking purposes.</p>
                  <p style="color: var(--text-secondary); font-size:0.85em; margin-top:8px;"><strong>Example:</strong> If you lose 0.5 lbs of fat in one day, estimated deficit = 0.5 √ó 3,500 = 1,750 calories for that day.</p>
                </div>

                <div class="form-section">
                  <h3>TDEE Estimation</h3>
                  <p style="color: var(--text-secondary); margin-bottom:10px;"><strong>Estimated TDEE = Average Calories + Average Deficit per Day</strong></p>
                  <p style="color: var(--text-secondary); font-size:0.85em;">Based on energy balance equation. Becomes more accurate with longer tracking periods (4+ weeks recommended).</p>
                  <p style="color: var(--text-secondary); font-size:0.85em; margin-top:8px;"><strong>Example:</strong> If you eat 1,800 cal/day average and lose 1 lb/week (500 cal/day deficit), estimated TDEE = 1,800 + 500 = 2,300 calories/day.</p>
                  <p style="color: var(--text-secondary); font-size:0.85em; margin-top:8px;"><strong>Reference:</strong> Energy balance principles from Hall et al. (2011), "Quantification of the effect of energy imbalance on bodyweight." The Lancet.</p>
                </div>

                <div class="form-section">
                  <h3>Optimal Fat Loss Targets</h3>
                  <p style="color: var(--text-secondary); margin-bottom:10px;"><strong>Muscle Retention Deficit = TDEE ‚àí (0.5% body weight √ó 3,500 √∑ 7)</strong></p>
                  <p style="color: var(--text-secondary); font-size:0.85em;">Target: ~0.5% of body weight loss per week. This rate maximizes fat loss while preserving muscle mass.</p>
                  <p style="color: var(--text-secondary); font-size:0.85em; margin-top:8px;"><strong>Reference:</strong> Alpert, S.S. (2005). "A limit on the energy transfer rate from the human fat store in hypophagia." Journal of Theoretical Biology, 233(1), 1-13. This study established the maximum rate fat can be mobilized from adipose tissue.</p>
                  <p style="color: var(--text-secondary); font-size:0.85em; margin-top:8px;"><strong>Interpretation:</strong> Deficits larger than this may cause the body to break down muscle tissue for energy since fat stores cannot mobilize energy fast enough.</p>
                  
                  <p style="color: var(--text-secondary); margin:20px 0 10px;"><strong>Max Fat Burn Deficit = TDEE ‚àí (1.0% body weight √ó 3,500 √∑ 7)</strong></p>
                  <p style="color: var(--text-secondary); font-size:0.85em;">Target: ~1% of body weight loss per week. This represents the upper safe limit for fat loss.</p>
                  <p style="color: var(--text-secondary); font-size:0.85em; margin-top:8px;"><strong>Reference:</strong> Garthe et al. (2011). "Effect of two different weight-loss rates on body composition and strength in elite athletes." International Journal of Sport Nutrition and Exercise Metabolism. Found that 0.7% weekly loss preserved strength better than 1.4% weekly loss.</p>
                  <p style="color: var(--text-secondary); font-size:0.85em; margin-top:8px;"><strong>Interpretation:</strong> Rates above 1% body weight per week significantly increase risk of muscle loss, strength decreases, metabolic adaptation, and hormonal disruption.</p>
                </div>

                <div class="form-section">
                  <h3>Training Calculations</h3>
                  <p style="color: var(--text-secondary); margin-bottom:10px;"><strong>Working Volume = Œ£ (Sets √ó Reps √ó Weight)</strong></p>
                  <p style="color: var(--text-secondary); font-size:0.85em;">Total volume load. Excludes warm-up sets. Tracks training stimulus over time.</p>
                  
                  <p style="color: var(--text-secondary); margin:15px 0 10px;"><strong>Estimated 1RM (Epley) = Weight √ó (1 + Reps √∑ 30)</strong></p>
                  <p style="color: var(--text-secondary); font-size:0.85em;"><strong>Reference:</strong> Epley, B. (1985). Poundage Chart. Boyd Epley Workout. University of Nebraska.</p>
                  <p style="color: var(--text-secondary); font-size:0.85em; margin-top:8px;"><strong>Example:</strong> 225 lbs √ó (1 + 8 √∑ 30) = 225 √ó 1.267 = 285 lbs estimated 1RM</p>
                  <p style="color: var(--text-secondary); font-size:0.85em; margin-top:8px;"><strong>Note:</strong> Most accurate for 1-10 rep range. For higher reps (10-15), Brzycki formula may be more accurate: Weight √∑ (1.0278 ‚àí 0.0278 √ó Reps)</p>
                </div>

                <div class="form-section">
                  <h3>Progressive Overload Guidelines</h3>
                  <p style="color: var(--text-secondary); margin-bottom:10px;"><strong>Barbell Exercises: 1-3% weight increase</strong></p>
                  <p style="color: var(--text-secondary); margin-bottom:10px;"><strong>Dumbbell Exercises: 2-5% weight increase</strong></p>
                  <p style="color: var(--text-secondary); font-size:0.85em;">Conservative guidelines for sustainable progression. Increase when you can complete target reps with good form for 2 consecutive sessions.</p>
                  <p style="color: var(--text-secondary); font-size:0.85em; margin-top:8px;"><strong>Example:</strong> 100 lb barbell: add 2.5-5 lbs. 50 lb dumbbell: add 5 lbs (2.5 lb per hand).</p>
                  <p style="color: var(--text-secondary); font-size:0.85em; margin-top:8px;"><strong>Reference:</strong> Based on DeLorme & Watkins (1948) progressive resistance principles and modern periodization practices.</p>
                </div>

                <div class="form-section">
                  <h3>Protein Requirements</h3>
                  <p style="color: var(--text-secondary); margin-bottom:10px;"><strong>Maintenance: 0.8-1.0 g per lb body weight</strong></p>
                  <p style="color: var(--text-secondary); margin-bottom:10px;"><strong>Fat Loss: 1.0-1.2 g per lb body weight</strong></p>
                  <p style="color: var(--text-secondary); margin-bottom:10px;"><strong>Muscle Gain: 0.8-1.0 g per lb body weight</strong></p>
                  <p style="color: var(--text-secondary); font-size:0.85em;"><strong>Reference:</strong> Phillips, S.M. & Van Loon, L.J.C. (2011). "Dietary protein for athletes: from requirements to optimum adaptation." Journal of Sports Sciences.</p>
                  <p style="color: var(--text-secondary); font-size:0.85em; margin-top:8px;"><strong>Note:</strong> Higher protein during caloric deficit helps preserve muscle mass. Above 1.2 g/lb shows diminishing returns.</p>
                </div>

                <div style="background:rgba(6,182,212,0.1); border-left:4px solid var(--accent-cyan); padding:15px; border-radius:8px; margin-top:20px;">
                  <h4 style="color:var(--accent-cyan); margin-bottom:8px;">üí° How to Use These Formulas</h4>
                  <p style="color:var(--text-secondary); font-size:0.85em;">
                    ‚Ä¢ Track consistently for 2-4 weeks before making conclusions<br>
                    ‚Ä¢ Combine multiple metrics (weight, measurements, photos, performance)<br>
                    ‚Ä¢ Adjust based on actual results, not just calculations<br>
                    ‚Ä¢ Consider weekly averages to smooth daily fluctuations<br>
                    ‚Ä¢ These are guidelines, not absolute rules - individual variation exists
                  </p>
                </div>

                <div style="display:flex; gap:10px; margin-top: 20px;">
                  <button class="primary" onclick="closeFormulaDocs()">Close</button>
                </div>
              </div>
            `;
            modal.classList.add('show');
        }
        function closeFormulaDocs(){ document.getElementById('formulaModal').classList.remove('show'); }


        // ----- Analytics Tab (lightweight) -----
        function updateAnalyticsTab() {
            const sorted = bodyData.slice().sort((a,b)=>a.date.localeCompare(b.date));
            if (sorted.length < 10) {
                document.getElementById('analyticsContent').innerHTML = '<p style="color: var(--text-secondary);">Need more data to compute analytics.</p>';
                return;
            }
            const pairs = [];
            for (let i=1;i<sorted.length;i++){
                const prev = sorted[i-1];
                const cur = sorted[i];
                if (prev && cur) {
                    const fatPrev = (prev.bf_lbs != null) ? prev.bf_lbs : (prev.weight*prev.bf_percent/100);
                    const fatCur = (cur.bf_lbs != null) ? cur.bf_lbs : (cur.weight*cur.bf_percent/100);
                    const fatDelta = fatCur - fatPrev; // negative = fat loss
                    pairs.push({
                        calories: prev.calories, protein: prev.protein, fat: prev.fat, carbs: prev.carbs,
                        steps: prev.steps, sleep: prev.sleep_duration_hrs, rhr: prev.rhr,
                        nextFatDelta: fatDelta
                    });
                }
            }
            function corr(xk, yk) {
                const xs=[], ys=[];
                pairs.forEach(p=>{
                    const x=p[xk], y=p[yk];
                    if (isFinite(x) && isFinite(y)) { xs.push(x); ys.push(y); }
                });
                if (xs.length < 8) return null;
                const mx=xs.reduce((a,b)=>a+b,0)/xs.length;
                const my=ys.reduce((a,b)=>a+b,0)/ys.length;
                let num=0, dx=0, dy=0;
                for (let i=0;i<xs.length;i++){
                    const vx=xs[i]-mx, vy=ys[i]-my;
                    num += vx*vy; dx += vx*vx; dy += vy*vy;
                }
                const den = Math.sqrt(dx*dy);
                return den ? (num/den) : null;
            }
            const metrics = ['calories','protein','fat','carbs','steps','sleep','rhr'];
            const rows = metrics.map(m=>{
                const c = corr(m,'nextFatDelta');
                const val = (c==null) ? '‚Äî' : c.toFixed(2);
                const color = (c==null) ? 'var(--text-secondary)' : (c< -0.2 ? 'var(--accent-success)' : (c>0.2 ? 'var(--accent-danger)' : 'var(--accent-warning)'));
                return `<tr><td>${m}</td><td style="font-family:'Space Mono', monospace; color:${color};">${val}</td></tr>`;
            }).join('');

            document.getElementById('analyticsContent').innerHTML = `
              <div style="color: var(--text-secondary); margin-bottom: 12px;">
                Correlation of <b>previous-day inputs</b> vs <b>next-day fat change</b> (negative = more fat loss). This is directional and noisy, but useful.
              </div>
              <div class="table-container" style="max-height: 320px;">
                <table>
                  <thead><tr><th>Metric (Prev Day)</th><th>Corr ‚Üí Next-day Fat Œî</th></tr></thead>
                  <tbody>${rows}</tbody>
                </table>
              </div>
            `;
        }

        // Personal records store (for overload tab enhancements)
        function loadPRs() {
            const stored = localStorage.getItem(PR_KEY);
            if (stored) { try { personalRecords = JSON.parse(stored); } catch { personalRecords = null; } }
            if (!personalRecords) personalRecords = { version: 1, prs: {} };
        }
        function savePRs() { localStorage.setItem(PR_KEY, JSON.stringify(personalRecords)); }




        // ===== MOBILE SWIPE NAV (V13) =====
        function enableSwipeNav() {
            let startX = null, startY = null, startT = null;
            const threshold = 60;
            document.addEventListener('touchstart', (e)=>{
                if (!e.touches || e.touches.length!==1) return;
                startX = e.touches[0].clientX;
                startY = e.touches[0].clientY;
                startT = Date.now();
            }, {passive:true});
            document.addEventListener('touchend', (e)=>{
                if (startX===null) return;
                const dx = (e.changedTouches[0].clientX - startX);
                const dy = (e.changedTouches[0].clientY - startY);
                const dt = Date.now() - startT;
                startX=null; startY=null; startT=null;
                if (dt>700) return;
                if (Math.abs(dx) < threshold || Math.abs(dx) < Math.abs(dy)) return;
                const order = ['dashboard','nutrition','measurements','training','progressive','correlations','analytics','data'];
                const active = document.querySelector('.main-tab-content.active')?.id?.replace('-tab','') || 'dashboard';
                const idx = Math.max(0, order.indexOf(active));
                const nextIdx = dx < 0 ? Math.min(order.length-1, idx+1) : Math.max(0, idx-1);
                const tabName = order[nextIdx];
                // Find corresponding button and click
                const btn = Array.from(document.querySelectorAll('.tab-button')).find(b=>b.getAttribute('onclick')?.includes(`'${tabName}'`));
                if (btn) btn.click();
            }, {passive:true});
        }


// ===== INITIALIZATION =====
        
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ Body Tracker Pro - Complete Ultimate Edition');
            console.log('‚ú® With All Features: Nutrition, Measurements, Training, Correlations, Integrity Validation');
            
            loadSettings();
            loadPRs();
            loadData();
            loadMeasurements();
            loadExerciseLibrary();
            loadTemplates();
            loadTraining();
/* Seed workouts from screenshots for testing */
try {
  if (trainingStore && Array.isArray(trainingStore.workouts) && trainingStore.workouts.length === 0) {
    trainingStore.workouts = [{"id": "w_seed_2025_12_18_pull2", "date": "2025-12-18", "startTime": "15:01", "type": "2nd Pull", "notes": "Great workout. Started with 500 ropes and finished with 500 ropes. Thank you Lord for the health and ability to do this! Glory to God!", "exercises": [{"id": "ex_seated_row", "name": "Seated Row", "sets": [{"id": "s1", "type": "Standard", "reps": 10, "weight": 162, "completed": true}, {"id": "s1", "type": "Standard", "reps": 10, "weight": 162, "completed": true}, {"id": "s1", "type": "Standard", "reps": 10, "weight": 162, "completed": true}]}, {"id": "ex_sup_bob_row", "name": "Supinated bent over barbell row", "sets": [{"id": "s1", "type": "Standard", "reps": 8, "weight": 175, "completed": true}, {"id": "s1", "type": "Standard", "reps": 8, "weight": 175, "completed": true}, {"id": "s1", "type": "Standard", "reps": 8, "weight": 175, "completed": true}, {"id": "s1", "type": "Standard", "reps": 8, "weight": 175, "completed": true}]}, {"id": "ex_cable_rear_delt", "name": "Cable Rear Delt Flys", "sets": [{"id": "s1", "type": "Standard", "reps": 10, "weight": 22, "completed": true}, {"id": "s1", "type": "Standard", "reps": 10, "weight": 22, "completed": true}]}, {"id": "ex_rear_delt_hp", "name": "Rear Delt High Pull", "sets": [{"id": "s1", "type": "Standard", "reps": 10, "weight": 66, "completed": true}, {"id": "s1", "type": "Standard", "reps": 10, "weight": 66, "completed": true}, {"id": "s1", "type": "Standard", "reps": 10, "weight": 66, "completed": true}]}, {"id": "ex_cg_chins", "name": "Close Grip Chin-Ups", "isBodyweight": true, "sets": [{"id": "s1", "type": "Standard", "reps": 8, "weight": 239, "completed": true}, {"id": "s1", "type": "Standard", "reps": 8, "weight": 239, "completed": true}, {"id": "s1", "type": "Standard", "reps": 8, "weight": 239, "completed": true}, {"id": "s1", "type": "Standard", "reps": 8, "weight": 239, "completed": true}]}, {"id": "ex_hammer_curls", "name": "Cross Body Hammer Curls", "isDumbbell": true, "sets": [{"id": "s1", "type": "Standard", "reps": 12, "weight": 30, "completed": true}, {"id": "s1", "type": "Standard", "reps": 12, "weight": 30, "completed": true}, {"id": "s1", "type": "Standard", "reps": 12, "weight": 30, "completed": true}, {"id": "s1", "type": "Standard", "reps": 12, "weight": 30, "completed": true}, {"id": "s1", "type": "Standard", "reps": 12, "weight": 30, "completed": true}]}, {"id": "ex_leg_raises", "name": "Leg Raises", "isBodyweight": true, "sets": [{"id": "s1", "type": "Standard", "reps": 0, "weight": null, "completed": false}]}, {"id": "ex_db_shrugs", "name": "Dumbbell Shrugs", "isDumbbell": true, "sets": [{"id": "s1", "type": "Standard", "reps": 10, "weight": 95, "completed": true}, {"id": "s1", "type": "Standard", "reps": 10, "weight": 95, "completed": true}, {"id": "s1", "type": "Standard", "reps": 10, "weight": 95, "completed": true}, {"id": "s1", "type": "Standard", "reps": 10, "weight": 95, "completed": true}, {"id": "s1", "type": "Standard", "reps": 10, "weight": 95, "completed": true}, {"id": "s1", "type": "Standard", "reps": 10, "weight": 95, "completed": true}, {"id": "s1", "type": "Standard", "reps": 10, "weight": 95, "completed": true}, {"id": "s1", "type": "Standard", "reps": 10, "weight": 95, "completed": true}]}, {"id": "ex_roman_chair", "name": "Roman Chair Back Extensions", "sets": [{"id": "s1", "type": "Standard", "reps": 20, "weight": 25, "completed": true}]}]}, {"id": "w_seed_2025_12_18_push", "date": "2025-12-18", "startTime": "16:38", "type": "Push", "notes": "Workout was awesome!", "exercises": [{"id": "ex_smith_incline_bench", "name": "Smith Machine Incline bench Press", "sets": [{"id": "s1", "type": "Standard", "reps": 10, "weight": 182.5, "completed": true}, {"id": "s1", "type": "Standard", "reps": 10, "weight": 182.5, "completed": true}, {"id": "s1", "type": "Standard", "reps": 10, "weight": 182.5, "completed": true}, {"id": "s1", "type": "Standard", "reps": 10, "weight": 182.5, "completed": true}]}, {"id": "ex_smith_incline_sp", "name": "Smith Machine Incline Shoulder Press", "sets": [{"id": "s1", "type": "Standard", "reps": 10, "weight": 135, "completed": true}, {"id": "s1", "type": "Standard", "reps": 10, "weight": 135, "completed": true}, {"id": "s1", "type": "Standard", "reps": 10, "weight": 135, "completed": true}, {"id": "s1", "type": "Standard", "reps": 10, "weight": 135, "completed": true}]}, {"id": "ex_sup_smith_incline_sp", "name": "Supinated Smith Incline Shoulder Press", "sets": [{"id": "s1", "type": "Standard", "reps": 10, "weight": 95, "completed": true}, {"id": "s1", "type": "Standard", "reps": 10, "weight": 95, "completed": true}, {"id": "s1", "type": "Standard", "reps": 10, "weight": 95, "completed": true}]}, {"id": "ex_incline_db_flies", "name": "Incline Dumbbell Flies", "isDumbbell": true, "sets": [{"id": "s1", "type": "Standard", "reps": 12, "weight": 40, "completed": true}, {"id": "s1", "type": "Standard", "reps": 12, "weight": 40, "completed": true}, {"id": "s1", "type": "Standard", "reps": 12, "weight": 40, "completed": true}, {"id": "s1", "type": "Standard", "reps": 12, "weight": 40, "completed": true}, {"id": "s1", "type": "Standard", "reps": 12, "weight": 40, "completed": true}]}, {"id": "ex_cg_incline_db_press", "name": "Close Grip Incline Dumbbell Press", "isDumbbell": true, "sets": [{"id": "s1", "type": "Standard", "reps": 12, "weight": 65, "completed": true}, {"id": "s1", "type": "Standard", "reps": 12, "weight": 65, "completed": true}, {"id": "s1", "type": "Standard", "reps": 12, "weight": 65, "completed": true}, {"id": "s1", "type": "Standard", "reps": 12, "weight": 65, "completed": true}]}, {"id": "ex_dips", "name": "Dips", "isBodyweight": true, "sets": [{"id": "s1", "type": "Standard", "reps": 10, "weight": 191.6, "completed": true}, {"id": "s1", "type": "Standard", "reps": 10, "weight": 191.6, "completed": true}, {"id": "s1", "type": "Standard", "reps": 10, "weight": 191.6, "completed": true}, {"id": "s1", "type": "Standard", "reps": 10, "weight": 191.6, "completed": true}]}, {"id": "ex_hanging_knee", "name": "Hanging Knee Raises", "isBodyweight": true, "sets": [{"id": "s1", "type": "Standard", "reps": 15, "weight": 191.6, "completed": true}, {"id": "s1", "type": "Standard", "reps": 15, "weight": 191.6, "completed": true}, {"id": "s1", "type": "Standard", "reps": 15, "weight": 191.6, "completed": true}]}]}, {"id": "w_seed_2025_12_21_lower", "date": "2025-12-21", "startTime": "16:38", "type": "Lower Body", "notes": "", "exercises": [{"id": "ex_front_squat", "name": "Front Squat", "sets": [{"id": "s1", "type": "Standard", "reps": 10, "weight": 205, "completed": true}, {"id": "s1", "type": "Standard", "reps": 10, "weight": 205, "completed": true}]}, {"id": "ex_back_squat", "name": "Back Squat", "sets": [{"id": "s1", "type": "Standard", "reps": 10, "weight": 135, "completed": true}, {"id": "s1", "type": "Standard", "reps": 10, "weight": 135, "completed": true}, {"id": "s1", "type": "Standard", "reps": 10, "weight": 135, "completed": true}]}, {"id": "ex_leg_curls", "name": "Leg Curls", "sets": [{"id": "s1", "type": "Standard", "reps": 10, "weight": 106, "completed": true}, {"id": "s1", "type": "Standard", "reps": 10, "weight": 106, "completed": true}, {"id": "s1", "type": "Standard", "reps": 10, "weight": 106, "completed": true}, {"id": "s1", "type": "Standard", "reps": 10, "weight": 106, "completed": true}, {"id": "s1", "type": "Standard", "reps": 10, "weight": 106, "completed": true}]}, {"id": "ex_leg_ext", "name": "Leg Extensions", "sets": [{"id": "s1", "type": "Standard", "reps": 10, "weight": 154.75, "completed": true}, {"id": "s1", "type": "Standard", "reps": 10, "weight": 154.75, "completed": true}, {"id": "s1", "type": "Standard", "reps": 10, "weight": 154.75, "completed": true}, {"id": "s1", "type": "Standard", "reps": 10, "weight": 154.75, "completed": true}]}, {"id": "ex_inner_thigh", "name": "Inner Thigh", "sets": [{"id": "s1", "type": "Standard", "reps": 10, "weight": 120, "completed": true}, {"id": "s1", "type": "Standard", "reps": 10, "weight": 120, "completed": true}, {"id": "s1", "type": "Standard", "reps": 10, "weight": 120, "completed": true}, {"id": "s1", "type": "Standard", "reps": 10, "weight": 120, "completed": true}]}, {"id": "ex_outer_thigh", "name": "Outer Thigh", "sets": [{"id": "s1", "type": "Standard", "reps": 10, "weight": 120, "completed": true}, {"id": "s1", "type": "Standard", "reps": 10, "weight": 120, "completed": true}, {"id": "s1", "type": "Standard", "reps": 10, "weight": 120, "completed": true}, {"id": "s1", "type": "Standard", "reps": 10, "weight": 120, "completed": true}]}]}];
    localStorage.setItem(TRAINING_KEY, JSON.stringify(trainingStore));
    try { saveTraining(); } catch {}
    try { updateTrainingTab(); } catch {}
    try { updateProgressiveTabV13 && updateProgressiveTabV13(); } catch {}
  }
} catch (e) { console.warn('Training seed error', e); }

            loadTemplates();
            loadExerciseLibrary();
            updateTrainingTab();
            updateProgressiveTab();

            
            updateStats();
            updateTable();
            updateChart();
            
            console.log(`‚úÖ Loaded ${bodyData.length} body composition entries`);
            console.log(`‚úÖ Loaded ${measurements.length} measurement records`);
            console.log(`‚úÖ Loaded ${trainingLog.length} training sessions`);
            
            // Auto-update inputs on modal
            ['entryWeight', 'entryBfPercent', 'entryLeanLbs'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.addEventListener('input', updateModalDerivedFields);
            });
            
            // Show welcome message for first-time users
            const hasSeenWelcome = localStorage.getItem('hasSeenWelcome_v2');
            if (!hasSeenWelcome) {
                setTimeout(() => {
                    showToast(
                        'üéâ Welcome to Body Tracker Pro - Complete Edition!\n\n' +
                        '‚ú® 6 powerful tabs\n' +
                        'üìä Nutrition analysis & recommendations\n' +
                        'üìè Body measurements tracking\n' +
                        'üèãÔ∏è Training log\n' +
                        'üîç Correlations & insights\n' +
                        'üõ°Ô∏è Data integrity validation\n\n' +
                        'All 48 days pre-loaded!'
                    );
                    localStorage.setItem('hasSeenWelcome_v2', 'true');
                }, 500);
            }
        });
    

        // ===== PROGRESSIVE OVERLOAD ENHANCED (V13) =====
        function epley1RM(w, reps){ if(!isFinite(w)||!isFinite(reps)||reps<=0) return null; return w*(1+(reps/30)); }

        function collectTrainingSets() {
            // Supports both legacy and set-based formats
            const all = [];
            (trainingLog||[]).forEach(w=>{
                const workoutId = w.id || w.date || 'workout';
                const date = w.date || '';
                const sess = w.session || w.session_name || w.name || w.type || 'Workout';
                const exercises = w.exercises || [];
                exercises.forEach(ex=>{
                    const exName = ex.name || ex.exercise || 'Exercise';
                    const exId = ex.id || exName;
                    const superset = !!ex.superset;
                    const sets = ex.sets_detail || ex.sets || [];
                    if (Array.isArray(sets) && sets.length && typeof sets[0] === 'object') {
                        sets.forEach((s, idx)=>{
                            const isWarmup = !!s.warmup;
                            const completed = (s.completed===undefined)? true : !!s.completed;
                            const weight = Number(s.weight||0);
                            const reps = Number(s.reps||0);
                            all.push({date, workoutId, sess, exId, exName, superset, setIndex: idx+1, isWarmup, completed, weight, reps});
                        });
                    } else {
                        // legacy single-line
                        const weight = Number(ex.weight||0);
                        const reps = Number(ex.reps||0);
                        const setsN = Number(ex.sets||0);
                        for (let i=0;i<Math.max(1,setsN||1);i++){
                            all.push({date, workoutId, sess, exId, exName, superset, setIndex:i+1, isWarmup:false, completed:true, weight, reps});
                        }
                    }
                });
            });
            return all.filter(s=>s.exName && isFinite(s.weight) && isFinite(s.reps));
        }

        function computeExerciseStats(sets) {
            const stats = {};
            sets.forEach(s=>{
                if (!stats[s.exName]) stats[s.exName] = {sets:[], volume:0, workVolume:0, best1rm:0, bestSet:null, prReps:0, prWeight:0};
                stats[s.exName].sets.push(s);
                const v = s.weight * s.reps;
                stats[s.exName].volume += v;
                if (!s.isWarmup && s.completed) stats[s.exName].workVolume += v;
                const est = epley1RM(s.weight, s.reps);
                if (est && est > stats[s.exName].best1rm) { stats[s.exName].best1rm = est; stats[s.exName].bestSet = s; }
                if (s.reps > stats[s.exName].prReps) stats[s.exName].prReps = s.reps;
                if (s.weight > stats[s.exName].prWeight) stats[s.exName].prWeight = s.weight;
            });
            return stats;
        }

        function updatePersonalRecordsFromTraining() {
            loadPRs();
            const sets = collectTrainingSets().filter(s=>s.completed && !s.isWarmup);
            const stats = computeExerciseStats(sets);
            Object.keys(stats).forEach(name=>{
                const s = stats[name];
                const cur = personalRecords.prs[name] || {};
                const newPR = {
                    best1rm: Math.max(cur.best1rm||0, s.best1rm||0),
                    prWeight: Math.max(cur.prWeight||0, s.prWeight||0),
                    prReps: Math.max(cur.prReps||0, s.prReps||0),
                    updated_at: new Date().toISOString()
                };
                personalRecords.prs[name] = newPR;
            });
            savePRs();
        }

        function deloadHeuristic() {
            // Basic heuristic: elevated RHR + falling volume over last 7 entries
            const sortedBody = bodyData.slice().sort((a,b)=>a.date.localeCompare(b.date));
            const recent = sortedBody.slice(-7).filter(d=>isFinite(d.rhr));
            const rhrAvg = recent.length ? recent.reduce((s,d)=>s+d.rhr,0)/recent.length : null;
            const base = sortedBody.slice(-21,-7).filter(d=>isFinite(d.rhr));
            const baseAvg = base.length ? base.reduce((s,d)=>s+d.rhr,0)/base.length : null;
            const rhrUp = (rhrAvg!=null && baseAvg!=null) ? (rhrAvg - baseAvg) : null;
            const sets = collectTrainingSets().filter(s=>s.completed && !s.isWarmup);
            // weekly volume last 2 weeks
            const byDate = {};
            sets.forEach(s=>{
                byDate[s.date] = (byDate[s.date]||0) + (s.weight*s.reps);
            });
            const dates = Object.keys(byDate).sort();
            const last7 = dates.slice(-7).reduce((sum, d)=>sum+byDate[d],0);
            const prev7 = dates.slice(-14,-7).reduce((sum, d)=>sum+byDate[d],0);
            const volDown = (prev7>0) ? ((last7 - prev7)/prev7) : null;
            const suggest = (rhrUp!=null && rhrUp>=4) || (volDown!=null && volDown<-0.15);
            return {rhrAvg, baseAvg, rhrUp, last7, prev7, volDown, suggest};
        }

        function updateProgressiveTabV13() {
            const el = document.getElementById('progressiveContent');
            if (!el) return;
            if (!trainingLog || trainingLog.length === 0) {
                el.innerHTML = `<div style="background: var(--bg-tertiary); padding: 30px; border-radius: 10px; text-align:center;">
                    <h3 style="color: var(--accent-purple); margin-bottom: 15px;">üèãÔ∏è No Training Data Yet</h3>
                    <p style="color: var(--text-secondary);">Log workouts to see PRs, volume trends, and deload guidance.</p>
                </div>`;
                return;
            }

            updatePersonalRecordsFromTraining();
            const sets = collectTrainingSets().filter(s=>s.completed);
            const exStats = computeExerciseStats(sets);
            const names = Object.keys(exStats).sort((a,b)=> (exStats[b].workVolume||0) - (exStats[a].workVolume||0)).slice(0, 20);

            // Build table
            const rows = names.map(n=>{
                const s = exStats[n];
                const pr = (personalRecords && personalRecords.prs && personalRecords.prs[n]) ? personalRecords.prs[n] : {};
                const best = s.bestSet;
                const bestStr = best ? `${best.weight}√ó${best.reps} (Set ${best.setIndex})` : '‚Äî';
                const best1 = s.best1rm ? s.best1rm.toFixed(1) : '‚Äî';
                const sug = (best && isFinite(best.weight)) ? Math.round(best.weight + 5) : '‚Äî';
                return `<tr>
                    <td>${n}${s.sets.some(x=>x.superset)?' <span style="color:var(--accent-warning)">(SS)</span>':''}</td>
                    <td style="font-family:'Space Mono', monospace;">${Math.round(s.workVolume).toLocaleString()}</td>
                    <td style="font-family:'Space Mono', monospace;">${bestStr}</td>
                    <td style="font-family:'Space Mono', monospace;">${best1}</td>
                    <td style="font-family:'Space Mono', monospace;">${(pr.best1rm||0).toFixed(1)}</td>
                    <td style="font-family:'Space Mono', monospace;">Try +5: ${sug}</td>
                </tr>`;
            }).join('');

            const d = deloadHeuristic();
            const deloadCard = `
              <div style="background: rgba(245, 158, 11, 0.12); border-left:4px solid var(--accent-warning); padding: 18px; border-radius: 10px; margin-bottom: 16px;">
                <h3 style="color: var(--accent-warning); margin-bottom: 8px;">üßØ Deload / Recovery Check</h3>
                <div style="color: var(--text-secondary); font-size: 0.9em; line-height: 1.7;">
                  RHR (last 7 avg): <b>${d.rhrAvg!=null ? d.rhrAvg.toFixed(1) : '‚Äî'}</b> ‚Ä¢ Prior baseline: <b>${d.baseAvg!=null ? d.baseAvg.toFixed(1) : '‚Äî'}</b> ‚Ä¢ Œî: <b>${d.rhrUp!=null ? d.rhrUp.toFixed(1) : '‚Äî'}</b><br/>
                  Training volume (last 7 logged days): <b>${Math.round(d.last7||0).toLocaleString()}</b> ‚Ä¢ Prior 7: <b>${Math.round(d.prev7||0).toLocaleString()}</b> ‚Ä¢ Change: <b>${d.volDown!=null ? (d.volDown*100).toFixed(0)+'%' : '‚Äî'}</b><br/>
                  ${d.suggest ? `<span style="color: var(--accent-warning); font-weight:700;">Suggestion:</span> Consider a 3‚Äì7 day deload (reduce volume 30‚Äì50%, keep intensity moderate) + prioritize sleep.` :
                                `‚úÖ No strong deload flags detected.`}
                </div>
              </div>`;

            el.innerHTML = `
              ${deloadCard}
              <div style="color: var(--text-secondary); margin-bottom: 10px;">
                Top exercises by working volume. Warmup sets are excluded from "working volume". (SS)=superset.
              </div>
              <div class="table-container" style="max-height: 520px;">
                <table>
                  <thead><tr>
                    <th>Exercise</th><th>Work Volume</th><th>Best Set</th><th>Best Est 1RM</th><th>All-time PR 1RM</th><th>Next Step</th>
                  </tr></thead>
                  <tbody>${rows || '<tr><td colspan="6" style="color:var(--text-secondary);">No completed sets found.</td></tr>'}</tbody>
                </table>
              </div>
            `;
        }



        // ===== INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', ()=> {
            init();
        });
    
/* ===========================
   v15 Enhancements (non-breaking)
   =========================== */
(function(){
  // Safe chart registry to avoid leaks
  window.__v15Charts = window.__v15Charts || {};

  function destroyChart(id){
    const c = window.__v15Charts[id];
    if (c && typeof c.destroy === 'function') { try{ c.destroy(); }catch{} }
    delete window.__v15Charts[id];
  }

  function iso(d){ return new Date(d).toISOString().slice(0,10); }

  function weekStartISO(dateStr){
    const d = new Date(dateStr + 'T12:00:00');
    // Monday as start
    const day = (d.getDay()+6)%7; // 0=Mon
    d.setDate(d.getDate()-day);
    return iso(d);
  }

  function epley1RM(w,r){ if(!w||!r) return null; return Math.round(w*(1+r/30)); }

  function safeGet(obj, path, fallback){
    try{
      return path.split('.').reduce((a,k)=> (a && a[k]!=null)?a[k]:null, obj) ?? fallback;
    }catch{ return fallback; }
  }

  function calcAvg(arr, key){
    const vals = arr.map(d=>d[key]).filter(v=>v!=null && isFinite(v));
    if(!vals.length) return null;
    return vals.reduce((a,b)=>a+b,0)/vals.length;
  }

  function calculateWeeklyTrainingVolume(log){
    const weekly = {};
    (log||[]).forEach(w=>{
      if(!w || !w.date) return;
      const wk = weekStartISO(w.date);
      weekly[wk] = weekly[wk] || 0;
      (w.exercises||[]).forEach(ex=>{
        (ex.sets||[]).forEach(s=>{
          if(!s || !s.completed || s.warmup) return;
          const wt = Number(s.weight||0), reps = Number(s.reps||0);
          if(isFinite(wt) && isFinite(reps)) weekly[wk] += wt*reps;
        });
      });
    });
    const keys = Object.keys(weekly).sort();
    return keys.map(k=>({week:k, volume: weekly[k]}));
  }

  function calculateWeeklyVolumeByExercise(log){
    const weekly = {}; // ex -> week -> vol
    (log||[]).forEach(w=>{
      if(!w || !w.date) return;
      const wk = weekStartISO(w.date);
      (w.exercises||[]).forEach(ex=>{
        const name = (ex.name||'').trim() || 'Unknown';
        weekly[name] = weekly[name] || {};
        weekly[name][wk] = weekly[name][wk] || 0;
        (ex.sets||[]).forEach(s=>{
          if(!s || !s.completed || s.warmup) return;
          const wt = Number(s.weight||0), reps = Number(s.reps||0);
          if(isFinite(wt) && isFinite(reps)) weekly[name][wk] += wt*reps;
        });
      });
    });
    return weekly;
  }

  function topExercisesByRecentVolume(weeklyByEx, weeks){
    const weekKeys = Array.from(new Set(Object.values(weeklyByEx).flatMap(o=>Object.keys(o)))).sort();
    const recent = weekKeys.slice(-weeks);
    const totals = Object.entries(weeklyByEx).map(([name,map])=>{
      const v = recent.reduce((sum,w)=>sum+(map[w]||0),0);
      return {name, v};
    }).sort((a,b)=>b.v-a.v);
    return totals.filter(t=>t.v>0).slice(0,6).map(t=>t.name);
  }

  function buildHeatmapColor(r){
    if (r == null || !isFinite(r)) return '#334155';
    if (r < -0.5) return '#10b981';
    if (r < -0.3) return '#4ade80';
    if (r < -0.1) return '#86efac';
    if (r > 0.5) return '#ef4444';
    if (r > 0.3) return '#f87171';
    if (r > 0.1) return '#fca5a5';
    return '#6b7280';
  }

  function pearson(x,y){
    const pairs = x.map((xi,i)=>[xi,y[i]]).filter(([a,b])=>a!=null && b!=null && isFinite(a) && isFinite(b));
    if(pairs.length < 8) return null;
    const xs = pairs.map(p=>p[0]), ys = pairs.map(p=>p[1]);
    const n = xs.length;
    const sumX = xs.reduce((a,b)=>a+b,0), sumY = ys.reduce((a,b)=>a+b,0);
    const sumXY = xs.reduce((s,xi,i)=>s+xi*ys[i],0);
    const sumX2 = xs.reduce((s,xi)=>s+xi*xi,0);
    const sumY2 = ys.reduce((s,yi)=>s+yi*yi,0);
    const num = n*sumXY - sumX*sumY;
    const den = Math.sqrt((n*sumX2 - sumX*sumX)*(n*sumY2 - sumY*sumY));
    return den===0 ? 0 : (num/den);
  }

  function calcCorrelationsForChanges(){
    const sorted = (bodyData||[]).slice().sort((a,b)=>String(a.date).localeCompare(String(b.date)));
    const metrics = ['calories','protein','fat','carbs','steps','sleep_duration_hrs','rhr'];
    const changes = [];
    for(let i=1;i<sorted.length;i++){
      const prev=sorted[i-1], curr=sorted[i];
      if(!prev||!curr) continue;
      const weight_change = (curr.weight!=null && prev.weight!=null) ? (curr.weight - prev.weight) : null;
      const fatPrev = (prev.weight!=null && prev.bf_percent!=null) ? (prev.weight*prev.bf_percent/100) : null;
      const fatCurr = (curr.weight!=null && curr.bf_percent!=null) ? (curr.weight*curr.bf_percent/100) : null;
      const fat_change = (fatCurr!=null && fatPrev!=null) ? (fatCurr-fatPrev) : null;
      const lean_change = (curr.lean_lbs!=null && prev.lean_lbs!=null) ? (curr.lean_lbs - prev.lean_lbs) : null;
      changes.push(Object.assign({}, prev, {weight_change, fat_change, lean_change}));
    }
    const outcomes = ['weight_change','fat_change','lean_change'];
    const corr = {};
    metrics.forEach(m=>{
      corr[m]={};
      outcomes.forEach(o=>{
        corr[m][o]=pearson(changes.map(d=>d[m]), changes.map(d=>d[o]));
      });
    });
    return corr;
  }

  function ensureModalInBody(id, html){
    if(document.getElementById(id)) return;
    const wrap = document.createElement('div');
    wrap.innerHTML = html.trim();
    document.body.appendChild(wrap.firstElementChild);
  }

  window.showConfettiV15 = function(){
    const container = document.querySelector('#prCelebrationModal .confetti-container');
    if(!container) return;
    container.innerHTML = '';
    const colors = ['#06b6d4','#8b5cf6','#10b981','#f59e0b'];
    for(let i=0;i<50;i++){
      const c = document.createElement('div');
      c.className = 'confetti-piece';
      c.style.left = (Math.random()*100)+'%';
      c.style.top = '-20px';
      c.style.background = colors[Math.floor(Math.random()*colors.length)];
      c.style.animationDelay = (Math.random()*0.5)+'s';
      c.style.animationDuration = (Math.random()*2+2)+'s';
      container.appendChild(c);
    }
    setTimeout(()=>{ container.innerHTML=''; }, 5000);
  };

  window.closePRCelebration = function(){
    const m = document.getElementById('prCelebrationModal');
    if(m) m.classList.remove('show');
  };

  window.updateProgressiveTabV15 = function(){
    const el = document.getElementById('progressiveContent');
    if(!el) return;

    // Add container once
    let extra = document.getElementById('v15ProgressiveExtras');
    if(!extra){
      extra = document.createElement('div');
      extra.id = 'v15ProgressiveExtras';
      extra.style.marginTop = '18px';
      el.appendChild(extra);
    }

    const log = (window.trainingLog || []);
    const weeklyByEx = calculateWeeklyVolumeByExercise(log);
    const top = topExercisesByRecentVolume(weeklyByEx, 12);

    // Build extras UI
    extra.innerHTML = `
      <div class="card" style="margin:0;">
        <h3>üìä Volume Progression (Last 12 Weeks)</h3>
        <div class="chart-wrapper" style="height:300px; margin-top:12px;">
          <canvas id="v15_volumeChart"></canvas>
        </div>
        <p style="color:var(--text-secondary); margin-top:10px;">Top exercises by recent volume: <strong>${top.length?top.join(', '):'‚Äî'}</strong></p>
      </div>

      <div class="card" style="margin-top:16px;">
        <h3>üèÜ Personal Records</h3>
        <div style="display:flex; gap:10px; flex-wrap:wrap; margin: 12px 0;">
          <select id="prExerciseFilter" onchange="filterPRsV15()" style="min-width:220px;">
            <option value="all">All Exercises</option>
          </select>
          <button onclick="sortPRsV15('recent')">Most Recent</button>
          <button onclick="sortPRsV15('value')">Highest Value</button>
        </div>
        <div id="v15_prGrid" class="pr-cards-grid"></div>
        <div id="v15_prTimeline" style="margin-top:22px;"></div>
      </div>

      <div class="card" style="margin-top:16px;">
        <h3>üßØ Recovery & Deload Check</h3>
        <div id="v15_deloadCard"></div>
      </div>

      <div class="card" style="margin-top:16px;">
        <h3>üìà Progressive Overload Recommendations</h3>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Exercise</th>
                <th>Last Session</th>
                <th>Suggested Next</th>
                <th>Increase</th>
              </tr>
            </thead>
            <tbody id="v15_overloadRows"></tbody>
          </table>
        </div>
        <div class="info-box" style="margin-top: 15px;">
          <h4>üí° Guidelines</h4>
          <p>Barbell: +1‚Äì3% per session (2.5‚Äì5 lbs). Dumbbell: +2‚Äì5% per session (typically 5‚Äì10 lbs total).</p>
          <p>Only increase when target reps are solid with good form.</p>
        </div>
      </div>
    `;

    // Render volume chart
    destroyChart('v15_volumeChart');
    const ctx = document.getElementById('v15_volumeChart')?.getContext('2d');
    if(ctx && window.Chart){
      const allWeeks = Array.from(new Set(Object.values(weeklyByEx).flatMap(o=>Object.keys(o)))).sort();
      const weeks = allWeeks.slice(-12);
      const datasets = top.map(name=>{
        const map = weeklyByEx[name]||{};
        return {
          label: name,
          data: weeks.map(w=>map[w]||0),
          tension: 0.35,
          pointRadius: 2,
          borderWidth: 2,
        };
      });
      window.__v15Charts['v15_volumeChart'] = SafeChart(ctx, {
        type:'line',
        data:{ labels: weeks.map(w=>w.slice(5)), datasets },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{ legend:{ position:'bottom', labels:{ color:'#94a3b8' } } },
          scales:{
            x:{ ticks:{ color:'#94a3b8' }, grid:{ color:'#334155' } },
            y:{ ticks:{ color:'#94a3b8' }, grid:{ color:'#334155' } }
          }
        }
      });
    }

    // PR Dashboard
    const prs = safeGet(window, 'personalRecords.prs', {}) || {};
    const history = safeGet(window, 'personalRecords.history', []) || [];
    const exNames = Object.keys(prs).sort((a,b)=>a.localeCompare(b));
    const sel = document.getElementById('prExerciseFilter');
    if(sel){
      sel.innerHTML = `<option value="all">All Exercises</option>` + exNames.map(n=>`<option value="${n.replace(/"/g,'&quot;')}">${n}</option>`).join('');
    }
    window.__v15PRSort = window.__v15PRSort || 'recent';
    window.__v15PRFilter = window.__v15PRFilter || 'all';

    function prCardHTML(name, pr){
      const one = pr['1rm'];
      const vol = pr['volume'];
      const reps = pr['reps'];
      return `
        <div class="card" style="margin:0;">
          <h4>${name} üèÜ</h4>
          <div class="pr-details">
            <div class="pr-item">
              <span class="pr-label">1RM PR</span>
              <div>
                <div class="pr-value">${one?one.value+' lbs':'‚Äî'}</div>
                <div class="pr-detail">${one?`${one.weight} √ó ${one.reps} (${one.date})`:'Log workouts to compute'}</div>
              </div>
            </div>
            <div class="pr-item">
              <span class="pr-label">Volume</span>
              <div>
                <div class="pr-value">${vol?Math.round(vol.value).toLocaleString()+' lbs':'‚Äî'}</div>
                <div class="pr-detail">${vol?`${vol.totalSets} sets (${vol.date})`:'‚Äî'}</div>
              </div>
            </div>
            <div class="pr-item">
              <span class="pr-label">Reps</span>
              <div>
                <div class="pr-value">${reps?reps.value+' reps':'‚Äî'}</div>
                <div class="pr-detail">${reps?`@ ${reps.weight} lbs (${reps.date})`:'‚Äî'}</div>
              </div>
            </div>
          </div>
        </div>`;
    }

    window.renderPRsV15 = function(){
      const grid = document.getElementById('v15_prGrid');
      if(!grid) return;
      let items = Object.entries(prs).map(([name,pr])=>({name,pr}));
      if(window.__v15PRFilter !== 'all') items = items.filter(i=>i.name===window.__v15PRFilter);
      if(window.__v15PRSort === 'value'){
        items.sort((a,b)=> (safeGet(b,'pr.1rm.value',0)||0) - (safeGet(a,'pr.1rm.value',0)||0));
      }else{
        items.sort((a,b)=> String(safeGet(b,'pr.1rm.date','')).localeCompare(String(safeGet(a,'pr.1rm.date',''))));
      }
      grid.innerHTML = items.map(i=>prCardHTML(i.name,i.pr)).join('');
      const tl = document.getElementById('v15_prTimeline');
      if(tl){
        const recent = (history||[]).slice().sort((a,b)=>String(b.date).localeCompare(String(a.date))).slice(0,10);
        tl.innerHTML = `
          <h4 style="margin-bottom:10px;">PR History Timeline</h4>
          ${recent.length?`<div class="timeline">${recent.map(h=>`
            <div class="timeline-entry" style="margin-bottom:10px; padding:12px; border:1px solid var(--border); border-radius:10px; background:rgba(148,163,184,0.05);">
              <div class="timeline-date" style="font-family:'Space Mono', monospace; color:var(--text-secondary);">${h.date}</div>
              <div class="timeline-content" style="margin-top:6px;">
                <strong>NEW ${String(h.type).toUpperCase()} PR: ${h.exercise}</strong><br/>
                ${h.value}${h.type==='1rm'?' lbs':h.type==='volume'?' lbs':' reps'} (was ${h.previous||0}) +${h.improvement||0} üéâ
              </div>
            </div>`).join('')}</div>`:`<p style="color:var(--text-secondary);">No PR history yet.</p>`}
        `;
      }
    };
    window.filterPRsV15 = function(){
      const v = document.getElementById('prExerciseFilter')?.value || 'all';
      window.__v15PRFilter = v;
      window.renderPRsV15();
    };
    window.sortPRsV15 = function(mode){
      window.__v15PRSort = mode;
      window.renderPRsV15();
    };
    window.renderPRsV15();

    // Deload analysis (lightweight, uses your spec thresholds)
    function analyzeDeloadNeedV15(){
      const analysis = { volumeSpike:false, rhrElevated:false, performancePlateau:false, overallRisk:'low', recommendations:[] };
      const weekly = calculateWeeklyTrainingVolume(log);
      if(weekly.length>=2){
        const last=weekly[weekly.length-1].volume, prev=weekly[weekly.length-2].volume;
        if(prev>0){
          const inc = (last-prev)/prev;
          if(inc>0.25){ analysis.volumeSpike=true; analysis.recommendations.push(`Volume increased ${(inc*100).toFixed(0)}% vs last week.`); }
        }
      }
      const last7 = (bodyData||[]).slice(-7);
      const base = (bodyData||[]).slice(-21,-7);
      const avg7 = calcAvg(last7,'rhr');
      const avgB = calcAvg(base,'rhr');
      if(avg7!=null && avgB!=null && avg7 > avgB + 5){
        analysis.rhrElevated=true;
        analysis.recommendations.push(`RHR elevated +${(avg7-avgB).toFixed(0)} bpm vs baseline.`);
      }
      const factors = [analysis.volumeSpike, analysis.rhrElevated].filter(Boolean).length;
      analysis.overallRisk = factors>=2 ? 'high' : factors===1 ? 'moderate' : 'low';
      return {analysis, avg7, avgB, weekly};
    }

    const del = document.getElementById('v15_deloadCard');
    if(del){
      const {analysis, avg7, avgB, weekly} = analyzeDeloadNeedV15();
      const lastW = weekly.at(-1)?.volume || 0;
      const prevW = weekly.at(-2)?.volume || 0;
      const volChange = (prevW>0)? ((lastW-prevW)/prevW) : null;
      const riskColor = analysis.overallRisk==='high'?'var(--accent-danger)':analysis.overallRisk==='moderate'?'var(--accent-warning)':'var(--accent-success)';
      del.innerHTML = `
        <div class="warning-box" style="margin:0;">
          <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 14px;">
            <div>
              <div style="color:var(--text-secondary); font-size:0.85em;">RHR (last 7d)</div>
              <div style="font-size:1.4em; font-weight:800;">${avg7!=null?avg7.toFixed(0)+' bpm':'‚Äî'}</div>
              <div style="font-size:0.85em; color:var(--text-secondary);">${(avg7!=null && avgB!=null)?(`baseline ${avgB.toFixed(0)} bpm`):''}</div>
            </div>
            <div>
              <div style="color:var(--text-secondary); font-size:0.85em;">Weekly Volume</div>
              <div style="font-size:1.4em; font-weight:800;">${Math.round(lastW).toLocaleString()}</div>
              <div style="font-size:0.85em; color:var(--text-secondary);">${volChange!=null?((volChange>=0?'+':'')+(volChange*100).toFixed(0)+'% vs last week'):'‚Äî'}</div>
            </div>
            <div>
              <div style="color:var(--text-secondary); font-size:0.85em;">Overall Risk</div>
              <div style="font-size:1.4em; font-weight:900; color:${riskColor}; text-transform:uppercase;">${analysis.overallRisk}</div>
              <div style="font-size:0.85em; color:var(--text-secondary);">${analysis.recommendations.length} flags</div>
            </div>
          </div>

          ${analysis.overallRisk!=='low' ? `
            <div style="margin-top:14px; padding:14px; border-radius:10px; background:rgba(239,68,68,0.12); border:1px solid rgba(239,68,68,0.35);">
              <h4 style="margin:0 0 8px 0; color:var(--accent-danger);">‚ö†Ô∏è Deload Recommended</h4>
              <ul style="margin:0 0 0 18px; line-height:1.7;">
                ${analysis.recommendations.map(r=>`<li>${r}</li>`).join('')}
              </ul>
              <div style="margin-top:10px; color:var(--text-secondary);">
                Suggested protocol: reduce volume 40‚Äì50% for 5‚Äì7 days, keep intensity moderate, prioritize sleep.
              </div>
            </div>` : `
            <div style="margin-top:14px; padding:14px; border-radius:10px; background:rgba(16,185,129,0.10); border:1px solid rgba(16,185,129,0.25);">
              <strong style="color:var(--accent-success);">‚úÖ Recovery looks good.</strong>
              <div style="color:var(--text-secondary); margin-top:6px;">Train as planned ‚Äî keep an eye on sleep + RHR.</div>
            </div>`}
        </div>
      `;
    }

    // Overload recommendations (best last working set per exercise)
    const rowsEl = document.getElementById('v15_overloadRows');
    if(rowsEl){
      const lastByEx = {};
      // Build last session per exercise
      (log||[]).slice().sort((a,b)=>String(a.date).localeCompare(String(b.date))).forEach(w=>{
        (w.exercises||[]).forEach(ex=>{
          const name=(ex.name||'').trim(); if(!name) return;
          lastByEx[name]=w;
        });
      });

      const exerciseNames = Object.keys(lastByEx).sort((a,b)=>a.localeCompare(b)).slice(0,30);
      const barPct = Number(safeGet(window,'appSettings.workout.progressive_overload_barbell',2.5) || 2.5);
      const dbPct  = Number(safeGet(window,'appSettings.workout.progressive_overload_dumbbell',3.5) || 3.5);

      const isDB = (n)=>/dumbbell|\bdb\b/i.test(n);
      const roundTo = (x,step)=> Math.round(x/step)*step;

      rowsEl.innerHTML = exerciseNames.map(name=>{
        const w = lastByEx[name];
        const ex = (w.exercises||[]).find(e=>(e.name||'').trim()===name);
        const sets = (ex?.sets||[]).filter(s=>s.completed && !s.warmup);
        if(!sets.length) return '';
        const best = sets.slice().sort((a,b)=> (Number(b.weight||0)*Number(b.reps||0)) - (Number(a.weight||0)*Number(a.reps||0)))[0];
        const pct = isDB(name) ? dbPct : barPct;
        const inc = roundTo(Number(best.weight||0)*(pct/100), 2.5);
        const nextW = Number(best.weight||0) + (inc||0);
        const canProgress = Number(best.reps||0) >= 8;
        return `<tr>
          <td>${name}</td>
          <td style="font-family:'Space Mono', monospace;">${best.weight} √ó ${best.reps}</td>
          <td style="font-family:'Space Mono', monospace; font-weight:800; color:${canProgress?'var(--accent-success)':'var(--text-secondary)'};">${canProgress?`${nextW} √ó ${best.reps}`:'Hold / build reps'}</td>
          <td>${canProgress?`+${inc} lbs (${pct.toFixed(1)}%)`:'‚Äî'}</td>
        </tr>`;
      }).join('') || `<tr><td colspan="4" style="color:var(--text-secondary);">No completed working sets found yet.</td></tr>`;
    }
  };

  window.updateAnalyticsTabV15 = function(){
    const el = document.getElementById('analyticsContent');
    if(!el) return;

    let extra = document.getElementById('v15AnalyticsExtras');
    if(!extra){
      extra = document.createElement('div');
      extra.id = 'v15AnalyticsExtras';
      extra.style.marginTop = '18px';
      el.appendChild(extra);
    }

    extra.innerHTML = `
      <div class="card" style="margin:0;">
        <h3>üî• Correlation Heatmap</h3>
        <div class="info-box">
          <h4>How to read</h4>
          <p><strong>Green:</strong> negative correlation (more of X tends to reduce Y). <strong>Red:</strong> positive correlation. <strong>Gray:</strong> weak/insufficient data.</p>
          <p>Values reflect correlation between <em>yesterday's inputs</em> and <em>today's change</em>.</p>
        </div>
        <div class="heatmap-container" style="overflow-x:auto; margin-top:12px;">
          <table class="heatmap-table" style="border-collapse:collapse; width:100%;">
            <thead>
              <tr>
                <th style="background:var(--bg-tertiary); padding:12px;"></th>
                <th style="background:var(--bg-tertiary); padding:12px;">Weight Œî</th>
                <th style="background:var(--bg-tertiary); padding:12px;">Fat Œî</th>
                <th style="background:var(--bg-tertiary); padding:12px;">Lean Œî</th>
              </tr>
            </thead>
            <tbody id="v15_heatmapBody"></tbody>
          </table>
        </div>
      </div>

      <div class="card" style="margin-top:16px;">
        <h3>üìä Frequency Distributions</h3>
        <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px; margin-top: 14px;">
          <div class="chart-wrapper" style="height:280px;"><canvas id="v15_hist_calories"></canvas></div>
          <div class="chart-wrapper" style="height:280px;"><canvas id="v15_hist_protein"></canvas></div>
          <div class="chart-wrapper" style="height:280px;"><canvas id="v15_hist_weight"></canvas></div>
          <div class="chart-wrapper" style="height:280px;"><canvas id="v15_hist_sleep"></canvas></div>
        </div>
      </div>

      <div class="card" style="margin-top:16px;">
        <h3>‚ö†Ô∏è Anomaly Detection</h3>
        <div style="display:flex; gap: 12px; flex-wrap:wrap; margin-top:12px;">
          <div class="stat-card"><div class="stat-label">Total</div><div class="stat-value" id="v15_anom_total">0</div></div>
          <div class="stat-card"><div class="stat-label">Extreme (&gt;3 SD)</div><div class="stat-value" style="color:var(--accent-danger);" id="v15_anom_ext">0</div></div>
          <div class="stat-card"><div class="stat-label">Moderate (2‚Äì3 SD)</div><div class="stat-value" style="color:var(--accent-warning);" id="v15_anom_mod">0</div></div>
        </div>
        <button onclick="showAnomalyReviewV15()" style="margin-top:14px;">üìã Review All Anomalies</button>
      </div>

      <div class="card" style="margin-top:16px;">
        <h3>üìà Trend Analysis & Projections</h3>
        <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 18px; margin-top: 14px;">
          <div class="card" style="margin:0;">
            <h4>Weight Trend</h4>
            <div class="chart-wrapper" style="height:220px;"><canvas id="v15_trend_weight"></canvas></div>
            <div id="v15_trend_weight_stats" style="margin-top:10px;"></div>
          </div>
          <div class="card" style="margin:0;">
            <h4>Body Fat % Trend</h4>
            <div class="chart-wrapper" style="height:220px;"><canvas id="v15_trend_bf"></canvas></div>
            <div id="v15_trend_bf_stats" style="margin-top:10px;"></div>
          </div>
        </div>
        <div class="info-box" style="margin-top:14px;">
          <h4>Confidence</h4>
          <p>R¬≤ near 1.0 = consistent trend. Low R¬≤ = high variability (projections less reliable).</p>
        </div>
      </div>
    `;

    // Heatmap fill
    const corr = calcCorrelationsForChanges();
    const metrics = ['calories','protein','fat','carbs','steps','sleep_duration_hrs','rhr'];
    const metricNames = {calories:'Calories', protein:'Protein', fat:'Fat', carbs:'Carbs', steps:'Steps', sleep_duration_hrs:'Sleep', rhr:'RHR'};
    const outcomes = [{k:'weight_change', t:'Weight Œî'},{k:'fat_change',t:'Fat Œî'},{k:'lean_change',t:'Lean Œî'}];
    const body = document.getElementById('v15_heatmapBody');
    if(body){
      body.innerHTML = metrics.map(m=>{
        const cells = outcomes.map(o=>{
          const r = corr[m]?.[o.k];
          const bg = buildHeatmapColor(r);
          const txt = (r==null || !isFinite(r)) ? 'N/A' : r.toFixed(3);
          const tc = (r!=null && isFinite(r) && Math.abs(r)>0.3) ? 'white' : 'var(--text-primary)';
          return `<td class="heatmap-cell" style="background:${bg}; color:${tc};" title="${metricNames[m]} vs ${o.t}: ${txt}">${txt}</td>`;
        }).join('');
        return `<tr>
          <td style="background:var(--bg-tertiary); padding:12px; font-weight:700;">${metricNames[m]}</td>
          ${cells}
        </tr>`;
      }).join('');
    }

    // Histograms
    function renderHistogram(canvasId, field, binSize){
      destroyChart(canvasId);
      const canvas = document.getElementById(canvasId);
      if(!canvas || !window.Chart) return;
      const vals = (bodyData||[]).map(d=>d[field]).filter(v=>v!=null && isFinite(v));
      if(!vals.length) return;
      const min = Math.min(...vals), max = Math.max(...vals);
      const binCount = Math.max(1, Math.ceil((max-min)/binSize));
      const bins = Array(binCount).fill(0);
      const labels = Array(binCount).fill('').map((_,i)=>{
        const a = min + i*binSize;
        const b = a + binSize;
        return `${a.toFixed(0)}-${b.toFixed(0)}`;
      });
      vals.forEach(v=>{
        const idx = Math.min(binCount-1, Math.floor((v-min)/binSize));
        bins[idx] += 1;
      });
      const mean = vals.reduce((a,b)=>a+b,0)/vals.length;
      const sorted = vals.slice().sort((a,b)=>a-b);
      const median = sorted[Math.floor(sorted.length/2)];
      window.__v15Charts[canvasId] = SafeChart(canvas.getContext('2d'),{
        type:'bar',
        data:{ labels, datasets:[{ data: bins, borderWidth:1 }] },
        options:{
          responsive:true, maintainAspectRatio:false,
          plugins:{ legend:{display:false}, title:{display:true, text:`${field} | Mean: ${mean.toFixed(1)} | Median: ${median.toFixed(1)}`, color:'#f1f5f9'} },
          scales:{
            x:{ ticks:{ color:'#94a3b8', maxRotation:0, autoSkip:true }, grid:{ color:'#334155'} },
            y:{ ticks:{ color:'#94a3b8', stepSize:1 }, grid:{ color:'#334155'}, title:{display:true, text:'Days', color:'#94a3b8'} }
          }
        }
      });
    }
    renderHistogram('v15_hist_calories','calories',100);
    renderHistogram('v15_hist_protein','protein',20);
    renderHistogram('v15_hist_weight','weight',0.5);
    renderHistogram('v15_hist_sleep','sleep_duration_hrs',0.5);

    // Anomalies
    function detectAnomaliesV15(){
      const fields = ['weight','bf_percent','calories','protein','steps','sleep_duration_hrs','rhr'];
      const anoms = [];
      fields.forEach(field=>{
        const vals = (bodyData||[]).map(d=>d[field]).filter(v=>v!=null && isFinite(v));
        if(vals.length<10) return;
        const mean = vals.reduce((a,b)=>a+b,0)/vals.length;
        const variance = vals.reduce((s,v)=>s+Math.pow(v-mean,2),0)/vals.length;
        const sd = Math.sqrt(variance) || 0;
        (bodyData||[]).forEach(e=>{
          const v = e[field];
          if(v==null || !isFinite(v) || sd===0) return;
          const z = Math.abs((v-mean)/sd);
          if(z>2){
            anoms.push({date:e.date, field, value:v, mean, sd, z, severity: z>3?'extreme':'moderate', refeed:!!e.refeed});
          }
        });
      });
      // de-dupe by date+field
      const seen = new Set();
      return anoms.filter(a=>{
        const k = a.date+'|'+a.field;
        if(seen.has(k)) return false;
        seen.add(k);
        return true;
      }).sort((a,b)=> (b.z-a.z));
    }
    window.__v15Anomalies = detectAnomaliesV15();
    const total = window.__v15Anomalies.length;
    const ext = window.__v15Anomalies.filter(a=>a.severity==='extreme').length;
    const mod = total-ext;
    const tEl=document.getElementById('v15_anom_total'); if(tEl) tEl.textContent = total;
    const eEl=document.getElementById('v15_anom_ext'); if(eEl) eEl.textContent = ext;
    const mEl=document.getElementById('v15_anom_mod'); if(mEl) mEl.textContent = mod;

    // Trend regression
    function linReg(field){
      const sorted = (bodyData||[]).slice().sort((a,b)=>String(a.date).localeCompare(String(b.date)));
      const pts = sorted.map((d,i)=>({x:i,y:d[field]})).filter(p=>p.y!=null && isFinite(p.y));
      if(pts.length<5) return null;
      const n=pts.length;
      const sumX=pts.reduce((s,p)=>s+p.x,0), sumY=pts.reduce((s,p)=>s+p.y,0);
      const sumXY=pts.reduce((s,p)=>s+p.x*p.y,0), sumX2=pts.reduce((s,p)=>s+p.x*p.x,0);
      const slope = (n*sumXY - sumX*sumY)/(n*sumX2 - sumX*sumX);
      const intercept = (sumY - slope*sumX)/n;
      const meanY = sumY/n;
      const ssT = pts.reduce((s,p)=>s+Math.pow(p.y-meanY,2),0);
      const ssR = pts.reduce((s,p)=>{const pred=slope*p.x+intercept; return s+Math.pow(p.y-pred,2);},0);
      const r2 = ssT===0 ? 0 : (1 - ssR/ssT);
      return {slope, intercept, r2, predict:(dx)=>slope*dx+intercept, n};
    }

    function renderTrend(canvasId, field, statsId){
      destroyChart(canvasId);
      const reg = linReg(field);
      const sorted = (bodyData||[]).slice().sort((a,b)=>String(a.date).localeCompare(String(b.date)));
      const labels = sorted.map(d=>String(d.date).slice(5));
      const vals = sorted.map(d=>d[field] ?? null);
      if(!window.Chart || !document.getElementById(canvasId)) return;
      const pred = reg ? vals.map((_,i)=>reg.predict(i)) : [];
      window.__v15Charts[canvasId] = SafeChart(document.getElementById(canvasId).getContext('2d'),{
        type:'line',
        data:{ labels, datasets:[
          { label: field, data: vals, borderWidth:2, pointRadius:2, tension:0.35 },
          ...(reg?[{ label:'Trend', data: pred, borderWidth:2, pointRadius:0, borderDash:[6,6], tension:0 }]:[])
        ]},
        options:{
          responsive:true, maintainAspectRatio:false,
          plugins:{ legend:{ position:'bottom', labels:{ color:'#94a3b8' } } },
          scales:{ x:{ ticks:{ color:'#94a3b8' }, grid:{ color:'#334155' } }, y:{ ticks:{ color:'#94a3b8' }, grid:{ color:'#334155' } } }
        }
      });
      const sEl = document.getElementById(statsId);
      if(sEl){
        const perWeek = reg ? (reg.slope*7) : null;
        const last = sorted.at(-1)?.[field];
        const proj7 = reg ? reg.predict(reg.n-1 + 7) : null;
        const proj30 = reg ? reg.predict(reg.n-1 + 30) : null;
        sEl.innerHTML = reg ? `
          <div style="display:flex; justify-content:space-between; margin-bottom:6px;"><span style="color:var(--text-secondary);">Trend</span><span style="font-weight:800;">${(perWeek>=0?'+':'')}${perWeek.toFixed(2)} /wk</span></div>
          <div style="display:flex; justify-content:space-between; margin-bottom:6px;"><span style="color:var(--text-secondary);">Current</span><span style="font-weight:800;">${last!=null?Number(last).toFixed(1):'‚Äî'}</span></div>
          <div style="display:flex; justify-content:space-between; margin-bottom:6px;"><span style="color:var(--text-secondary);">Projected (7d)</span><span style="font-weight:800;">${proj7!=null?proj7.toFixed(1):'‚Äî'}</span></div>
          <div style="display:flex; justify-content:space-between; margin-bottom:6px;"><span style="color:var(--text-secondary);">Projected (30d)</span><span style="font-weight:800;">${proj30!=null?proj30.toFixed(1):'‚Äî'}</span></div>
          <div style="display:flex; justify-content:space-between;"><span style="color:var(--text-secondary);">R¬≤</span><span style="font-weight:800; color:var(--accent-cyan);">${reg.r2.toFixed(2)}</span></div>
        ` : `<p style="color:var(--text-secondary);">Not enough data for projections.</p>`;
      }
    }
    renderTrend('v15_trend_weight','weight','v15_trend_weight_stats');
    renderTrend('v15_trend_bf','bf_percent','v15_trend_bf_stats');

    // Add anomaly review modal once
    ensureModalInBody('anomalyReviewModalV15', `
      <div class="modal-overlay" id="anomalyReviewModalV15">
        <div class="modal">
          <h2>‚ö†Ô∏è Anomaly Review</h2>
          <div id="v15_anomalyList" style="max-height: 500px; overflow-y: auto; margin-top: 10px;"></div>
          <button class="primary" onclick="closeAnomalyReviewV15()" style="width:100%; margin-top: 15px;">Close</button>
        </div>
      </div>
    `);

    window.showAnomalyReviewV15 = function(){
      const m = document.getElementById('anomalyReviewModalV15');
      const list = document.getElementById('v15_anomalyList');
      if(!m || !list) return;
      const anoms = window.__v15Anomalies || [];
      list.innerHTML = anoms.length ? anoms.slice(0,50).map(a=>`
        <div class="warning-box" style="margin-bottom: 12px;">
          <div style="display:flex; justify-content:space-between; gap: 12px;">
            <div>
              <h4 style="margin:0; color:${a.severity==='extreme'?'var(--accent-danger)':'var(--accent-warning)'};">${a.date} ‚Äî ${a.field}</h4>
              <div style="margin-top:8px; color:var(--text-secondary); line-height:1.6;">
                <strong>Value:</strong> ${Number(a.value).toFixed(2)}<br/>
                <strong>Z-Score:</strong> ${a.z.toFixed(2)} (${a.severity})<br/>
                ${a.refeed ? '<span style="color:var(--accent-purple); font-weight:700;">Refeed day</span>' : ''}
              </div>
            </div>
            <div style="display:flex; flex-direction:column; gap:6px; min-width:120px;">
              <button onclick="editEntry('${a.date}')" style="padding:8px 10px;">‚úèÔ∏è Edit</button>
              <button class="danger" onclick="deleteEntry('${a.date}')" style="padding:8px 10px;">üóëÔ∏è Delete</button>
            </div>
          </div>
        </div>
      `).join('') : `<p style="color:var(--text-secondary);">No anomalies detected.</p>`;
      m.classList.add('show');
    };
    window.closeAnomalyReviewV15 = function(){
      const m = document.getElementById('anomalyReviewModalV15');
      if(m) m.classList.remove('show');
    };
  };

  // PR Celebration modal once
  ensureModalInBody('prCelebrationModal', `
    <div class="modal-overlay" id="prCelebrationModal">
      <div class="modal celebration-modal">
        <div class="confetti-container"></div>
        <h2 style="font-size: 2em; text-align: center;">üèÜ NEW PERSONAL RECORD! üèÜ</h2>
        <div id="prCelebrationContent" style="text-align:center; margin: 20px 0;"></div>
        <div style="display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">
          <button class="primary" onclick="closePRCelebration()">Continue</button>
        </div>
      </div>
    </div>
  `);

  window.showPRCelebrationV15 = function(pr){
    const m = document.getElementById('prCelebrationModal');
    const c = document.getElementById('prCelebrationContent');
    if(!m || !c) return;
    c.innerHTML = `
      <div style="font-size:1.4em; font-weight:900; color:var(--accent-success); margin-bottom:6px;">${pr.exercise} ‚Äî ${pr.type.toUpperCase()}</div>
      <div style="font-size:3em; font-weight:900; font-family:'Space Mono', monospace;">${pr.value}${pr.type==='reps'?' reps':' lbs'}</div>
      <div style="color:var(--text-secondary); margin-top:6px;">Previous: ${pr.previous || 0}</div>
      <div style="font-size:1.2em; color:var(--accent-cyan); margin-top:8px;">+${pr.improvement} improvement! üí™</div>
      ${pr.details?`<div style="color:var(--text-secondary); margin-top:10px;">${pr.details}</div>`:''}
    `;
    m.classList.add('show');
    window.showConfettiV15();
  };

  // Hook workout save to detect PRs (non-breaking)
  const _origSave = window.saveWorkoutFromModal;
  if(typeof _origSave === 'function' && !window.__v15SaveWrapped){
    window.__v15SaveWrapped = true;
    window.saveWorkoutFromModal = function(existingId){
      // Snapshot PRs for relevant exercises BEFORE save
      const before = JSON.parse(JSON.stringify(safeGet(window,'personalRecords.prs',{})||{}));
      const res = _origSave.apply(this, arguments);
      try{
        // After save, PRs will be recomputed in updateProgressiveTabV13; do a quick diff if possible
        if(typeof updatePersonalRecordsFromTraining === 'function'){
          updatePersonalRecordsFromTraining();
        }
        const after = safeGet(window,'personalRecords.prs',{})||{};
        // Find first improvement (show one celebration to avoid spam)
        const exs = new Set([...Object.keys(before), ...Object.keys(after)]);
        let found = null;
        exs.forEach(name=>{
          if(found) return;
          const b = before[name]||{}, a = after[name]||{};
          const types = ['1rm','volume','reps'];
          types.forEach(t=>{
            if(found) return;
            const bv = safeGet(b, t+'.value', null);
            const av = safeGet(a, t+'.value', null);
            if(av!=null && isFinite(av) && (bv==null || av>bv)){
              const improvement = (bv==null)?av:(av-bv);
              const details = t==='1rm' ? `${a[t].weight} √ó ${a[t].reps} (${a[t].date})` :
                              t==='volume' ? `${a[t].totalSets} sets (${a[t].date})` :
                              `${a[t].value} @ ${a[t].weight} lbs (${a[t].date})`;
              found = {exercise:name, type:t, value:Math.round(av), previous: bv?Math.round(bv):0, improvement: Math.round(improvement), details};
            }
          });
        });
        if(found) window.showPRCelebrationV15(found);
      }catch{}
      return res;
    };
  }
})();


</script>
</body>
</html>
