<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete Body Composition & Training Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --bg-input: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border: #334155;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border);
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(135deg, var(--primary), var(--success));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        /* Tab System */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid var(--border);
            overflow-x: auto;
        }

        .tab {
            padding: 15px 25px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .tab:hover {
            color: var(--text-primary);
            background: var(--bg-input);
        }

        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Cards */
        .card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid var(--border);
        }

        .card h2 {
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        /* Form Elements */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 0.875rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 12px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 1rem;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1rem;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-hover);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-secondary {
            background: var(--bg-input);
            color: var(--text-primary);
        }

        .btn-block {
            width: 100%;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border);
        }

        .stat-card h3 {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-card .value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-card .label {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .positive { color: var(--success); }
        .negative { color: var(--danger); }
        .neutral { color: var(--text-secondary); }

        /* Table */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .data-table th {
            background: var(--bg-input);
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.875rem;
            text-transform: uppercase;
        }

        .data-table tr:hover {
            background: var(--bg-input);
        }

        .data-table button {
            padding: 6px 12px;
            font-size: 0.875rem;
            margin-right: 5px;
        }

        /* Training Log Specific */
        .body-parts-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        .checkbox-label {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 15px;
            background: var(--bg-input);
            border: 2px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            user-select: none;
        }

        .checkbox-label:hover {
            border-color: var(--primary);
            background: var(--bg-card);
        }

        .checkbox-label input:checked + span {
            font-weight: 600;
        }

        .checkbox-label:has(input:checked) {
            border-color: var(--primary);
            background: rgba(37, 99, 235, 0.1);
        }

        .exercise-row {
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .exercise-header {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 15px;
        }

        .exercise-number {
            background: var(--primary);
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.1rem;
            flex-shrink: 0;
        }

        .exercise-input-wrapper {
            position: relative;
            flex: 1;
        }

        .exercise-input {
            width: 100%;
        }

        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-top: 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .autocomplete-item {
            padding: 12px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .autocomplete-item:hover,
        .autocomplete-item.selected {
            background: var(--primary);
        }

        .sets-grid {
            display: grid;
            grid-template-columns: auto repeat(6, 1fr);
            gap: 10px;
            align-items: center;
        }

        .set-label {
            font-weight: 600;
            font-size: 0.875rem;
            color: var(--text-secondary);
            text-align: center;
        }

        .set-input {
            padding: 8px;
            text-align: center;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .set-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .set-checkbox {
            transform: scale(1.3);
            cursor: pointer;
        }

        .previous-workout {
            background: rgba(37, 99, 235, 0.1);
            border: 1px solid var(--primary);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .previous-workout h4 {
            color: var(--primary);
            margin-bottom: 10px;
            font-size: 0.95rem;
        }

        .previous-workout-sets {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }

        .previous-set {
            background: var(--bg-card);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .warmup-indicator {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-size: 0.75rem;
            color: var(--warning);
            margin-top: 5px;
        }

        .warmup-indicator input {
            transform: scale(1.2);
        }

        /* Charts */
        .chart-container {
            position: relative;
            height: 400px;
            margin-bottom: 30px;
        }

        /* Insights */
        .insight-card {
            background: var(--bg-input);
            border-left: 4px solid var(--primary);
            padding: 15px 20px;
            margin-bottom: 15px;
            border-radius: 8px;
        }

        .insight-card.success {
            border-left-color: var(--success);
        }

        .insight-card.warning {
            border-left-color: var(--warning);
        }

        .insight-card.danger {
            border-left-color: var(--danger);
        }

        .insight-card h4 {
            margin-bottom: 8px;
            font-size: 1rem;
        }

        .insight-card p {
            color: var(--text-secondary);
            font-size: 0.95rem;
            line-height: 1.5;
        }

        /* Weekly Summary */
        .weekly-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-section {
            background: var(--bg-input);
            border-radius: 12px;
            padding: 20px;
        }

        .summary-section h3 {
            font-size: 1.1rem;
            margin-bottom: 15px;
            color: var(--primary);
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
        }

        .summary-row:last-child {
            border-bottom: none;
        }

        .summary-row .label {
            color: var(--text-secondary);
        }

        .summary-row .value {
            font-weight: 600;
        }

        /* PR Badge */
        .pr-badge {
            display: inline-block;
            background: linear-gradient(135deg, #f59e0b, #ef4444);
            color: white;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 700;
            margin-left: 8px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .sets-grid {
                grid-template-columns: auto repeat(3, 1fr);
            }

            .tabs {
                font-size: 0.9rem;
            }

            .tab {
                padding: 12px 15px;
            }

            .stat-card .value {
                font-size: 1.5rem;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Loading Spinner */
        .spinner {
            border: 3px solid var(--border);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }

        /* Correlation Chart */
        .correlation-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        /* Export Button */
        .export-section {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        /* Template Buttons */
        .template-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .template-btn {
            padding: 15px;
            background: var(--bg-input);
            border: 2px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: left;
        }

        .template-btn:hover {
            border-color: var(--primary);
            background: var(--bg-card);
        }

        .template-btn h4 {
            margin-bottom: 5px;
            color: var(--text-primary);
        }

        .template-btn p {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üí™ Complete Body Composition & Training Tracker</h1>
            <p>Track your physique, training, and performance - All in one place</p>
        </div>

        <!-- Tab Navigation -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('daily')">üìÖ Daily Log</button>
            <button class="tab" onclick="switchTab('training')">üèãÔ∏è Training Log</button>
            <button class="tab" onclick="switchTab('progress')">üìä Progress & Analytics</button>
            <button class="tab" onclick="switchTab('correlations')">üîç Correlations & Insights</button>
        </div>

        <!-- Tab 1: Daily Body Metrics -->
        <div id="daily-tab" class="tab-content active">
            <div class="card">
                <h2>üìà Daily Body Metrics</h2>
                <form id="daily-form">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Date *</label>
                            <input type="date" id="date" required>
                        </div>
                        <div class="form-group">
                            <label>Weight (lbs) *</label>
                            <input type="number" id="weight" step="0.1" required>
                        </div>
                        <div class="form-group">
                            <label>Body Fat % *</label>
                            <input type="number" id="bodyfat" step="0.1" required>
                        </div>
                        <div class="form-group">
                            <label>Calories</label>
                            <input type="number" id="calories">
                        </div>
                        <div class="form-group">
                            <label>Protein (g)</label>
                            <input type="number" id="protein">
                        </div>
                        <div class="form-group">
                            <label>Carbs (g)</label>
                            <input type="number" id="carbs">
                        </div>
                        <div class="form-group">
                            <label>Fat (g)</label>
                            <input type="number" id="fat">
                        </div>
                        <div class="form-group">
                            <label>Steps</label>
                            <input type="number" id="steps">
                        </div>
                        <div class="form-group">
                            <label>Sleep (hours)</label>
                            <input type="number" id="sleep" step="0.1">
                        </div>
                        <div class="form-group">
                            <label>Water (oz)</label>
                            <input type="number" id="water">
                        </div>
                        <div class="form-group">
                            <label>Stress (1-10)</label>
                            <input type="number" id="stress" min="1" max="10">
                        </div>
                        <div class="form-group">
                            <label>Body Temp (¬∞F)</label>
                            <input type="number" id="bodytemp" step="0.1">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Daily Notes</label>
                        <textarea id="notes" placeholder="How did you feel today? Any notable observations..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary btn-block">üíæ Save Daily Data</button>
                </form>
            </div>

            <!-- Current Stats -->
            <div class="stats-grid" id="current-stats">
                <!-- Stats will be populated by JavaScript -->
            </div>

            <!-- Recent Data Table -->
            <div class="card">
                <h2>üìä Recent Entries</h2>
                <div style="overflow-x: auto;">
                    <table class="data-table" id="daily-data-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Weight</th>
                                <th>BF%</th>
                                <th>Lean Mass</th>
                                <th>Fat Mass</th>
                                <th>Calories</th>
                                <th>Protein</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="daily-data-body">
                        </tbody>
                    </table>
                </div>
                <div class="export-section">
                    <button onclick="exportDailyData()" class="btn btn-secondary">üì• Export Body Data CSV</button>
                    <button onclick="clearAllDailyData()" class="btn btn-danger">üóëÔ∏è Clear All Daily Data</button>
                </div>
            </div>
        </div>

        <!-- Tab 2: Training Log -->
        <div id="training-tab" class="tab-content">
            <div class="card">
                <h2>üèãÔ∏è Training Log</h2>
                
                <!-- Training Templates -->
                <div style="margin-bottom: 30px;">
                    <h3 style="margin-bottom: 15px;">Quick Start Templates</h3>
                    <div class="template-grid" id="template-grid">
                        <!-- Templates populated by JavaScript -->
                    </div>
                </div>

                <form id="training-form">
                    <!-- Session Details -->
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Date *</label>
                            <input type="date" id="train-date" required>
                        </div>
                        <div class="form-group">
                            <label>Time</label>
                            <input type="time" id="train-time">
                        </div>
                        <div class="form-group">
                            <label>Duration (min)</label>
                            <input type="number" id="duration">
                        </div>
                        <div class="form-group">
                            <label>RPE (1-10)</label>
                            <input type="number" id="rpe" min="1" max="10">
                        </div>
                    </div>

                    <!-- Body Parts -->
                    <div style="margin-bottom: 25px;">
                        <label style="display: block; margin-bottom: 10px; font-weight: 600; color: var(--text-secondary);">Body Parts Trained</label>
                        <div class="body-parts-grid">
                            <label class="checkbox-label">
                                <input type="checkbox" value="Back"><span>Back</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" value="Chest"><span>Chest</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" value="Legs"><span>Legs</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" value="Shoulders"><span>Shoulders</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" value="Biceps"><span>Biceps</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" value="Triceps"><span>Triceps</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" value="Forearms"><span>Forearms</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" value="Calves"><span>Calves</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" value="Abs"><span>Abs</span>
                            </label>
                        </div>
                    </div>

                    <!-- Exercises -->
                    <div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3>Exercises</h3>
                            <button type="button" onclick="addExerciseRow()" class="btn btn-secondary">+ Add Exercise</button>
                        </div>
                        <div id="exercises-container">
                            <!-- Exercise rows will be added here -->
                        </div>
                    </div>

                    <!-- Cardio -->
                    <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid var(--border);">
                        <h3 style="margin-bottom: 15px;">Cardio (Optional)</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Type</label>
                                <select id="cardio-type">
                                    <option value="">None</option>
                                    <option value="Running">Running</option>
                                    <option value="Walking">Walking</option>
                                    <option value="Cycling">Cycling</option>
                                    <option value="Rowing">Rowing</option>
                                    <option value="Elliptical">Elliptical</option>
                                    <option value="Swimming">Swimming</option>
                                    <option value="Stairmaster">Stairmaster</option>
                                    <option value="HIIT">HIIT</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Time (min)</label>
                                <input type="number" id="cardio-time">
                            </div>
                            <div class="form-group">
                                <label>Distance (mi)</label>
                                <input type="number" id="cardio-distance" step="0.1">
                            </div>
                            <div class="form-group">
                                <label>Avg HR</label>
                                <input type="number" id="cardio-hr">
                            </div>
                            <div class="form-group">
                                <label>Intensity (1-10)</label>
                                <input type="number" id="cardio-intensity" min="1" max="10">
                            </div>
                        </div>
                    </div>

                    <!-- Training Notes -->
                    <div class="form-group" style="margin-top: 20px;">
                        <label>Training Notes</label>
                        <textarea id="train-notes" placeholder="How did the workout feel? Any PRs, form notes, or adjustments..."></textarea>
                    </div>

                    <button type="submit" class="btn btn-success btn-block" style="margin-top: 20px;">üí™ Save Training Session</button>
                </form>
            </div>

            <!-- Training History -->
            <div class="card">
                <h2>üìä Training History</h2>
                <div style="overflow-x: auto;">
                    <table class="data-table" id="training-data-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Time</th>
                                <th>Duration</th>
                                <th>Body Parts</th>
                                <th>Exercises</th>
                                <th>Sets</th>
                                <th>Volume</th>
                                <th>RPE</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="training-data-body">
                        </tbody>
                    </table>
                </div>
                <div class="export-section">
                    <button onclick="exportTrainingData()" class="btn btn-secondary">üì• Export Training CSV</button>
                    <button onclick="clearAllTrainingData()" class="btn btn-danger">üóëÔ∏è Clear All Training Data</button>
                </div>
            </div>
        </div>

        <!-- Tab 3: Progress & Analytics -->
        <div id="progress-tab" class="tab-content">
            <!-- Weekly Summary -->
            <div class="card">
                <h2>üìÖ Weekly Summary</h2>
                <div id="weekly-summary-container">
                    <!-- Populated by JavaScript -->
                </div>
            </div>

            <!-- Body Composition Charts -->
            <div class="card">
                <h2>üìà Body Composition Trends</h2>
                <div class="chart-container">
                    <canvas id="weight-chart"></canvas>
                </div>
                <div class="chart-container">
                    <canvas id="composition-chart"></canvas>
                </div>
            </div>

            <!-- Training Volume Charts -->
            <div class="card">
                <h2>üèãÔ∏è Training Volume Trends</h2>
                <div class="chart-container">
                    <canvas id="volume-chart"></canvas>
                </div>
                <div class="chart-container">
                    <canvas id="muscle-volume-chart"></canvas>
                </div>
            </div>

            <!-- Strength Progress -->
            <div class="card">
                <h2>üí™ Strength Progress (Estimated 1RM)</h2>
                <div class="chart-container">
                    <canvas id="strength-chart"></canvas>
                </div>
                <div id="pr-list" style="margin-top: 20px;">
                    <!-- PR list populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Tab 4: Correlations & Insights -->
        <div id="correlations-tab" class="tab-content">
            <div class="card">
                <h2>üîç Correlations & Insights</h2>
                <p style="color: var(--text-secondary); margin-bottom: 20px;">
                    Analyzing relationships between your training, nutrition, and body composition changes.
                    Minimum 4 weeks of data recommended for accurate insights.
                </p>
                <div id="insights-container">
                    <!-- Insights populated by JavaScript -->
                </div>
            </div>

            <!-- Correlation Charts -->
            <div class="card">
                <h2>üìä Correlation Analysis</h2>
                <div class="correlation-grid">
                    <div>
                        <h3 style="margin-bottom: 15px;">Training Volume ‚Üí Lean Mass</h3>
                        <div class="chart-container">
                            <canvas id="volume-lean-chart"></canvas>
                        </div>
                    </div>
                    <div>
                        <h3 style="margin-bottom: 15px;">Calories ‚Üí Weight Change</h3>
                        <div class="chart-container">
                            <canvas id="calories-weight-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Performance Analysis -->
            <div class="card">
                <h2>‚ö° Performance Analysis</h2>
                <div id="performance-analysis">
                    <!-- Populated by JavaScript -->
                </div>
            </div>

            <!-- Recommendations -->
            <div class="card">
                <h2>üéØ Personalized Recommendations</h2>
                <div id="recommendations-container">
                    <!-- Recommendations populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== DATA STORAGE ====================
        
        let dailyData = JSON.parse(localStorage.getItem('dailyData') || '[]');
        let trainingData = JSON.parse(localStorage.getItem('trainingData') || '[]');
        let exerciseLibrary = JSON.parse(localStorage.getItem('exerciseLibrary') || '[]');
        
        // Initialize with common exercises if library is empty
        if (exerciseLibrary.length === 0) {
            exerciseLibrary = [
                'Bench Press', 'Incline Bench Press', 'Decline Bench Press',
                'Squat', 'Deadlift', 'Romanian Deadlift',
                'Overhead Press', 'Barbell Row', 'Pull-ups',
                'Lat Pulldown', 'Leg Press', 'Leg Curl', 'Leg Extension',
                'Dumbbell Fly', 'Cable Fly', 'Dumbbell Press',
                'Barbell Curl', 'Hammer Curl', 'Tricep Pushdown',
                'Lateral Raise', 'Front Raise', 'Face Pull',
                'Calf Raise', 'Plank', 'Crunch'
            ];
            localStorage.setItem('exerciseLibrary', JSON.stringify(exerciseLibrary));
        }

        // Training Templates
        const trainingTemplates = [
            {
                name: 'Push Day A (Chest Focus)',
                exercises: [
                    { name: 'Bench Press', sets: 3 },
                    { name: 'Incline Dumbbell Press', sets: 3 },
                    { name: 'Cable Fly', sets: 3 },
                    { name: 'Overhead Press', sets: 3 },
                    { name: 'Lateral Raise', sets: 3 },
                    { name: 'Tricep Pushdown', sets: 3 }
                ],
                bodyParts: ['Chest', 'Shoulders', 'Triceps']
            },
            {
                name: 'Pull Day (Back Focus)',
                exercises: [
                    { name: 'Deadlift', sets: 3 },
                    { name: 'Barbell Row', sets: 3 },
                    { name: 'Pull-ups', sets: 3 },
                    { name: 'Lat Pulldown', sets: 3 },
                    { name: 'Face Pull', sets: 3 },
                    { name: 'Barbell Curl', sets: 3 }
                ],
                bodyParts: ['Back', 'Biceps']
            },
            {
                name: 'Leg Day (Quad Focus)',
                exercises: [
                    { name: 'Squat', sets: 4 },
                    { name: 'Leg Press', sets: 3 },
                    { name: 'Leg Extension', sets: 3 },
                    { name: 'Romanian Deadlift', sets: 3 },
                    { name: 'Leg Curl', sets: 3 },
                    { name: 'Calf Raise', sets: 4 }
                ],
                bodyParts: ['Legs', 'Calves']
            }
        ];

        let exerciseCounter = 0;

        // ==================== INITIALIZATION ====================
        
        function initializeApp() {
            // Set today's date as default
            document.getElementById('date').valueAsDate = new Date();
            document.getElementById('train-date').valueAsDate = new Date();
            
            // Load data
            renderDailyStats();
            renderDailyTable();
            renderTrainingTable();
            renderTemplates();
            
            // Add one exercise row by default
            addExerciseRow();
        }

        // ==================== TAB SWITCHING ====================
        
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');
            
            // Update charts and data for the selected tab
            if (tabName === 'progress') {
                renderProgressCharts();
            } else if (tabName === 'correlations') {
                renderCorrelations();
            }
        }

        // ==================== DAILY LOG FUNCTIONS ====================
        
        document.getElementById('daily-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const entry = {
                date: document.getElementById('date').value,
                weight: parseFloat(document.getElementById('weight').value),
                bodyfat: parseFloat(document.getElementById('bodyfat').value),
                calories: parseInt(document.getElementById('calories').value) || null,
                protein: parseInt(document.getElementById('protein').value) || null,
                carbs: parseInt(document.getElementById('carbs').value) || null,
                fat: parseInt(document.getElementById('fat').value) || null,
                steps: parseInt(document.getElementById('steps').value) || null,
                sleep: parseFloat(document.getElementById('sleep').value) || null,
                water: parseInt(document.getElementById('water').value) || null,
                stress: parseInt(document.getElementById('stress').value) || null,
                bodytemp: parseFloat(document.getElementById('bodytemp').value) || null,
                notes: document.getElementById('notes').value || ''
            };
            
            // Calculate lean and fat mass
            entry.leanMass = entry.weight * (1 - entry.bodyfat / 100);
            entry.fatMass = entry.weight * (entry.bodyfat / 100);
            
            // Check if date already exists
            const existingIndex = dailyData.findIndex(d => d.date === entry.date);
            if (existingIndex >= 0) {
                if (confirm('Data for this date already exists. Overwrite?')) {
                    dailyData[existingIndex] = entry;
                }
            } else {
                dailyData.push(entry);
            }
            
            // Sort by date
            dailyData.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // Save and update
            localStorage.setItem('dailyData', JSON.stringify(dailyData));
            renderDailyStats();
            renderDailyTable();
            
            alert('Daily data saved successfully!');
        });

        function renderDailyStats() {
            const container = document.getElementById('current-stats');
            if (dailyData.length === 0) {
                container.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: var(--text-secondary);">No data yet. Add your first entry above!</p>';
                return;
            }
            
            const latest = dailyData[0];
            const weekAgo = dailyData.find(d => {
                const daysDiff = (new Date(latest.date) - new Date(d.date)) / (1000 * 60 * 60 * 24);
                return daysDiff >= 6 && daysDiff <= 8;
            });
            
            let html = `
                <div class="stat-card">
                    <h3>Current Weight</h3>
                    <div class="value">${latest.weight.toFixed(1)}</div>
                    <div class="label">lbs</div>
                    ${weekAgo ? `<div class="${latest.weight < weekAgo.weight ? 'positive' : 'negative'}">
                        ${(latest.weight - weekAgo.weight).toFixed(1)} lbs this week
                    </div>` : ''}
                </div>
                <div class="stat-card">
                    <h3>Body Fat %</h3>
                    <div class="value">${latest.bodyfat.toFixed(1)}%</div>
                    <div class="label">${latest.fatMass.toFixed(1)} lbs fat mass</div>
                    ${weekAgo ? `<div class="${latest.bodyfat < weekAgo.bodyfat ? 'positive' : 'negative'}">
                        ${(latest.bodyfat - weekAgo.bodyfat).toFixed(1)}% this week
                    </div>` : ''}
                </div>
                <div class="stat-card">
                    <h3>Lean Mass</h3>
                    <div class="value">${latest.leanMass.toFixed(1)}</div>
                    <div class="label">lbs</div>
                    ${weekAgo ? `<div class="${latest.leanMass > weekAgo.leanMass ? 'positive' : 'negative'}">
                        ${(latest.leanMass - weekAgo.leanMass).toFixed(1)} lbs this week
                    </div>` : ''}
                </div>
            `;
            
            if (latest.calories) {
                html += `
                    <div class="stat-card">
                        <h3>Today's Nutrition</h3>
                        <div class="value">${latest.calories}</div>
                        <div class="label">
                            ${latest.protein}g P / ${latest.carbs}g C / ${latest.fat}g F
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }

        function renderDailyTable() {
            const tbody = document.getElementById('daily-data-body');
            if (dailyData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: var(--text-secondary);">No entries yet</td></tr>';
                return;
            }
            
            tbody.innerHTML = dailyData.map((entry, index) => `
                <tr>
                    <td>${entry.date}</td>
                    <td>${entry.weight.toFixed(1)}</td>
                    <td>${entry.bodyfat.toFixed(1)}%</td>
                    <td>${entry.leanMass.toFixed(1)}</td>
                    <td>${entry.fatMass.toFixed(1)}</td>
                    <td>${entry.calories || '-'}</td>
                    <td>${entry.protein || '-'}g</td>
                    <td>
                        <button onclick="editDailyEntry(${index})" class="btn btn-secondary">Edit</button>
                        <button onclick="deleteDailyEntry(${index})" class="btn btn-danger">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        function editDailyEntry(index) {
            const entry = dailyData[index];
            document.getElementById('date').value = entry.date;
            document.getElementById('weight').value = entry.weight;
            document.getElementById('bodyfat').value = entry.bodyfat;
            document.getElementById('calories').value = entry.calories || '';
            document.getElementById('protein').value = entry.protein || '';
            document.getElementById('carbs').value = entry.carbs || '';
            document.getElementById('fat').value = entry.fat || '';
            document.getElementById('steps').value = entry.steps || '';
            document.getElementById('sleep').value = entry.sleep || '';
            document.getElementById('water').value = entry.water || '';
            document.getElementById('stress').value = entry.stress || '';
            document.getElementById('bodytemp').value = entry.bodytemp || '';
            document.getElementById('notes').value = entry.notes || '';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function deleteDailyEntry(index) {
            if (confirm('Delete this entry?')) {
                dailyData.splice(index, 1);
                localStorage.setItem('dailyData', JSON.stringify(dailyData));
                renderDailyStats();
                renderDailyTable();
            }
        }

        function exportDailyData() {
            if (dailyData.length === 0) {
                alert('No data to export');
                return;
            }
            
            const headers = 'Date,Weight,Body Fat %,Lean Mass,Fat Mass,Calories,Protein,Carbs,Fat,Steps,Sleep,Water,Stress,Body Temp,Notes\n';
            const csv = headers + dailyData.map(d => 
                `${d.date},${d.weight},${d.bodyfat},${d.leanMass.toFixed(2)},${d.fatMass.toFixed(2)},${d.calories||''},${d.protein||''},${d.carbs||''},${d.fat||''},${d.steps||''},${d.sleep||''},${d.water||''},${d.stress||''},${d.bodytemp||''},"${(d.notes||'').replace(/"/g, '""')}"`
            ).join('\n');
            
            downloadCSV(csv, 'body-composition-data.csv');
        }

        function clearAllDailyData() {
            if (confirm('Are you sure you want to delete ALL daily data? This cannot be undone!')) {
                if (confirm('FINAL WARNING: This will permanently delete all your body composition data!')) {
                    dailyData = [];
                    localStorage.setItem('dailyData', JSON.stringify(dailyData));
                    renderDailyStats();
                    renderDailyTable();
                    alert('All daily data has been cleared');
                }
            }
        }

        // ==================== TRAINING LOG FUNCTIONS ====================
        
        function renderTemplates() {
            const container = document.getElementById('template-grid');
            container.innerHTML = trainingTemplates.map((template, index) => `
                <div class="template-btn" onclick="loadTemplate(${index})">
                    <h4>${template.name}</h4>
                    <p>${template.exercises.length} exercises</p>
                </div>
            `).join('');
        }

        function loadTemplate(index) {
            const template = trainingTemplates[index];
            
            // Check body parts
            const checkboxes = document.querySelectorAll('.body-parts-grid input[type="checkbox"]');
            checkboxes.forEach(cb => {
                cb.checked = template.bodyParts.includes(cb.value);
            });
            
            // Clear existing exercises
            document.getElementById('exercises-container').innerHTML = '';
            exerciseCounter = 0;
            
            // Add template exercises
            template.exercises.forEach(exercise => {
                addExerciseRow(exercise.name, exercise.sets);
            });
            
            alert(`Template "${template.name}" loaded! Fill in your weights and reps.`);
        }

        function addExerciseRow(exerciseName = '', numSets = 3) {
            exerciseCounter++;
            const container = document.getElementById('exercises-container');
            
            const exerciseRow = document.createElement('div');
            exerciseRow.className = 'exercise-row';
            exerciseRow.id = `exercise-${exerciseCounter}`;
            
            // Check for previous workout with this exercise
            let previousWorkout = '';
            if (exerciseName) {
                previousWorkout = getPreviousWorkout(exerciseName);
            }
            
            let setsHTML = '';
            for (let i = 1; i <= 6; i++) {
                setsHTML += `
                    <div class="set-label">${i}</div>
                `;
            }
            
            for (let i = 1; i <= 6; i++) {
                setsHTML += `
                    <input type="number" class="set-input" placeholder="Reps" data-set="${i}" data-type="reps">
                `;
            }
            
            for (let i = 1; i <= 6; i++) {
                setsHTML += `
                    <input type="number" class="set-input" placeholder="Lbs" data-set="${i}" data-type="weight">
                `;
            }
            
            for (let i = 1; i <= 6; i++) {
                setsHTML += `
                    <div style="text-align: center;">
                        <input type="checkbox" class="set-checkbox" data-set="${i}">
                    </div>
                `;
            }
            
            exerciseRow.innerHTML = `
                <div class="exercise-header">
                    <div class="exercise-number">${exerciseCounter}</div>
                    <div class="exercise-input-wrapper">
                        <input type="text" 
                               class="form-group input exercise-input" 
                               placeholder="Exercise name..." 
                               value="${exerciseName}"
                               onkeyup="handleExerciseAutocomplete(event, ${exerciseCounter})"
                               onblur="hideAutocomplete(${exerciseCounter})"
                               style="margin: 0;">
                        <div id="autocomplete-${exerciseCounter}" class="autocomplete-dropdown" style="display: none;"></div>
                    </div>
                    <button type="button" onclick="removeExerciseRow(${exerciseCounter})" class="btn btn-danger" style="padding: 8px 12px;">‚úï Remove</button>
                </div>
                ${previousWorkout}
                <div class="sets-grid">
                    <div class="set-label">SET</div>
                    ${setsHTML}
                    <div class="set-label" style="margin-top: 10px;">REPS</div>
                    <div class="set-label" style="margin-top: 10px;">WEIGHT</div>
                    <div class="set-label" style="margin-top: 10px;">‚úì</div>
                </div>
                <div class="warmup-indicator">
                    <input type="checkbox" id="warmup-${exerciseCounter}">
                    <label for="warmup-${exerciseCounter}">Mark warm-up sets (Sets 1-2 won't count toward working volume)</label>
                </div>
                <div class="form-group" style="margin-top: 15px;">
                    <label>Exercise Notes</label>
                    <textarea class="exercise-notes" rows="2" placeholder="Form cues, adjustments, how it felt..."></textarea>
                </div>
            `;
            
            container.appendChild(exerciseRow);
        }

        function getPreviousWorkout(exerciseName) {
            if (!exerciseName) return '';
            
            // Find the most recent workout with this exercise
            for (let workout of trainingData) {
                const exercise = workout.exercises.find(e => 
                    e.name.toLowerCase() === exerciseName.toLowerCase()
                );
                
                if (exercise) {
                    const sets = exercise.sets.filter(s => s.reps && s.weight).slice(0, 6);
                    if (sets.length === 0) continue;
                    
                    const totalVolume = sets.reduce((sum, s) => sum + (s.reps * s.weight), 0);
                    const workingSets = sets.filter(s => !s.warmup);
                    const workingVolume = workingSets.reduce((sum, s) => sum + (s.reps * s.weight), 0);
                    
                    const setsHTML = sets.map((s, i) => 
                        `<span class="previous-set">${s.warmup ? '(W) ' : ''}${s.reps}√ó${s.weight}</span>`
                    ).join('');
                    
                    return `
                        <div class="previous-workout">
                            <h4>üìä Last Workout (${workout.date})</h4>
                            <div class="previous-workout-sets">${setsHTML}</div>
                            <div style="margin-top: 8px; font-size: 0.875rem;">
                                <strong>Total Volume:</strong> ${totalVolume.toLocaleString()} lbs | 
                                <strong>Working Volume:</strong> ${workingVolume.toLocaleString()} lbs | 
                                <strong>Goal:</strong> Beat ${totalVolume.toLocaleString()} lbs
                            </div>
                        </div>
                    `;
                }
            }
            
            return '';
        }

        function removeExerciseRow(id) {
            const element = document.getElementById(`exercise-${id}`);
            if (element) {
                element.remove();
            }
        }

        function handleExerciseAutocomplete(event, exerciseId) {
            const input = event.target;
            const value = input.value.toLowerCase();
            const dropdown = document.getElementById(`autocomplete-${exerciseId}`);
            
            if (value.length < 2) {
                dropdown.style.display = 'none';
                return;
            }
            
            const matches = exerciseLibrary.filter(exercise => 
                exercise.toLowerCase().includes(value)
            );
            
            if (matches.length === 0) {
                dropdown.style.display = 'none';
                return;
            }
            
            dropdown.innerHTML = matches.map(exercise => 
                `<div class="autocomplete-item" onclick="selectExercise('${exercise}', ${exerciseId})">${exercise}</div>`
            ).join('');
            dropdown.style.display = 'block';
            
            // Keyboard navigation
            if (event.key === 'ArrowDown' || event.key === 'ArrowUp') {
                event.preventDefault();
                const items = dropdown.querySelectorAll('.autocomplete-item');
                const selected = dropdown.querySelector('.selected');
                let index = Array.from(items).indexOf(selected);
                
                if (event.key === 'ArrowDown') {
                    index = (index + 1) % items.length;
                } else {
                    index = (index - 1 + items.length) % items.length;
                }
                
                items.forEach(item => item.classList.remove('selected'));
                items[index].classList.add('selected');
            } else if (event.key === 'Enter' && dropdown.querySelector('.selected')) {
                event.preventDefault();
                const selectedExercise = dropdown.querySelector('.selected').textContent;
                selectExercise(selectedExercise, exerciseId);
            } else if (event.key === 'Escape') {
                dropdown.style.display = 'none';
            }
        }

        function selectExercise(exercise, exerciseId) {
            const input = document.querySelector(`#exercise-${exerciseId} .exercise-input`);
            input.value = exercise;
            
            // Add to library if not already there
            if (!exerciseLibrary.includes(exercise)) {
                exerciseLibrary.push(exercise);
                localStorage.setItem('exerciseLibrary', JSON.stringify(exerciseLibrary));
            }
            
            // Hide dropdown
            hideAutocomplete(exerciseId);
            
            // Update with previous workout data
            const previousWorkout = getPreviousWorkout(exercise);
            if (previousWorkout) {
                const existingPrevious = document.querySelector(`#exercise-${exerciseId} .previous-workout`);
                if (existingPrevious) {
                    existingPrevious.remove();
                }
                
                const headerDiv = document.querySelector(`#exercise-${exerciseId} .exercise-header`);
                headerDiv.insertAdjacentHTML('afterend', previousWorkout);
            }
            
            // Focus first reps input
            const firstRepsInput = document.querySelector(`#exercise-${exerciseId} input[data-set="1"][data-type="reps"]`);
            if (firstRepsInput) {
                setTimeout(() => firstRepsInput.focus(), 100);
            }
        }

        function hideAutocomplete(exerciseId) {
            setTimeout(() => {
                const dropdown = document.getElementById(`autocomplete-${exerciseId}`);
                if (dropdown) {
                    dropdown.style.display = 'none';
                }
            }, 200);
        }

        document.getElementById('training-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const date = document.getElementById('train-date').value;
            const time = document.getElementById('train-time').value;
            const duration = parseInt(document.getElementById('duration').value) || null;
            const rpe = parseInt(document.getElementById('rpe').value) || null;
            
            // Get checked body parts
            const bodyParts = Array.from(document.querySelectorAll('.body-parts-grid input:checked'))
                .map(cb => cb.value);
            
            // Get exercises
            const exerciseRows = document.querySelectorAll('.exercise-row');
            const exercises = [];
            
            exerciseRows.forEach(row => {
                const name = row.querySelector('.exercise-input').value.trim();
                if (!name) return;
                
                const warmupChecked = row.querySelector('input[type="checkbox"][id^="warmup-"]').checked;
                const notes = row.querySelector('.exercise-notes').value.trim();
                
                const sets = [];
                for (let i = 1; i <= 6; i++) {
                    const reps = parseInt(row.querySelector(`input[data-set="${i}"][data-type="reps"]`).value);
                    const weight = parseInt(row.querySelector(`input[data-set="${i}"][data-type="weight"]`).value);
                    const completed = row.querySelector(`input[data-set="${i}"].set-checkbox`).checked;
                    
                    if (reps && weight) {
                        sets.push({
                            reps,
                            weight,
                            completed,
                            warmup: warmupChecked && i <= 2 // First 2 sets are warm-up if checked
                        });
                    }
                }
                
                if (sets.length > 0) {
                    exercises.push({ name, sets, notes });
                    
                    // Add to library
                    if (!exerciseLibrary.includes(name)) {
                        exerciseLibrary.push(name);
                    }
                }
            });
            
            if (exercises.length === 0) {
                alert('Please add at least one exercise with sets');
                return;
            }
            
            // Calculate total volume and working volume
            let totalVolume = 0;
            let workingVolume = 0;
            let totalSets = 0;
            let workingSets = 0;
            
            exercises.forEach(ex => {
                ex.sets.forEach(set => {
                    const vol = set.reps * set.weight;
                    totalVolume += vol;
                    totalSets++;
                    
                    if (!set.warmup) {
                        workingVolume += vol;
                        workingSets++;
                    }
                });
            });
            
            // Get cardio data
            const cardio = {
                type: document.getElementById('cardio-type').value,
                time: parseInt(document.getElementById('cardio-time').value) || null,
                distance: parseFloat(document.getElementById('cardio-distance').value) || null,
                hr: parseInt(document.getElementById('cardio-hr').value) || null,
                intensity: parseInt(document.getElementById('cardio-intensity').value) || null
            };
            
            const session = {
                date,
                time,
                duration,
                rpe,
                bodyParts,
                exercises,
                cardio: cardio.type ? cardio : null,
                notes: document.getElementById('train-notes').value,
                totalVolume,
                workingVolume,
                totalSets,
                workingSets
            };
            
            // Check if date already exists
            const existingIndex = trainingData.findIndex(t => t.date === date && t.time === time);
            if (existingIndex >= 0) {
                if (confirm('Training session for this date/time already exists. Overwrite?')) {
                    trainingData[existingIndex] = session;
                }
            } else {
                trainingData.push(session);
            }
            
            // Sort by date and time
            trainingData.sort((a, b) => {
                const dateCompare = new Date(b.date) - new Date(a.date);
                if (dateCompare !== 0) return dateCompare;
                return (b.time || '').localeCompare(a.time || '');
            });
            
            // Save
            localStorage.setItem('trainingData', JSON.stringify(trainingData));
            localStorage.setItem('exerciseLibrary', JSON.stringify(exerciseLibrary));
            
            renderTrainingTable();
            
            alert('Training session saved successfully!');
            
            // Reset form
            document.getElementById('training-form').reset();
            document.getElementById('exercises-container').innerHTML = '';
            exerciseCounter = 0;
            addExerciseRow();
            document.querySelectorAll('.body-parts-grid input').forEach(cb => cb.checked = false);
        });

        function renderTrainingTable() {
            const tbody = document.getElementById('training-data-body');
            if (trainingData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: var(--text-secondary);">No training sessions yet</td></tr>';
                return;
            }
            
            tbody.innerHTML = trainingData.map((session, index) => {
                const exerciseNames = session.exercises.map(e => e.name).join(', ');
                const bodyPartsStr = session.bodyParts.join(', ');
                
                return `
                    <tr>
                        <td>${session.date}</td>
                        <td>${session.time || '-'}</td>
                        <td>${session.duration ? session.duration + ' min' : '-'}</td>
                        <td>${bodyPartsStr || '-'}</td>
                        <td>${exerciseNames.substring(0, 40)}${exerciseNames.length > 40 ? '...' : ''}</td>
                        <td>${session.workingSets}</td>
                        <td>${session.workingVolume.toLocaleString()} lbs</td>
                        <td>${session.rpe || '-'}</td>
                        <td>
                            <button onclick="viewTrainingSession(${index})" class="btn btn-secondary">View</button>
                            <button onclick="deleteTrainingSession(${index})" class="btn btn-danger">Delete</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function viewTrainingSession(index) {
            const session = trainingData[index];
            
            let exercisesHTML = session.exercises.map((ex, i) => {
                const setsHTML = ex.sets.map((s, j) => 
                    `<div>${j + 1}) ${s.reps} reps √ó ${s.weight} lbs${s.warmup ? ' (Warm-up)' : ''}${s.completed ? ' ‚úì' : ''}</div>`
                ).join('');
                
                const exVolume = ex.sets.reduce((sum, s) => sum + (s.reps * s.weight), 0);
                const workingVolume = ex.sets.filter(s => !s.warmup).reduce((sum, s) => sum + (s.reps * s.weight), 0);
                
                // Calculate 1RM
                const workingSets = ex.sets.filter(s => !s.warmup && s.reps > 0);
                let max1RM = 0;
                if (workingSets.length > 0) {
                    workingSets.forEach(s => {
                        const estimated1RM = s.weight * (1 + s.reps / 30); // Epley formula
                        if (estimated1RM > max1RM) max1RM = estimated1RM;
                    });
                }
                
                return `
                    <div style="margin-bottom: 20px; padding: 15px; background: var(--bg-input); border-radius: 8px;">
                        <h4 style="margin-bottom: 10px;">${i + 1}. ${ex.name}</h4>
                        ${setsHTML}
                        <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border); font-size: 0.9rem; color: var(--text-secondary);">
                            Total Volume: ${exVolume.toLocaleString()} lbs | 
                            Working Volume: ${workingVolume.toLocaleString()} lbs
                            ${max1RM > 0 ? ` | Est. 1RM: ${Math.round(max1RM)} lbs` : ''}
                        </div>
                        ${ex.notes ? `<div style="margin-top: 10px; font-size: 0.9rem; font-style: italic; color: var(--text-secondary);">Notes: ${ex.notes}</div>` : ''}
                    </div>
                `;
            }).join('');
            
            let cardioHTML = '';
            if (session.cardio && session.cardio.type) {
                cardioHTML = `
                    <div style="margin-top: 20px; padding: 15px; background: var(--bg-input); border-radius: 8px;">
                        <h4 style="margin-bottom: 10px;">üèÉ Cardio</h4>
                        <div>Type: ${session.cardio.type}</div>
                        ${session.cardio.time ? `<div>Duration: ${session.cardio.time} minutes</div>` : ''}
                        ${session.cardio.distance ? `<div>Distance: ${session.cardio.distance} miles</div>` : ''}
                        ${session.cardio.hr ? `<div>Avg HR: ${session.cardio.hr} bpm</div>` : ''}
                        ${session.cardio.intensity ? `<div>Intensity: ${session.cardio.intensity}/10</div>` : ''}
                    </div>
                `;
            }
            
            const modalHTML = `
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px;" onclick="this.remove()">
                    <div style="background: var(--bg-card); border-radius: 12px; padding: 30px; max-width: 800px; max-height: 90vh; overflow-y: auto;" onclick="event.stopPropagation()">
                        <h2 style="margin-bottom: 20px;">üìÖ ${session.date} ${session.time ? 'at ' + session.time : ''}</h2>
                        ${session.duration ? `<p><strong>Duration:</strong> ${session.duration} minutes</p>` : ''}
                        ${session.rpe ? `<p><strong>RPE:</strong> ${session.rpe}/10</p>` : ''}
                        <p><strong>Body Parts:</strong> ${session.bodyParts.join(', ')}</p>
                        <p><strong>Total Working Volume:</strong> ${session.workingVolume.toLocaleString()} lbs (${session.workingSets} sets)</p>
                        
                        <h3 style="margin-top: 30px; margin-bottom: 15px;">Exercises</h3>
                        ${exercisesHTML}
                        
                        ${cardioHTML}
                        
                        ${session.notes ? `
                            <div style="margin-top: 20px; padding: 15px; background: var(--bg-input); border-radius: 8px;">
                                <h4 style="margin-bottom: 10px;">üìù Session Notes</h4>
                                <p style="white-space: pre-wrap;">${session.notes}</p>
                            </div>
                        ` : ''}
                        
                        <button onclick="this.closest('div[style*=fixed]').remove()" class="btn btn-primary" style="margin-top: 20px; width: 100%;">Close</button>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        function deleteTrainingSession(index) {
            if (confirm('Delete this training session?')) {
                trainingData.splice(index, 1);
                localStorage.setItem('trainingData', JSON.stringify(trainingData));
                renderTrainingTable();
            }
        }

        function exportTrainingData() {
            if (trainingData.length === 0) {
                alert('No training data to export');
                return;
            }
            
            const rows = [];
            trainingData.forEach(session => {
                session.exercises.forEach(ex => {
                    ex.sets.forEach((set, i) => {
                        rows.push({
                            date: session.date,
                            time: session.time || '',
                            duration: session.duration || '',
                            rpe: session.rpe || '',
                            bodyParts: session.bodyParts.join(';'),
                            exercise: ex.name,
                            setNumber: i + 1,
                            reps: set.reps,
                            weight: set.weight,
                            warmup: set.warmup ? 'Y' : 'N',
                            completed: set.completed ? 'Y' : 'N',
                            exerciseNotes: ex.notes || '',
                            sessionNotes: session.notes || ''
                        });
                    });
                });
            });
            
            const headers = 'Date,Time,Duration,RPE,Body Parts,Exercise,Set #,Reps,Weight,Warmup,Completed,Exercise Notes,Session Notes\n';
            const csv = headers + rows.map(r => 
                `${r.date},${r.time},${r.duration},${r.rpe},"${r.bodyParts}",${r.exercise},${r.setNumber},${r.reps},${r.weight},${r.warmup},${r.completed},"${r.exerciseNotes.replace(/"/g, '""')}","${r.sessionNotes.replace(/"/g, '""')}"`
            ).join('\n');
            
            downloadCSV(csv, 'training-data.csv');
        }

        function clearAllTrainingData() {
            if (confirm('Are you sure you want to delete ALL training data? This cannot be undone!')) {
                if (confirm('FINAL WARNING: This will permanently delete all your training sessions!')) {
                    trainingData = [];
                    localStorage.setItem('trainingData', JSON.stringify(trainingData));
                    renderTrainingTable();
                    alert('All training data has been cleared');
                }
            }
        }

        // ==================== PROGRESS & ANALYTICS ====================
        
        function renderProgressCharts() {
            renderWeeklySummary();
            renderBodyCompositionCharts();
            renderTrainingVolumeCharts();
            renderStrengthChart();
        }

        function renderWeeklySummary() {
            const container = document.getElementById('weekly-summary-container');
            
            if (dailyData.length < 7 && trainingData.length < 2) {
                container.innerHTML = '<p style="color: var(--text-secondary);">Need at least 1 week of data for weekly summary</p>';
                return;
            }
            
            // Get last 7 days
            const today = new Date();
            const sevenDaysAgo = new Date(today);
            sevenDaysAgo.setDate(today.getDate() - 7);
            
            const weekData = dailyData.filter(d => new Date(d.date) >= sevenDaysAgo);
            const weekTraining = trainingData.filter(t => new Date(t.date) >= sevenDaysAgo);
            
            // Body composition summary
            let bodyHTML = '';
            if (weekData.length >= 2) {
                const latest = weekData[0];
                const earliest = weekData[weekData.length - 1];
                
                const weightChange = latest.weight - earliest.weight;
                const fatChange = latest.fatMass - earliest.fatMass;
                const leanChange = latest.leanMass - earliest.leanMass;
                
                const avgCals = weekData.filter(d => d.calories).reduce((sum, d) => sum + d.calories, 0) / weekData.filter(d => d.calories).length;
                const avgProtein = weekData.filter(d => d.protein).reduce((sum, d) => sum + d.protein, 0) / weekData.filter(d => d.protein).length;
                const avgSteps = weekData.filter(d => d.steps).reduce((sum, d) => sum + d.steps, 0) / weekData.filter(d => d.steps).length;
                
                bodyHTML = `
                    <div class="summary-section">
                        <h3>üìä Body Composition (Last 7 Days)</h3>
                        <div class="summary-row">
                            <span class="label">Weight Change</span>
                            <span class="value ${weightChange < 0 ? 'positive' : weightChange > 0 ? 'negative' : 'neutral'}">
                                ${weightChange > 0 ? '+' : ''}${weightChange.toFixed(1)} lbs
                            </span>
                        </div>
                        <div class="summary-row">
                            <span class="label">Fat Mass Change</span>
                            <span class="value ${fatChange < 0 ? 'positive' : fatChange > 0 ? 'negative' : 'neutral'}">
                                ${fatChange > 0 ? '+' : ''}${fatChange.toFixed(1)} lbs
                            </span>
                        </div>
                        <div class="summary-row">
                            <span class="label">Lean Mass Change</span>
                            <span class="value ${leanChange > 0 ? 'positive' : leanChange < 0 ? 'negative' : 'neutral'}">
                                ${leanChange > 0 ? '+' : ''}${leanChange.toFixed(1)} lbs
                            </span>
                        </div>
                        <div class="summary-row">
                            <span class="label">Avg Calories</span>
                            <span class="value">${avgCals ? Math.round(avgCals) : '-'}</span>
                        </div>
                        <div class="summary-row">
                            <span class="label">Avg Protein</span>
                            <span class="value">${avgProtein ? Math.round(avgProtein) + 'g' : '-'}</span>
                        </div>
                        <div class="summary-row">
                            <span class="label">Avg Steps</span>
                            <span class="value">${avgSteps ? Math.round(avgSteps).toLocaleString() : '-'}</span>
                        </div>
                    </div>
                `;
            }
            
            // Training summary
            let trainingHTML = '';
            if (weekTraining.length > 0) {
                const totalVolume = weekTraining.reduce((sum, t) => sum + t.workingVolume, 0);
                const totalSets = weekTraining.reduce((sum, t) => sum + t.workingSets, 0);
                const avgRPE = weekTraining.filter(t => t.rpe).reduce((sum, t) => sum + t.rpe, 0) / weekTraining.filter(t => t.rpe).length;
                
                // Volume by muscle group
                const volumeByMuscle = {};
                weekTraining.forEach(session => {
                    session.bodyParts.forEach(part => {
                        if (!volumeByMuscle[part]) volumeByMuscle[part] = 0;
                        volumeByMuscle[part] += session.workingVolume / session.bodyParts.length;
                    });
                });
                
                const muscleHTML = Object.entries(volumeByMuscle)
                    .sort((a, b) => b[1] - a[1])
                    .map(([muscle, volume]) => `
                        <div class="summary-row">
                            <span class="label">${muscle}</span>
                            <span class="value">${Math.round(volume).toLocaleString()} lbs</span>
                        </div>
                    `).join('');
                
                trainingHTML = `
                    <div class="summary-section">
                        <h3>üèãÔ∏è Training (Last 7 Days)</h3>
                        <div class="summary-row">
                            <span class="label">Sessions</span>
                            <span class="value">${weekTraining.length}</span>
                        </div>
                        <div class="summary-row">
                            <span class="label">Total Volume</span>
                            <span class="value">${totalVolume.toLocaleString()} lbs</span>
                        </div>
                        <div class="summary-row">
                            <span class="label">Total Sets</span>
                            <span class="value">${totalSets}</span>
                        </div>
                        <div class="summary-row">
                            <span class="label">Avg RPE</span>
                            <span class="value">${avgRPE ? avgRPE.toFixed(1) : '-'}/10</span>
                        </div>
                        <h4 style="margin-top: 20px; margin-bottom: 10px; font-size: 0.95rem; color: var(--text-secondary);">Volume by Muscle</h4>
                        ${muscleHTML}
                    </div>
                `;
            }
            
            container.innerHTML = `
                <div class="weekly-summary">
                    ${bodyHTML}
                    ${trainingHTML}
                </div>
            `;
        }

        function renderBodyCompositionCharts() {
            if (dailyData.length < 2) return;
            
            const sortedData = [...dailyData].sort((a, b) => new Date(a.date) - new Date(b.date));
            const dates = sortedData.map(d => d.date);
            
            // Weight chart
            const weightCtx = document.getElementById('weight-chart');
            if (weightCtx) {
                new Chart(weightCtx, {
                    type: 'line',
                    data: {
                        labels: dates,
                        datasets: [{
                            label: 'Weight (lbs)',
                            data: sortedData.map(d => d.weight),
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { labels: { color: '#f1f5f9' } }
                        },
                        scales: {
                            x: { ticks: { color: '#94a3b8' }, grid: { color: '#334155' } },
                            y: { ticks: { color: '#94a3b8' }, grid: { color: '#334155' } }
                        }
                    }
                });
            }
            
            // Composition chart
            const compCtx = document.getElementById('composition-chart');
            if (compCtx) {
                new Chart(compCtx, {
                    type: 'line',
                    data: {
                        labels: dates,
                        datasets: [
                            {
                                label: 'Lean Mass (lbs)',
                                data: sortedData.map(d => d.leanMass),
                                borderColor: '#10b981',
                                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                tension: 0.4
                            },
                            {
                                label: 'Fat Mass (lbs)',
                                data: sortedData.map(d => d.fatMass),
                                borderColor: '#ef4444',
                                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                                tension: 0.4
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { labels: { color: '#f1f5f9' } }
                        },
                        scales: {
                            x: { ticks: { color: '#94a3b8' }, grid: { color: '#334155' } },
                            y: { ticks: { color: '#94a3b8' }, grid: { color: '#334155' } }
                        }
                    }
                });
            }
        }

        function renderTrainingVolumeCharts() {
            if (trainingData.length < 2) return;
            
            const sortedTraining = [...trainingData].sort((a, b) => new Date(a.date) - new Date(b.date));
            const dates = sortedTraining.map(t => t.date);
            
            // Total volume chart
            const volumeCtx = document.getElementById('volume-chart');
            if (volumeCtx) {
                new Chart(volumeCtx, {
                    type: 'bar',
                    data: {
                        labels: dates,
                        datasets: [{
                            label: 'Working Volume (lbs)',
                            data: sortedTraining.map(t => t.workingVolume),
                            backgroundColor: 'rgba(59, 130, 246, 0.7)',
                            borderColor: '#3b82f6',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { labels: { color: '#f1f5f9' } }
                        },
                        scales: {
                            x: { ticks: { color: '#94a3b8' }, grid: { color: '#334155' } },
                            y: { ticks: { color: '#94a3b8' }, grid: { color: '#334155' } }
                        }
                    }
                });
            }
            
            // Volume by muscle group
            const muscleVolumeCtx = document.getElementById('muscle-volume-chart');
            if (muscleVolumeCtx) {
                const muscleData = {};
                sortedTraining.forEach(session => {
                    session.bodyParts.forEach(part => {
                        if (!muscleData[part]) muscleData[part] = [];
                        muscleData[part].push(session.workingVolume / session.bodyParts.length);
                    });
                });
                
                const datasets = Object.entries(muscleData).map(([muscle, volumes]) => ({
                    label: muscle,
                    data: volumes,
                    backgroundColor: getRandomColor(),
                    borderWidth: 1
                }));
                
                new Chart(muscleVolumeCtx, {
                    type: 'bar',
                    data: {
                        labels: dates.slice(0, datasets[0].data.length),
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { labels: { color: '#f1f5f9' } }
                        },
                        scales: {
                            x: { stacked: true, ticks: { color: '#94a3b8' }, grid: { color: '#334155' } },
                            y: { stacked: true, ticks: { color: '#94a3b8' }, grid: { color: '#334155' } }
                        }
                    }
                });
            }
        }

        function renderStrengthChart() {
            if (trainingData.length < 2) return;
            
            // Calculate 1RM for major lifts
            const lifts = ['Bench Press', 'Squat', 'Deadlift', 'Overhead Press'];
            const strengthData = {};
            
            lifts.forEach(lift => {
                strengthData[lift] = [];
            });
            
            trainingData.forEach(session => {
                lifts.forEach(lift => {
                    const exercise = session.exercises.find(e => e.name === lift);
                    if (exercise) {
                        const workingSets = exercise.sets.filter(s => !s.warmup && s.reps > 0);
                        if (workingSets.length > 0) {
                            let max1RM = 0;
                            workingSets.forEach(s => {
                                const estimated1RM = s.weight * (1 + s.reps / 30);
                                if (estimated1RM > max1RM) max1RM = estimated1RM;
                            });
                            strengthData[lift].push({ date: session.date, oneRM: Math.round(max1RM) });
                        }
                    }
                });
            });
            
            // Create datasets
            const datasets = Object.entries(strengthData)
                .filter(([lift, data]) => data.length > 0)
                .map(([lift, data]) => {
                    const sortedData = data.sort((a, b) => new Date(a.date) - new Date(b.date));
                    return {
                        label: lift,
                        data: sortedData.map(d => ({ x: d.date, y: d.oneRM })),
                        borderColor: getRandomColor(),
                        backgroundColor: 'transparent',
                        tension: 0.4
                    };
                });
            
            const strengthCtx = document.getElementById('strength-chart');
            if (strengthCtx && datasets.length > 0) {
                new Chart(strengthCtx, {
                    type: 'line',
                    data: { datasets },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { labels: { color: '#f1f5f9' } }
                        },
                        scales: {
                            x: { type: 'time', time: { unit: 'day' }, ticks: { color: '#94a3b8' }, grid: { color: '#334155' } },
                            y: { ticks: { color: '#94a3b8' }, grid: { color: '#334155' } }
                        }
                    }
                });
            }
            
            // Render PR list
            renderPRList();
        }

        function renderPRList() {
            const container = document.getElementById('pr-list');
            if (!container) return;
            
            // Get all unique exercises
            const exercises = new Set();
            trainingData.forEach(session => {
                session.exercises.forEach(ex => exercises.add(ex.name));
            });
            
            const prs = [];
            exercises.forEach(exerciseName => {
                let maxWeight = 0;
                let maxReps = 0;
                let max1RM = 0;
                let maxVolume = 0;
                let bestDate = '';
                
                trainingData.forEach(session => {
                    const exercise = session.exercises.find(e => e.name === exerciseName);
                    if (exercise) {
                        const workingSets = exercise.sets.filter(s => !s.warmup);
                        workingSets.forEach(set => {
                            if (set.weight > maxWeight) {
                                maxWeight = set.weight;
                            }
                            if (set.reps > maxReps) {
                                maxReps = set.reps;
                            }
                            const estimated1RM = set.weight * (1 + set.reps / 30);
                            if (estimated1RM > max1RM) {
                                max1RM = estimated1RM;
                                bestDate = session.date;
                            }
                        });
                        const exVolume = workingSets.reduce((sum, s) => sum + (s.reps * s.weight), 0);
                        if (exVolume > maxVolume) {
                            maxVolume = exVolume;
                        }
                    }
                });
                
                if (max1RM > 0) {
                    prs.push({
                        name: exerciseName,
                        weight: maxWeight,
                        reps: maxReps,
                        oneRM: Math.round(max1RM),
                        volume: maxVolume,
                        date: bestDate
                    });
                }
            });
            
            prs.sort((a, b) => b.oneRM - a.oneRM);
            
            if (prs.length > 0) {
                container.innerHTML = `
                    <h3 style="margin-bottom: 15px;">üèÜ Personal Records</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px;">
                        ${prs.slice(0, 6).map(pr => `
                            <div style="background: var(--bg-input); padding: 15px; border-radius: 8px; border-left: 4px solid var(--warning);">
                                <h4 style="margin-bottom: 8px;">${pr.name}</h4>
                                <div style="font-size: 0.9rem; color: var(--text-secondary);">
                                    <div>Est. 1RM: <strong style="color: var(--warning);">${pr.oneRM} lbs</strong></div>
                                    <div>Max Weight: ${pr.weight} lbs</div>
                                    <div>Max Reps: ${pr.reps}</div>
                                    <div>Max Volume: ${pr.volume.toLocaleString()} lbs</div>
                                    <div style="margin-top: 5px; font-size: 0.85rem;">Last PR: ${pr.date}</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
        }

        // ==================== CORRELATIONS & INSIGHTS ====================
        
        function renderCorrelations() {
            generateInsights();
            renderCorrelationCharts();
            generateRecommendations();
        }

        function generateInsights() {
            const container = document.getElementById('insights-container');
            
            if (dailyData.length < 7 || trainingData.length < 2) {
                container.innerHTML = `
                    <div class="insight-card">
                        <h4>üìä Not Enough Data Yet</h4>
                        <p>Keep logging for at least 2 weeks to see meaningful correlations and insights. Current data: ${dailyData.length} days of body metrics, ${trainingData.length} training sessions.</p>
                    </div>
                `;
                return;
            }
            
            const insights = [];
            
            // Analyze training volume vs lean mass correlation
            const volumeCorrelation = analyzeVolumeVsLean();
            if (volumeCorrelation) {
                insights.push(volumeCorrelation);
            }
            
            // Analyze refeed timing
            const refeedAnalysis = analyzeRefeedTiming();
            if (refeedAnalysis) {
                insights.push(refeedAnalysis);
            }
            
            // Analyze rest days
            const restDayAnalysis = analyzeRestDays();
            if (restDayAnalysis) {
                insights.push(restDayAnalysis);
            }
            
            // Analyze calorie vs weight
            const calorieAnalysis = analyzeCaloriesVsWeight();
            if (calorieAnalysis) {
                insights.push(calorieAnalysis);
            }
            
            // Protein sufficiency
            const proteinAnalysis = analyzeProtein();
            if (proteinAnalysis) {
                insights.push(proteinAnalysis);
            }
            
            // Training frequency
            const frequencyAnalysis = analyzeTrainingFrequency();
            if (frequencyAnalysis) {
                insights.push(frequencyAnalysis);
            }
            
            container.innerHTML = insights.map(insight => `
                <div class="insight-card ${insight.type}">
                    <h4>${insight.icon} ${insight.title}</h4>
                    <p>${insight.message}</p>
                    ${insight.action ? `<p style="margin-top: 10px;"><strong>Action:</strong> ${insight.action}</p>` : ''}
                </div>
            `).join('');
        }

        function analyzeVolumeVsLean() {
            // Group data by week
            const weeks = groupDataByWeek();
            if (weeks.length < 2) return null;
            
            const volumeChanges = [];
            const leanChanges = [];
            
            for (let i = 1; i < weeks.length; i++) {
                const prevWeek = weeks[i - 1];
                const currWeek = weeks[i];
                
                if (prevWeek.volume && currWeek.volume && prevWeek.avgLean && currWeek.avgLean) {
                    volumeChanges.push(currWeek.volume - prevWeek.volume);
                    leanChanges.push(currWeek.avgLean - prevWeek.avgLean);
                }
            }
            
            if (volumeChanges.length < 2) return null;
            
            const correlation = calculateCorrelation(volumeChanges, leanChanges);
            const avgVolumeChange = volumeChanges.reduce((a, b) => a + b, 0) / volumeChanges.length;
            const avgLeanChange = leanChanges.reduce((a, b) => a + b, 0) / leanChanges.length;
            
            let message = '';
            let type = 'success';
            let action = '';
            
            if (correlation > 0.5) {
                message = `Strong positive correlation (${correlation.toFixed(2)}) detected! When you increase training volume by ${Math.abs(avgVolumeChange).toLocaleString()} lbs, you gain ${avgLeanChange.toFixed(2)} lbs of lean mass on average.`;
                action = 'Keep pushing volume progressively. Your body responds well to increased training stress.';
            } else if (correlation < -0.5) {
                message = `Warning: Negative correlation (${correlation.toFixed(2)}) detected. Higher training volume is associated with lean mass loss. This suggests inadequate recovery or nutrition.`;
                type = 'danger';
                action = 'Reduce training volume by 15-20% or increase calories by 200-300. You may be overtrained.';
            } else {
                message = `Weak correlation (${correlation.toFixed(2)}) between volume and lean mass. Your lean mass changes are likely driven more by nutrition than training volume.`;
                type = 'warning';
                action = 'Focus on protein intake (1g per lb bodyweight) and ensure adequate calories on training days.';
            }
            
            return {
                icon: 'üìä',
                title: 'Training Volume ‚Üí Lean Mass Correlation',
                message,
                type,
                action
            };
        }

        function analyzeRefeedTiming() {
            const refeeds = dailyData.filter(d => d.calories && d.calories > 2400).map(d => d.date);
            if (refeeds.length < 2) return null;
            
            // Check training performance after refeeds
            const performanceAfterRefeed = [];
            const performanceNormal = [];
            
            trainingData.forEach(session => {
                const sessionDate = new Date(session.date);
                const isAfterRefeed = refeeds.some(refeedDate => {
                    const diff = (sessionDate - new Date(refeedDate)) / (1000 * 60 * 60 * 24);
                    return diff >= 0 && diff <= 2; // Within 2 days after refeed
                });
                
                if (isAfterRefeed) {
                    performanceAfterRefeed.push(session.workingVolume);
                } else {
                    performanceNormal.push(session.workingVolume);
                }
            });
            
            if (performanceAfterRefeed.length < 2 || performanceNormal.length < 2) return null;
            
            const avgAfterRefeed = performanceAfterRefeed.reduce((a, b) => a + b, 0) / performanceAfterRefeed.length;
            const avgNormal = performanceNormal.reduce((a, b) => a + b, 0) / performanceNormal.length;
            
            const improvement = ((avgAfterRefeed - avgNormal) / avgNormal * 100);
            
            let message = '';
            let type = 'success';
            let action = '';
            
            if (improvement > 5) {
                message = `Refeeds are working! Training volume is ${improvement.toFixed(1)}% higher after refeed days (${avgAfterRefeed.toLocaleString()} vs ${avgNormal.toLocaleString()} lbs).`;
                action = `Schedule refeeds every 5-6 days before your heavy training days (legs or push days).`;
            } else if (improvement < -5) {
                message = `Warning: Performance drops ${Math.abs(improvement).toFixed(1)}% after refeeds. You may be overeating or timing them poorly.`;
                type = 'warning';
                action = 'Try lighter refeeds (2,200-2,400 cals) or schedule them on rest days instead.';
            } else {
                message = `Refeeds have minimal impact on performance (${improvement.toFixed(1)}% difference). They may still help with hormones and adherence.`;
                type = 'warning';
                action = 'Continue current refeed protocol but monitor long-term metabolic adaptation.';
            }
            
            return {
                icon: 'üçΩÔ∏è',
                title: 'Refeed Day Performance Impact',
                message,
                type,
                action
            };
        }

        function analyzeRestDays() {
            if (trainingData.length < 5) return null;
            
            const sortedTraining = [...trainingData].sort((a, b) => new Date(a.date) - new Date(b.date));
            
            const afterRestVolume = [];
            const noRestVolume = [];
            
            for (let i = 1; i < sortedTraining.length; i++) {
                const current = sortedTraining[i];
                const previous = sortedTraining[i - 1];
                
                const daysBetween = (new Date(current.date) - new Date(previous.date)) / (1000 * 60 * 60 * 24);
                
                if (daysBetween >= 2) {
                    afterRestVolume.push(current.workingVolume);
                } else if (daysBetween === 1) {
                    noRestVolume.push(current.workingVolume);
                }
            }
            
            if (afterRestVolume.length < 2 || noRestVolume.length < 2) return null;
            
            const avgAfterRest = afterRestVolume.reduce((a, b) => a + b, 0) / afterRestVolume.length;
            const avgNoRest = noRestVolume.reduce((a, b) => a + b, 0) / noRestVolume.length;
            
            const improvement = ((avgAfterRest - avgNoRest) / avgNoRest * 100);
            
            let message = '';
            let type = 'success';
            let action = '';
            
            if (improvement > 3) {
                message = `Rest days boost performance! Volume is ${improvement.toFixed(1)}% higher after rest days (${avgAfterRest.toLocaleString()} vs ${avgNoRest.toLocaleString()} lbs).`;
                action = 'Take at least 1 rest day every 5-6 training days for optimal recovery.';
            } else if (improvement < -3) {
                message = `Interesting: You perform better without rest days. This suggests good recovery capacity or deconditioning from rest.`;
                type = 'warning';
                action = 'You can train 5-6 days straight, but watch for signs of overtraining (elevated resting HR, poor sleep, mood changes).';
            } else {
                message = `Rest days have minimal impact on performance (${improvement.toFixed(1)}% difference). Your recovery is consistent.`;
                action = 'Continue current rest day schedule. Monitor long-term recovery markers.';
            }
            
            return {
                icon: 'üò¥',
                title: 'Rest Day Recovery Analysis',
                message,
                type,
                action
            };
        }

        function analyzeCaloriesVsWeight() {
            const dataWithCals = dailyData.filter(d => d.calories);
            if (dataWithCals.length < 7) return null;
            
            const avgCalories = dataWithCals.reduce((sum, d) => sum + d.calories, 0) / dataWithCals.length;
            
            // Calculate weekly weight changes and calorie averages
            const weeks = groupDataByWeek();
            if (weeks.length < 2) return null;
            
            const weeklyCalChanges = [];
            const weeklyWeightChanges = [];
            
            for (let i = 1; i < weeks.length; i++) {
                if (weeks[i].avgCals && weeks[i - 1].avgCals) {
                    weeklyCalChanges.push(weeks[i].avgCals - weeks[i - 1].avgCals);
                    weeklyWeightChanges.push(weeks[i].avgWeight - weeks[i - 1].avgWeight);
                }
            }
            
            if (weeklyCalChanges.length < 2) return null;
            
            const correlation = calculateCorrelation(weeklyCalChanges, weeklyWeightChanges);
            
            let message = '';
            let type = 'success';
            let action = '';
            
            if (avgCalories < 2000) {
                message = `Low calorie intake detected (${Math.round(avgCalories)}/day avg). Weight correlation: ${correlation.toFixed(2)}. You're in aggressive deficit.`;
                type = 'warning';
                action = 'Consider increasing to 2,100-2,200 on training days to preserve muscle. Add refeeds every 5-6 days.';
            } else if (avgCalories > 2400) {
                message = `High calorie intake (${Math.round(avgCalories)}/day avg). Weight correlation: ${correlation.toFixed(2)}. May be slowing fat loss.`;
                type = 'warning';
                action = 'Reduce to 2,000-2,200 for consistent fat loss, or ensure these are planned refeeds.';
            } else {
                message = `Good calorie range (${Math.round(avgCalories)}/day avg). Correlation with weight: ${correlation.toFixed(2)}. Deficit is working sustainably.`;
                action = 'Maintain current calorie intake. Monitor weekly averages, not daily fluctuations.';
            }
            
            return {
                icon: 'üî•',
                title: 'Calorie Intake vs Weight Changes',
                message,
                type,
                action
            };
        }

        function analyzeProtein() {
            const dataWithProtein = dailyData.filter(d => d.protein && d.weight);
            if (dataWithProtein.length < 5) return null;
            
            const avgProtein = dataWithProtein.reduce((sum, d) => sum + d.protein, 0) / dataWithProtein.length;
            const avgWeight = dataWithProtein.reduce((sum, d) => sum + d.weight, 0) / dataWithProtein.length;
            const proteinPerLb = avgProtein / avgWeight;
            
            let message = '';
            let type = 'success';
            let action = '';
            
            if (proteinPerLb >= 1.0) {
                message = `Excellent protein intake! Averaging ${Math.round(avgProtein)}g/day (${proteinPerLb.toFixed(2)}g per lb). This is optimal for muscle retention during fat loss.`;
                action = 'Keep it up! This protein level maximizes muscle protein synthesis and satiety.';
            } else if (proteinPerLb >= 0.8) {
                message = `Good protein intake. Averaging ${Math.round(avgProtein)}g/day (${proteinPerLb.toFixed(2)}g per lb). Could be slightly higher for maximum muscle retention.`;
                type = 'warning';
                action = `Increase to ${Math.round(avgWeight)} - ${Math.round(avgWeight * 1.1)}g/day for optimal results.`;
            } else {
                message = `Low protein detected. Averaging ${Math.round(avgProtein)}g/day (${proteinPerLb.toFixed(2)}g per lb). This increases risk of muscle loss during deficit.`;
                type = 'danger';
                action = `Increase to at least ${Math.round(avgWeight * 0.8)}g/day minimum, ideally ${Math.round(avgWeight)}g/day.`;
            }
            
            return {
                icon: 'ü•©',
                title: 'Protein Intake Analysis',
                message,
                type,
                action
            };
        }

        function analyzeTrainingFrequency() {
            if (trainingData.length < 4) return null;
            
            const sortedTraining = [...trainingData].sort((a, b) => new Date(a.date) - new Date(b.date));
            const firstDate = new Date(sortedTraining[0].date);
            const lastDate = new Date(sortedTraining[sortedTraining.length - 1].date);
            const totalDays = (lastDate - firstDate) / (1000 * 60 * 60 * 24);
            const sessionsPerWeek = (trainingData.length / totalDays) * 7;
            
            let message = '';
            let type = 'success';
            let action = '';
            
            if (sessionsPerWeek >= 5) {
                message = `High training frequency: ${sessionsPerWeek.toFixed(1)} sessions per week. Great for body recomposition if recovery is adequate.`;
                action = 'Monitor recovery markers (sleep quality, resting HR, performance). Take a deload week every 4-6 weeks.';
            } else if (sessionsPerWeek >= 3) {
                message = `Moderate training frequency: ${sessionsPerWeek.toFixed(1)} sessions per week. Good for sustainable progress.`;
                action = 'Consider adding 1 more session per week if recovery allows. Aim for 4-5 for optimal results.';
            } else {
                message = `Low training frequency: ${sessionsPerWeek.toFixed(1)} sessions per week. May limit muscle retention during fat loss.`;
                type = 'warning';
                action = 'Increase to 4-5 sessions per week for better muscle retention and higher TDEE.';
            }
            
            return {
                icon: 'üìÖ',
                title: 'Training Frequency',
                message,
                type,
                action
            };
        }

        function renderCorrelationCharts() {
            renderVolumeLeanChart();
            renderCaloriesWeightChart();
        }

        function renderVolumeLeanChart() {
            const weeks = groupDataByWeek();
            if (weeks.length < 3) return;
            
            const validWeeks = weeks.filter(w => w.volume && w.avgLean);
            
            const volumeLeanCtx = document.getElementById('volume-lean-chart');
            if (volumeLeanCtx && validWeeks.length > 0) {
                new Chart(volumeLeanCtx, {
                    type: 'scatter',
                    data: {
                        datasets: [{
                            label: 'Training Volume vs Lean Mass',
                            data: validWeeks.map(w => ({ x: w.volume, y: w.avgLean })),
                            backgroundColor: 'rgba(59, 130, 246, 0.6)',
                            borderColor: '#3b82f6',
                            pointRadius: 6,
                            pointHoverRadius: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { labels: { color: '#f1f5f9' } }
                        },
                        scales: {
                            x: {
                                title: { display: true, text: 'Weekly Training Volume (lbs)', color: '#f1f5f9' },
                                ticks: { color: '#94a3b8' },
                                grid: { color: '#334155' }
                            },
                            y: {
                                title: { display: true, text: 'Lean Mass (lbs)', color: '#f1f5f9' },
                                ticks: { color: '#94a3b8' },
                                grid: { color: '#334155' }
                            }
                        }
                    }
                });
            }
        }

        function renderCaloriesWeightChart() {
            const weeks = groupDataByWeek();
            if (weeks.length < 3) return;
            
            const validWeeks = weeks.filter(w => w.avgCals && w.avgWeight);
            
            const calWeightCtx = document.getElementById('calories-weight-chart');
            if (calWeightCtx && validWeeks.length > 0) {
                new Chart(calWeightCtx, {
                    type: 'scatter',
                    data: {
                        datasets: [{
                            label: 'Avg Calories vs Avg Weight',
                            data: validWeeks.map(w => ({ x: w.avgCals, y: w.avgWeight })),
                            backgroundColor: 'rgba(16, 185, 129, 0.6)',
                            borderColor: '#10b981',
                            pointRadius: 6,
                            pointHoverRadius: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { labels: { color: '#f1f5f9' } }
                        },
                        scales: {
                            x: {
                                title: { display: true, text: 'Average Calories', color: '#f1f5f9' },
                                ticks: { color: '#94a3b8' },
                                grid: { color: '#334155' }
                            },
                            y: {
                                title: { display: true, text: 'Average Weight (lbs)', color: '#f1f5f9' },
                                ticks: { color: '#94a3b8' },
                                grid: { color: '#334155' }
                            }
                        }
                    }
                });
            }
        }

        function generateRecommendations() {
            const container = document.getElementById('recommendations-container');
            
            if (dailyData.length < 14 || trainingData.length < 4) {
                container.innerHTML = '<p style="color: var(--text-secondary);">Need at least 2 weeks of data for personalized recommendations.</p>';
                return;
            }
            
            const recommendations = [];
            
            // Get latest data
            const latest = dailyData[0];
            const weekAgo = dailyData[Math.min(7, dailyData.length - 1)];
            const weeks = groupDataByWeek();
            
            // Fat loss rate
            if (weekAgo) {
                const weeklyFatLoss = (weekAgo.fatMass - latest.fatMass);
                const weeklyLeanChange = (latest.leanMass - weekAgo.leanMass);
                
                if (weeklyFatLoss < 1.5) {
                    recommendations.push({
                        icon: '‚ö°',
                        title: 'Accelerate Fat Loss',
                        message: `Current fat loss: ${weeklyFatLoss.toFixed(2)} lbs/week. To hit 2-2.5 lbs/week:`,
                        actions: [
                            'Reduce calories by 200 (from training days)',
                            'Add 2-3 LISS cardio sessions (30-40 min)',
                            'Increase daily steps to 12,000+'
                        ]
                    });
                } else if (weeklyFatLoss > 3) {
                    recommendations.push({
                        icon: '‚ö†Ô∏è',
                        title: 'Fat Loss Too Aggressive',
                        message: `Losing ${weeklyFatLoss.toFixed(2)} lbs/week of fat. Risk of muscle loss and metabolic adaptation:`,
                        actions: [
                            'Increase calories by 200-300',
                            'Add refeed every 5 days instead of 10-14',
                            'Consider diet break (2 weeks at maintenance)'
                        ]
                    });
                }
                
                if (weeklyLeanChange < -0.3) {
                    recommendations.push({
                        icon: 'üí™',
                        title: 'Preserve Lean Mass',
                        message: `Losing ${Math.abs(weeklyLeanChange).toFixed(2)} lbs lean mass per week. Critical adjustments needed:`,
                        actions: [
                            `Increase protein to ${Math.round(latest.weight)}g/day minimum`,
                            'Increase training volume by 10-15%',
                            'Add refeed days every 5-6 days',
                            'Slightly increase calories (100-150)'
                        ]
                    });
                }
            }
            
            // Training volume optimization
            if (weeks.length >= 2) {
                const avgVolume = weeks.reduce((sum, w) => sum + (w.volume || 0), 0) / weeks.length;
                
                if (avgVolume < 100000) {
                    recommendations.push({
                        icon: 'üèãÔ∏è',
                        title: 'Increase Training Volume',
                        message: `Average weekly volume: ${Math.round(avgVolume).toLocaleString()} lbs. Optimal range for your goal: 130,000-150,000 lbs.`,
                        actions: [
                            'Add 2-3 sets per muscle group per week',
                            'Increase training frequency to 5-6 days',
                            'Focus on compound movements (Bench, Squat, Deadlift, Row)'
                        ]
                    });
                } else if (avgVolume > 160000) {
                    recommendations.push({
                        icon: 'üò¥',
                        title: 'Monitor Recovery',
                        message: `High weekly volume: ${Math.round(avgVolume).toLocaleString()} lbs. Ensure adequate recovery:`,
                        actions: [
                            'Sleep 8-9 hours per night',
                            'Take deload week every 4-5 weeks (50% volume)',
                            'Monitor resting heart rate and HRV',
                            'Consider reducing to 130,000-140,000 lbs if performance drops'
                        ]
                    });
                }
            }
            
            // Body fat specific recommendations
            if (latest.bodyfat > 12) {
                recommendations.push({
                    icon: 'üéØ',
                    title: `Current Body Fat: ${latest.bodyfat.toFixed(1)}%`,
                    message: `To reach 10%:`,
                    actions: [
                        `Estimated ${Math.round((latest.bodyfat - 10) * latest.weight / 100)} lbs fat to lose`,
                        `At 2 lbs/week: ${Math.round((latest.bodyfat - 10) * latest.weight / 200)} weeks remaining`,
                        'Maintain protein at 1g per lb',
                        'Keep strength training volume high',
                        'Refeeds every 5-6 days'
                    ]
                });
            }
            
            container.innerHTML = recommendations.map(rec => `
                <div class="insight-card">
                    <h4>${rec.icon} ${rec.title}</h4>
                    <p>${rec.message}</p>
                    <ul style="margin-top: 10px; margin-left: 20px; color: var(--text-secondary);">
                        ${rec.actions.map(action => `<li>${action}</li>`).join('')}
                    </ul>
                </div>
            `).join('');
        }

        // ==================== HELPER FUNCTIONS ====================
        
        function groupDataByWeek() {
            const weeks = [];
            const sortedDaily = [...dailyData].sort((a, b) => new Date(a.date) - new Date(b.date));
            const sortedTraining = [...trainingData].sort((a, b) => new Date(a.date) - new Date(b.date));
            
            if (sortedDaily.length === 0) return weeks;
            
            let weekStart = new Date(sortedDaily[0].date);
            let currentWeek = {
                startDate: weekStart.toISOString().split('T')[0],
                daily: [],
                training: []
            };
            
            sortedDaily.forEach(day => {
                const dayDate = new Date(day.date);
                const daysDiff = (dayDate - weekStart) / (1000 * 60 * 60 * 24);
                
                if (daysDiff >= 7) {
                    // Save current week
                    if (currentWeek.daily.length > 0) {
                        weeks.push(processWeek(currentWeek));
                    }
                    
                    // Start new week
                    weekStart = dayDate;
                    currentWeek = {
                        startDate: weekStart.toISOString().split('T')[0],
                        daily: [],
                        training: []
                    };
                }
                
                currentWeek.daily.push(day);
            });
            
            // Add training sessions to weeks
            sortedTraining.forEach(session => {
                const sessionDate = new Date(session.date);
                const week = weeks.find(w => {
                    const wStart = new Date(w.startDate);
                    const daysDiff = (sessionDate - wStart) / (1000 * 60 * 60 * 24);
                    return daysDiff >= 0 && daysDiff < 7;
                });
                
                if (week) {
                    week.training.push(session);
                } else if (currentWeek) {
                    const wStart = new Date(currentWeek.startDate);
                    const daysDiff = (sessionDate - wStart) / (1000 * 60 * 60 * 24);
                    if (daysDiff >= 0 && daysDiff < 7) {
                        currentWeek.training.push(session);
                    }
                }
            });
            
            // Add current week if it has data
            if (currentWeek.daily.length > 0) {
                weeks.push(processWeek(currentWeek));
            }
            
            return weeks;
        }

        function processWeek(week) {
            const processed = { ...week };
            
            if (week.daily.length > 0) {
                processed.avgWeight = week.daily.reduce((sum, d) => sum + d.weight, 0) / week.daily.length;
                processed.avgLean = week.daily.reduce((sum, d) => sum + d.leanMass, 0) / week.daily.length;
                processed.avgFat = week.daily.reduce((sum, d) => sum + d.fatMass, 0) / week.daily.length;
                
                const withCals = week.daily.filter(d => d.calories);
                if (withCals.length > 0) {
                    processed.avgCals = withCals.reduce((sum, d) => sum + d.calories, 0) / withCals.length;
                    processed.avgProtein = withCals.reduce((sum, d) => sum + (d.protein || 0), 0) / withCals.length;
                }
            }
            
            if (week.training.length > 0) {
                processed.volume = week.training.reduce((sum, t) => sum + t.workingVolume, 0);
                processed.sessions = week.training.length;
            }
            
            return processed;
        }

        function calculateCorrelation(x, y) {
            const n = Math.min(x.length, y.length);
            if (n < 2) return 0;
            
            const meanX = x.reduce((a, b) => a + b, 0) / n;
            const meanY = y.reduce((a, b) => a + b, 0) / n;
            
            let numerator = 0;
            let denomX = 0;
            let denomY = 0;
            
            for (let i = 0; i < n; i++) {
                const dx = x[i] - meanX;
                const dy = y[i] - meanY;
                numerator += dx * dy;
                denomX += dx * dx;
                denomY += dy * dy;
            }
            
            if (denomX === 0 || denomY === 0) return 0;
            
            return numerator / Math.sqrt(denomX * denomY);
        }

        function getRandomColor() {
            const colors = [
                'rgba(59, 130, 246, 0.7)',   // blue
                'rgba(16, 185, 129, 0.7)',   // green
                'rgba(239, 68, 68, 0.7)',    // red
                'rgba(245, 158, 11, 0.7)',   // orange
                'rgba(168, 85, 247, 0.7)',   // purple
                'rgba(236, 72, 153, 0.7)',   // pink
                'rgba(20, 184, 166, 0.7)',   // teal
                'rgba(251, 191, 36, 0.7)'    // yellow
            ];
            return colors[Math.floor(Math.random() * colors.length)];
        }

        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // ==================== INITIALIZE APP ====================
        
        window.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
