<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Body Tracker Pro v15 - Ultimate Edition</title>
    <link rel="manifest" href='data:application/manifest+json,{"name": "Body Tracker Pro", "short_name": "BodyTracker", "start_url": "./?pwa=1", "display": "standalone", "background_color": "#0f172a", "theme_color": "#06b6d4", "icons": []}'>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Work+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --accent-cyan: #06b6d4;
            --accent-purple: #8b5cf6;
            --accent-success: #10b981;
            --accent-danger: #ef4444;
            --accent-warning: #f59e0b;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border: #334155;
        }
        
        body {
            font-family: 'Work Sans', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container { max-width: 1600px; margin: 0 auto; }
        
        .header {
            background: var(--bg-secondary);
            padding: 30px;
            border-radius: 16px;
            margin-bottom: 30px;
            border: 1px solid var(--border);
        }
        
        .header h1 {
            font-size: 2.5em;
            font-weight: 700;
            font-family: 'Space Mono', monospace;
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }
        
        .header-subtitle {
            color: var(--text-secondary);
            font-family: 'Space Mono', monospace;
            font-size: 0.9em;
            margin-bottom: 5px;
        }
        
        .header-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        /* INTEGRITY BADGES */
        .integrity-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
            font-family: 'Space Mono', monospace;
        }
        
        .integrity-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        .integrity-green {
            background: rgba(16, 185, 129, 0.15);
            color: var(--accent-success);
            border: 1px solid var(--accent-success);
        }
        
        .integrity-yellow {
            background: rgba(245, 158, 11, 0.15);
            color: var(--accent-warning);
            border: 1px solid var(--accent-warning);
        }
        
        .integrity-red {
            background: rgba(239, 68, 68, 0.15);
            color: var(--accent-danger);
            border: 1px solid var(--accent-danger);
        }
        
        .integrity-blue {
            background: rgba(6, 182, 212, 0.15);
            color: var(--accent-cyan);
            border: 1px solid var(--accent-cyan);
        }
        
        .integrity-gray {
            background: rgba(148, 163, 184, 0.15);
            color: var(--text-secondary);
            border: 1px solid var(--border);
        }
        
        .dot-green { background: var(--accent-success); }
        .dot-yellow { background: var(--accent-warning); }
        .dot-red { background: var(--accent-danger); }
        .dot-blue { background: var(--accent-cyan); }
        .dot-gray { background: var(--text-secondary); }
        
        button {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border);
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 0.9em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        button:hover {
            background: var(--accent-cyan);
            border-color: var(--accent-cyan);
            transform: translateY(-2px);
        }
        
        button.primary {
            background: var(--accent-cyan);
            border-color: var(--accent-cyan);
        }
        
        button.danger {
            background: var(--accent-danger);
            border-color: var(--accent-danger);
            padding: 5px 10px;
            font-size: 0.8em;
        }
        
        .card {
            background: var(--bg-secondary);
            padding: 25px;
            border-radius: 12px;
            border: 1px solid var(--border);
            margin-bottom: 20px;
        }
        
        .card h2 {
            font-size: 1.5em;
            margin-bottom: 20px;
            color: var(--accent-cyan);
        }
        
        .grid { display: grid; gap: 20px; margin-bottom: 20px; }
        .grid-4 { grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); }
        
        .stat-card {
            background: var(--bg-tertiary);
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid var(--accent-cyan);
        }
        
        .stat-label {
            font-size: 0.85em;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: 700;
            font-family: 'Space Mono', monospace;
            margin: 10px 0;
        }
        
        .stat-change {
            font-size: 0.9em;
            font-family: 'Space Mono', monospace;
        }
        
        .positive { color: var(--accent-success); }
        .negative { color: var(--accent-danger); }
        
        .chart-wrapper {
            position: relative;
            height: 400px;
            width: 100%;
            margin-bottom: 20px;
        }
        
        canvas { max-height: 400px !important; }
        
        .chart-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .chart-tab {
            padding: 10px 20px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9em;
        }
        
        .chart-tab.active {
            background: var(--accent-cyan);
            border-color: var(--accent-cyan);
            font-weight: 600;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.75em;
        }
        
        th {
            background: var(--bg-tertiary);
            padding: 10px 6px;
            text-align: left;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.8em;
            letter-spacing: 0.5px;
            border-bottom: 2px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        td {
            padding: 8px 6px;
            border-bottom: 1px solid var(--border);
        }
        
        tbody tr:hover {
            background: var(--bg-tertiary);
            cursor: pointer;
        }
        
        tbody tr.editing {
            background: rgba(6, 182, 212, 0.15);
            outline: 2px solid var(--accent-cyan);
        }
        
        .refeed-row {
            background: rgba(239, 68, 68, 0.1);
        }
        
        .refeed-row:hover {
            background: rgba(239, 68, 68, 0.15);
        }
        
        td.editing input {
            width: 100%;
            background: var(--bg-primary);
            border: 1px solid var(--accent-cyan);
            color: var(--text-primary);
            padding: 4px 6px;
            border-radius: 4px;
            font-size: 0.95em;
        }
        
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            align-items: center;
            justify-content: center;
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
        }
        
        .modal-overlay.show { display: flex; }
        
        .modal {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 30px;
            max-width: 700px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid var(--border);
        }
        
        .form-section {
            background: var(--bg-tertiary);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        
        .form-section h3 {
            font-size: 1.1em;
            margin-bottom: 15px;
            color: var(--accent-cyan);
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
        }
        
        .form-field label {
            display: block;
            font-size: 0.85em;
            color: var(--text-secondary);
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .form-field input, .form-field textarea {
            width: 100%;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 8px;
            border-radius: 6px;
            font-size: 0.9em;
        }
        
        .form-field input:focus {
            outline: none;
            border-color: var(--accent-cyan);
        }
        
        .form-field input[readonly] {
            background: var(--bg-primary);
            color: var(--text-secondary);
            cursor: not-allowed;
        }
        
        .required::after {
            content: " *";
            color: var(--accent-danger);
        }
        
        .integrity-notice {
            background: rgba(6, 182, 212, 0.1);
            border-left: 4px solid var(--accent-cyan);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        .integrity-notice h4 {
            color: var(--accent-cyan);
            margin-bottom: 8px;
            font-size: 1em;
        }
        
        .integrity-notice p {
            font-size: 0.9em;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }
        
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--accent-success);
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 2000;
            display: none;
            animation: slideIn 0.3s ease;
            max-width: 500px;
            font-size: 0.9em;
            white-space: pre-line;
            font-family: 'Space Mono', monospace;
        }
        
        .toast.show { display: block; }
        .toast.error { background: var(--accent-danger); }
        .toast.warning { background: var(--accent-warning); }
        
        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .table-container {
            overflow-x: auto;
            max-height: 600px;
            overflow-y: auto;
        }
        
        .edit-actions {
            display: flex;
            gap: 5px;
        }
        
        .tab-button {
            padding: 12px 24px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1em;
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .tab-button:hover {
            background: var(--accent-cyan);
            border-color: var(--accent-cyan);
            transform: translateY(-2px);
        }
        
        .tab-button.active {
            background: var(--accent-cyan);
            border-color: var(--accent-cyan);
            font-weight: 600;
        }
        
        .main-tab-content {
            display: none;
        }
        
        .main-tab-content.active {
            display: block;
        }
        
        .grid-2 { grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); }
        
        .nutrition-card {
            background: var(--bg-tertiary);
            padding: 20px;
            border-radius: 10px;
            margin: 10px 0;
        }
        
        .nutrition-label {
            font-size: 0.9em;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }
        
        .nutrition-value {
            font-size: 1.8em;
            font-weight: 700;
            font-family: 'Space Mono', monospace;
            color: var(--accent-cyan);
        }
        
        @media (max-width: 768px) {
            .header h1 { font-size: 1.8em; }
            .grid-4, .grid-2 { grid-template-columns: 1fr; }
            .form-grid { grid-template-columns: 1fr; }
            table { font-size: 0.7em; }
            th, td { padding: 6px 3px; }
        }
    
        @media print {
            body { background: white !important; color: black !important; }
            .header-actions, .tab-button, button, .toast, .modal-overlay { display: none !important; }
            .card { page-break-inside: avoid; border: 1px solid #ddd !important; }
            th { position: static !important; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üí™ BODY TRACKER PRO v15 <span style="font-size: 0.5em; color: var(--accent-cyan);">ULTIMATE</span></h1>
            

<div class="brand-section" style="margin-top:14px; display:flex; gap:14px; align-items:center; flex-wrap:wrap;">
  <div class="brand-logo" style="width:56px; height:56px; border-radius:14px; background: rgba(139,92,246,0.15); border:1px solid var(--border); display:flex; align-items:center; justify-content:center; box-shadow: 0 0 0 rgba(6,182,212,0); transition: all 0.25s ease;">
    <svg width="40" height="40" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg" aria-label="Rak Chazaq logo">
      <!-- Mountain / strength mark -->
      <path d="M10 50L26 26L34 36L42 28L54 50" stroke="url(#g1)" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/>
      <!-- Barbell -->
      <path d="M18 20v10M46 20v10M22 25h20" stroke="url(#g2)" stroke-width="4" stroke-linecap="round"/>
      <!-- Hebrew -->
      <text x="32" y="60" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="url(#g1)">◊®◊ß ◊ó◊ñ◊ß</text>
      <defs>
        <linearGradient id="g1" x1="10" y1="10" x2="54" y2="54" gradientUnits="userSpaceOnUse">
          <stop stop-color="#06b6d4"/><stop offset="1" stop-color="#8b5cf6"/>
        </linearGradient>
        <linearGradient id="g2" x1="18" y1="18" x2="46" y2="34" gradientUnits="userSpaceOnUse">
          <stop stop-color="#10b981"/><stop offset="1" stop-color="#06b6d4"/>
        </linearGradient>
      </defs>
    </svg>
  </div>
  <div style="min-width:220px;">
    <div style="font-family:'Space Mono', monospace; letter-spacing:0.06em; font-weight:800; font-size:0.95em;">
      <span style="background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple)); -webkit-background-clip:text; -webkit-text-fill-color:transparent;">RAK CHAZAQ</span>
      <span style="color: var(--text-secondary); font-weight:600; margin-left:8px;">(◊®◊ß ◊ó◊ñ◊ß)</span>
    </div>
    <div style="color: var(--text-secondary); font-size:0.9em; margin-top:2px;">
      <strong>Only Strong ‚Ä¢ Joshua 1:9</strong> ‚Ä¢ Plan the work, work the plan ‚Ä¢ Built for Transformation
    </div>
  </div>
  <span style="display:inline-block; background:rgba(139,92,246,0.2); color:var(--accent-purple); padding:4px 12px; border-radius:12px; font-size:0.75em; font-weight:600; font-family:'Space Mono',monospace; border:1px solid var(--accent-purple); margin-left:10px;">v14.0</span>
</div>
<script>
  document.addEventListener('DOMContentLoaded', ()=>{
            
            // Load training data
            function loadTrainingData() {
                try {
                    const saved = localStorage.getItem('trainingData_v1');
                    if (saved) {
                        trainingLog = JSON.parse(saved);
                    } else {
                        trainingLog = INITIAL_TRAINING_WORKOUTS;
                        localStorage.setItem('trainingData_v1', JSON.stringify(trainingLog));
                    }
                } catch (e) {
                    console.error('Error loading training data:', e);
                    trainingLog = INITIAL_TRAINING_WORKOUTS;
                }
            }
            
            function loadPRs() {
                try {
                    const saved = localStorage.getItem('personalRecords_v1');
                    if (saved) {
                        personalRecords = JSON.parse(saved);
                    } else {
                        personalRecords = { version: 1, prs: INITIAL_PERSONAL_RECORDS };
                        localStorage.setItem('personalRecords_v1', JSON.stringify(personalRecords));
                    }
                } catch (e) {
                    console.error('Error loading PRs:', e);
                    personalRecords = { version: 1, prs: INITIAL_PERSONAL_RECORDS };
                }
            }
            
            loadTrainingData();
            loadPRs();

            // Initialize Phase 2 features
            initPWA();
            initQuickAdd();
            
            // Update all tabs on load
            updateProgressiveTabEnhanced();
            updateAnalyticsTab();
            updateInsightsTab();
            updateQualityTab();
            

    const logo = document.querySelector('.brand-logo');
    if(!logo) return;
    logo.addEventListener('mouseenter', ()=>{ logo.style.boxShadow='0 0 22px rgba(6,182,212,0.35)'; logo.style.transform='translateY(-1px)';});
    logo.addEventListener('mouseleave', ()=>{ logo.style.boxShadow='0 0 0 rgba(6,182,212,0)'; logo.style.transform='translateY(0)';});
  });
</script>

<p class="header-subtitle">‚ú® v14: Critical bug fixes ‚Ä¢ Enhanced formula docs ‚Ä¢ Improved analytics ‚Ä¢ Mobile optimizations</p>
            <p style="color: var(--text-secondary); font-family: 'Space Mono', monospace;" id="headerStatus">Loading...</p>
            <div class="header-actions">
                <button onclick="showAddEntry()" class="primary">+ Add Entry</button>
                <button onclick="exportCSV()">üì• Export CSV</button>
                <button onclick="exportBackup()">üíæ Backup JSON</button>
                <button onclick="openBulkEdit()" style="background: var(--accent-purple);">üßæ Bulk Edit</button>
                <button onclick="reloadData()" style="background: var(--accent-purple);">üîÑ Reload Data</button>
                <button onclick="openSettings()" style="background: var(--accent-purple);">‚öôÔ∏è Settings</button>
                <button onclick="openFormulaDocs()" style="background: var(--accent-cyan);">‚ÑπÔ∏è Formulas</button>
                <button onclick="debugData()" style="background: var(--accent-warning);">üîß Debug Data</button>
            </div>
        </div>

        <!-- TAB NAVIGATION -->
        <div style="display: flex; gap: 10px; margin-bottom: 30px; flex-wrap: wrap; background: var(--bg-secondary); padding: 15px; border-radius: 12px; border: 1px solid var(--border);">
            <button class="tab-button active" onclick="switchMainTab('dashboard', this)">üìä Dashboard</button>
            <button class="tab-button" onclick="switchMainTab('nutrition', this)">üçΩÔ∏è Nutrition</button>
            <button class="tab-button" onclick="switchMainTab('measurements', this)">üìè Body Measurements</button>
            <button class="tab-button" onclick="switchMainTab('training', this)">üèãÔ∏è Training Log</button>
            <button class="tab-button" onclick="switchMainTab('correlations', this)">üîç Correlations</button>
            <button class="tab-button" onclick="switchMainTab('analytics')">üß† Analytics</button>
            <button class="tab-button" onclick="switchMainTab('data', this)">üìã All Data</button>
        </div>

        <!-- DASHBOARD TAB -->
        <div id="dashboard-tab" class="main-tab-content active">
            <div class="grid grid-4" id="statsGrid"></div>

            <div class="card">
                <h2>üéØ Goal Projection</h2>
                <div id="goalContent"></div>
            
<div class="card">
    <h2>üìä Health Statistics</h2>
    <div id="healthStatsContent"></div>
</div>

</div>

            <div class="card">
                <h2>üìä Body Composition Analysis</h2>
                <p style="color: var(--text-secondary); margin-bottom: 15px;">Choose a view to understand your transformation better</p>
                <div class="chart-tabs">
                    <div class="chart-tab active" onclick="switchChart('fatVsLean', this)">Fat vs Lean Breakdown</div>
                    <div class="chart-tab" onclick="switchChart('weightTrend', this)">Weight & BF% Trend</div>
                    <div class="chart-tab" onclick="switchChart('rateOfChange', this)">Daily Rate of Change</div>
                    <div class="chart-tab" onclick="switchChart('nutrition', this)">Nutrition Tracking</div>
                    <div class="chart-tab" onclick="switchChart('waterOverlay', this)">Body Water % Overlay</div>
                </div>
                <div class="chart-wrapper">
                    <canvas id="mainChart"></canvas>
                </div>
            </div>
        </div>

        <!-- NUTRITION TAB -->
        <div id="nutrition-tab" class="main-tab-content">
            <div class="card">
                <h2>üçΩÔ∏è Nutrition Goals & Analysis</h2>
                <div id="nutritionGoals"></div>
            </div>
            <div class="grid grid-2">
                <div class="card">
                    <h3>üìä Total Averages (All Time)</h3>
                    <div id="totalAverages"></div>
                </div>
                <div class="card">
                    <h3>üìà Rolling 7-Day Averages</h3>
                    <div id="rollingAverages"></div>
                </div>
            </div>
            <div class="card">
                <h2>üí° Calorie Recommendations</h2>
                <div id="recommendations"></div>
            </div>
            <div class="card">
                <h2>üéØ What-If Calculator</h2>
                <div id="whatIfCalc"></div>
            </div>
        </div>

        <!-- MEASUREMENTS TAB -->
        <div id="measurements-tab" class="main-tab-content">
            <div class="card">
                <h2>üìè Body Measurements</h2>
                <button onclick="showAddMeasurement()" class="primary" style="margin-bottom: 20px;">+ Add Measurement</button>
                <div id="measurementsContent"></div>
            </div>
        </div>

        <!-- TRAINING TAB -->
        <div id="training-tab" class="main-tab-content">
            <div class="card">
                <h2>üèãÔ∏è Training Log</h2>
                <button onclick="showAddWorkout()" class="primary" style="margin-bottom: 20px;">+ Add Workout</button>
                <div id="trainingContent"></div>
            </div>
        </div>

        <!-- CORRELATIONS TAB -->
        <div id="correlations-tab" class="main-tab-content">
            <div class="card">
                <h2>üîç Correlations & Insights</h2>
                <div id="correlationsContent"></div>
            </div>
    
    <!-- ===== TAB: ANALYTICS ===== -->
    <div id="analytics-tab" class="main-tab-content">
        <div class="card">
            <h2 style="color: var(--accent-cyan); margin-bottom: 20px;">üî¨ Advanced Analytics Dashboard</h2>
            <div id="analyticsContent"></div>
        </div>
    </div>
    
    <!-- ===== TAB: INSIGHTS ===== -->
    <div id="insights-tab" class="main-tab-content">
        <div class="card">
            <h2 style="color: var(--accent-cyan); margin-bottom: 20px;">üí° Training Insights & Recommendations</h2>
            <div id="insightsContent"></div>
        </div>
    </div>
    
    <!-- ===== TAB: DATA QUALITY ===== -->
    <div id="quality-tab" class="main-tab-content">
        <div class="card">
            <h2 style="color: var(--accent-cyan); margin-bottom: 20px;">‚úÖ Data Quality Management</h2>
            <div id="qualityContent"></div>
        </div>
    </div>

        </div>

        
<!-- PROGRESSIVE OVERLOAD TAB -->
<div id="progressive-tab" class="main-tab-content">
    <div class="card">
        <h2>üìà Progressive Overload</h2>
        <div id="progressiveContent"></div>
    </div>
</div>


        <!-- ANALYTICS TAB -->
        <div id="analytics-tab" class="main-tab-content">
            <div class="card">
                <h2>üß† Advanced Analytics</h2>
                <div id="analyticsContent"></div>
            </div>
        </div>

<!-- DATA TAB -->
        <div id="data-tab" class="main-tab-content">
            <div class="card">
                <h2>üìã Complete Data Log (<span id="entryCount">0</span> entries)</h2>
                <p style="color: var(--text-secondary); margin-bottom: 15px;">Click any row to edit ‚Ä¢ Red rows = refeed days ‚Ä¢ Badges show data integrity</p>
                
                <!-- Column Visibility Controls -->
                <div class="column-controls">
                    <div style="color: var(--accent-cyan); font-weight: 700; margin-right: 10px;">üéõÔ∏è Columns:</div>
                    <label class="column-toggle"><input type="checkbox" checked disabled> Date</label>
                    <label class="column-toggle"><input type="checkbox" checked disabled> Weight</label>
                    <label class="column-toggle"><input type="checkbox" checked disabled> BF%</label>
                    <label class="column-toggle"><input type="checkbox" checked> BF lbs</label>
                    <label class="column-toggle"><input type="checkbox" checked> Lean</label>
                    <label class="column-toggle"><input type="checkbox" checked> Lean%</label>
                    <label class="column-toggle"><input type="checkbox" checked> Water%</label>
                    <label class="column-toggle"><input type="checkbox" checked> Cal</label>
                    <label class="column-toggle"><input type="checkbox" checked> Pro</label>
                    <label class="column-toggle"><input type="checkbox" checked> Fat</label>
                    <label class="column-toggle"><input type="checkbox" checked> Carbs</label>
                    <label class="column-toggle"><input type="checkbox" checked> Steps</label>
                    <label class="column-toggle"><input type="checkbox" checked> RHR</label>
                    <label class="column-toggle"><input type="checkbox" checked> Sleep</label>
                    <label class="column-toggle" style="background: var(--accent-purple); color: white; border: none; padding: 8px 14px;">
                        <input type="checkbox" id="compactModeToggle" onchange="toggleCompactMode()"> <strong>Compact Mode</strong>
                    </label>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>‚úì</th>
                                <th>Weight</th>
                                <th>BF%</th>
                                <th>BF lbs</th>
                                <th>Lean</th>
                                <th>Lean%</th>
                                <th>Water%</th>
                                <th>Cal</th>
                                <th>Pro</th>
                                <th>Fat</th>
                                <th>Carbs</th>
                                <th>Steps</th>
                                <th>RHR</th>
                                <th>Sleep</th>
                                <th>Sleep Hrs</th>
                                <th>Q</th>
                                <th>Refeed</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="dataTable"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- ADD ENTRY MODAL -->
    <div class="modal-overlay" id="addEntryModal">
        <div class="modal">
            <h2 id="modalTitle">Add New Entry</h2>
            
            <div class="integrity-notice">
                <h4>üõ°Ô∏è Intelligent Data Validation</h4>
                <p>This tracker automatically validates your entries to catch typos and errors.</p>
                <p>You'll be alerted if weight, body fat %, or lean mass don't align with your typical patterns.</p>
            </div>
            
            <div class="form-section">
                <h3>Body Composition (Required)</h3>
                <div class="form-grid">
                    <div class="form-field">
                        <label class="required">Date</label>
                        <input type="date" id="entryDate" required>
                    </div>
                    <div class="form-field">
                        <label class="required">Weight (lbs)</label>
                        <input type="number" step="0.1" id="entryWeight" required>
                    </div>
                    <div class="form-field">
                        <label class="required">Body Fat %</label>
                        <input type="number" step="0.1" id="entryBfPercent" required>
                    </div>
                    <div class="form-field">
                        <label class="required">Lean Mass (lbs)</label>
                        <input type="number" step="0.1" id="entryLeanLbs" required>
                    </div>
                    <div class="form-field">
                        <label>BF lbs (Auto)</label>
                        <input type="text" id="entryBfLbsAuto" readonly>
                    </div>
                    <div class="form-field">
                        <label>Lean % (Auto)</label>
                        <input type="text" id="entryLeanPercentAuto" readonly>
                    </div>
                    <div class="form-field">
                        <label>Residual (Auto)</label>
                        <input type="text" id="entryResidualAuto" readonly>
                        <div style="font-size: 0.75em; color: var(--text-secondary); margin-top: 3px;">Used for integrity check</div>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h3>Nutrition</h3>
                <div class="form-grid">
                    <div class="form-field">
                        <label>Calories</label>
                        <input type="number" id="entryCalories">
                    </div>
                    <div class="form-field">
                        <label>Protein (g)</label>
                        <input type="number" id="entryProtein">
                    </div>
                    <div class="form-field">
                        <label>Fat (g)</label>
                        <input type="number" id="entryFat">
                    </div>
                    <div class="form-field">
                        <label>Carbs (g)</label>
                        <input type="number" id="entryCarbs">
                    </div>
                    <div class="form-field">
                        <label><input type="checkbox" id="entryRefeed" style="width: auto; margin-right: 8px;">Refeed Day üî•</label>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h3>Activity & Wellness</h3>
                <div class="form-grid">
                    <div class="form-field">
                        <label>Steps</label>
                        <input type="number" id="entrySteps">
                    </div>
                    <div class="form-field">
                        <label>RHR (bpm)</label>
                        <input type="number" id="entryRhr">
                    </div>
                    <div class="form-field">
                        <label>Sleep Score (0-100)</label>
                        <input type="number" min="0" max="100" id="entrySleepScore">
                    </div>
                    <div class="form-field">
                        <label>Sleep Hours</label>
                        <input type="number" step="0.1" id="entrySleepHours">
                    </div>
                    <div class="form-field">
                        <label>Body Water % (Optional)</label>
                        <input type="number" step="0.1" id="entryBodyWater">
                    </div>
                </div>
            </div>

            <div class="form-section">
                <div class="form-field">
                    <label>Notes</label>
                    <textarea rows="2" id="entryNotes"></textarea>
                </div>
            </div>

            <!-- Integrity Status in Modal -->
            <div id="modalIntegrityStatus" style="margin: 15px 0;"></div>

            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button onclick="saveEntry()" class="primary" id="saveBtn">Save Entry</button>
                <button onclick="hideModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- MEASUREMENTS MODAL -->
    <div class="modal-overlay" id="measurementsModal"></div>

    <!-- TRAINING MODAL -->
    <div class="modal-overlay" id="trainingModal"></div>

    <!-- SETTINGS MODAL -->
    <div class="modal-overlay" id="settingsModal"></div>

    <!-- FORMULA DOCS MODAL -->
    <div class="modal-overlay" id="formulaModal"></div>

    <div class="toast" id="toast"></div>

    <div id="quickAddBar" style="position: fixed; left: 12px; right: 12px; bottom: 12px; z-index: 1500; display:none;">
        <div style="background: rgba(30,41,59,0.92); backdrop-filter: blur(8px); border: 1px solid var(--border); border-radius: 14px; padding: 10px; display:flex; gap:10px; justify-content: space-between; align-items:center;">
            <button class="primary" onclick="showAddEntry()" style="flex:1; min-height:44px;">+ Body Entry</button>
            <button onclick="switchMainTab('training'); showAddWorkout();" style="flex:1; min-height:44px;">+ Workout</button>
            <button onclick="switchMainTab('data')" style="min-width:54px; min-height:44px;">üìã</button>
        </div>
    </div>


    <script>
        // ===== GLOBAL CONFIGURATION =====
        const STORAGE_KEY = 'bodyTrackingData_User1';
        
        const MEASUREMENTS_KEY = 'bodyMeasurements_User1';
        const TRAINING_KEY_OLD = 'trainingLog_User1';
const GOALS = {
    // Body composition goals
    target_weight: 215,
    target_bf_percent: 10.0,
    // For projection logic: target fat lbs at 10% of 215 = 21.5
    target_bf_lbs: 21.5,

    // Nutrition targets (editable)
    target_calories: 1600,
    target_protein: 195,
    target_fat: 55,
    target_carbs: 120,

    // Cutting milestone
    cut_target_bf_lbs: 20.0
};
        
        // Integrity validation thresholds
        const INTEGRITY_CONFIG = {
            baselineWindow: 14,  // Days to use for baseline calculation
            greenThreshold: 1.0, // lbs - good integrity
            yellowThreshold: 2.0, // lbs - warning
            // Anything above yellowThreshold is red (error likely)
        };

        let bodyData = [];
        let currentChart = null;
        let currentChartType = 'fatVsLean';
        let editingRow = null;

        // ===== INITIAL DATA (57 days: Oct 27 - Dec 22, 2025) =====
        const INITIAL_DATA = [{"date":"2025-10-27","weight":208.1,"bf_percent":20.5,"lean_lbs":156.3,"bf_lbs":42.66,"lean_percent":75.11,"residual":9.14,"calories":1405,"protein":116,"fat":83,"carbs":40,"steps":7046,"rhr":48,"sleep_score":87,"sleep_duration_hrs":9.42,"body_water_percent":58.4,"refeed":false,"notes":"","integrity_status":"yellow","integrity_message":"Warning - Slight variance detected"},{"date":"2025-10-28","weight":208.9,"bf_percent":20.5,"lean_lbs":154.5,"bf_lbs":42.82,"lean_percent":73.96,"residual":11.58,"calories":1565,"protein":139,"fat":92,"carbs":30,"steps":null,"rhr":null,"sleep_score":77,"sleep_duration_hrs":6.62,"body_water_percent":58.3,"refeed":false,"notes":"","integrity_status":"yellow","integrity_message":"Warning - Slight variance detected"},{"date":"2025-10-29","weight":203.4,"bf_percent":20.3,"lean_lbs":154.6,"bf_lbs":41.29,"lean_percent":76.01,"residual":7.51,"calories":1577,"protein":151,"fat":79,"carbs":50,"steps":null,"rhr":null,"sleep_score":63,"sleep_duration_hrs":9.18,"body_water_percent":59.8,"refeed":false,"notes":"","integrity_status":"red","integrity_message":"Check data - Residual shifted 2.7 lbs from baseline"},{"date":"2025-10-30","weight":202.6,"bf_percent":20,"lean_lbs":154.5,"bf_lbs":40.52,"lean_percent":76.26,"residual":7.58,"calories":1555,"protein":142,"fat":95,"carbs":23,"steps":6480,"rhr":55,"sleep_score":null,"sleep_duration_hrs":null,"body_water_percent":59.8,"refeed":false,"notes":"","integrity_status":"red","integrity_message":"Check data - Residual shifted 2.6 lbs from baseline"},{"date":"2025-10-31","weight":205,"bf_percent":19.7,"lean_lbs":154.2,"bf_lbs":40.38,"lean_percent":75.22,"residual":10.42,"calories":1290,"protein":147,"fat":59,"carbs":35,"steps":9519,"rhr":54,"sleep_score":86,"sleep_duration_hrs":10.38,"body_water_percent":58.8,"refeed":false,"notes":"","integrity_status":"green","integrity_message":"Good - Values align with baseline"},{"date":"2025-11-01","weight":204.4,"bf_percent":19.7,"lean_lbs":154.2,"bf_lbs":40.27,"lean_percent":75.44,"residual":9.93,"calories":1735,"protein":146,"fat":41,"carbs":31,"steps":5231,"rhr":52,"sleep_score":66,"sleep_duration_hrs":7,"body_water_percent":59.3,"refeed":false,"notes":"","integrity_status":"green","integrity_message":"Good - Values align with baseline"},{"date":"2025-11-02","weight":203.8,"bf_percent":19.5,"lean_lbs":154.3,"bf_lbs":39.74,"lean_percent":75.71,"residual":9.76,"calories":1436,"protein":134,"fat":76,"carbs":29,"steps":2859,"rhr":51,"sleep_score":91,"sleep_duration_hrs":8.1,"body_water_percent":59.7,"refeed":false,"notes":"","integrity_status":"green","integrity_message":"Good - Values align with baseline"},{"date":"2025-11-03","weight":204,"bf_percent":19.3,"lean_lbs":154.4,"bf_lbs":39.37,"lean_percent":75.69,"residual":10.23,"calories":1981,"protein":207,"fat":76,"carbs":35,"steps":9321,"rhr":55,"sleep_score":67,"sleep_duration_hrs":7.53,"body_water_percent":59.8,"refeed":false,"notes":"","integrity_status":"green","integrity_message":"Good - Values align with baseline"},{"date":"2025-11-04","weight":203.9,"bf_percent":19.2,"lean_lbs":154.4,"bf_lbs":39.15,"lean_percent":75.72,"residual":10.35,"calories":1660,"protein":131,"fat":48,"carbs":50,"steps":7202,"rhr":54,"sleep_score":73,"sleep_duration_hrs":6.65,"body_water_percent":59.5,"refeed":false,"notes":"","integrity_status":"green","integrity_message":"Good - Values align with baseline"},{"date":"2025-11-05","weight":200.8,"bf_percent":19.5,"lean_lbs":153.8,"bf_lbs":39.16,"lean_percent":76.59,"residual":7.84,"calories":1525,"protein":161,"fat":85,"carbs":20,"steps":5753,"rhr":52,"sleep_score":87,"sleep_duration_hrs":9.1,"body_water_percent":59.1,"refeed":false,"notes":"","integrity_status":"red","integrity_message":"Check data - Residual shifted 2.3 lbs from baseline"},{"date":"2025-11-06","weight":200.6,"bf_percent":19.6,"lean_lbs":153.3,"bf_lbs":39.32,"lean_percent":76.42,"residual":7.98,"calories":1492,"protein":141,"fat":82,"carbs":39,"steps":10762,"rhr":50,"sleep_score":76,"sleep_duration_hrs":9.03,"body_water_percent":58.8,"refeed":false,"notes":"","integrity_status":"red","integrity_message":"Check data - Residual shifted 2.2 lbs from baseline"},{"date":"2025-11-07","weight":200.2,"bf_percent":19.4,"lean_lbs":153.2,"bf_lbs":38.84,"lean_percent":76.52,"residual":8.16,"calories":1724,"protein":179,"fat":71,"carbs":83,"steps":11448,"rhr":52,"sleep_score":65,"sleep_duration_hrs":6.48,"body_water_percent":60,"refeed":false,"notes":"","integrity_status":"red","integrity_message":"Check data - Residual shifted 2.0 lbs from baseline"},{"date":"2025-11-08","weight":201.1,"bf_percent":19.1,"lean_lbs":153.3,"bf_lbs":38.41,"lean_percent":76.23,"residual":9.39,"calories":2465,"protein":180,"fat":82,"carbs":197,"steps":4149,"rhr":49,"sleep_score":73,"sleep_duration_hrs":8.67,"body_water_percent":60.2,"refeed":true,"notes":"","integrity_status":"green","integrity_message":"Good - Values align with baseline"},{"date":"2025-11-09","weight":202.8,"bf_percent":18.6,"lean_lbs":153.8,"bf_lbs":37.72,"lean_percent":75.84,"residual":11.28,"calories":1710,"protein":203,"fat":57,"carbs":81,"steps":4673,"rhr":48,"sleep_score":85,"sleep_duration_hrs":7.17,"body_water_percent":61,"refeed":false,"notes":"","integrity_status":"yellow","integrity_message":"Warning - Slight variance detected"},{"date":"2025-11-10","weight":201.8,"bf_percent":18.4,"lean_lbs":154.2,"bf_lbs":37.13,"lean_percent":76.41,"residual":10.47,"calories":1908,"protein":203,"fat":68,"carbs":100,"steps":7444,"rhr":51,"sleep_score":78,"sleep_duration_hrs":9,"body_water_percent":61.1,"refeed":false,"notes":"","integrity_status":"green","integrity_message":"Good - Values align with baseline"},{"date":"2025-11-11","weight":200.3,"bf_percent":18.3,"lean_lbs":154.4,"bf_lbs":36.65,"lean_percent":77.08,"residual":9.25,"calories":1199,"protein":150,"fat":26,"carbs":65,"steps":2327,"rhr":45,"sleep_score":56,"sleep_duration_hrs":4.88,"body_water_percent":61.1,"refeed":false,"notes":"","integrity_status":"green","integrity_message":"Good - Values align with baseline"},{"date":"2025-11-12","weight":199.1,"bf_percent":18.3,"lean_lbs":154.2,"bf_lbs":36.44,"lean_percent":77.45,"residual":8.46,"calories":1210,"protein":101,"fat":72,"carbs":28,"steps":3724,"rhr":46,"sleep_score":76,"sleep_duration_hrs":9.7,"body_water_percent":60.2,"refeed":false,"notes":"","integrity_status":"yellow","integrity_message":"Warning - Slight variance detected"},{"date":"2025-11-13","weight":199.5,"bf_percent":18.3,"lean_lbs":153.7,"bf_lbs":36.51,"lean_percent":77.04,"residual":9.29,"calories":1756,"protein":133,"fat":112,"carbs":39,"steps":10266,"rhr":48,"sleep_score":83,"sleep_duration_hrs":8.78,"body_water_percent":59.6,"refeed":false,"notes":"","integrity_status":"green","integrity_message":"Good - Values align with baseline"},{"date":"2025-11-14","weight":197.5,"bf_percent":18.4,"lean_lbs":153.5,"bf_lbs":36.34,"lean_percent":77.72,"residual":7.66,"calories":2583,"protein":202,"fat":51,"carbs":270,"steps":6214,"rhr":47,"sleep_score":81,"sleep_duration_hrs":8.53,"body_water_percent":60.5,"refeed":true,"notes":"","integrity_status":"red","integrity_message":"Check data - Residual shifted 2.5 lbs from baseline"},{"date":"2025-11-15","weight":199.1,"bf_percent":18,"lean_lbs":153.6,"bf_lbs":35.84,"lean_percent":77.15,"residual":9.66,"calories":1960,"protein":219,"fat":84,"carbs":75,"steps":4173,"rhr":55,"sleep_score":62,"sleep_duration_hrs":6.62,"body_water_percent":61,"refeed":false,"notes":"","integrity_status":"green","integrity_message":"Good - Values align with baseline"},{"date":"2025-11-16","weight":199.6,"bf_percent":17.8,"lean_lbs":153.8,"bf_lbs":35.53,"lean_percent":77.05,"residual":10.27,"calories":1502,"protein":156,"fat":30,"carbs":128,"steps":4655,"rhr":54,"sleep_score":60,"sleep_duration_hrs":7.1,"body_water_percent":61.2,"refeed":false,"notes":"","integrity_status":"green","integrity_message":"Good - Values align with baseline"},{"date":"2025-11-17","weight":198.3,"bf_percent":17.7,"lean_lbs":153.8,"bf_lbs":35.1,"lean_percent":77.56,"residual":9.4,"calories":2165,"protein":207,"fat":127,"carbs":32,"steps":12478,"rhr":52,"sleep_score":67,"sleep_duration_hrs":8.88,"body_water_percent":61,"refeed":true,"notes":"","integrity_status":"green","integrity_message":"Good - Values align with baseline"},{"date":"2025-11-18","weight":199.8,"bf_percent":17.8,"lean_lbs":153.4,"bf_lbs":35.56,"lean_percent":76.78,"residual":10.84,"calories":1718,"protein":163,"fat":103,"carbs":26,"steps":4852,"rhr":50,"sleep_score":71,"sleep_duration_hrs":7.05,"body_water_percent":59.1,"refeed":false,"notes":"","integrity_status":"green","integrity_message":"Good - Values align with baseline"},{"date":"2025-11-19","weight":199.8,"bf_percent":17.5,"lean_lbs":153.9,"bf_lbs":34.96,"lean_percent":77.03,"residual":10.94,"calories":1715,"protein":169,"fat":60,"carbs":61,"steps":10165,"rhr":57,"sleep_score":null,"sleep_duration_hrs":null,"body_water_percent":61.9,"refeed":false,"notes":"","integrity_status":"green","integrity_message":"Good - Values align with baseline"},{"date":"2025-11-20","weight":197.9,"bf_percent":17.2,"lean_lbs":154.4,"bf_lbs":34.04,"lean_percent":78.02,"residual":9.46,"calories":2008,"protein":195,"fat":105,"carbs":50,"steps":4982,"rhr":54,"sleep_score":63,"sleep_duration_hrs":8.33,"body_water_percent":62.8,"refeed":true,"notes":"","integrity_status":"green","integrity_message":"Good - Values align with baseline"},{"date":"2025-11-21","weight":197.2,"bf_percent":16.9,"lean_lbs":154.7,"bf_lbs":33.33,"lean_percent":78.45,"residual":9.17,"calories":1275,"protein":207,"fat":48,"carbs":17,"steps":6988,"rhr":54,"sleep_score":85,"sleep_duration_hrs":9.3,"body_water_percent":62.4,"refeed":false,"notes":"","integrity_status":"yellow","integrity_message":"Warning - Slight variance detected"},{"date":"2025-11-22","weight":198.4,"bf_percent":16.4,"lean_lbs":155.3,"bf_lbs":32.54,"lean_percent":78.28,"residual":10.56,"calories":1835,"protein":229,"fat":48,"carbs":114,"steps":4021,"rhr":48,"sleep_score":null,"sleep_duration_hrs":null,"body_water_percent":62.4,"refeed":false,"notes":"","integrity_status":"green","integrity_message":"Good - Values align with baseline"},{"date":"2025-11-23","weight":200.2,"bf_percent":16,"lean_lbs":155.9,"bf_lbs":32.03,"lean_percent":77.87,"residual":12.27,"calories":1501,"protein":132,"fat":37,"carbs":146,"steps":5803,"rhr":51,"sleep_score":72,"sleep_duration_hrs":7.35,"body_water_percent":62.8,"refeed":false,"notes":"","integrity_status":"red","integrity_message":"Check data - Residual shifted 2.1 lbs from baseline"},{"date":"2025-11-24","weight":196.7,"bf_percent":16.6,"lean_lbs":154.9,"bf_lbs":32.65,"lean_percent":78.75,"residual":9.15,"calories":1654,"protein":158,"fat":98,"carbs":21,"steps":7179,"rhr":49,"sleep_score":88,"sleep_duration_hrs":10.03,"body_water_percent":59.3,"refeed":false,"notes":"","integrity_status":"yellow","integrity_message":"Warning - Slight variance detected"},{"date":"2025-11-25","weight":199.7,"bf_percent":16.5,"lean_lbs":154.7,"bf_lbs":32.95,"lean_percent":77.47,"residual":12.05,"calories":1431,"protein":110,"fat":23,"carbs":188,"steps":9946,"rhr":50,"sleep_score":76,"sleep_duration_hrs":7.98,"body_water_percent":60.6,"refeed":false,"notes":"","integrity_status":"yellow","integrity_message":"Warning - Slight variance detected"},{"date":"2025-11-26","weight":200.2,"bf_percent":16.5,"lean_lbs":154.8,"bf_lbs":33.03,"lean_percent":77.32,"residual":12.37,"calories":1325,"protein":195,"fat":47,"carbs":25,"steps":10712,"rhr":48,"sleep_score":67,"sleep_duration_hrs":7.82,"body_water_percent":60.9,"refeed":false,"notes":"","integrity_status":"red","integrity_message":"Check data - Residual shifted 2.2 lbs from baseline"},{"date":"2025-11-27","weight":196,"bf_percent":16.9,"lean_lbs":154.3,"bf_lbs":33.12,"lean_percent":78.72,"residual":8.58,"calories":null,"protein":null,"fat":null,"carbs":null,"steps":7392,"rhr":49,"sleep_score":null,"sleep_duration_hrs":10.3,"body_water_percent":60.7,"refeed":true,"notes":"Thanksgiving","integrity_status":"yellow","integrity_message":"Warning - Slight variance detected"},{"date":"2025-11-28","weight":200.1,"bf_percent":16.4,"lean_lbs":154.7,"bf_lbs":32.82,"lean_percent":77.31,"residual":12.58,"calories":967,"protein":133,"fat":40,"carbs":13,"steps":7310,"rhr":53,"sleep_score":78,"sleep_duration_hrs":10.3,"body_water_percent":61.8,"refeed":false,"notes":"","integrity_status":"red","integrity_message":"Check data - Residual shifted 2.4 lbs from baseline"},{"date":"2025-11-29","weight":196.2,"bf_percent":16.7,"lean_lbs":154.6,"bf_lbs":32.77,"lean_percent":78.8,"residual":8.83,"calories":1907,"protein":247,"fat":75,"carbs":84,"steps":4914,"rhr":50,"sleep_score":85,"sleep_duration_hrs":7.55,"body_water_percent":61.6,"refeed":false,"notes":"","integrity_status":"yellow","integrity_message":"Warning - Slight variance detected"},{"date":"2025-11-30","weight":196.3,"bf_percent":16.7,"lean_lbs":154.2,"bf_lbs":32.78,"lean_percent":78.55,"residual":9.32,"calories":1410,"protein":206,"fat":46,"carbs":47,"steps":3947,"rhr":49,"sleep_score":89,"sleep_duration_hrs":7.63,"body_water_percent":60.8,"refeed":false,"notes":"","integrity_status":"green","integrity_message":"Good - Values align with baseline"},{"date":"2025-12-01","weight":192.6,"bf_percent":16.7,"lean_lbs":154,"bf_lbs":32.16,"lean_percent":79.96,"residual":6.44,"calories":1105,"protein":182,"fat":27,"carbs":46,"steps":5540,"rhr":49,"sleep_score":84,"sleep_duration_hrs":12.1,"body_water_percent":62.5,"refeed":false,"notes":"","integrity_status":"red","integrity_message":"Check data - Residual shifted 3.7 lbs from baseline"},{"date":"2025-12-02","weight":194.1,"bf_percent":16.4,"lean_lbs":153.9,"bf_lbs":31.83,"lean_percent":79.29,"residual":8.37,"calories":1442,"protein":201,"fat":36,"carbs":94,"steps":10665,"rhr":49,"sleep_score":73,"sleep_duration_hrs":7.2,"body_water_percent":62.1,"refeed":false,"notes":"Starting today (Dec 2), all carb entries are Total Carbs (not Net Carbs).","integrity_status":"yellow","integrity_message":"Warning - Slight variance detected"},{"date":"2025-12-03","weight":192.5,"bf_percent":16.1,"lean_lbs":154.1,"bf_lbs":30.99,"lean_percent":80.05,"residual":7.41,"calories":1522,"protein":195,"fat":66,"carbs":45,"steps":6742,"rhr":51,"sleep_score":81,"sleep_duration_hrs":8.72,"body_water_percent":63.5,"refeed":false,"notes":"","integrity_status":"red","integrity_message":"Check data - Residual shifted 2.8 lbs from baseline"},{"date":"2025-12-04","weight":192.9,"bf_percent":16.1,"lean_lbs":152.8,"bf_lbs":31.06,"lean_percent":79.21,"residual":9.04,"calories":1817,"protein":219,"fat":61,"carbs":118,"steps":3050,"rhr":49,"sleep_score":85,"sleep_duration_hrs":7.5,"body_water_percent":61,"refeed":false,"notes":"","integrity_status":"yellow","integrity_message":"Warning - Slight variance detected"},{"date":"2025-12-05","weight":195.2,"bf_percent":15.6,"lean_lbs":154.1,"bf_lbs":30.45,"lean_percent":78.94,"residual":10.65,"calories":1525,"protein":136,"fat":81,"carbs":159,"steps":8607,"rhr":48,"sleep_score":90,"sleep_duration_hrs":7.99,"body_water_percent":63.6,"refeed":false,"notes":"Traveled back from Tampa. Ate dinner at friend's house. Had sour dough bread and a cream of chicken dish. Difficult to accurately track nutrition.","integrity_status":"green","integrity_message":"Good - Values align with baseline"},{"date":"2025-12-06","weight":194.4,"bf_percent":15.7,"lean_lbs":153.7,"bf_lbs":30.52,"lean_percent":79.06,"residual":10.18,"calories":1837,"protein":168,"fat":81,"carbs":122,"steps":2662,"rhr":49,"sleep_score":85,"sleep_duration_hrs":8.27,"body_water_percent":61.2,"refeed":false,"notes":"Ate at a friends but had 2 helpings of instant mashed potatoes and had cheese when I came home. Picked a little and probably had a half of a potato skin w/cheese.","integrity_status":"green","integrity_message":"Good - Values align with baseline"},{"date":"2025-12-07","weight":195.3,"bf_percent":15.5,"lean_lbs":153.9,"bf_lbs":30.27,"lean_percent":78.8,"residual":11.13,"calories":1776,"protein":198,"fat":61,"carbs":118,"steps":5230,"rhr":53,"sleep_score":null,"sleep_duration_hrs":8.25,"body_water_percent":62.4,"refeed":false,"notes":"Diet was atrocious. Had crackers and dip around lunch time. Cleaned diet up in the afternoon and went to the gym and put in 1500 ropes to lessen the negative impact.","integrity_status":"green","integrity_message":"Good - Values align with baseline"},{"date":"2025-12-08","weight":193.2,"bf_percent":16.2,"lean_lbs":152.8,"bf_lbs":31.3,"lean_percent":79.09,"residual":9.1,"calories":1768,"protein":198,"fat":67,"carbs":114,"steps":7734,"rhr":47,"sleep_score":86,"sleep_duration_hrs":8.1,"body_water_percent":59.2,"refeed":false,"notes":"","integrity_status":"yellow","integrity_message":"Warning - Slight variance detected"},{"date":"2025-12-09","weight":193.2,"bf_percent":16.2,"lean_lbs":152.5,"bf_lbs":31.3,"lean_percent":78.93,"residual":9.4,"calories":1330,"protein":185,"fat":36,"carbs":47,"steps":6809,"rhr":47,"sleep_score":78,"sleep_duration_hrs":6.62,"body_water_percent":61.3,"refeed":false,"notes":"","integrity_status":"green","integrity_message":"Good - Values align with baseline"},{"date":"2025-12-10","weight":196.7,"bf_percent":16.1,"lean_lbs":152.3,"bf_lbs":31.67,"lean_percent":77.43,"residual":12.73,"calories":1465,"protein":213,"fat":47,"carbs":48,"steps":9408,"rhr":47,"sleep_score":72,"sleep_duration_hrs":7.37,"body_water_percent":60.5,"refeed":false,"notes":"","integrity_status":"red","integrity_message":"Check data - Residual shifted 2.5 lbs from baseline"},{"date":"2025-12-11","weight":192.5,"bf_percent":16.2,"lean_lbs":152.4,"bf_lbs":31.19,"lean_percent":79.17,"residual":8.91,"calories":1604,"protein":194,"fat":66,"carbs":55,"steps":2821,"rhr":47,"sleep_score":90,"sleep_duration_hrs":9.48,"body_water_percent":62.5,"refeed":false,"notes":"","integrity_status":"yellow","integrity_message":"Warning - Slight variance detected"},{"date":"2025-12-12","weight":193.2,"bf_percent":16.2,"lean_lbs":152.1,"bf_lbs":31.3,"lean_percent":78.73,"residual":9.8,"calories":1571,"protein":193,"fat":66,"carbs":59,"steps":4484,"rhr":52,"sleep_score":83,"sleep_duration_hrs":7.72,"body_water_percent":62.4,"refeed":false,"notes":"","integrity_status":"green","integrity_message":"Good - Values align with baseline"},{"date":"2025-12-13","weight":193.8,"bf_percent":16,"lean_lbs":152.2,"bf_lbs":31.01,"lean_percent":78.53,"residual":10.59,"calories":3097,"protein":224,"fat":138,"carbs":238,"steps":3626,"rhr":44,"sleep_score":82,"sleep_duration_hrs":6.43,"body_water_percent":61.9,"refeed":true,"notes":"","integrity_status":"green","integrity_message":"Good - Values align with baseline"},{"date":"2025-12-14","weight":197.3,"bf_percent":15.5,"lean_lbs":152.9,"bf_lbs":30.58,"lean_percent":77.5,"residual":13.82,"calories":1630,"protein":205,"fat":21,"carbs":178,"steps":5949,"rhr":47,"sleep_score":59,"sleep_duration_hrs":6.78,"body_water_percent":62.9,"refeed":false,"notes":"","integrity_status":"red","integrity_message":"Check data - Residual shifted 3.6 lbs from baseline"},{"date":"2025-12-15","weight":194.1,"bf_percent":15.6,"lean_lbs":153.1,"bf_lbs":30.28,"lean_percent":78.88,"residual":10.72,"calories":1533,"protein":211,"fat":56,"carbs":52,"steps":11492,"rhr":48,"sleep_score":84,"sleep_duration_hrs":7.92,"body_water_percent":62.4,"refeed":false,"notes":"","integrity_status":"green","integrity_message":"Good - Values align with baseline"},{"date":"2025-12-16","weight":191,"bf_percent":15.8,"lean_lbs":152.8,"bf_lbs":30.18,"lean_percent":80,"residual":8.02,"calories":1920,"protein":214,"fat":92,"carbs":60,"steps":6875,"rhr":49,"sleep_score":83,"sleep_duration_hrs":7.42,"body_water_percent":62.1,"refeed":false,"notes":"","integrity_status":"red","integrity_message":"Check data - Residual shifted 2.2 lbs from baseline"},{"date":"2025-12-17","weight":191.4,"bf_percent":15.7,"lean_lbs":152.6,"bf_lbs":30.05,"lean_percent":79.73,"residual":8.75,"calories":1650,"protein":247,"fat":40,"carbs":105,"steps":7391,"rhr":45,"sleep_score":87,"sleep_duration_hrs":9.95,"body_water_percent":62.2,"refeed":false,"notes":"","integrity_status":"yellow","integrity_message":"Warning - Slight variance detected"},{"date":"2025-12-18","weight":190.9,"bf_percent":15.6,"lean_lbs":152.4,"bf_lbs":29.78,"lean_percent":79.83,"residual":8.72,"calories":2344,"protein":308,"fat":98,"carbs":60,"steps":8276,"rhr":50,"sleep_score":75,"sleep_duration_hrs":6.7,"body_water_percent":62.4,"refeed":false,"notes":"","integrity_status":"yellow","integrity_message":"Warning - Slight variance detected"},{"date":"2025-12-19","weight":191.3,"bf_percent":15.3,"lean_lbs":152.6,"bf_lbs":29.27,"lean_percent":79.77,"residual":9.43,"calories":1628,"protein":208,"fat":70,"carbs":47,"steps":7716,"rhr":49,"sleep_score":94,"sleep_duration_hrs":8.3,"body_water_percent":63.3,"refeed":false,"notes":"","integrity_status":"green","integrity_message":"Good - Values align with baseline"},{"date":"2025-12-20","weight":194.2,"bf_percent":14.9,"lean_lbs":153,"bf_lbs":28.94,"lean_percent":78.78,"residual":12.26,"calories":1956,"protein":207,"fat":49,"carbs":178,"steps":4541,"rhr":46,"sleep_score":88,"sleep_duration_hrs":7.95,"body_water_percent":62.9,"refeed":false,"notes":"","integrity_status":"red","integrity_message":"Check data - Residual shifted 2.2 lbs from baseline"},{"date":"2025-12-21","weight":192.9,"bf_percent":14.8,"lean_lbs":153.4,"bf_lbs":28.55,"lean_percent":79.52,"residual":10.95,"calories":1557,"protein":241,"fat":52,"carbs":61,"steps":5602,"rhr":47,"sleep_score":68,"sleep_duration_hrs":8.92,"body_water_percent":63.7,"refeed":false,"notes":"","integrity_status":"green","integrity_message":"Good - Values align with baseline"},{"date":"2025-12-22","weight":191.6,"bf_percent":14.7,"lean_lbs":153.5,"bf_lbs":28.17,"lean_percent":80.11,"residual":9.93,"calories":null,"protein":null,"fat":null,"carbs":null,"steps":null,"rhr":47,"sleep_score":69,"sleep_duration_hrs":5.28,"body_water_percent":63.3,"refeed":false,"notes":"Sleep hours seem low because I fell asleep at 1 but the app says 3:04. Not sure why.","integrity_status":"green","integrity_message":"Good - Values align with baseline"}];

        // ===== INITIAL TRAINING DATA (3 workouts, 21 exercises, 97,230 lbs total) =====
        const INITIAL_TRAINING_WORKOUTS = [{"date":"2025-12-21","time":"16:38","name":"Lower Body","exercises":[{"name":"Front Squat","workingVolume":4100,"pr1rm":180,"category":"Lower Body","equipment":"Barbell","notes":""},{"name":"Back Squat","workingVolume":4050,"pr1rm":180,"category":"Lower Body","equipment":"Barbell","notes":""},{"name":"Leg Curls","workingVolume":5300,"pr1rm":187,"category":"Lower Body","equipment":"Machine","notes":""},{"name":"Leg Extensions","workingVolume":6180,"pr1rm":253,"category":"Lower Body","equipment":"Machine","notes":""},{"name":"Inner Thigh","workingVolume":4800,"pr1rm":160,"category":"Lower Body","equipment":"Machine","superset":"A","notes":""},{"name":"Outer Thigh","workingVolume":4800,"pr1rm":160,"category":"Lower Body","equipment":"Machine","superset":"A","notes":""}],"totalVolume":29230,"notes":""},{"date":"2025-12-18","time":"16:38","name":"Push","exercises":[{"name":"Smith Machine Incline Bench Press","workingVolume":7300,"pr1rm":207,"category":"Push","equipment":"Smith Machine","notes":""},{"name":"Smith Machine Incline Shoulder Press","workingVolume":5400,"pr1rm":180,"category":"Push","equipment":"Smith Machine","notes":""},{"name":"Supinated Smith Incline Shoulder Press","workingVolume":2850,"pr1rm":127,"category":"Push","equipment":"Smith Machine","notes":""},{"name":"Incline Dumbbell Flies","workingVolume":2400,"pr1rm":107,"category":"Push","equipment":"Dumbbell","superset":"A","notes":""},{"name":"Close Grip Incline Dumbbell Press","workingVolume":3120,"pr1rm":131,"category":"Push","equipment":"Dumbbell","superset":"A","notes":""},{"name":"Dips","workingVolume":7664,"pr1rm":255,"category":"Push","equipment":"Bodyweight","notes":""},{"name":"Hanging Knee Raises","workingVolume":8622,"pr1rm":287,"category":"Core","equipment":"Bodyweight","notes":""}],"totalVolume":37356,"notes":"Workout was awesome!"},{"date":"2025-12-18","time":"15:01","name":"2nd Pull","exercises":[{"name":"Seated Row","workingVolume":4860,"pr1rm":187,"category":"Pull","equipment":"Cable","notes":""},{"name":"Supinated Bent Over Barbell Row","workingVolume":5800,"pr1rm":207,"category":"Pull","equipment":"Barbell","notes":""},{"name":"Cable Rear Delt Flys","workingVolume":440,"pr1rm":15,"category":"Pull","equipment":"Cable","notes":""},{"name":"Rear Delt High Pull","workingVolume":1980,"pr1rm":103,"category":"Pull","equipment":"Cable","notes":""},{"name":"Close Grip Chin-Ups","workingVolume":7664,"pr1rm":255,"category":"Pull","equipment":"Bodyweight","notes":""},{"name":"Cross Body Hammer Curls","workingVolume":1800,"pr1rm":93,"category":"Arms","equipment":"Dumbbell","superset":"A","notes":""},{"name":"Leg Raises","workingVolume":0,"pr1rm":null,"category":"Core","equipment":"Bodyweight","superset":"A","notes":""},{"name":"Dumbbell Shrugs","workingVolume":7600,"pr1rm":293,"category":"Pull","equipment":"Dumbbell","superset":"B","notes":""},{"name":"Roman Chair Back Extensions","workingVolume":500,"pr1rm":33,"category":"Lower Body","equipment":"Bodyweight","superset":"B","notes":""}],"totalVolume":30644,"notes":"Great workout. Started with 500 ropes and finished with 500 ropes. Thank you Lord for the health and ability to do this! Glory to God!"}];
        
        // ===== INITIAL PERSONAL RECORDS (21 exercises) =====
        const INITIAL_PERSONAL_RECORDS = {"Front Squat":{"1rm":180,"date":"2025-12-21"},"Back Squat":{"1rm":180,"date":"2025-12-21"},"Leg Curls":{"1rm":187,"date":"2025-12-21"},"Leg Extensions":{"1rm":253,"date":"2025-12-21"},"Inner Thigh":{"1rm":160,"date":"2025-12-21"},"Outer Thigh":{"1rm":160,"date":"2025-12-21"},"Smith Machine Incline Bench Press":{"1rm":207,"date":"2025-12-18"},"Smith Machine Incline Shoulder Press":{"1rm":180,"date":"2025-12-18"},"Supinated Smith Incline Shoulder Press":{"1rm":127,"date":"2025-12-18"},"Incline Dumbbell Flies":{"1rm":107,"date":"2025-12-18"},"Close Grip Incline Dumbbell Press":{"1rm":131,"date":"2025-12-18"},"Dips":{"1rm":255,"date":"2025-12-18"},"Hanging Knee Raises":{"1rm":287,"date":"2025-12-18"},"Seated Row":{"1rm":187,"date":"2025-12-18"},"Supinated Bent Over Barbell Row":{"1rm":207,"date":"2025-12-18"},"Cable Rear Delt Flys":{"1rm":15,"date":"2025-12-18"},"Rear Delt High Pull":{"1rm":103,"date":"2025-12-18"},"Close Grip Chin-Ups":{"1rm":255,"date":"2025-12-18"},"Cross Body Hammer Curls":{"1rm":93,"date":"2025-12-18"},"Dumbbell Shrugs":{"1rm":293,"date":"2025-12-18"},"Roman Chair Back Extensions":{"1rm":33,"date":"2025-12-18"}};
        
        // Training data state
        let trainingLog = [];
        let personalRecords = { version: 1, prs: {} };

        // ===== INTEGRITY VALIDATION FUNCTIONS =====
        
        function computeDerivedFields(weight, bfPercent, leanMass) {
            if (!isFinite(weight) || !isFinite(bfPercent) || !isFinite(leanMass)) {
                return null;
            }
            
            const bfLbs = weight * (bfPercent / 100);
            const leanPercent = (leanMass / weight) * 100;
            const residual = weight - bfLbs - leanMass;
            
            return {
                bf_lbs: parseFloat(bfLbs.toFixed(2)),
                lean_percent: parseFloat(leanPercent.toFixed(2)),
                residual: parseFloat(residual.toFixed(2))
            };
        }
        
        function validateEntry(weight, bfPercent, leanMass) {
            // Sanity checks
            const errors = [];
            
            if (!isFinite(weight) || !isFinite(bfPercent) || !isFinite(leanMass)) {
                return { status: 'gray', message: 'Missing required fields', errors: ['Enter weight, body fat %, and lean mass'] };
            }
            
            if (weight <= 50 || weight >= 500) errors.push('Weight looks out of range (50-500 lbs)');
            if (bfPercent <= 2 || bfPercent >= 70) errors.push('Body fat % looks out of range (2-70%)');
            if (leanMass <= 50 || leanMass >= weight) errors.push('Lean mass must be less than weight and plausible');
            
            const derived = computeDerivedFields(weight, bfPercent, leanMass);
            if (!derived) {
                errors.push('Unable to compute derived fields');
                return { status: 'red', message: 'Validation failed', errors, derived: null };
            }
            
            if (derived.bf_lbs < 0 || derived.bf_lbs > weight) errors.push('Computed body fat lbs out of range');
            if (derived.lean_percent < 30 || derived.lean_percent > 95) errors.push('Computed lean % out of range (30-95%)');
            if (derived.residual < -5 || derived.residual > 80) errors.push('Residual out of plausible range');
            
            if (errors.length > 0) {
                return { status: 'red', message: errors[0], errors, derived };
            }
            
            return { status: 'valid', message: 'Entry passes sanity checks', errors: [], derived };
        }
        
        function computeIntegrityStatus(weight, bfPercent, leanMass) {
            const validation = validateEntry(weight, bfPercent, leanMass);
            
            if (validation.status === 'red' || validation.status === 'gray') {
                return validation;
            }
            
            // Get historical residuals for baseline
            const validEntries = bodyData.filter(e => 
                isFinite(e.weight) && isFinite(e.bf_percent) && isFinite(e.lean_lbs) && e.residual !== undefined
            ).sort((a, b) => a.date.localeCompare(b.date));
            
            const recent = validEntries.slice(-INTEGRITY_CONFIG.baselineWindow);
            
            if (recent.length < 7) {
                return {
                    status: 'blue',
                    message: 'Building baseline (need 7+ entries)',
                    errors: [],
                    derived: validation.derived,
                    baselineCount: recent.length
                };
            }
            
            const residuals = recent.map(e => e.residual);
            const baselineMean = residuals.reduce((sum, r) => sum + r, 0) / residuals.length;
            const residualDelta = Math.abs(validation.derived.residual - baselineMean);
            
            if (residualDelta <= INTEGRITY_CONFIG.greenThreshold) {
                return {
                    status: 'green',
                    message: 'Good - Values align with baseline',
                    errors: [],
                    derived: validation.derived,
                    baselineMean,
                    residualDelta
                };
            } else if (residualDelta <= INTEGRITY_CONFIG.yellowThreshold) {
                return {
                    status: 'yellow',
                    message: 'Warning - Slight variance detected',
                    errors: [],
                    derived: validation.derived,
                    baselineMean,
                    residualDelta
                };
            } else {
                return {
                    status: 'red',
                    message: `Check data - Residual shifted ${residualDelta.toFixed(1)} lbs from baseline`,
                    errors: ['Possible entry error - verify values from Hume app'],
                    derived: validation.derived,
                    baselineMean,
                    residualDelta
                };
            }
        }
        
        function createIntegrityBadge(status, message) {
            const badges = {
                green: { class: 'integrity-green', dot: 'dot-green', text: '‚úì Good' },
                yellow: { class: 'integrity-yellow', dot: 'dot-yellow', text: '‚ö† Warn' },
                red: { class: 'integrity-red', dot: 'dot-red', text: '‚úó Check' },
                blue: { class: 'integrity-blue', dot: 'dot-blue', text: '‚óã Build' },
                gray: { class: 'integrity-gray', dot: 'dot-gray', text: '‚Äî N/A' }
            };
            
            const badge = badges[status] || badges.gray;
            return `<span class="integrity-badge ${badge.class}" title="${message}">
                        <span class="integrity-dot ${badge.dot}"></span>
                        <span>${badge.text}</span>
                    </span>`;
        }

        // ===== DATA MANAGEMENT =====
        
        function loadData() {
            const stored = localStorage.getItem(STORAGE_KEY);
            if (stored) {
                bodyData = JSON.parse(stored);
                console.log(`‚úÖ Loaded ${bodyData.length} entries from localStorage`);
            } else {
                // First time - load initial data
                bodyData = INITIAL_DATA.map(entry => {
                    const derived = computeDerivedFields(entry.weight, entry.bf_percent, entry.lean_lbs);
                    return {
                        ...entry,
                        bf_lbs: derived?.bf_lbs || (entry.weight * entry.bf_percent / 100),
                        lean_percent: derived?.lean_percent || ((entry.lean_lbs / entry.weight) * 100),
                        residual: derived?.residual || (entry.weight - (entry.weight * entry.bf_percent / 100) - entry.lean_lbs)
                    };
                });
                saveData();
                console.log(`‚úÖ Loaded ${bodyData.length} entries from INITIAL_DATA`);
            }
            
            // Recompute integrity for all entries
            bodyData = bodyData.map(entry => {
                const integrity = computeIntegrityStatus(entry.weight, entry.bf_percent, entry.lean_lbs);
                return {
                    ...entry,
                    integrity_status: integrity.status,
                    integrity_message: integrity.message
                };
            });
        }
        
        function saveData() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(bodyData));
        }
        
        function reloadData() {
            if (confirm('Reload original 48-day dataset? This will replace any new entries you added.')) {
                localStorage.removeItem(STORAGE_KEY);
                location.reload();
            }
        }
        
        // ===== UI UPDATE FUNCTIONS =====
        
        function updateStats() {
            if (bodyData.length === 0) {
                document.getElementById('headerStatus').textContent = 'No data yet - add your first entry!';
                return;
            }
            
            const sorted = bodyData.slice().sort((a, b) => a.date.localeCompare(b.date));
            const first = sorted[0];
            const latest = sorted[sorted.length - 1];
            
            const weightChange = latest.weight - first.weight;
            const bfChange = latest.bf_percent - first.bf_percent;
            const leanChange = latest.lean_lbs - first.lean_lbs;
            
            const fatLost = (first.weight * first.bf_percent / 100) - (latest.weight * latest.bf_percent / 100);
            
            document.getElementById('headerStatus').textContent = 
                `${bodyData.length} entries ‚Ä¢ ${first.date} to ${latest.date} ‚Ä¢ ` +
                `Weight: ${weightChange >= 0 ? '+' : ''}${weightChange.toFixed(1)} lbs ‚Ä¢ ` +
                `Fat Lost: ${fatLost.toFixed(1)} lbs`;
            
            document.getElementById('entryCount').textContent = bodyData.length;
            
            // Stats cards
            const statsHtml = `
                <div class="stat-card">
                    <div class="stat-label">Current Weight</div>
                    <div class="stat-value">${latest.weight.toFixed(1)}</div>
                    <div class="stat-change ${weightChange <= 0 ? 'positive' : 'negative'}">
                        ${weightChange >= 0 ? '+' : ''}${weightChange.toFixed(1)} lbs from start
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Body Fat %</div>
                    <div class="stat-value">${latest.bf_percent.toFixed(1)}%</div>
                    <div class="stat-change ${bfChange <= 0 ? 'positive' : 'negative'}">
                        ${bfChange >= 0 ? '+' : ''}${bfChange.toFixed(1)}% from start
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Fat Lost</div>
                    <div class="stat-value">${fatLost.toFixed(1)}</div>
                    <div class="stat-change positive">
                        lbs of pure fat
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Lean Mass</div>
                    <div class="stat-value">${latest.lean_lbs.toFixed(1)}</div>
                    <div class="stat-change ${leanChange >= 0 ? 'positive' : 'negative'}">
                        ${leanChange >= 0 ? '+' : ''}${leanChange.toFixed(1)} lbs from start
                    </div>
                </div>
            `;
            
            document.getElementById('statsGrid').innerHTML = statsHtml;
            
            // Goal projection
            updateGoalProjection(sorted, latest, fatLost);
            updateHealthStatsCard();
        }
        
        function updateGoalProjection(sorted, latest, fatLost) {
            const currentFatLbs = latest.weight * latest.bf_percent / 100;
            const targetFatLbs = GOALS.target_bf_lbs;
            const fatToLose = currentFatLbs - targetFatLbs;
            
            const days = sorted.length;
            const avgFatLossPerDay = days > 1 ? fatLost / days : 0;
            const daysToGoal = avgFatLossPerDay > 0 ? fatToLose / avgFatLossPerDay : 0;
            
            const goalDate = new Date(latest.date);
            goalDate.setDate(goalDate.getDate() + daysToGoal);
            
            const progress = Math.max(0, Math.min(100, (fatLost / (fatLost + fatToLose)) * 100));
            
            const goalHtml = `
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span style="font-family: 'Space Mono', monospace;">Current: ${currentFatLbs.toFixed(1)} lbs fat</span>
                        <span style="font-family: 'Space Mono', monospace;">Target: ${targetFatLbs.toFixed(1)} lbs fat</span>
                    </div>
                    <div style="background: var(--bg-tertiary); height: 30px; border-radius: 8px; overflow: hidden;">
                        <div style="background: linear-gradient(90deg, var(--accent-success), var(--accent-cyan)); height: 100%; width: ${progress}%; transition: width 0.5s ease;"></div>
                    </div>
                    <div style="text-align: center; margin-top: 10px; color: var(--text-secondary);">
                        ${progress.toFixed(1)}% to goal
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div>
                        <div style="color: var(--text-secondary); font-size: 0.85em;">Fat to Lose</div>
                        <div style="font-size: 1.5em; font-weight: 700; font-family: 'Space Mono', monospace;">${fatToLose.toFixed(1)} lbs</div>
                    </div>
                    <div>
                        <div style="color: var(--text-secondary); font-size: 0.85em;">Avg Loss Rate</div>
                        <div style="font-size: 1.5em; font-weight: 700; font-family: 'Space Mono', monospace;">${(avgFatLossPerDay * 7).toFixed(2)} lbs/week</div>
                    </div>
                    <div>
                        <div style="color: var(--text-secondary); font-size: 0.85em;">Estimated Goal Date</div>
                        <div style="font-size: 1.5em; font-weight: 700; font-family: 'Space Mono', monospace;">
                            ${daysToGoal > 0 ? goalDate.toLocaleDateString() : 'N/A'}
                        </div>
                    </div>
                    <div>
                        <div style="color: var(--text-secondary); font-size: 0.85em;">Days Remaining</div>
                        <div style="font-size: 1.5em; font-weight: 700; font-family: 'Space Mono', monospace;">
                            ${daysToGoal > 0 ? Math.ceil(daysToGoal) : 'N/A'}
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('goalContent').innerHTML = goalHtml;
        }
        
        function updateTable() {
            const tbody = document.getElementById('dataTable');
            tbody.innerHTML = '';
            
            const sorted = bodyData.slice().sort((a, b) => b.date.localeCompare(a.date));
            
            sorted.forEach((entry, idx) => {
                const row = document.createElement('tr');
                if (entry.refeed) row.classList.add('refeed-row');
                
                const integrityBadge = createIntegrityBadge(
                    entry.integrity_status || 'gray',
                    entry.integrity_message || 'No validation'
                );
                
                row.innerHTML = `
                    <td>${entry.date}</td>
                    <td>${integrityBadge}</td>
                    <td>${entry.weight?.toFixed(1) || ''}</td>
                    <td>${entry.bf_percent?.toFixed(1) || ''}%</td>
                    <td>${entry.bf_lbs?.toFixed(1) || ''}</td>
                    <td>${entry.lean_lbs?.toFixed(1) || ''}</td>
                    <td>${entry.lean_percent?.toFixed(1) || ''}%</td>
                    <td>${entry.body_water_percent?.toFixed(1) || ''}%</td>
                    <td>${entry.calories || ''}</td>
                    <td>${entry.protein || ''}</td>
                    <td>${entry.fat || ''}</td>
                    <td>${entry.carbs || ''}</td>
                    <td>${entry.steps || ''}</td>
                    <td>${entry.rhr || ''}</td>
                    <td>${entry.sleep_score || ''}</td>
                    <td>${entry.sleep_duration_hrs?.toFixed(1) || ''}</td>
                    <td>${computeQualityScore(entry)}%</td>
                    <td>${entry.refeed ? 'üî•' : ''}</td>
                    <td>
                        <div class="edit-actions">
                            <button class="danger" onclick="deleteEntry('${entry.date}')">√ó</button>
                        </div>
                    </td>
                `;
                
                row.onclick = (e) => {
                    if (!e.target.classList.contains('danger')) {
                        editEntry(entry.date);
                    }
                };
                
                tbody.appendChild(row);
            });
        }

        // ===== MODAL FUNCTIONS =====
        
        function showAddEntry() {
            document.getElementById('modalTitle').textContent = 'Add New Entry';
            document.getElementById('entryDate').value = new Date().toISOString().split('T')[0];
            clearForm();
            document.getElementById('addEntryModal').classList.add('show');
            updateModalDerivedFields();
        }
        
        function editEntry(date) {
            const entry = bodyData.find(e => e.date === date);
            if (!entry) return;
            
            document.getElementById('modalTitle').textContent = 'Edit Entry';
            document.getElementById('entryDate').value = entry.date;
            document.getElementById('entryWeight').value = entry.weight || '';
            document.getElementById('entryBfPercent').value = entry.bf_percent || '';
            document.getElementById('entryLeanLbs').value = entry.lean_lbs || '';
            document.getElementById('entryCalories').value = entry.calories || '';
            document.getElementById('entryProtein').value = entry.protein || '';
            document.getElementById('entryFat').value = entry.fat || '';
            document.getElementById('entryCarbs').value = entry.carbs || '';
            document.getElementById('entrySteps').value = entry.steps || '';
            document.getElementById('entryRhr').value = entry.rhr || '';
            document.getElementById('entrySleepScore').value = entry.sleep_score || '';
            document.getElementById('entrySleepHours').value = entry.sleep_duration_hrs || '';
            document.getElementById('entryBodyWater').value = entry.body_water_percent || '';
            document.getElementById('entryRefeed').checked = entry.refeed || false;
            document.getElementById('entryNotes').value = entry.notes || '';
            
            updateModalDerivedFields();
            document.getElementById('addEntryModal').classList.add('show');
        }
        
        function hideModal() {
            document.getElementById('addEntryModal').classList.remove('show');
            clearForm();
        }
        
        function clearForm() {
            document.getElementById('entryWeight').value = '';
            document.getElementById('entryBfPercent').value = '';
            document.getElementById('entryLeanLbs').value = '';
            document.getElementById('entryCalories').value = '';
            document.getElementById('entryProtein').value = '';
            document.getElementById('entryFat').value = '';
            document.getElementById('entryCarbs').value = '';
            document.getElementById('entrySteps').value = '';
            document.getElementById('entryRhr').value = '';
            document.getElementById('entrySleepScore').value = '';
            document.getElementById('entrySleepHours').value = '';
            document.getElementById('entryBodyWater').value = '';
            document.getElementById('entryRefeed').checked = false;
            document.getElementById('entryNotes').value = '';
            updateModalDerivedFields();
        }
        
        function updateModalDerivedFields() {
            const weight = parseFloat(document.getElementById('entryWeight').value);
            const bfPercent = parseFloat(document.getElementById('entryBfPercent').value);
            const leanLbs = parseFloat(document.getElementById('entryLeanLbs').value);
            
            const derived = computeDerivedFields(weight, bfPercent, leanLbs);
            
            if (derived) {
                document.getElementById('entryBfLbsAuto').value = derived.bf_lbs.toFixed(1);
                document.getElementById('entryLeanPercentAuto').value = derived.lean_percent.toFixed(1) + '%';
                document.getElementById('entryResidualAuto').value = derived.residual.toFixed(2);
            } else {
                document.getElementById('entryBfLbsAuto').value = '';
                document.getElementById('entryLeanPercentAuto').value = '';
                document.getElementById('entryResidualAuto').value = '';
            }
            
            // Update integrity status in modal
            const integrity = computeIntegrityStatus(weight, bfPercent, leanLbs);
            const statusDiv = document.getElementById('modalIntegrityStatus');
            
            if (integrity.status === 'gray') {
                statusDiv.innerHTML = '';
            } else {
                const badge = createIntegrityBadge(integrity.status, integrity.message);
                let details = `<p style="margin: 5px 0; font-size: 0.9em; color: var(--text-secondary);">${integrity.message}</p>`;
                
                if (integrity.residualDelta !== undefined) {
                    details += `<p style="margin: 5px 0; font-size: 0.85em; font-family: 'Space Mono', monospace; color: var(--text-secondary);">
                        Residual: ${integrity.derived.residual.toFixed(2)} lbs | 
                        Baseline: ${integrity.baselineMean?.toFixed(2) || 'N/A'} lbs | 
                        Delta: ${integrity.residualDelta.toFixed(2)} lbs
                    </p>`;
                }
                
                statusDiv.innerHTML = `
                    <div style="background: rgba(6, 182, 212, 0.05); border: 1px solid var(--border); padding: 15px; border-radius: 8px;">
                        <div style="margin-bottom: 8px;">${badge}</div>
                        ${details}
                    </div>
                `;
            }
        }
        
        // Auto-update when user types
        ['entryWeight', 'entryBfPercent', 'entryLeanLbs'].forEach(id => {
            document.addEventListener('DOMContentLoaded', () => {
                document.getElementById(id)?.addEventListener('input', updateModalDerivedFields);
            });
        });
        
        function saveEntry() {
            const date = document.getElementById('entryDate').value;
            const weight = parseFloat(document.getElementById('entryWeight').value);
            const bf_percent = parseFloat(document.getElementById('entryBfPercent').value);
            const lean_lbs = parseFloat(document.getElementById('entryLeanLbs').value);
            
            if (!date || !isFinite(weight) || !isFinite(bf_percent) || !isFinite(lean_lbs)) {
                showToast('Please fill in required fields: Date, Weight, BF%, Lean Mass', true);
                return;
            }
            
            // Validate integrity
            const integrity = computeIntegrityStatus(weight, bf_percent, lean_lbs);
            
            // Show warning for yellow or red status
            if (integrity.status === 'red') {
                const confirm = window.confirm(
                    `‚ö†Ô∏è DATA INTEGRITY WARNING\n\n` +
                    `${integrity.message}\n\n` +
                    `${integrity.errors.join('\n')}\n\n` +
                    `This may indicate a data entry error.\n` +
                    `Please double-check your values from the Hume app.\n\n` +
                    `Save anyway?`
                );
                if (!confirm) return;
            } else if (integrity.status === 'yellow') {
                const confirm = window.confirm(
                    `‚ö†Ô∏è Slight Variance Detected\n\n` +
                    `${integrity.message}\n\n` +
                    `Residual: ${integrity.derived.residual.toFixed(2)} lbs\n` +
                    `Baseline: ${integrity.baselineMean.toFixed(2)} lbs\n` +
                    `Delta: ${integrity.residualDelta.toFixed(2)} lbs\n\n` +
                    `This is usually normal day-to-day variance.\n` +
                    `Continue saving?`
                );
                if (!confirm) return;
            }
            
            const entry = {
                date,
                weight,
                bf_percent,
                lean_lbs,
                bf_lbs: integrity.derived.bf_lbs,
                lean_percent: integrity.derived.lean_percent,
                residual: integrity.derived.residual,
                calories: parseFloat(document.getElementById('entryCalories').value) || null,
                protein: parseFloat(document.getElementById('entryProtein').value) || null,
                fat: parseFloat(document.getElementById('entryFat').value) || null,
                carbs: parseFloat(document.getElementById('entryCarbs').value) || null,
                steps: parseFloat(document.getElementById('entrySteps').value) || null,
                rhr: parseFloat(document.getElementById('entryRhr').value) || null,
                sleep_score: parseFloat(document.getElementById('entrySleepScore').value) || null,
                sleep_duration_hrs: parseFloat(document.getElementById('entrySleepHours').value) || null,
                body_water_percent: parseFloat(document.getElementById('entryBodyWater').value) || null,
                refeed: document.getElementById('entryRefeed').checked,
                notes: document.getElementById('entryNotes').value,
                integrity_status: integrity.status,
                integrity_message: integrity.message
            };
            
            // Remove existing entry with same date
            bodyData = bodyData.filter(e => e.date !== date);
            bodyData.push(entry);
            bodyData.sort((a, b) => a.date.localeCompare(b.date));
            
            saveData();
            updateStats();
            updateTable();
            updateChart();
            // Mobile helpers
            if (window.innerWidth <= 768) { const qb=document.getElementById('quickAddBar'); if(qb) qb.style.display='block'; }
            if (typeof enableSwipeNav==='function') enableSwipeNav();
            if (typeof updateProgressiveTabV13==='function') updateProgressiveTabV13();
            hideModal();
            
            showToast(`Entry saved for ${date}\nIntegrity: ${integrity.message}`);
        }
        
        function deleteEntry(date) {
            if (!confirm(`Delete entry for ${date}?`)) return;
            
            bodyData = bodyData.filter(e => e.date !== date);
            saveData();
            updateStats();
            updateTable();
            updateChart();
            showToast(`Deleted entry for ${date}`);
        }

        // ===== CHART FUNCTIONS =====
        
        function switchChart(chartType, el) {
            currentChartType = chartType;

            // Update active tab
            document.querySelectorAll('.chart-tab').forEach(tab => tab.classList.remove('active'));
            if (el && el.classList) {
                el.classList.add('active');
            } else {
                const map = {
                    fatVsLean: 'Fat vs Lean Breakdown',
                    weightTrend: 'Weight & BF% Trend',
                    rateOfChange: 'Daily Rate of Change',
                    nutrition: 'Nutrition Tracking',
                    waterOverlay: 'Body Water % Overlay'
                };
                const label = map[chartType];
                if (label) {
                    document.querySelectorAll('.chart-tab').forEach(tab => {
                        if ((tab.textContent || '').trim() === label) tab.classList.add('active');
                    });
                }
            }

            updateChart();
        }
        
        function updateChart() {
            if (currentChart) {
                currentChart.destroy();
            }
            
            const sorted = bodyData.slice().sort((a, b) => a.date.localeCompare(b.date));
            
            if (sorted.length === 0) return;
            
            const ctx = document.getElementById('mainChart').getContext('2d');
            
            switch (currentChartType) {
                case 'fatVsLean':
                    currentChart = createFatVsLeanChart(ctx, sorted);
                    break;
                case 'weightTrend':
                    currentChart = createWeightTrendChart(ctx, sorted);
                    break;
                case 'rateOfChange':
                    currentChart = createRateOfChangeChart(ctx, sorted);
                    break;
                case 'nutrition':
                    currentChart = createNutritionChart(ctx, sorted);
                    break;
            
                case 'waterOverlay':
                    currentChart = createWaterOverlayChart(ctx, sorted);
                    break;
}
        }
        
        function createFatVsLeanChart(ctx, data) {
            return new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [
                        {
                            label: 'Fat Mass',
                            data: data.map(d => d.bf_lbs),
                            backgroundColor: 'rgba(239, 68, 68, 0.3)',
                            borderColor: 'rgba(239, 68, 68, 1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.3
                        },
                        {
                            label: 'Lean Mass',
                            data: data.map(d => d.lean_lbs),
                            backgroundColor: 'rgba(16, 185, 129, 0.3)',
                            borderColor: 'rgba(16, 185, 129, 1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Body Composition: Fat vs Lean Mass',
                            color: '#f1f5f9',
                            font: { size: 16 }
                        },
                        legend: {
                            labels: { color: '#f1f5f9' }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(51, 65, 85, 0.3)' }
                        },
                        y: {
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(51, 65, 85, 0.3)' },
                            title: {
                                display: true,
                                text: 'Mass (lbs)',
                                color: '#f1f5f9'
                            }
                        }
                    }
                }
            });
        }
        
        function createWeightTrendChart(ctx, data) {
            return new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [
                        {
                            label: 'Weight (lbs)',
                            data: data.map(d => d.weight),
                            backgroundColor: 'rgba(6, 182, 212, 0.1)',
                            borderColor: 'rgba(6, 182, 212, 1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.3,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Body Fat %',
                            data: data.map(d => d.bf_percent),
                            backgroundColor: 'rgba(139, 92, 246, 0.1)',
                            borderColor: 'rgba(139, 92, 246, 1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.3,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Weight & Body Fat % Trend',
                            color: '#f1f5f9',
                            font: { size: 16 }
                        },
                        legend: {
                            labels: { color: '#f1f5f9' }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(51, 65, 85, 0.3)' }
                        },
                        y: {
                            type: 'linear',
                            position: 'left',
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(51, 65, 85, 0.3)' },
                            title: {
                                display: true,
                                text: 'Weight (lbs)',
                                color: '#06b6d4'
                            }
                        },
                        y1: {
                            type: 'linear',
                            position: 'right',
                            ticks: { color: '#94a3b8' },
                            grid: { display: false },
                            title: {
                                display: true,
                                text: 'Body Fat %',
                                color: '#8b5cf6'
                            }
                        }
                    }
                }
            });
        }
        
        function createRateOfChangeChart(ctx, data) {
            const changes = data.slice(1).map((d, i) => ({
                date: d.date,
                weightChange: d.weight - data[i].weight,
                fatChange: d.bf_lbs - data[i].bf_lbs,
                leanChange: d.lean_lbs - data[i].lean_lbs
            }));
            
            return new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: changes.map(d => d.date),
                    datasets: [
                        {
                            label: 'Weight Œî',
                            data: changes.map(d => d.weightChange),
                            backgroundColor: 'rgba(6, 182, 212, 0.7)',
                            borderColor: 'rgba(6, 182, 212, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Fat Œî',
                            data: changes.map(d => d.fatChange),
                            backgroundColor: 'rgba(239, 68, 68, 0.7)',
                            borderColor: 'rgba(239, 68, 68, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Lean Œî',
                            data: changes.map(d => d.leanChange),
                            backgroundColor: 'rgba(16, 185, 129, 0.7)',
                            borderColor: 'rgba(16, 185, 129, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Daily Rate of Change',
                            color: '#f1f5f9',
                            font: { size: 16 }
                        },
                        legend: {
                            labels: { color: '#f1f5f9' }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(51, 65, 85, 0.3)' }
                        },
                        y: {
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(51, 65, 85, 0.3)' },
                            title: {
                                display: true,
                                text: 'Change (lbs)',
                                color: '#f1f5f9'
                            }
                        }
                    }
                }
            });
        }
        
        function createNutritionChart(ctx, data) {
            const withNutrition = data.filter(d => d.calories);
            
            return new Chart(ctx, {
                type: 'line',
                data: {
                    labels: withNutrition.map(d => d.date),
                    datasets: [
                        {
                            label: 'Calories',
                            data: withNutrition.map(d => d.calories),
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            borderColor: 'rgba(245, 158, 11, 1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.3,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Protein (g)',
                            data: withNutrition.map(d => d.protein),
                            backgroundColor: 'rgba(6, 182, 212, 0.1)',
                            borderColor: 'rgba(6, 182, 212, 1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.3,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Nutrition Tracking',
                            color: '#f1f5f9',
                            font: { size: 16 }
                        },
                        legend: {
                            labels: { color: '#f1f5f9' }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(51, 65, 85, 0.3)' }
                        },
                        y: {
                            type: 'linear',
                            position: 'left',
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(51, 65, 85, 0.3)' },
                            title: {
                                display: true,
                                text: 'Calories',
                                color: '#f59e0b'
                            }
                        },
                        y1: {
                            type: 'linear',
                            position: 'right',
                            ticks: { color: '#94a3b8' },
                            grid: { display: false },
                            title: {
                                display: true,
                                text: 'Protein (g)',
                                color: '#06b6d4'
                            }
                        }
                    }
                }
            });
        }

        
        
        function createWaterOverlayChart(ctx, data) {
            const withWater = data.filter(d => d.body_water_percent != null && isFinite(d.body_water_percent));
            if (withWater.length < 2) {
                return createWeightTrendChart(ctx, data);
            }
            return new Chart(ctx, {
                type: 'line',
                data: {
                    labels: withWater.map(d => d.date),
                    datasets: [
                        {
                            label: 'Weight (lbs)',
                            data: withWater.map(d => d.weight),
                            backgroundColor: 'rgba(6, 182, 212, 0.1)',
                            borderColor: 'rgba(6, 182, 212, 1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.3,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Body Water %',
                            data: withWater.map(d => d.body_water_percent),
                            backgroundColor: 'rgba(16, 185, 129, 0.08)',
                            borderColor: 'rgba(16, 185, 129, 1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.3,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Weight with Body Water % Overlay',
                            color: '#f1f5f9',
                            font: { size: 16 }
                        },
                        legend: {
                            labels: { color: '#f1f5f9' }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.dataset.label || '';
                                    const v = context.parsed.y;
                                    if (label.includes('%')) return `${label}: ${v.toFixed(1)}%`;
                                    return `${label}: ${v.toFixed(1)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(51, 65, 85, 0.3)' }
                        },
                        y: {
                            type: 'linear',
                            position: 'left',
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(51, 65, 85, 0.3)' },
                            title: {
                                display: true,
                                text: 'Weight (lbs)',
                                color: '#06b6d4'
                            }
                        },
                        y1: {
                            type: 'linear',
                            position: 'right',
                            ticks: { color: '#94a3b8' },
                            grid: { display: false },
                            title: {
                                display: true,
                                text: 'Body Water %',
                                color: '#10b981'
                            }
                        }
                    }
                }
            });
        }


        
        function computeQualityScore(entry) {
            // 100% = all optional fields present; penalize missing nutrition/activity/recovery metrics
            if (!entry) return 0;
            const fields = ['calories','protein','fat','carbs','steps','rhr','sleep_score','sleep_duration_hrs','water_percent'];
            let present = 0;
            fields.forEach(f=>{ if (isFinite(entry[f])) present++; });
            return Math.round((present / fields.length) * 100);
        }

// ===== EXPORT FUNCTIONS =====
        
        function exportCSV() {
            if (bodyData.length === 0) {
                showToast('No data to export', true);
                return;
            }
            
            const headers = [
                'Date', 'Weight', 'BF%', 'BF lbs', 'Lean lbs', 'Lean%', 'Residual',
                'Calories', 'Protein', 'Fat', 'Carbs', 'Steps', 'RHR', 
                'Sleep Score', 'Sleep Hrs', 'Water %', 'Refeed', 'Integrity', 'Notes'
            ];
            
            const rows = bodyData
                .slice()
                .sort((a, b) => a.date.localeCompare(b.date))
                .map(d => [
                    d.date,
                    d.weight?.toFixed(1) || '',
                    d.bf_percent?.toFixed(1) || '',
                    d.bf_lbs?.toFixed(1) || '',
                    d.lean_lbs?.toFixed(1) || '',
                    d.lean_percent?.toFixed(1) || '',
                    d.residual?.toFixed(2) || '',
                    d.calories || '',
                    d.protein || '',
                    d.fat || '',
                    d.carbs || '',
                    d.steps || '',
                    d.rhr || '',
                    d.sleep_score || '',
                    d.sleep_duration_hrs?.toFixed(2) || '',
                    d.body_water_percent?.toFixed(1) || '',
                    d.refeed ? 'Yes' : 'No',
                    d.integrity_status || '',
                    `"${(d.notes || '').replace(/"/g, '""')}"`
                ]);
            
            const csv = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `body-tracker-export-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            
            showToast('CSV exported successfully!');
        }
        
        function exportBackup() {
            if (bodyData.length === 0) {
                showToast('No data to backup', true);
                return;
            }
            
            const backup = {
                version: '2.0',
                exportDate: new Date().toISOString(),
                entries: bodyData.length,
                goals: GOALS,
                data: bodyData
            };
            
            const json = JSON.stringify(backup, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `body-tracker-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showToast('Backup created successfully!');
        }
        
        
        // ===== TAB NAVIGATION =====
        
        function switchMainTab(tabName, el) {
            // Hide all tabs
            document.querySelectorAll('.main-tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active from all buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // Set button active
            if (el) {
                el.classList.add('active');
            } else {
                const btn = Array.from(document.querySelectorAll('.tab-button')).find(b => (b.getAttribute('onclick') || '').includes("switchMainTab('" + tabName + "'"));
                if (btn) btn.classList.add('active');
            }
            
            // Update content for specific tabs
            if (tabName === 'nutrition') updateNutritionTab();
            if (tabName === 'measurements') updateMeasurementsTab();
            if (tabName === 'training') updateTrainingTab();
            if (tabName === 'correlations') updateCorrelationsTab();
            if (tabName === 'analytics') updateAnalyticsTab();
        }
        
        // ===== NUTRITION TAB FUNCTIONS =====
        
        function updateNutritionTab() {
            updateNutritionGoals();
            updateTotalAverages();
            updateRollingAverages();
            updateRecommendations();
            updateWhatIfCalculator();
        }
        
        function updateNutritionGoals() {
            const html = `
                <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 10px;">
                    <h3 style="color: var(--accent-purple); margin-bottom: 15px;">Your Nutrition Targets</h3>
                    <div class="grid grid-4">
                        <div>
                            <div class="nutrition-label">Target Calories</div>
                            <div class="nutrition-value">${GOALS.target_calories}</div>
                        </div>
                        <div>
                            <div class="nutrition-label">Target Protein (g)</div>
                            <div class="nutrition-value">${GOALS.target_protein}</div>
                        </div>
                        <div>
                            <div class="nutrition-label">Target Fat (g)</div>
                            <div class="nutrition-value">${GOALS.target_fat}</div>
                        </div>
                        <div>
                            <div class="nutrition-label">Target Carbs (g)</div>
                            <div class="nutrition-value">${GOALS.target_carbs}</div>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('nutritionGoals').innerHTML = html;
        }
        
        function updateTotalAverages() {
            const withNutrition = bodyData.filter(d => d.calories && d.protein);
            
            if (withNutrition.length === 0) {
                document.getElementById('totalAverages').innerHTML = '<p style="color: var(--text-secondary);">No nutrition data yet</p>';
                return;
            }
            
            const avgCals = withNutrition.reduce((sum, d) => sum + (d.calories || 0), 0) / withNutrition.length;
            const avgProtein = withNutrition.reduce((sum, d) => sum + (d.protein || 0), 0) / withNutrition.length;
            const avgFat = withNutrition.reduce((sum, d) => sum + (d.fat || 0), 0) / withNutrition.length;
            const avgCarbs = withNutrition.reduce((sum, d) => sum + (d.carbs || 0), 0) / withNutrition.length;
            
            const latest = bodyData[bodyData.length - 1];
            const avgProteinPerLb = latest.lean_lbs ? avgProtein / latest.lean_lbs : 0;
            
            const html = `
                <div class="nutrition-card">
                    <div class="nutrition-label">Average Calories</div>
                    <div class="nutrition-value">${Math.round(avgCals)}</div>
                    <div style="font-size: 0.85em; color: var(--text-secondary); margin-top: 5px;">
                        Based on ${withNutrition.length} days
                    </div>
                </div>
                <div class="nutrition-card">
                    <div class="nutrition-label">Average Protein</div>
                    <div class="nutrition-value">${Math.round(avgProtein)}g</div>
                    <div style="font-size: 0.85em; color: var(--text-secondary); margin-top: 5px;">
                        ${avgProteinPerLb.toFixed(2)}g per lb lean mass
                    </div>
                </div>
                <div class="nutrition-card">
                    <div class="nutrition-label">Average Fat</div>
                    <div class="nutrition-value">${Math.round(avgFat)}g</div>
                </div>
                <div class="nutrition-card">
                    <div class="nutrition-label">Average Carbs</div>
                    <div class="nutrition-value">${Math.round(avgCarbs)}g</div>
                </div>
            `;
            
            document.getElementById('totalAverages').innerHTML = html;
        }
        
        function updateRollingAverages() {
            const sorted = bodyData.slice().sort((a, b) => a.date.localeCompare(b.date));
            const recent7 = sorted.slice(-7).filter(d => d.calories && d.protein);
            
            if (recent7.length === 0) {
                document.getElementById('rollingAverages').innerHTML = '<p style="color: var(--text-secondary);">Need at least 7 days of nutrition data</p>';
                return;
            }
            
            const avgCals = recent7.reduce((sum, d) => sum + (d.calories || 0), 0) / recent7.length;
            const avgProtein = recent7.reduce((sum, d) => sum + (d.protein || 0), 0) / recent7.length;
            const avgFat = recent7.reduce((sum, d) => sum + (d.fat || 0), 0) / recent7.length;
            const avgCarbs = recent7.reduce((sum, d) => sum + (d.carbs || 0), 0) / recent7.length;
            
            const html = `
                <div class="nutrition-card">
                    <div class="nutrition-label">7-Day Avg Calories</div>
                    <div class="nutrition-value">${Math.round(avgCals)}</div>
                    <div style="font-size: 0.85em; color: var(--text-secondary); margin-top: 5px;">
                        Last ${recent7.length} days
                    </div>
                </div>
                <div class="nutrition-card">
                    <div class="nutrition-label">7-Day Avg Protein</div>
                    <div class="nutrition-value">${Math.round(avgProtein)}g</div>
                </div>
                <div class="nutrition-card">
                    <div class="nutrition-label">7-Day Avg Fat</div>
                    <div class="nutrition-value">${Math.round(avgFat)}g</div>
                </div>
                <div class="nutrition-card">
                    <div class="nutrition-label">7-Day Avg Carbs</div>
                    <div class="nutrition-value">${Math.round(avgCarbs)}g</div>
                </div>
            `;
            
            document.getElementById('rollingAverages').innerHTML = html;
        }
        
        function updateRecommendations() {
            const sorted = bodyData.slice().sort((a, b) => a.date.localeCompare(b.date));
            const latest = sorted[sorted.length - 1];
            
            if (!latest) {
                document.getElementById('recommendations').innerHTML = '<p style="color: var(--text-secondary);">No data available</p>';
                return;
            }
            
            // Calculate TDEE estimate based on recent fat loss
            const recent14 = sorted.slice(-14);
            if (recent14.length < 2) {
                document.getElementById('recommendations').innerHTML = '<p style="color: var(--text-secondary);">Need at least 14 days of data for recommendations</p>';
                return;
            }
            
            const first14 = recent14[0];
            const last14 = recent14[recent14.length - 1];
            const days = 14;
            
            const fatLost = (first14.weight * first14.bf_percent / 100) - (last14.weight * last14.bf_percent / 100);
            const fatLostPerDay = fatLost / days;
            const fatLostPerWeek = fatLostPerDay * 7;
            
            // 1 lb fat = 3500 calories
            const calorieDeficit = fatLostPerDay * 3500;
            
            const avgCals = recent14.filter(d => d.calories).reduce((sum, d) => sum + d.calories, 0) / recent14.filter(d => d.calories).length;
            const estimatedTDEE = avgCals + calorieDeficit;
            
            // Max fat burn = 1% body weight per week
            const maxFatBurnPerWeek = latest.weight * 0.01;
            const maxFatBurnCals = estimatedTDEE - (maxFatBurnPerWeek * 3500 / 7);
            
            // Muscle retention = 0.5% body weight per week
            const muscleRetentionFatLoss = latest.weight * 0.005;
            const muscleRetentionCals = estimatedTDEE - (muscleRetentionFatLoss * 3500 / 7);
            
            const proteinRec = latest.lean_lbs ? latest.lean_lbs * 1.0 : 180;
            
            const html = `
                <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 10px; margin-bottom: 15px;">
                    <h3 style="color: var(--accent-purple); margin-bottom: 10px;">Estimated TDEE</h3>
                    <div class="nutrition-value" style="color: var(--accent-success);">${Math.round(estimatedTDEE)} cals/day</div>
                    <p style="font-size: 0.85em; color: var(--text-secondary); margin-top: 5px;">
                        Based on ${fatLostPerWeek.toFixed(2)} lbs/week fat loss
                    </p>
                </div>
                
                <div class="grid grid-2">
                    <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 10px;">
                        <h3 style="color: var(--accent-purple); margin-bottom: 10px;">üî• Max Fat Burn Rate</h3>
                        <div class="nutrition-value">${Math.round(maxFatBurnCals)}</div>
                        <p style="font-size: 0.85em; color: var(--text-secondary); margin-top: 10px;">
                            Target: ~${maxFatBurnPerWeek.toFixed(2)} lbs/week loss (1% body weight)<br>
                            Deficit: ${Math.round(estimatedTDEE - maxFatBurnCals)} cals/day
                        </p>
                    </div>
                    
                    <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 10px;">
                        <h3 style="color: var(--accent-purple); margin-bottom: 10px;">üí™ Muscle Retention</h3>
                        <div class="nutrition-value">${Math.round(muscleRetentionCals)}</div>
                        <p style="font-size: 0.85em; color: var(--text-secondary); margin-top: 10px;">
                            Target: ~${muscleRetentionFatLoss.toFixed(2)} lbs/week loss (0.5% body weight)<br>
                            Deficit: ${Math.round(estimatedTDEE - muscleRetentionCals)} cals/day
                        </p>
                    </div>
                </div>
                
                <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 10px; margin-top: 15px;">
                    <h3 style="color: var(--accent-purple); margin-bottom: 10px;">ü•© Protein Recommendation</h3>
                    <div class="nutrition-value">${Math.round(proteinRec)}g/day</div>
                    <p style="font-size: 0.85em; color: var(--text-secondary); margin-top: 5px;">
                        Based on 1.0g per lb lean mass (${latest.lean_lbs?.toFixed(1)} lbs)
                    </p>
                </div>
            `;
            
            document.getElementById('recommendations').innerHTML = html;
        }
        
        function updateWhatIfCalculator() {
            const sorted = bodyData.slice().sort((a, b) => a.date.localeCompare(b.date));
            const latest = sorted[sorted.length - 1];
            
            if (!latest) {
                document.getElementById('whatIfCalc').innerHTML = '<p style="color: var(--text-secondary);">No data available</p>';
                return;
            }
            
            const currentFatLbs = latest.weight * latest.bf_percent / 100;
            const targetFatLbs = GOALS.target_bf_lbs;
            const fatToLose = currentFatLbs - targetFatLbs;
            
            // Calculate current rate
            const recent14 = sorted.slice(-14);
            let avgFatLossPerWeek = 0;
            if (recent14.length >= 2) {
                const first = recent14[0];
                const last = recent14[recent14.length - 1];
                const fatLost = (first.weight * first.bf_percent / 100) - (last.weight * last.bf_percent / 100);
                avgFatLossPerWeek = (fatLost / 14) * 7;
            }
            
            const weeksToGoal = avgFatLossPerWeek > 0 ? fatToLose / avgFatLossPerWeek : 0;
            const daysToGoal = weeksToGoal * 7;
            
            const goalDate = new Date(latest.date);
            goalDate.setDate(goalDate.getDate() + daysToGoal);
            
            // Different scenarios
            const scenarios = [
                { rate: 0.5, name: 'Conservative (0.5 lb/week)' },
                { rate: 1.0, name: 'Moderate (1.0 lb/week)' },
                { rate: 1.5, name: 'Aggressive (1.5 lb/week)' },
                { rate: 2.0, name: 'Very Aggressive (2.0 lb/week)' }
            ];
            
            let scenariosHtml = '';
            scenarios.forEach(scenario => {
                const weeks = fatToLose / scenario.rate;
                const date = new Date(latest.date);
                date.setDate(date.getDate() + (weeks * 7));
                
                scenariosHtml += `
                    <div style="background: var(--bg-tertiary); padding: 15px; border-radius: 8px;">
                        <div style="font-weight: 600; margin-bottom: 5px;">${scenario.name}</div>
                        <div style="font-size: 1.3em; font-family: 'Space Mono', monospace; color: var(--accent-cyan);">
                            ${date.toLocaleDateString()}
                        </div>
                        <div style="font-size: 0.85em; color: var(--text-secondary); margin-top: 5px;">
                            ${Math.round(weeks)} weeks (${Math.round(weeks * 7)} days)
                        </div>
                    </div>
                `;
            });
            
            const html = `
                <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 10px; margin-bottom: 15px;">
                    <h3 style="color: var(--accent-purple); margin-bottom: 10px;">Current Progress</h3>
                    <div class="grid grid-4">
                        <div>
                            <div class="nutrition-label">Current Fat Mass</div>
                            <div class="nutrition-value" style="font-size: 1.3em;">${currentFatLbs.toFixed(1)} lbs</div>
                        </div>
                        <div>
                            <div class="nutrition-label">Target Fat Mass</div>
                            <div class="nutrition-value" style="font-size: 1.3em;">${targetFatLbs.toFixed(1)} lbs</div>
                        </div>
                        <div>
                            <div class="nutrition-label">Fat to Lose</div>
                            <div class="nutrition-value" style="font-size: 1.3em;">${fatToLose.toFixed(1)} lbs</div>
                        </div>
                        <div>
                            <div class="nutrition-label">Current Rate</div>
                            <div class="nutrition-value" style="font-size: 1.3em;">${avgFatLossPerWeek.toFixed(2)} lb/wk</div>
                        </div>
                    </div>
                </div>
                
                <h3 style="margin-bottom: 15px;">Goal Date Scenarios</h3>
                <div class="grid grid-2">
                    ${scenariosHtml}
                </div>
                
                ${avgFatLossPerWeek > 0 ? `
                <div style="background: rgba(6, 182, 212, 0.1); padding: 20px; border-radius: 10px; margin-top: 15px; border-left: 4px solid var(--accent-cyan);">
                    <h3 style="color: var(--accent-cyan); margin-bottom: 10px;">At Your Current Rate</h3>
                    <div style="font-size: 1.5em; font-family: 'Space Mono', monospace; margin-bottom: 10px;">
                        ${goalDate.toLocaleDateString()}
                    </div>
                    <p style="color: var(--text-secondary);">
                        ${Math.round(weeksToGoal)} weeks (${Math.round(daysToGoal)} days) to reach ${GOALS.target_weight} lbs @ ${GOALS.target_bf_percent}% BF
                    </p>
                </div>
                ` : ''}
            `;
            
            document.getElementById('whatIfCalc').innerHTML = html;
        }
        
        // ===== MEASUREMENTS TAB =====
        
        let measurements = [];
        
        function loadMeasurements() {
            const stored = localStorage.getItem(MEASUREMENTS_KEY);
            if (stored) {
                measurements = JSON.parse(stored);
            }
        }
        
        function saveMeasurements() {
            localStorage.setItem(MEASUREMENTS_KEY, JSON.stringify(measurements));
        }
        
        function updateMeasurementsTab() {
            if (measurements.length === 0) {
                document.getElementById('measurementsContent').innerHTML = `
                    <div style="background: var(--bg-tertiary); padding: 30px; border-radius: 10px; text-align: center;">
                        <h3 style="color: var(--accent-purple); margin-bottom: 15px;">üìè No Measurements Yet</h3>
                        <p style="color: var(--text-secondary); margin-bottom: 20px;">
                            Start tracking body measurements like neck, chest, waist, hips, arms, thighs, and calves.
                        </p>
                        <button onclick="showAddMeasurement()" class="primary">+ Add First Measurement</button>
                    </div>
                `;
                return;
            }
            
            const sorted = measurements.slice().sort((a, b) => b.date.localeCompare(a.date));
            const latest = sorted[0];
            const oldest = sorted[sorted.length - 1];
            
            let tableRows = '';
            sorted.forEach(m => {
                tableRows += `
                    <tr onclick="editMeasurement('${m.date}')">
                        <td>${m.date}</td>
                        <td>${m.neck || '-'}</td>
                        <td>${m.chest || '-'}</td>
                        <td>${m.waist || '-'}</td>
                        <td>${m.hips || '-'}</td>
                        <td>${m.arms || '-'}</td>
                        <td>${m.thighs || '-'}</td>
                        <td>${m.calves || '-'}</td>
                        <td>
                            <button class="danger" onclick="event.stopPropagation(); deleteMeasurement('${m.date}')">√ó</button>
                        </td>
                    </tr>
                `;
            });
            
            const html = `
                <div style="margin-bottom: 20px;">
                    <h3 style="color: var(--accent-purple); margin-bottom: 15px;">Latest Measurements (${latest.date})</h3>
                    <div class="grid grid-4">
                        <div class="nutrition-card">
                            <div class="nutrition-label">Neck</div>
                            <div class="nutrition-value" style="font-size: 1.5em;">${latest.neck || '-'}"</div>
                        </div>
                        <div class="nutrition-card">
                            <div class="nutrition-label">Chest</div>
                            <div class="nutrition-value" style="font-size: 1.5em;">${latest.chest || '-'}"</div>
                        </div>
                        <div class="nutrition-card">
                            <div class="nutrition-label">Waist</div>
                            <div class="nutrition-value" style="font-size: 1.5em;">${latest.waist || '-'}"</div>
                        </div>
                        <div class="nutrition-card">
                            <div class="nutrition-label">Hips</div>
                            <div class="nutrition-value" style="font-size: 1.5em;">${latest.hips || '-'}"</div>
                        </div>
                        <div class="nutrition-card">
                            <div class="nutrition-label">Arms</div>
                            <div class="nutrition-value" style="font-size: 1.5em;">${latest.arms || '-'}"</div>
                        </div>
                        <div class="nutrition-card">
                            <div class="nutrition-label">Thighs</div>
                            <div class="nutrition-value" style="font-size: 1.5em;">${latest.thighs || '-'}"</div>
                        </div>
                        <div class="nutrition-card">
                            <div class="nutrition-label">Calves</div>
                            <div class="nutrition-value" style="font-size: 1.5em;">${latest.calves || '-'}"</div>
                        </div>
                    </div>
                </div>
                
                <h3 style="margin: 20px 0 15px 0;">Measurement History</h3>
                <div class="table-container" style="max-height: 400px;">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Neck</th>
                                <th>Chest</th>
                                <th>Waist</th>
                                <th>Hips</th>
                                <th>Arms</th>
                                <th>Thighs</th>
                                <th>Calves</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tableRows}
                        </tbody>
                    </table>
                </div>
            `;
            
            document.getElementById('measurementsContent').innerHTML = html;
        }
        
        function showAddMeasurement() {
            const modal = document.getElementById('measurementsModal');
            modal.innerHTML = `
                <div class="modal">
                    <h2>Add Body Measurements</h2>
                    <div class="form-section">
                        <h3>Date & Core Measurements</h3>
                        <div class="form-grid">
                            <div class="form-field">
                                <label class="required">Date</label>
                                <input type="date" id="measDate" value="${new Date().toISOString().split('T')[0]}">
                            </div>
                            <div class="form-field">
                                <label>Neck (inches)</label>
                                <input type="number" step="0.25" id="measNeck">
                            </div>
                            <div class="form-field">
                                <label>Chest (inches)</label>
                                <input type="number" step="0.25" id="measChest">
                            </div>
                            <div class="form-field">
                                <label>Waist (inches)</label>
                                <input type="number" step="0.25" id="measWaist">
                            </div>
                            <div class="form-field">
                                <label>Hips (inches)</label>
                                <input type="number" step="0.25" id="measHips">
                            </div>
                            <div class="form-field">
                                <label>Arms (inches)</label>
                                <input type="number" step="0.25" id="measArms">
                            </div>
                            <div class="form-field">
                                <label>Thighs (inches)</label>
                                <input type="number" step="0.25" id="measThighs">
                            </div>
                            <div class="form-field">
                                <label>Calves (inches)</label>
                                <input type="number" step="0.25" id="measCalves">
                            </div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button onclick="saveMeasurement()" class="primary">Save Measurements</button>
                        <button onclick="hideMeasurementsModal()">Cancel</button>
                    </div>
                </div>
            `;
            modal.classList.add('show');
        }
        
        function saveMeasurement() {
            const date = document.getElementById('measDate').value;
            if (!date) {
                showToast('Please enter a date', true);
                return;
            }
            
            const measurement = {
                date,
                neck: parseFloat(document.getElementById('measNeck').value) || null,
                chest: parseFloat(document.getElementById('measChest').value) || null,
                waist: parseFloat(document.getElementById('measWaist').value) || null,
                hips: parseFloat(document.getElementById('measHips').value) || null,
                arms: parseFloat(document.getElementById('measArms').value) || null,
                thighs: parseFloat(document.getElementById('measThighs').value) || null,
                calves: parseFloat(document.getElementById('measCalves').value) || null
            };
            
            measurements = measurements.filter(m => m.date !== date);
            measurements.push(measurement);
            measurements.sort((a, b) => a.date.localeCompare(b.date));
            
            saveMeasurements();
            updateMeasurementsTab();
            hideMeasurementsModal();
            showToast('Measurements saved!');
        }
        
        function editMeasurement(date) {
            const meas = measurements.find(m => m.date === date);
            if (!meas) return;
            
            const modal = document.getElementById('measurementsModal');
            modal.innerHTML = `
                <div class="modal">
                    <h2>Edit Measurements</h2>
                    <div class="form-section">
                        <h3>Date & Core Measurements</h3>
                        <div class="form-grid">
                            <div class="form-field">
                                <label class="required">Date</label>
                                <input type="date" id="measDate" value="${meas.date}">
                            </div>
                            <div class="form-field">
                                <label>Neck (inches)</label>
                                <input type="number" step="0.25" id="measNeck" value="${meas.neck || ''}">
                            </div>
                            <div class="form-field">
                                <label>Chest (inches)</label>
                                <input type="number" step="0.25" id="measChest" value="${meas.chest || ''}">
                            </div>
                            <div class="form-field">
                                <label>Waist (inches)</label>
                                <input type="number" step="0.25" id="measWaist" value="${meas.waist || ''}">
                            </div>
                            <div class="form-field">
                                <label>Hips (inches)</label>
                                <input type="number" step="0.25" id="measHips" value="${meas.hips || ''}">
                            </div>
                            <div class="form-field">
                                <label>Arms (inches)</label>
                                <input type="number" step="0.25" id="measArms" value="${meas.arms || ''}">
                            </div>
                            <div class="form-field">
                                <label>Thighs (inches)</label>
                                <input type="number" step="0.25" id="measThighs" value="${meas.thighs || ''}">
                            </div>
                            <div class="form-field">
                                <label>Calves (inches)</label>
                                <input type="number" step="0.25" id="measCalves" value="${meas.calves || ''}">
                            </div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button onclick="saveMeasurement()" class="primary">Save Changes</button>
                        <button onclick="hideMeasurementsModal()">Cancel</button>
                    </div>
                </div>
            `;
            modal.classList.add('show');
        }
        
        function deleteMeasurement(date) {
            if (!confirm(`Delete measurements from ${date}?`)) return;
            measurements = measurements.filter(m => m.date !== date);
            saveMeasurements();
            updateMeasurementsTab();
            showToast('Measurements deleted');
        }
        
        function hideMeasurementsModal() {
            document.getElementById('measurementsModal').classList.remove('show');
        }
        
        
// ===== TRAINING TAB (v12) =====
// Goals:
// - Set-by-set tracking (variable reps/weight per set)
// - Set types: Standard, Drop Set, Rest-Pause, Warm-up
// - Warm-up sets excluded from "working volume"
// - Superset designation (tag)
// - Plan-ahead: "Workout for Today" card + templates
// - Multiple workouts per day (two-a-days)
// - Exercise library (preset + learns new exercises)
// - Progressive overload analysis tab (PRs + suggestions)
// - Reliable save button + Ctrl/Cmd+S
// - Auto-save with debounce + saved indicator
// - Data schema versioning + migrations so upgrades won't break data

const TRAINING_SCHEMA_VERSION = 2;
const TRAINING_KEY = 'rakChazaq_training_v12';
const TRAINING_TEMPLATES_KEY = 'rakChazaq_training_templates_v12';
const EXERCISE_LIBRARY_KEY = 'rakChazaq_exercise_library_v12';

// Auto-save status
let __dirty = false;
let __saveTimer = null;
let __lastSavedAt = null;

// Training data in-memory
let trainingStore = { schema_version: TRAINING_SCHEMA_VERSION, exported_at: null, workouts: [] };
let workoutTemplates = { schema_version: 1, templates: [] };
let exerciseLibrary = { schema_version: 1, items: [] };

// Live mode (timer + rest)
let liveMode = { running:false, startTs:null, elapsedSec:0, restUntil:null, restTimer:null, elapsedTimer:null };

function _nowIso() { return new Date().toISOString(); }
function newId(prefix='id') { return `${prefix}_${Math.random().toString(16).slice(2)}_${Date.now()}`; }

function markDirty() {
    __dirty = true;
    scheduleAutosave();
    updateSaveIndicator('Saving‚Ä¶');
}

function scheduleAutosave() {
    if (__saveTimer) clearTimeout(__saveTimer);
    __saveTimer = setTimeout(() => {
        persistAll();
    }, 2000);
}

function updateSaveIndicator(stateText) {
    // Header line already exists: #headerStatus, keep it; we add a small status on the right via a badge
    let el = document.getElementById('saveStatusBadge');
    if (!el) {
        const header = document.querySelector('.header-actions');
        if (header) {
            const span = document.createElement('span');
            span.id = 'saveStatusBadge';
            span.style.cssText = 'margin-left:auto;align-self:center;font-family:Space Mono, monospace;font-size:0.85em;color:var(--text-secondary);';
            header.appendChild(span);
            el = span;
        }
    }
    if (el) {
        const ts = __lastSavedAt ? ` ‚Ä¢ Last saved: ${__lastSavedAt.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}` : '';
        el.textContent = `${stateText}${(stateText.startsWith('Saved') ? ts : '')}`;
    }
}

window.addEventListener('beforeunload', (e) => {
    if (__dirty) {
        e.preventDefault();
        e.returnValue = '';
    }
});

function safeJsonParse(str) {
    try { return JSON.parse(str); } catch { return null; }
}

function loadExerciseLibrary() {
    const stored = safeJsonParse(localStorage.getItem(EXERCISE_LIBRARY_KEY));
    const defaults = [
        'Bench Press','Incline Bench Press','Dumbbell Bench Press','Overhead Press','Dumbbell Shoulder Press',
        'Back Squat','Front Squat','Deadlift','Romanian Deadlift','Leg Press',
        'Pull-up','Lat Pulldown','Barbell Row','Dumbbell Row','Cable Row',
        'Bicep Curl','Hammer Curl','Tricep Pushdown','Dips',
        'Lateral Raise','Rear Delt Fly','Chest Fly','Calf Raise','Plank'
    ];
    if (stored && stored.items) {
        exerciseLibrary = stored;
    } else {
        exerciseLibrary = { schema_version: 1, items: defaults };
        localStorage.setItem(EXERCISE_LIBRARY_KEY, JSON.stringify(exerciseLibrary));
    }
}

function learnExercise(name) {
    if (!name) return;
    const n = name.trim();
    if (!n) return;
    if (!exerciseLibrary.items.some(x => x.toLowerCase() === n.toLowerCase())) {
        exerciseLibrary.items.push(n);
        exerciseLibrary.items.sort((a,b)=>a.localeCompare(b));
        localStorage.setItem(EXERCISE_LIBRARY_KEY, JSON.stringify(exerciseLibrary));
    }
}

// --- Migrations ---
function migrateTrainingPayload(raw) {
    // Accept:
    // 1) Array of workouts (legacy)
    // 2) { trainingLog: [...] } (legacy)
    // 3) { schema_version, workouts: [...] } (current)
    if (!raw) return { schema_version: TRAINING_SCHEMA_VERSION, exported_at: _nowIso(), workouts: [] };

    // Backup old payload once
    try {
        localStorage.setItem(`${TRAINING_KEY}__backup__${Date.now()}`, JSON.stringify(raw));
    } catch {}

    // Normalize to object with workouts[]
    let obj = null;
    if (Array.isArray(raw)) obj = { schema_version: 0, workouts: raw };
    else if (raw.workouts && Array.isArray(raw.workouts)) obj = raw;
    else if (raw.trainingLog && Array.isArray(raw.trainingLog)) obj = { schema_version: 0, workouts: raw.trainingLog };
    else obj = { schema_version: 0, workouts: [] };

    const fromV = Number(obj.schema_version || 0);
    let migrated = obj;

    // v0 -> v1: ensure ids, sets arrays, date+time fields, exercise fields
    if (fromV < 1) {
        migrated = {
            schema_version: 1,
            exported_at: _nowIso(),
            workouts: (migrated.workouts || []).map(w => {
                const wid = w.id || newId('w');
                const date = w.date || w.workoutDate || w.day || new Date().toISOString().split('T')[0];
                const startTime = w.startTime || w.time || null;
                const type = w.type || w.workoutType || 'Workout';
                const notes = w.notes || '';
                const exercises = (w.exercises || w.blocks || []).map(ex => {
                    const exid = ex.id || newId('ex');
                    const name = ex.name || ex.exercise || '';
                    const isDumbbell = !!ex.isDumbbell;
                    const isBodyweight = !!ex.isBodyweight;
                    const superset = ex.superset || null;
                    const exNotes = ex.notes || '';
                    // Legacy might have sets/reps/weight at exercise level:
                    const legacySets = ex.sets || [];
                    let sets = [];
                    if (Array.isArray(legacySets) && legacySets.length) {
                        sets = legacySets.map(s => ({
                            id: s.id || newId('s'),
                            type: s.type || (s.warmup ? 'Warm-up' : 'Standard'),
                            reps: Number(s.reps || 0),
                            weight: s.weight !== undefined ? Number(s.weight) : null,
                            db_weight: s.db_weight !== undefined ? Number(s.db_weight) : null,
                            drops: Array.isArray(s.drops) ? s.drops : null,
                            rest_pause: s.rest_pause || null,
                            assistance: s.assistance !== undefined ? Number(s.assistance) : null,
                            added: s.added !== undefined ? Number(s.added) : null,
                            completed: s.completed !== undefined ? !!s.completed : true
                        }));
                    } else {
                        // If old schema had ex.setsCount/ex.reps/ex.weight
                        const reps = Number(ex.reps || 0);
                        const weight = ex.weight !== undefined ? Number(ex.weight) : null;
                        if (reps || weight) {
                            sets = [{ id: newId('s'), type: 'Standard', reps, weight, completed: true }];
                        } else {
                            sets = [{ id: newId('s'), type: 'Standard', reps: 0, weight: null, completed: false }];
                        }
                    }
                    return { id: exid, name, isDumbbell, isBodyweight, superset, notes: exNotes, sets };
                });
                return { id: wid, date, startTime, type, notes, exercises };
            })
        };
    }

    // v1 -> v2: add template linkage + allow multiple workouts/day: enforce date+id uniqueness
    if (migrated.schema_version < 2) {
        migrated = {
            schema_version: 2,
            exported_at: _nowIso(),
            workouts: (migrated.workouts || []).map(w => ({
                id: w.id || newId('w'),
                date: w.date,
                startTime: w.startTime || null,
                type: w.type || 'Workout',
                title: w.title || null,
                template_id: w.template_id || null,
                notes: w.notes || '',
                exercises: (w.exercises || []).map(ex => ({
                    id: ex.id || newId('ex'),
                    name: ex.name || '',
                    isDumbbell: !!ex.isDumbbell,
                    isBodyweight: !!ex.isBodyweight,
                    superset: ex.superset || null,
                    notes: ex.notes || '',
                    sets: (ex.sets || []).map(s => ({
                        id: s.id || newId('s'),
                        type: s.type || 'Standard',
                        reps: Number(s.reps || 0),
                        weight: s.weight !== null && s.weight !== undefined ? Number(s.weight) : null,
                        db_weight: s.db_weight !== null && s.db_weight !== undefined ? Number(s.db_weight) : null,
                        drops: s.drops || null,
                        rest_pause: s.rest_pause || null,
                        assistance: s.assistance !== null && s.assistance !== undefined ? Number(s.assistance) : null,
                        added: s.added !== null && s.added !== undefined ? Number(s.added) : null,
                        completed: s.completed !== undefined ? !!s.completed : true
                    }))
                }))
            }))
        };
    }

    return migrated;
}

function loadTraining() {
    const raw = safeJsonParse(localStorage.getItem(TRAINING_KEY));
    trainingStore = migrateTrainingPayload(raw);
    localStorage.setItem(TRAINING_KEY, JSON.stringify(trainingStore));
}

function saveTraining() {
    trainingStore.exported_at = _nowIso();
    localStorage.setItem(TRAINING_KEY, JSON.stringify(trainingStore));
}

function loadTemplates() {
    const raw = safeJsonParse(localStorage.getItem(TRAINING_TEMPLATES_KEY));
    if (raw && raw.templates) workoutTemplates = raw;
    else {
        workoutTemplates = { schema_version: 1, templates: [] };
        localStorage.setItem(TRAINING_TEMPLATES_KEY, JSON.stringify(workoutTemplates));
    }
}

function saveTemplates() {
    localStorage.setItem(TRAINING_TEMPLATES_KEY, JSON.stringify(workoutTemplates));
}

// Persist everything (body data + training + measurements + templates + library)
function persistAll() {
    try {
        saveData(); // existing body data saver
    } catch {}
    try {
        saveTraining();
        saveTemplates();
        localStorage.setItem(EXERCISE_LIBRARY_KEY, JSON.stringify(exerciseLibrary));
    } catch {}
    __dirty = false;
    __lastSavedAt = new Date();
    updateSaveIndicator('Saved ‚úì');
}

// ----- Volume + 1RM -----
function epley1RM(weight, reps) {
    if (!isFinite(weight) || !isFinite(reps) || reps <= 0) return null;
    return weight * (1 + (reps / 30));
}

function latestBodyweight() {
    // Use most recent bodyData weight
    try {
        const sorted = bodyData.slice().sort((a,b)=>a.date.localeCompare(b.date));
        const latest = sorted[sorted.length-1];
        return isFinite(latest?.weight) ? latest.weight : null;
    } catch { return null; }
}

function effectiveSetWeight(ex, set) {
    // Dumbbell: use total = db_weight*2, but preserve set.weight if user enters total weight
    let w = null;
    if (ex.isDumbbell) {
        const dbw = (set.db_weight !== null && set.db_weight !== undefined) ? Number(set.db_weight) : null;
        if (isFinite(dbw)) w = dbw * 2;
    }
    if (w === null) {
        if (set.weight !== null && set.weight !== undefined && isFinite(set.weight)) w = Number(set.weight);
    }

    if (ex.isBodyweight) {
        const bw = latestBodyweight();
        if (!isFinite(bw)) return w; // fallback
        const assistance = isFinite(set.assistance) ? Number(set.assistance) : 0;
        const added = isFinite(set.added) ? Number(set.added) : 0;
        w = (bw - assistance + added);
    }
    return w;
}

function setVolume(ex, set) {
    // Drop set: parse drops array: [{weight,reps}, ...] OR "225x8 -> 185x6"
    const type = (set.type || 'Standard');
    if (type === 'Warm-up') return 0; // do not count towards working volume
    if (type === 'Drop Set' && set.drops && Array.isArray(set.drops)) {
        return set.drops.reduce((sum, d) => {
            const w = effectiveSetWeight(ex, { ...set, weight: d.weight, db_weight: d.db_weight ?? set.db_weight, assistance: set.assistance, added: set.added, type: 'Standard' });
            const r = Number(d.reps || 0);
            return sum + (isFinite(w) ? w : 0) * (isFinite(r) ? r : 0);
        }, 0);
    }
    if (type === 'Rest-Pause' && set.rest_pause) {
        // rest_pause example: "8+3+2" total reps
        const parts = String(set.rest_pause).split('+').map(x=>Number(x.trim())).filter(x=>isFinite(x) && x>0);
        const reps = parts.reduce((a,b)=>a+b,0);
        const w = effectiveSetWeight(ex, set);
        return (isFinite(w) ? w : 0) * reps;
    }
    const reps = Number(set.reps || 0);
    const w = effectiveSetWeight(ex, set);
    return (isFinite(w) ? w : 0) * (isFinite(reps) ? reps : 0);
}

function exerciseVolume(ex) {
    return (ex.sets || []).reduce((sum,s)=>sum + setVolume(ex,s), 0);
}

// ----- UI: Training tab -----
function updateTrainingTab() {
    const container = document.getElementById('trainingContent');
    if (!container) return;

    const workouts = (trainingStore.workouts || []).slice().sort((a,b)=>{
        const da = (a.date||'') + (a.startTime||'');
        const db = (b.date||'') + (b.startTime||'');
        return db.localeCompare(da);
    });

    if (workouts.length === 0) {
        container.innerHTML = `
            <div style="background: var(--bg-tertiary); padding: 30px; border-radius: 10px; text-align: center;">
                <h3 style="color: var(--accent-purple); margin-bottom: 15px;">üèãÔ∏è No Workouts Logged Yet</h3>
                <p style="color: var(--text-secondary); margin-bottom: 20px;">Log your first workout (set-by-set), plan ahead, and track progressive overload.</p>
                <button onclick="showAddWorkout()" class="primary">+ Log First Workout</button>
            </div>
        `;
        return;
    }

    // Workout for Today card
    const today = new Date().toISOString().split('T')[0];
    const todays = workouts.filter(w => w.date === today);

    let todayHtml = `
        <div style="background: rgba(6, 182, 212, 0.08); border: 1px solid var(--border); padding: 18px; border-radius: 12px; margin-bottom: 15px;">
            <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
                <div>
                    <div style="font-family:'Space Mono', monospace; color: var(--accent-cyan); font-weight:700;">Workout for Today</div>
                    <div style="color: var(--text-secondary); font-size:0.9em;">Plan the work ‚Ä¢ Work the plan</div>
                </div>
                <div style="display:flex; gap:10px; flex-wrap:wrap;">
                    <button onclick="showAddWorkout('${today}')" class="primary">+ New Session</button>
                    <button onclick="openTemplateManager()" style="background: var(--accent-purple);">Templates</button>
                    <button onclick="toggleLiveMode()" style="background: var(--accent-warning);">‚è± Live Mode</button>
                </div>
            </div>
            <div id="liveModeBar" style="margin-top:12px;"></div>
            <div style="margin-top:12px; color: var(--text-secondary); font-size:0.9em;">
                ${todays.length ? `Today's sessions logged: <b>${todays.length}</b>` : `No sessions logged today yet.`}
            </div>
        </div>
    `;

    // Recent workout cards
    let cards = '';
    workouts.slice(0, 30).forEach(w => {
        let exHtml = '';
        (w.exercises || []).forEach(ex => {
            const vol = exerciseVolume(ex);
            const pr1rm = getExercisePR(ex.name).pr_1rm;
            const bwTag = ex.isBodyweight ? 'ü§∏ BW' : '';
            const dbTag = ex.isDumbbell ? 'üèãÔ∏è DB' : '';
            const ssTag = ex.superset ? `üîó SS:${escapeHtml(ex.superset)}` : '';
            exHtml += `
                <div style="background: var(--bg-primary); padding: 10px; border-radius: 8px; margin: 8px 0;">
                    <div style="display:flex; justify-content:space-between; gap:10px; align-items:start;">
                        <div>
                            <div style="font-weight:700;">${escapeHtml(ex.name)} <span style="color:var(--text-secondary); font-size:0.85em;">${bwTag} ${dbTag} ${ssTag}</span></div>
                            <div style="font-family:'Space Mono', monospace; font-size:0.85em; color: var(--text-secondary); margin-top:3px;">
                                Working Volume: ${Math.round(vol).toLocaleString()} lbs ${pr1rm ? `‚Ä¢ PR 1RM: ${Math.round(pr1rm)} lbs` : ''}
                            </div>
                        </div>
                        <div style="display:flex; gap:6px;">
                            <button onclick="openProgressiveForExercise('${escapeAttr(ex.name)}')" style="padding:6px 10px; font-size:0.8em;">Overload</button>
                        </div>
                    </div>
                    ${(ex.notes ? `<details style="margin-top:8px;"><summary style="cursor:pointer;color:var(--accent-cyan); font-size:0.85em;">Notes</summary><div style="color:var(--text-secondary); font-size:0.9em; padding-top:8px;">${escapeHtml(ex.notes)}</div></details>` : '')}
                </div>
            `;
        });

        const title = w.title || w.type || 'Workout';
        const time = w.startTime ? ` ‚Ä¢ ${w.startTime}` : '';
        cards += `
            <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 12px; margin-bottom: 15px;">
                <div style="display:flex; justify-content:space-between; align-items:start; gap:10px;">
                    <div>
                        <h3 style="color: var(--accent-purple); margin-bottom: 4px;">${escapeHtml(title)}</h3>
                        <div style="color: var(--text-secondary); font-size:0.9em; font-family:'Space Mono', monospace;">${w.date}${time}</div>
                    </div>
                    <div style="display:flex; gap:8px; flex-wrap:wrap;">
                        <button onclick="editWorkout('${w.id}')" style="padding:6px 12px;">Edit</button>
                        <button class="danger" onclick="deleteWorkout('${w.id}')">√ó</button>
                    </div>
                </div>
                <div style="margin-top:10px;">${exHtml || `<p style="color:var(--text-secondary); font-style:italic;">No exercises logged</p>`}</div>
                ${w.notes ? `<div style="margin-top:10px; padding:10px; background: var(--bg-primary); border-radius:8px; color:var(--text-secondary);">${escapeHtml(w.notes)}</div>` : ''}
            </div>
        `;
    });

    container.innerHTML = todayHtml + cards;
    renderLiveModeBar();
}

// ----- Progressive Overload Tab -----
function getExerciseHistory(name) {
    const workouts = (trainingStore.workouts || []).slice().sort((a,b)=>a.date.localeCompare(b.date));
    const history = [];
    workouts.forEach(w => {
        (w.exercises || []).forEach(ex => {
            if ((ex.name||'').toLowerCase() === (name||'').toLowerCase()) {
                history.push({ workout: w, ex });
            }
        });
    });
    return history;
}

function getExercisePR(name) {
    // PR: max 1RM and max working volume
    let pr1 = null, prVol = null, prDate1=null, prDateVol=null;
    const hist = getExerciseHistory(name);
    hist.forEach(h => {
        const ex = h.ex;
        const vol = exerciseVolume(ex);
        if (prVol === null || vol > prVol) { prVol = vol; prDateVol = h.workout.date; }
        (ex.sets||[]).forEach(s => {
            const wgt = effectiveSetWeight(ex, s);
            const reps = (s.type==='Rest-Pause' && s.rest_pause) ? String(s.rest_pause).split('+').map(x=>Number(x)).filter(x=>isFinite(x)).reduce((a,b)=>a+b,0) : Number(s.reps||0);
            const one = epley1RM(wgt, reps);
            if (one && (pr1===null || one>pr1)) { pr1 = one; prDate1 = h.workout.date; }
        });
    });
    return { pr_1rm: pr1, pr_1rm_date: prDate1, pr_volume: prVol, pr_volume_date: prDateVol };
}

function updateProgressiveTab(focusExercise=null) {
    const el = document.getElementById('progressiveContent');
    if (!el) return;

    // collect unique exercise names
    const names = new Set();
    (trainingStore.workouts||[]).forEach(w => (w.exercises||[]).forEach(ex => names.add(ex.name)));
    const list = Array.from(names).filter(Boolean).sort((a,b)=>a.localeCompare(b));

    const pct = Number(localStorage.getItem('po_pct') || 2.5);
    const pctHtml = `
        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:15px;">
            <div style="font-family:'Space Mono', monospace; color: var(--text-secondary);">Default increase %:</div>
            <input id="poPct" type="number" step="0.1" value="${pct}" style="width:90px; padding:8px; border-radius:8px; border:1px solid var(--border); background:var(--bg-secondary); color:var(--text-primary);">
            <button onclick="savePoPct()" class="primary">Save</button>
            <div style="margin-left:auto; color: var(--text-secondary); font-size:0.9em;">Tip: Use 1‚Äì3% for barbell, 2‚Äì5% for dumbbells.</div>
        </div>
    `;

    if (list.length===0) {
        el.innerHTML = `<p style="color:var(--text-secondary);">Log workouts to see progressive overload suggestions.</p>`;
        return;
    }

    const focus = focusExercise || list[0];
    const options = list.map(n => `<option ${n===focus?'selected':''}>${escapeHtml(n)}</option>`).join('');
    const picker = `
        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:15px;">
            <div style="font-family:'Space Mono', monospace; color: var(--text-secondary);">Exercise:</div>
            <select id="poExercise" style="min-width:220px; padding:10px; border-radius:8px; border:1px solid var(--border); background:var(--bg-secondary); color:var(--text-primary);">
                ${options}
            </select>
            <button onclick="renderPoSelected()" style="background: var(--accent-purple);">Show</button>
        </div>
    `;

    el.innerHTML = pctHtml + picker + `<div id="poDetail"></div>`;
    renderPoExercise(focus);
}

function savePoPct() {
    const v = Number(document.getElementById('poPct').value);
    if (!isFinite(v) || v<=0) return;
    localStorage.setItem('po_pct', String(v));
    showToast('Progressive overload % saved!');
    renderPoSelected();
}

function renderPoSelected() {
    const name = document.getElementById('poExercise').value;
    renderPoExercise(name);
}

function renderPoExercise(name) {
    const detail = document.getElementById('poDetail');
    if (!detail) return;
    const hist = getExerciseHistory(name);
    const pct = Number(localStorage.getItem('po_pct') || 2.5);
    const pr = getExercisePR(name);

    if (hist.length === 0) {
        detail.innerHTML = `<p style="color:var(--text-secondary);">No history for ${escapeHtml(name)}</p>`;
        return;
    }

    const last = hist[hist.length-1];
    const ex = last.ex;
    const vol = exerciseVolume(ex);

    // find last working weight (first non-warmup standard set)
    const firstWork = (ex.sets||[]).find(s => (s.type||'Standard') !== 'Warm-up' && (effectiveSetWeight(ex,s) !== null));
    const lastWeight = firstWork ? effectiveSetWeight(ex, firstWork) : null;
    const suggested = isFinite(lastWeight) ? (lastWeight * (1 + pct/100)) : null;

    // show last workout sets
    const setsLines = (ex.sets||[]).map((s,i)=>{
        const type = s.type || 'Standard';
        if (type === 'Drop Set' && s.drops && Array.isArray(s.drops)) {
            const parts = s.drops.map(d=>`${d.reps}√ó${d.weight}`).join(' ‚Üí ');
            return `Set ${i+1}: ${parts} (Drop Set)`;
        }
        if (type === 'Rest-Pause' && s.rest_pause) {
            const w = effectiveSetWeight(ex,s);
            return `Set ${i+1}: ${s.rest_pause} reps √ó ${w?.toFixed(0) || ''} lbs (Rest-Pause)`;
        }
        const w = effectiveSetWeight(ex,s);
        const r = s.reps || 0;
        return `Set ${i+1}: ${r} reps √ó ${w?.toFixed(0) || ''} lbs${type==='Warm-up'?' (Warm-up)':''}`;
    }).join('<br>');

    const calc = (isFinite(lastWeight) && isFinite(suggested))
        ? `${Math.round(suggested)} lbs (${Math.round(lastWeight)} √ó ${(1 + pct/100).toFixed(3)})`
        : 'N/A';

    detail.innerHTML = `
        <div style="background: var(--bg-tertiary); padding: 18px; border-radius: 12px;">
            <div style="display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;">
                <div>
                    <div style="font-family:'Space Mono', monospace; color: var(--accent-cyan); font-weight:700;">Exercise: ${escapeHtml(name)}</div>
                    <div style="color: var(--text-secondary); font-size:0.9em;">Last Workout (${last.workout.date}${last.workout.startTime?(' '+last.workout.startTime):''})</div>
                </div>
                <div style="text-align:right;">
                    <div style="color: var(--text-secondary); font-size:0.85em;">PR 1RM (Epley)</div>
                    <div style="font-family:'Space Mono', monospace; font-size:1.1em;">${pr.pr_1rm?Math.round(pr.pr_1rm):'‚Äî'} ${pr.pr_1rm_date?`<span style="color:var(--text-secondary); font-size:0.85em;">(${pr.pr_1rm_date})</span>`:''}</div>
                </div>
            </div>
            <div style="margin-top:12px; font-family:'Space Mono', monospace; color: var(--text-secondary); font-size:0.9em; line-height:1.6;">
                ${setsLines}
                <br><br><b>Total Working Volume:</b> ${Math.round(vol).toLocaleString()} lbs
            </div>
            <div style="margin-top:14px; padding: 12px; background: rgba(139,92,246,0.12); border:1px solid var(--border); border-radius: 10px;">
                <div style="font-weight:700; color: var(--accent-purple); margin-bottom:8px;">Progressive Overload Suggestion (${pct}%)</div>
                <div style="font-family:'Space Mono', monospace;">Suggested Weight: <b>${calc}</b></div>
                <div style="color: var(--text-secondary); margin-top:8px;">
                    OR: Add <b>1 rep per set</b> ‚Ä¢ OR: Add <b>1 additional set</b>
                </div>
            </div>
        </div>
    `;
}

function openProgressiveForExercise(name) {
    switchMainTab('progressive');
    // ensure tab rendered
    setTimeout(()=>updateProgressiveTab(name), 50);
}

// ----- Workout Modal -----
function showAddWorkout(prefillDate=null) {
    const date = prefillDate || new Date().toISOString().split('T')[0];
    const modal = document.getElementById('trainingModal');
    modal.innerHTML = '';
    const workoutId = newId('w');
    renderWorkoutModal({ id: workoutId, date, startTime: null, type: 'Workout', title: null, notes:'', exercises: [] }, true);
    modal.classList.add('show');
}

function editWorkout(workoutId) {
    const w = (trainingStore.workouts||[]).find(x=>x.id===workoutId);
    if (!w) return;
    const modal = document.getElementById('trainingModal');
    modal.innerHTML = '';
    renderWorkoutModal(JSON.parse(JSON.stringify(w)), false);
    modal.classList.add('show');
}

function hideTrainingModal() {
    const modal = document.getElementById('trainingModal');
    modal.classList.remove('show');
    modal.innerHTML = '';
}

function renderWorkoutModal(workout, isNew) {
    const modal = document.getElementById('trainingModal');
    const startTimeDefault = workout.startTime || new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    const titleDefault = workout.title || '';
    const typeDefault = workout.type || 'Workout';

    modal.innerHTML = `
        <div class="modal">
            <h2>${isNew ? 'Log Workout' : 'Edit Workout'}</h2>

            <div class="form-section">
                <h3>Workout Details</h3>
                <div class="form-grid">
                    <div class="form-field">
                        <label class="required">Date</label>
                        <input type="date" id="wDate" value="${workout.date}">
                    </div>
                    <div class="form-field">
                        <label>Start Time (optional)</label>
                        <input type="text" id="wTime" value="${escapeAttr(startTimeDefault)}" placeholder="e.g., 06:15 AM">
                    </div>
                    <div class="form-field">
                        <label>Title (optional)</label>
                        <input type="text" id="wTitle" value="${escapeAttr(titleDefault)}" placeholder="e.g., Upper 1 (Strength)">
                    </div>
                    <div class="form-field">
                        <label>Workout Type</label>
                        <select id="wType">
                            ${['Upper Body','Lower Body','Full Body','Push','Pull','Legs','Cardio','Other','Workout'].map(t=>`<option ${t===typeDefault?'selected':''}>${t}</option>`).join('')}
                        </select>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h3>Exercises <span style="color:var(--text-secondary); font-size:0.85em;">(drag to reorder or use arrows)</span></h3>
                <div id="exerciseBlocks"></div>
                <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
                    <button onclick="addExerciseBlock()" class="primary">+ Add Exercise</button>
                    <button onclick="addSupersetPair()" style="background: var(--accent-purple);">+ Superset Pair</button>
                </div>
            </div>

            <div class="form-section">
                <div class="form-field">
                    <label>Workout Notes</label>
                    <textarea id="wNotes" rows="2" maxlength="1200" placeholder="Overall notes...">${escapeHtml(workout.notes||'')}</textarea>
                </div>
            </div>

            <div id="workoutSaveHint" style="margin-top:10px;color:var(--text-secondary); font-family:'Space Mono', monospace;"></div>

            <div style="display:flex; gap:10px; margin-top: 18px; flex-wrap:wrap;">
                <button id="saveWorkoutBtn" onclick="saveWorkoutFromModal('${workout.id}')" class="primary">Save Workout</button>
                <button onclick="hideTrainingModal()">Cancel</button>
                <button onclick="saveWorkoutAsTemplate('${workout.id}')" style="background: var(--accent-warning);">Save as Template</button>
            </div>
        </div>
    `;

    // store draft in modal dataset
    modal.dataset.workoutId = workout.id;
    modal.dataset.isNew = isNew ? '1' : '0';
    modal.dataset.draft = JSON.stringify(workout);

    // wire autosave
    ['wDate','wTime','wTitle','wType','wNotes'].forEach(id=>{
        const el = document.getElementById(id);
        if (el) el.addEventListener('input', ()=>{ markDirty(); updateWorkoutSaveHint('Unsaved changes‚Ä¶'); });
    });

    // Render existing exercises
    (workout.exercises||[]).forEach(ex => appendExerciseBlock(ex));

    if ((workout.exercises||[]).length === 0) addExerciseBlock();

    updateWorkoutSaveHint('Ready');
    installWorkoutKeyboardShortcut();
}

function updateWorkoutSaveHint(msg) {
    const el = document.getElementById('workoutSaveHint');
    if (el) el.textContent = msg;
}

function installWorkoutKeyboardShortcut() {
    const modal = document.getElementById('trainingModal');
    modal.onkeydown = (e) => {
        const isSave = (e.key === 's' || e.key === 'S') && (e.ctrlKey || e.metaKey);
        if (isSave) {
            e.preventDefault();
            const wid = modal.dataset.workoutId;
            if (wid) saveWorkoutFromModal(wid);
        }
    };
}

function addExerciseBlock() {
    const ex = {
        id: newId('ex'),
        name: '',
        isDumbbell: false,
        isBodyweight: false,
        superset: null,
        notes: '',
        sets: [{ id: newId('s'), type: 'Standard', reps: 0, weight: null, db_weight: null, completed: false }]
    };
    appendExerciseBlock(ex);
    markDirty();
}

function addSupersetPair() {
    const tag = prompt('Superset tag (e.g., A, B, C)?', 'A') || 'A';
    const ex1 = { id:newId('ex'), name:'', isDumbbell:false, isBodyweight:false, superset:tag, notes:'', sets:[{id:newId('s'), type:'Standard', reps:0, weight:null, completed:false}]};
    const ex2 = { id:newId('ex'), name:'', isDumbbell:false, isBodyweight:false, superset:tag, notes:'', sets:[{id:newId('s'), type:'Standard', reps:0, weight:null, completed:false}]};
    appendExerciseBlock(ex1);
    appendExerciseBlock(ex2);
    markDirty();
}

function appendExerciseBlock(ex) {
    const list = document.getElementById('exerciseBlocks');
    if (!list) return;

    const block = document.createElement('div');
    block.className = 'form-section';
    block.style.cssText = 'background: var(--bg-primary); border:1px solid var(--border); border-radius:12px; padding: 14px; margin-bottom:12px;';
    block.draggable = true;
    block.dataset.exId = ex.id;

    block.addEventListener('dragstart', (e)=>{ e.dataTransfer.setData('text/plain', ex.id); block.style.opacity='0.6'; });
    block.addEventListener('dragend', ()=>{ block.style.opacity='1'; });
    block.addEventListener('dragover', (e)=>{ e.preventDefault(); });
    block.addEventListener('drop', (e)=>{
        e.preventDefault();
        const fromId = e.dataTransfer.getData('text/plain');
        const toId = ex.id;
        if (fromId && toId && fromId !== toId) {
            reorderExerciseBlocks(fromId, toId);
            markDirty();
        }
    });

    const nameOptions = exerciseLibrary.items.map(n=>`<option value="${escapeAttr(n)}"></option>`).join('');
    const supersetVal = ex.superset ? escapeAttr(ex.superset) : '';

    block.innerHTML = `
        <div style="display:flex; justify-content:space-between; gap:10px; align-items:start; margin-bottom:10px;">
            <div style="flex:1;">
                <label class="required">Exercise</label>
                <input list="exerciseDatalist" type="text" id="exName_${ex.id}" value="${escapeAttr(ex.name||'')}" placeholder="Start typing‚Ä¶">
                <datalist id="exerciseDatalist">${nameOptions}</datalist>
                <div style="display:flex; gap:12px; flex-wrap:wrap; margin-top:8px; align-items:center;">
                    <label style="display:flex; gap:8px; align-items:center; color:var(--text-secondary); font-size:0.9em;">
                        <input type="checkbox" id="exDB_${ex.id}" ${ex.isDumbbell?'checked':''} style="width:auto;"> Dumbbell Exercise
                    </label>
                    <label style="display:flex; gap:8px; align-items:center; color:var(--text-secondary); font-size:0.9em;">
                        <input type="checkbox" id="exBW_${ex.id}" ${ex.isBodyweight?'checked':''} style="width:auto;"> Bodyweight Exercise
                    </label>
                    <label style="display:flex; gap:8px; align-items:center; color:var(--text-secondary); font-size:0.9em;">
                        Superset:
                        <input type="text" id="exSS_${ex.id}" value="${supersetVal}" placeholder="A" style="width:70px;">
                    </label>
                </div>
            </div>
            <div style="display:flex; gap:6px; align-items:center;">
                <button onclick="moveExerciseUp('${ex.id}')" style="padding:6px 10px;">‚Üë</button>
                <button onclick="moveExerciseDown('${ex.id}')" style="padding:6px 10px;">‚Üì</button>
                <button class="danger" onclick="removeExerciseBlock('${ex.id}')" style="padding:6px 10px;">√ó</button>
            </div>
        </div>

        <div>
            <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
                <h4 style="color: var(--accent-cyan);">Sets</h4>
                <button onclick="addSetRow('${ex.id}')" style="padding:6px 12px;">+ Set</button>
            </div>
            <div id="sets_${ex.id}" style="margin-top:8px;"></div>

            <div style="margin-top:10px;">
                <button onclick="toggleExerciseNotes('${ex.id}')" style="padding:6px 12px; background: var(--bg-tertiary);">üìù Notes</button>
                <div id="notes_${ex.id}" style="display:none; margin-top:10px;">
                    <textarea id="exNotes_${ex.id}" maxlength="500" rows="2" placeholder="Form cues, equipment, how it felt‚Ä¶">${escapeHtml(ex.notes||'')}</textarea>
                    <div style="color:var(--text-secondary); font-size:0.85em; margin-top:4px;">Max 500 chars ‚Ä¢ searchable in Overload tab (coming next)</div>
                </div>
            </div>
        </div>
    `;

    list.appendChild(block);

    // Render sets
    (ex.sets||[]).forEach(s => appendSetRow(ex.id, ex, s));

    // Hook changes
    document.getElementById(`exName_${ex.id}`).addEventListener('input', ()=>{ markDirty(); });
    document.getElementById(`exDB_${ex.id}`).addEventListener('change', ()=>{ markDirty(); rerenderSets(ex.id); });
    document.getElementById(`exBW_${ex.id}`).addEventListener('change', ()=>{ markDirty(); rerenderSets(ex.id); });
    document.getElementById(`exSS_${ex.id}`).addEventListener('input', ()=>{ markDirty(); });
    document.getElementById(`exNotes_${ex.id}`).addEventListener('input', ()=>{ markDirty(); });

    // Show previous session preview
    const name = ex.name || '';
    if (name) learnExercise(name);
}

function toggleExerciseNotes(exId) {
    const d = document.getElementById(`notes_${exId}`);
    if (!d) return;
    d.style.display = (d.style.display === 'none') ? 'block' : 'none';
}

function rerenderSets(exId) {
    // re-read block values then re-render set rows display hints (DB/BW fields)
    const block = document.querySelector(`[data-ex-id="${exId}"]`);
    if (!block) return;
    const setsDiv = document.getElementById(`sets_${exId}`);
    if (!setsDiv) return;

    // Collect current set DOM into draft then rerender
    const draft = collectExerciseFromDOM(exId);
    setsDiv.innerHTML = '';
    draft.sets.forEach(s => appendSetRow(exId, draft, s));
}

function appendSetRow(exId, exDraft, set) {
    const setsDiv = document.getElementById(`sets_${exId}`);
    if (!setsDiv) return;

    const row = document.createElement('div');
    row.dataset.setId = set.id;
    row.style.cssText = 'display:grid; grid-template-columns: 120px 1fr 1fr 1fr 110px 60px; gap:10px; align-items:center; margin-bottom:8px;';

    const type = set.type || 'Standard';
    const isDB = !!exDraft.isDumbbell;
    const isBW = !!exDraft.isBodyweight;

    // weight UI
    let weightCell = '';
    if (type === 'Drop Set') {
        weightCell = `<input type="text" id="sDrops_${set.id}" placeholder="225x8 -> 185x6 -> 135x10" value="${escapeAttr(formatDrops(set))}">`;
    } else if (type === 'Rest-Pause') {
        weightCell = `<input type="number" id="sWeight_${set.id}" step="0.5" placeholder="Weight" value="${set.weight ?? ''}">`;
    } else {
        if (isDB) {
            weightCell = `
                <div>
                    <input type="number" id="sDb_${set.id}" step="0.5" placeholder="Per DB" value="${set.db_weight ?? ''}">
                    <div style="font-size:0.75em; color:var(--text-secondary); margin-top:2px;">
                        Total: <span id="sTotal_${set.id}">‚Äî</span>
                    </div>
                </div>`;
        } else if (isBW) {
            const bw = latestBodyweight();
            weightCell = `
                <div>
                    <input type="text" disabled value="${bw ? ('BW ' + bw.toFixed(1)) : 'BW'}">
                    <div style="display:flex; gap:6px; margin-top:6px;">
                        <input type="number" id="sAssist_${set.id}" step="1" placeholder="Assist" value="${set.assistance ?? ''}">
                        <input type="number" id="sAdded_${set.id}" step="1" placeholder="+Wt" value="${set.added ?? ''}">
                    </div>
                </div>`;
        } else {
            weightCell = `<input type="number" id="sWeight_${set.id}" step="0.5" placeholder="Weight" value="${set.weight ?? ''}">`;
        }
    }

    // reps UI
    let repsCell = '';
    if (type === 'Rest-Pause') {
        repsCell = `<input type="text" id="sRP_${set.id}" placeholder="8+3+2" value="${escapeAttr(set.rest_pause || '')}">`;
    } else if (type === 'Drop Set') {
        repsCell = `<span style="color:var(--text-secondary); font-family:'Space Mono', monospace; font-size:0.85em;">(in drop string)</span>`;
    } else {
        repsCell = `<input type="number" id="sReps_${set.id}" step="1" placeholder="Reps" value="${set.reps ?? ''}">`;
    }

    row.innerHTML = `
        <select id="sType_${set.id}">
            ${['Standard','Drop Set','Rest-Pause','Warm-up'].map(t=>`<option ${t===type?'selected':''}>${t}</option>`).join('')}
        </select>
        ${repsCell}
        ${weightCell}
        <button onclick="startRest(90)" style="padding:6px 10px;">Rest</button>
        <label style="display:flex; gap:6px; align-items:center; color:var(--text-secondary); font-size:0.9em;">
            <input type="checkbox" id="sDone_${set.id}" ${set.completed!==false?'checked':''} style="width:auto;">Done
        </label>
        <button class="danger" onclick="removeSetRow('${exId}','${set.id}')" style="padding:6px 10px;">√ó</button>
    `;
    setsDiv.appendChild(row);

    // Wire change handlers
    const setTypeEl = document.getElementById(`sType_${set.id}`);
    setTypeEl.addEventListener('change', ()=>{ markDirty(); rerenderSets(exId); });

    ['sReps_','sWeight_','sDb_','sDrops_','sRP_','sAssist_','sAdded_','sDone_'].forEach(prefix=>{
        const el = document.getElementById(prefix + set.id);
        if (el) el.addEventListener('input', ()=>{ markDirty(); updateSetTotals(set.id); });
        if (el && el.type === 'checkbox') el.addEventListener('change', ()=>{ markDirty(); });
    });

    updateSetTotals(set.id);
}

function formatDrops(set) {
    if (!set.drops || !Array.isArray(set.drops)) return '';
    return set.drops.map(d=>`${d.weight}x${d.reps}`).join(' -> ');
}

function parseDrops(str) {
    // "225x8 -> 185x6 -> 135x10"
    const parts = String(str||'').split('->').map(s=>s.trim()).filter(Boolean);
    const drops = [];
    parts.forEach(p=>{
        const m = p.match(/(\d+(\.\d+)?)\s*x\s*(\d+)/i);
        if (m) drops.push({ weight: Number(m[1]), reps: Number(m[3]) });
    });
    return drops.length ? drops : null;
}

function updateSetTotals(setId) {
    const totalEl = document.getElementById(`sTotal_${setId}`);
    if (!totalEl) return;
    const db = Number(document.getElementById(`sDb_${setId}`)?.value);
    if (isFinite(db)) totalEl.textContent = (db*2).toFixed(1) + ' lbs';
    else totalEl.textContent = '‚Äî';
}

function addSetRow(exId) {
    const block = document.querySelector(`[data-ex-id="${exId}"]`);
    if (!block) return;
    const setsDiv = document.getElementById(`sets_${exId}`);
    if (!setsDiv) return;

    // append DOM row by re-render: collect existing exercise, add set, rerender
    const draft = collectExerciseFromDOM(exId);
    draft.sets.push({ id:newId('s'), type:'Standard', reps:0, weight:null, db_weight:null, completed:false });
    setsDiv.innerHTML = '';
    draft.sets.forEach(s=>appendSetRow(exId, draft, s));
    markDirty();
}

function removeSetRow(exId, setId) {
    const draft = collectExerciseFromDOM(exId);
    draft.sets = draft.sets.filter(s=>s.id!==setId);
    if (draft.sets.length===0) draft.sets=[{id:newId('s'), type:'Standard', reps:0, weight:null, completed:false}];
    const setsDiv = document.getElementById(`sets_${exId}`);
    setsDiv.innerHTML = '';
    draft.sets.forEach(s=>appendSetRow(exId, draft, s));
    markDirty();
}

function removeExerciseBlock(exId) {
    const el = document.querySelector(`[data-ex-id="${exId}"]`);
    if (el) el.remove();
    markDirty();
}

function moveExerciseUp(exId) {
    const el = document.querySelector(`[data-ex-id="${exId}"]`);
    if (!el || !el.previousElementSibling) return;
    el.parentElement.insertBefore(el, el.previousElementSibling);
    markDirty();
}

function moveExerciseDown(exId) {
    const el = document.querySelector(`[data-ex-id="${exId}"]`);
    if (!el || !el.nextElementSibling) return;
    el.parentElement.insertBefore(el.nextElementSibling, el);
    markDirty();
}

function reorderExerciseBlocks(fromId, toId) {
    const fromEl = document.querySelector(`[data-ex-id="${fromId}"]`);
    const toEl = document.querySelector(`[data-ex-id="${toId}"]`);
    if (!fromEl || !toEl) return;
    toEl.parentElement.insertBefore(fromEl, toEl);
}

function collectExerciseFromDOM(exId) {
    const name = document.getElementById(`exName_${exId}`)?.value || '';
    const isDumbbell = !!document.getElementById(`exDB_${exId}`)?.checked;
    const isBodyweight = !!document.getElementById(`exBW_${exId}`)?.checked;
    const superset = document.getElementById(`exSS_${exId}`)?.value || null;
    const notes = document.getElementById(`exNotes_${exId}`)?.value || '';
    learnExercise(name);

    const setsDiv = document.getElementById(`sets_${exId}`);
    const sets = [];
    if (setsDiv) {
        setsDiv.querySelectorAll('[data-set-id]').forEach(row=>{
            const sid = row.dataset.setId;
            const type = document.getElementById(`sType_${sid}`)?.value || 'Standard';
            const completed = document.getElementById(`sDone_${sid}`)?.checked ?? true;

            let reps = Number(document.getElementById(`sReps_${sid}`)?.value || 0);
            let weight = document.getElementById(`sWeight_${sid}`)?.value;
            weight = (weight === '' || weight === undefined) ? null : Number(weight);
            let db_weight = document.getElementById(`sDb_${sid}`)?.value;
            db_weight = (db_weight === '' || db_weight === undefined) ? null : Number(db_weight);

            const rest_pause = document.getElementById(`sRP_${sid}`)?.value || null;
            const dropsStr = document.getElementById(`sDrops_${sid}`)?.value || null;
            const drops = dropsStr ? parseDrops(dropsStr) : null;

            let assistance = document.getElementById(`sAssist_${sid}`)?.value;
            assistance = (assistance === '' || assistance === undefined) ? null : Number(assistance);

            let added = document.getElementById(`sAdded_${sid}`)?.value;
            added = (added === '' || added === undefined) ? null : Number(added);

            sets.push({ id: sid, type, reps, weight, db_weight, rest_pause, drops, assistance, added, completed });
        });
    }

    return { id: exId, name, isDumbbell, isBodyweight, superset: superset || null, notes, sets };
}

function saveWorkoutFromModal(existingId) {
    const btn = document.getElementById('saveWorkoutBtn');
    if (btn) { btn.disabled = true; btn.textContent = 'Saving‚Ä¶'; }

    try {
        const modal = document.getElementById('trainingModal');
        const date = document.getElementById('wDate')?.value;
        if (!date) throw new Error('Date is required.');

        // collect workout
        const w = {
            id: existingId || newId('w'),
            date,
            startTime: (document.getElementById('wTime')?.value || '').trim() || null,
            title: (document.getElementById('wTitle')?.value || '').trim() || null,
            type: document.getElementById('wType')?.value || 'Workout',
            notes: (document.getElementById('wNotes')?.value || '').trim(),
            exercises: []
        };

        document.querySelectorAll('#exerciseBlocks [data-ex-id]').forEach(block=>{
            const exId = block.dataset.exId;
            const ex = collectExerciseFromDOM(exId);
            if (!ex.name.trim()) return;
            // validation: at least one set with reps
            w.exercises.push(ex);
        });

        if (w.exercises.length === 0) throw new Error('Add at least 1 exercise with a name.');

        // Save into store (allow multiple per day)
        trainingStore.workouts = (trainingStore.workouts || []).filter(x=>x.id !== w.id);
        trainingStore.workouts.push(w);
        trainingStore.workouts.sort((a,b)=> (a.date + (a.startTime||'' )).localeCompare(b.date + (b.startTime||'')));

        saveTraining();
        markDirty(); // ensures persistAll also saves body data status badge
        __dirty = false;
        __lastSavedAt = new Date();
        updateSaveIndicator('Saved ‚úì');

        showToast('Workout Saved Successfully ‚úì');
        hideTrainingModal();
        updateTrainingTab();
        updateProgressiveTab(); // refresh overload insights
    } catch (err) {
        showToast(`Save failed: ${err.message || err}`, true);
    } finally {
        if (btn) { btn.disabled = false; btn.textContent = 'Save Workout'; }
    }
}

function deleteWorkout(id) {
    if (!confirm('Delete this workout?')) return;
    trainingStore.workouts = (trainingStore.workouts || []).filter(w=>w.id!==id);
    saveTraining();
    markDirty();
    updateTrainingTab();
    updateProgressiveTab();
    showToast('Workout deleted');
}

// ----- Templates -----
function saveWorkoutAsTemplate(workoutId) {
    try {
        // collect current modal workout as template
        const name = prompt('Template name?', 'My Template');
        if (!name) return;

        const w = {
            id: newId('tpl'),
            name: name.trim(),
            created_at: _nowIso(),
            workout: {
                title: (document.getElementById('wTitle')?.value || '').trim() || null,
                type: document.getElementById('wType')?.value || 'Workout',
                exercises: []
            }
        };

        document.querySelectorAll('#exerciseBlocks [data-ex-id]').forEach(block=>{
            const exId = block.dataset.exId;
            const ex = collectExerciseFromDOM(exId);
            if (!ex.name.trim()) return;
            // remove set completion state for template
            ex.sets = (ex.sets||[]).map(s=>({ ...s, completed:false }));
            w.workout.exercises.push(ex);
        });

        workoutTemplates.templates.push(w);
        saveTemplates();
        markDirty();
        showToast('Template saved ‚úì');
    } catch (e) {
        showToast('Template save failed', true);
    }
}

function openTemplateManager() {
    const modal = document.getElementById('trainingModal');
    const rows = workoutTemplates.templates.map(t=>`
        <div style="background: var(--bg-tertiary); padding: 12px; border-radius: 10px; margin-bottom: 10px; display:flex; justify-content:space-between; align-items:center; gap:10px;">
            <div>
                <div style="font-weight:700; color: var(--accent-cyan);">${escapeHtml(t.name)}</div>
                <div style="color: var(--text-secondary); font-size:0.85em; font-family:'Space Mono', monospace;">${t.created_at?.slice(0,10) || ''}</div>
            </div>
            <div style="display:flex; gap:8px; flex-wrap:wrap;">
                <button onclick="applyTemplate('${t.id}')" class="primary" style="padding:6px 12px;">Apply</button>
                <button onclick="renameTemplate('${t.id}')" style="padding:6px 12px;">Rename</button>
                <button class="danger" onclick="deleteTemplate('${t.id}')" style="padding:6px 12px;">√ó</button>
            </div>
        </div>
    `).join('');

    modal.innerHTML = `
        <div class="modal">
            <h2>Workout Templates</h2>
            <p style="color: var(--text-secondary); margin-bottom: 12px;">Apply templates to plan today‚Äôs workout. Templates store exercises + set structure.</p>
            <div style="max-height:55vh; overflow:auto;">${rows || `<p style="color:var(--text-secondary);">No templates yet. Save one from a workout.</p>`}</div>
            <div style="display:flex; gap:10px; margin-top: 18px;">
                <button onclick="hideTrainingModal()">Close</button>
            </div>
        </div>
    `;
    modal.classList.add('show');
}

function applyTemplate(tplId) {
    const t = workoutTemplates.templates.find(x=>x.id===tplId);
    if (!t) return;
    hideTrainingModal();
    const date = new Date().toISOString().split('T')[0];
    const w = {
        id: newId('w'),
        date,
        startTime: null,
        title: t.workout.title || t.name,
        type: t.workout.type || 'Workout',
        notes: '',
        exercises: (t.workout.exercises||[]).map(ex=>({
            ...ex,
            id: newId('ex'),
            sets: (ex.sets||[]).map(s=>({ ...s, id:newId('s'), completed:false }))
        }))
    };
    const modal = document.getElementById('trainingModal');
    modal.innerHTML='';
    renderWorkoutModal(w, true);
    modal.classList.add('show');
}

function renameTemplate(tplId) {
    const t = workoutTemplates.templates.find(x=>x.id===tplId);
    if (!t) return;
    const name = prompt('New template name:', t.name);
    if (!name) return;
    t.name = name.trim();
    saveTemplates();
    markDirty();
    openTemplateManager();
}

function deleteTemplate(tplId) {
    if (!confirm('Delete template?')) return;
    workoutTemplates.templates = workoutTemplates.templates.filter(x=>x.id!==tplId);
    saveTemplates();
    markDirty();
    openTemplateManager();
}

// ----- Live Mode -----
function toggleLiveMode() {
    liveMode.running = !liveMode.running;
    if (liveMode.running) {
        liveMode.startTs = Date.now();
        liveMode.elapsedTimer = setInterval(()=>{
            liveMode.elapsedSec = Math.floor((Date.now() - liveMode.startTs)/1000);
            renderLiveModeBar();
        }, 1000);
        showToast('Live Mode started');
    } else {
        if (liveMode.elapsedTimer) clearInterval(liveMode.elapsedTimer);
        liveMode.elapsedTimer = null;
        liveMode.elapsedSec = 0;
        liveMode.startTs = null;
        showToast('Live Mode stopped');
        renderLiveModeBar();
    }
}

function startRest(seconds) {
    const sec = Number(seconds||90);
    liveMode.restUntil = Date.now() + (sec*1000);
    if (liveMode.restTimer) clearInterval(liveMode.restTimer);
    liveMode.restTimer = setInterval(()=>{
        const left = Math.max(0, Math.ceil((liveMode.restUntil - Date.now())/1000));
        if (left <= 0) {
            clearInterval(liveMode.restTimer);
            liveMode.restTimer = null;
            liveMode.restUntil = null;
            if (navigator.vibrate) navigator.vibrate([200,100,200]);
            showToast('Rest complete ‚úì');
        }
        renderLiveModeBar();
    }, 500);
    renderLiveModeBar();
}

function renderLiveModeBar() {
    const el = document.getElementById('liveModeBar');
    if (!el) return;
    const fmt = (s)=>`${Math.floor(s/60)}:${String(s%60).padStart(2,'0')}`;
    const elapsed = liveMode.running ? fmt(liveMode.elapsedSec) : '0:00';
    let rest = '';
    if (liveMode.restUntil) {
        const left = Math.max(0, Math.ceil((liveMode.restUntil - Date.now())/1000));
        rest = ` ‚Ä¢ Rest: <b>${fmt(left)}</b>`;
    }
    el.innerHTML = `<div style="font-family:'Space Mono', monospace; color: var(--text-secondary);">
        ‚è± Elapsed: <b>${elapsed}</b>${rest}
    </div>`;
}

// ----- Health stats card (dashboard) -----
function updateHealthStatsCard() {
    const el = document.getElementById('healthStatsContent');
    if (!el) return;
    const sorted = bodyData.slice().sort((a,b)=>a.date.localeCompare(b.date));
    const last7 = sorted.slice(-7);
    const avg = (arr, key) => {
        const vals = arr.map(x=>x[key]).filter(v=>isFinite(v));
        if (!vals.length) return null;
        return vals.reduce((a,b)=>a+b,0)/vals.length;
    };
    const metrics = [
        { key:'steps', label:'Steps', fmt:(v)=>v?Math.round(v).toLocaleString():'‚Äî' },
        { key:'rhr', label:'RHR (bpm)', fmt:(v)=>v?Math.round(v).toString():'‚Äî' },
        { key:'sleep_score', label:'Sleep Score', fmt:(v)=>v?Math.round(v).toString():'‚Äî' },
        { key:'sleep_duration_hrs', label:'Sleep (hrs)', fmt:(v)=>v?v.toFixed(1):'‚Äî' },
    ];
    const rows = metrics.map(m=>{
        const all = avg(sorted, m.key);
        const r7 = avg(last7, m.key);
        const trend = (all && r7) ? ((r7 - all)/all) : null;
        const good = trend !== null && ((m.key==='rhr') ? (r7 < all) : (r7 > all));
        const equal = trend !== null && Math.abs(trend) <= 0.02;
        const icon = trend===null ? '‚Üí' : (equal ? '‚Üí' : (good ? '‚úì' : '‚Üì'));
        const color = trend===null ? 'var(--text-secondary)' : (equal ? 'var(--text-secondary)' : (good ? 'var(--accent-success)' : 'var(--accent-danger)'));
        return `<tr>
            <td>${m.label}</td>
            <td style="font-family:'Space Mono', monospace;">${all!==null?m.fmt(all):'‚Äî'}</td>
            <td style="font-family:'Space Mono', monospace; color:${color};">${r7!==null?m.fmt(r7):'‚Äî'} ${icon}</td>
        </tr>`;
    }).join('');
    el.innerHTML = `
        <div class="table-container" style="max-height:none;">
            <table>
                <thead><tr><th>Metric</th><th>All-Time</th><th>Last 7 Days</th></tr></thead>
                <tbody>${rows}</tbody>
            </table>
        </div>
        <div style="margin-top:10px; color: var(--text-secondary); font-size:0.85em;">
            ‚úì indicates improvement (lower RHR is better; higher steps/sleep is better). Within ¬±2% shows ‚Üí.
        </div>
    `;
}

// Hook training functions into existing tab navigation
const __oldSwitchMainTab = window.switchMainTab;
window.switchMainTab = function(tabName) {
    __oldSwitchMainTab(tabName);
    if (tabName === 'training') updateTrainingTab();
    if (tabName === 'progressive') updateProgressiveTab();
};

// ===== END TRAINING TAB (v12) =====

        // ===== CORRELATIONS TAB =====
        
        function updateCorrelationsTab() {
            const sorted = bodyData.slice().sort((a, b) => a.date.localeCompare(b.date));
            
            if (sorted.length < 14) {
                document.getElementById('correlationsContent').innerHTML = `
                    <div style="background: var(--bg-tertiary); padding: 30px; border-radius: 10px; text-align: center;">
                        <h3 style="color: var(--accent-purple); margin-bottom: 15px;">üîç Not Enough Data Yet</h3>
                        <p style="color: var(--text-secondary);">
                            Need at least 14 days of data to show meaningful correlations.<br>
                            You have ${sorted.length} days - keep tracking!
                        </p>
                    </div>
                `;
                return;
            }
            
            // Calculate correlations
            const withNutrition = sorted.filter(d => d.calories && d.protein);
            const recent30 = sorted.slice(-30);
            
            // Fat loss correlation with protein intake
            let proteinCorrelation = 'Unknown';
            if (withNutrition.length >= 14) {
                const avgProtein = withNutrition.reduce((sum, d) => sum + d.protein, 0) / withNutrition.length;
                const latest = withNutrition[withNutrition.length - 1];
                const proteinPerLb = latest.lean_lbs ? avgProtein / latest.lean_lbs : 0;
                
                if (proteinPerLb >= 1.0) {
                    proteinCorrelation = 'Excellent';
                } else if (proteinPerLb >= 0.8) {
                    proteinCorrelation = 'Good';
                } else if (proteinPerLb >= 0.6) {
                    proteinCorrelation = 'Fair';
                } else {
                    proteinCorrelation = 'Low';
                }
            }
            
            // Calculate fat loss rate
            const first = recent30[0];
            const last = recent30[recent30.length - 1];
            const fatLost = (first.weight * first.bf_percent / 100) - (last.weight * last.bf_percent / 100);
            const leanChange = last.lean_lbs - first.lean_lbs;
            const daysSpan = recent30.length;
            const fatLossRate = (fatLost / daysSpan) * 7;
            
            // Sleep correlation
            const withSleep = recent30.filter(d => d.sleep_duration_hrs);
            let avgSleep = 0;
            if (withSleep.length > 0) {
                avgSleep = withSleep.reduce((sum, d) => sum + d.sleep_duration_hrs, 0) / withSleep.length;
            }
            
            // Steps correlation
            const withSteps = recent30.filter(d => d.steps);
            let avgSteps = 0;
            if (withSteps.length > 0) {
                avgSteps = withSteps.reduce((sum, d) => sum + d.steps, 0) / withSteps.length;
            }
            
            const html = `
                <div class="grid grid-2">
                    <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 10px;">
                        <h3 style="color: var(--accent-purple); margin-bottom: 15px;">üìâ Fat Loss Progress (Last 30 Days)</h3>
                        <div class="nutrition-card">
                            <div class="nutrition-label">Fat Loss Rate</div>
                            <div class="nutrition-value">${fatLossRate.toFixed(2)} lbs/week</div>
                        </div>
                        <div class="nutrition-card">
                            <div class="nutrition-label">Total Fat Lost</div>
                            <div class="nutrition-value">${fatLost.toFixed(1)} lbs</div>
                        </div>
                        <div class="nutrition-card">
                            <div class="nutrition-label">Lean Mass Change</div>
                            <div class="nutrition-value" style="color: ${leanChange >= 0 ? 'var(--accent-success)' : 'var(--accent-danger)'}">
                                ${leanChange >= 0 ? '+' : ''}${leanChange.toFixed(1)} lbs
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 10px;">
                        <h3 style="color: var(--accent-purple); margin-bottom: 15px;">ü•© Protein Intake Analysis</h3>
                        <div class="nutrition-card">
                            <div class="nutrition-label">Protein Status</div>
                            <div class="nutrition-value" style="font-size: 1.3em; color: ${
                                proteinCorrelation === 'Excellent' ? 'var(--accent-success)' :
                                proteinCorrelation === 'Good' ? 'var(--accent-cyan)' :
                                proteinCorrelation === 'Fair' ? 'var(--accent-warning)' : 'var(--accent-danger)'
                            }">
                                ${proteinCorrelation}
                            </div>
                        </div>
                        <p style="color: var(--text-secondary); font-size: 0.9em; margin-top: 10px;">
                            ${proteinCorrelation === 'Excellent' ? 'Great job! Your protein intake is supporting lean mass retention.' :
                              proteinCorrelation === 'Good' ? 'Good protein intake. Consider increasing slightly for better muscle retention.' :
                              proteinCorrelation === 'Fair' ? 'Protein is adequate but could be higher for optimal muscle retention.' :
                              'Consider increasing protein intake to preserve lean mass during fat loss.'}
                        </p>
                    </div>
                </div>
                
                <div class="grid grid-2" style="margin-top: 20px;">
                    <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 10px;">
                        <h3 style="color: var(--accent-purple); margin-bottom: 15px;">üò¥ Sleep Analysis</h3>
                        <div class="nutrition-card">
                            <div class="nutrition-label">Average Sleep</div>
                            <div class="nutrition-value">${avgSleep > 0 ? avgSleep.toFixed(1) + ' hrs' : 'No data'}</div>
                        </div>
                        ${avgSleep > 0 ? `
                        <p style="color: var(--text-secondary); font-size: 0.9em; margin-top: 10px;">
                            ${avgSleep >= 7.5 ? '‚úÖ Excellent sleep duration supports recovery and fat loss.' :
                              avgSleep >= 6.5 ? '‚ö†Ô∏è Sleep is adequate but could be improved for better results.' :
                              '‚ùå Sleep duration is low. Aim for 7-9 hours for optimal recovery.'}
                        </p>
                        ` : ''}
                    </div>
                    
                    <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 10px;">
                        <h3 style="color: var(--accent-purple); margin-bottom: 15px;">üö∂ Activity Level</h3>
                        <div class="nutrition-card">
                            <div class="nutrition-label">Average Daily Steps</div>
                            <div class="nutrition-value">${avgSteps > 0 ? Math.round(avgSteps).toLocaleString() : 'No data'}</div>
                        </div>
                        ${avgSteps > 0 ? `
                        <p style="color: var(--text-secondary); font-size: 0.9em; margin-top: 10px;">
                            ${avgSteps >= 10000 ? '‚úÖ Excellent activity level! This supports your fat loss goals.' :
                              avgSteps >= 7500 ? 'üëç Good activity level. Consider increasing to 10k+ for faster progress.' :
                              avgSteps >= 5000 ? '‚ö†Ô∏è Moderate activity. Increasing steps could accelerate fat loss.' :
                              '‚ùå Low activity. Increasing daily movement would help with fat loss.'}
                        </p>
                        ` : ''}
                    </div>
                </div>
                
                ${trainingLog.length > 0 ? `
                <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 10px; margin-top: 20px;">
                    <h3 style="color: var(--accent-purple); margin-bottom: 15px;">üèãÔ∏è Training Frequency</h3>
                    <div class="nutrition-card">
                        <div class="nutrition-label">Total Workouts Logged</div>
                        <div class="nutrition-value">${trainingLog.length}</div>
                    </div>
                    <p style="color: var(--text-secondary); font-size: 0.9em; margin-top: 10px;">
                        ${trainingLog.length >= 20 ? 'üî• Excellent training consistency! Keep it up!' :
                          trainingLog.length >= 10 ? 'üí™ Good training frequency. Stay consistent!' :
                          'üìà Building training history. Consistency is key for results!'}
                    </p>
                </div>
                ` : `
                <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 10px; margin-top: 20px; text-align: center;">
                    <h3 style="color: var(--accent-purple); margin-bottom: 15px;">üèãÔ∏è No Training Data Yet</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 15px;">
                        Start logging workouts to see training correlations with body composition changes.
                    </p>
                    <button onclick="switchMainTab('training'); this.blur();" class="primary">Go to Training Log</button>
                </div>
                `}
                
                <div style="background: rgba(6, 182, 212, 0.1); padding: 20px; border-radius: 10px; margin-top: 20px; border-left: 4px solid var(--accent-cyan);">
                    <h3 style="color: var(--accent-cyan); margin-bottom: 10px;">üí° Key Insights</h3>
                    <ul style="color: var(--text-secondary); line-height: 1.8;">
                        <li>You're losing ${fatLossRate.toFixed(2)} lbs of fat per week on average</li>
                        <li>Lean mass change: ${leanChange >= 0 ? 'gaining' : 'losing'} ${Math.abs(leanChange).toFixed(1)} lbs (${leanChange >= -1 ? 'good retention' : 'consider increasing protein'})</li>
                        ${avgSleep > 0 ? `<li>Average sleep: ${avgSleep.toFixed(1)} hours (${avgSleep >= 7.5 ? 'optimal' : 'could improve'})</li>` : ''}
                        ${avgSteps > 0 ? `<li>Daily steps: ${Math.round(avgSteps).toLocaleString()} (${avgSteps >= 10000 ? 'excellent' : 'room for improvement'})</li>` : ''}
                        <li>Keep tracking consistently for more detailed correlations</li>
                    </ul>
                </div>
            `;
            
            document.getElementById('correlationsContent').innerHTML = html;
        }
        
        
        function escapeHTML(str) {
            if (str === null || str === undefined) return '';
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

// ===== UTILITY FUNCTIONS =====

function escapeHtml(str) {
    return String(str ?? '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}
function escapeAttr(str) {
    return escapeHtml(str).replace(/`/g,'&#96;');
}

        
        
        function closePRModal() {
            document.getElementById('prCelebrationModal').classList.remove('show');
        }
        
function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast show';
            if (isError) toast.classList.add('error');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
        
        function debugData() {
            console.log('=== BODY TRACKER DEBUG ===');
            console.log('Total entries:', bodyData.length);
            console.log('Storage key:', STORAGE_KEY);
            console.log('Goals:', GOALS);
            console.log('Integrity config:', INTEGRITY_CONFIG);
            console.log('Data sample:', bodyData.slice(0, 3));
            console.log('Latest entry:', bodyData[bodyData.length - 1]);
            
            // Integrity distribution
            const integrityCount = bodyData.reduce((acc, e) => {
                acc[e.integrity_status || 'unknown'] = (acc[e.integrity_status || 'unknown'] || 0) + 1;
                return acc;
            }, {});
            console.log('Integrity distribution:', integrityCount);
            
            // Residual stats
            const residuals = bodyData.filter(e => e.residual !== undefined).map(e => e.residual);
            if (residuals.length > 0) {
                const avgResidual = residuals.reduce((sum, r) => sum + r, 0) / residuals.length;
                const minResidual = Math.min(...residuals);
                const maxResidual = Math.max(...residuals);
                console.log('Residual stats:', {
                    avg: avgResidual.toFixed(2),
                    min: minResidual.toFixed(2),
                    max: maxResidual.toFixed(2),
                    range: (maxResidual - minResidual).toFixed(2)
                });
            }
            
            showToast('Debug info logged to console\n(Press F12 to view)');
        }
        
        
        // ===== SETTINGS + FORMULA DOCS + ANALYTICS (V13) =====
        const SETTINGS_KEY = 'btpSettings';
        const PR_KEY = 'btpPersonalRecords_v1';

        const DEFAULT_SETTINGS = {
            nutrition: { target_calories: 1800, target_protein: 195, target_fat: 60, target_carbs: 80 },
            body: { target_bf_lbs: 20.0, target_bf_percent: 10.0, target_weight: 215.0 },
            workout: { default_rest_seconds: 90, warmup_excluded: true, show_est_1rm: true },
            display: { units: 'lbs', date_format: 'YYYY-MM-DD', compact_tables: false, show_water_overlay: true },
            sync: { auto_pull_seconds: 60, auto_push: false }
        };

        let appSettings = null;
        let personalRecords = null;

        function loadSettings() {
            const stored = localStorage.getItem(SETTINGS_KEY);
            if (stored) {
                try { appSettings = JSON.parse(stored); } catch { appSettings = null; }
            }
            if (!appSettings) appSettings = JSON.parse(JSON.stringify(DEFAULT_SETTINGS));
            // merge defaults
            appSettings = deepMerge(JSON.parse(JSON.stringify(DEFAULT_SETTINGS)), appSettings);
            saveSettings(false);
        }

        function saveSettings(showToastMsg=true) {
            localStorage.setItem(SETTINGS_KEY, JSON.stringify(appSettings));
            // Apply to GOALS object if those fields exist
            GOALS.target_weight = appSettings.body.target_weight;
            GOALS.target_bf_percent = appSettings.body.target_bf_percent;
            GOALS.target_bf_lbs = appSettings.body.target_bf_lbs;
            GOALS.target_calories = appSettings.nutrition.target_calories;
            GOALS.target_protein = appSettings.nutrition.target_protein;
            GOALS.target_fat = appSettings.nutrition.target_fat;
            GOALS.target_carbs = appSettings.nutrition.target_carbs;
            if (showToastMsg) showToast('Settings saved');
        }

        function deepMerge(target, source) {
            if (typeof target !== 'object' || target === null) return source;
            if (typeof source !== 'object' || source === null) return target;
            for (const k of Object.keys(source)) {
                if (source[k] && typeof source[k] === 'object' && !Array.isArray(source[k])) {
                    target[k] = deepMerge(target[k] || {}, source[k]);
                } else {
                    target[k] = source[k];
                }
            }
            return target;
        }

        function openSettings() {
            loadSettings();
            const modal = document.getElementById('settingsModal');
            modal.innerHTML = `
              <div class="modal">
                <h2>‚öôÔ∏è Settings & Preferences</h2>
                <div class="integrity-notice">
                  <h4>Persistent Settings</h4>
                  <p>These preferences are stored locally (btpSettings) and apply immediately.</p>
                </div>

                <div class="form-section">
                  <h3>Nutrition Targets</h3>
                  <div class="form-grid">
                    <div class="form-field"><label>Target Calories</label><input type="number" id="setCals" value="${appSettings.nutrition.target_calories}"></div>
                    <div class="form-field"><label>Target Protein (g)</label><input type="number" id="setPro" value="${appSettings.nutrition.target_protein}"></div>
                    <div class="form-field"><label>Target Fat (g)</label><input type="number" id="setFat" value="${appSettings.nutrition.target_fat}"></div>
                    <div class="form-field"><label>Target Carbs (g)</label><input type="number" id="setCarb" value="${appSettings.nutrition.target_carbs}"></div>
                  </div>
                </div>

                <div class="form-section">
                  <h3>Body Composition Goals</h3>
                  <div class="form-grid">
                    <div class="form-field"><label>Target BF lbs</label><input type="number" step="0.1" id="setBfLbs" value="${appSettings.body.target_bf_lbs}"></div>
                    <div class="form-field"><label>Target BF %</label><input type="number" step="0.1" id="setBfPct" value="${appSettings.body.target_bf_percent}"></div>
                    <div class="form-field"><label>Target Weight</label><input type="number" step="0.1" id="setWgt" value="${appSettings.body.target_weight}"></div>
                  </div>
                </div>

                <div class="form-section">
                  <h3>Workout Preferences</h3>
                  <div class="form-grid">
                    <div class="form-field"><label>Default Rest (sec)</label><input type="number" id="setRest" value="${appSettings.workout.default_rest_seconds}"></div>
                    <div class="form-field"><label><input type="checkbox" id="setShow1rm" ${appSettings.workout.show_est_1rm?'checked':''} style="width:auto; margin-right:8px;">Show estimated 1RM</label></div>
                  </div>
                </div>

                <div class="form-section">
                  <h3>Display Preferences</h3>
                  <div class="form-grid">
                    <div class="form-field"><label><input type="checkbox" id="setWater" ${appSettings.display.show_water_overlay?'checked':''} style="width:auto; margin-right:8px;">Show Water % overlay tab</label></div>
                    <div class="form-field"><label><input type="checkbox" id="setCompact" ${appSettings.display.compact_tables?'checked':''} style="width:auto; margin-right:8px;">Compact tables</label></div>
                  </div>
                </div>

                <div class="form-section">
                  <h3>Data Management</h3>
                  <div style="display:flex; gap:10px; flex-wrap: wrap;">
                    <button onclick="exportBackup()" style="background: var(--accent-cyan);">üíæ Backup JSON</button>
                    <button onclick="exportCSV()">üì• Export CSV</button>
                    <button class="danger" onclick="resetTrainingOnly()">Reset Training Only</button>
                    <button class="danger" onclick="resetAllAppData()">Reset ALL Data</button>
                  </div>
                  <div style="font-size:0.85em; color: var(--text-secondary); margin-top: 8px;">
                    Reset actions affect only this device unless you use Sync.
                  </div>
                </div>

                <div style="display:flex; gap: 10px; flex-wrap:wrap; margin-top: 18px;">
                  <button class="primary" onclick="applySettings()">Save & Apply</button>
                  <button onclick="closeSettings()">Close</button>
                </div>
              </div>
            `;
            modal.classList.add('show');
          }

        function applySettings() {
            appSettings.nutrition.target_calories = Number(document.getElementById('setCals').value) || DEFAULT_SETTINGS.nutrition.target_calories;
            appSettings.nutrition.target_protein = Number(document.getElementById('setPro').value) || DEFAULT_SETTINGS.nutrition.target_protein;
            appSettings.nutrition.target_fat = Number(document.getElementById('setFat').value) || DEFAULT_SETTINGS.nutrition.target_fat;
            appSettings.nutrition.target_carbs = Number(document.getElementById('setCarb').value) || DEFAULT_SETTINGS.nutrition.target_carbs;
            appSettings.body.target_bf_lbs = Number(document.getElementById('setBfLbs').value) || DEFAULT_SETTINGS.body.target_bf_lbs;
            appSettings.body.target_bf_percent = Number(document.getElementById('setBfPct').value) || DEFAULT_SETTINGS.body.target_bf_percent;
            appSettings.body.target_weight = Number(document.getElementById('setWgt').value) || DEFAULT_SETTINGS.body.target_weight;
            appSettings.workout.default_rest_seconds = Number(document.getElementById('setRest').value) || DEFAULT_SETTINGS.workout.default_rest_seconds;
            appSettings.workout.show_est_1rm = !!document.getElementById('setShow1rm').checked;
            appSettings.display.show_water_overlay = !!document.getElementById('setWater').checked;
            appSettings.display.compact_tables = !!document.getElementById('setCompact').checked;
            saveSettings(true);
            updateStats(); updateTable(); updateChart();
            closeSettings();
        }

        function closeSettings() { document.getElementById('settingsModal').classList.remove('show'); }

        function resetTrainingOnly() {
            if (!confirm('Reset training only on this device?')) return;
            try { localStorage.removeItem(TRAINING_KEY); } catch {}
            try { localStorage.removeItem('workoutTemplates_User1_v6'); } catch {}
            try { localStorage.removeItem('exerciseLibrary_User1_v7'); } catch {}
            trainingLog = [];
            updateTrainingTab();
            showToast('Training reset');
        }

        function resetAllAppData() {
            if (!confirm('Reset ALL tracker data on this device?')) return;
            localStorage.clear();
            location.reload();
        }

        
        // ===== BULK EDIT / IMPORT (V13) =====
        function openBulkEdit() {
            const modal = document.getElementById('settingsModal');
            if (!modal) { showToast('Settings modal not available', true); return; }
            const sorted = bodyData.slice().sort((a,b)=>a.date.localeCompare(b.date));
            const header = ['date','weight','bf_percent','lean_lbs','water_percent','calories','protein','fat','carbs','steps','rhr','sleep_score','sleep_duration_hrs','refeed','notes'];
            const lines = [header.join(',')].concat(sorted.map(e=>header.map(k=>{
                const v = e[k];
                if (k==='notes') return `"${String(v||'').replace(/"/g,'""')}"`;
                if (k==='refeed') return e.refeed ? 'Yes' : 'No';
                return (v==null || v===undefined) ? '' : v;
            }).join(',')));
            modal.innerHTML = `
              <div class="modal">
                <h2>üßæ Bulk Edit Body Data</h2>
                <div class="integrity-notice">
                  <h4>Paste / Edit CSV</h4>
                  <p>Edit the CSV below and click Apply. Your data will be re-parsed and validated.</p>
                </div>
                <div class="form-section">
                  <textarea id="bulkCsv" rows="14" style="width:100%; background: var(--bg-primary); color: var(--text-primary); border:1px solid var(--border); border-radius:10px; padding:12px; font-family:'Space Mono', monospace; font-size:0.8em;">${lines.join('\n')}</textarea>
                  <div style="color: var(--text-secondary); font-size:0.85em; margin-top:8px;">
                    Tip: Leave blanks for unknown values. Dates must be YYYY-MM-DD.
                  </div>
                </div>
                <div style="display:flex; gap:10px; flex-wrap:wrap;">
                  <button class="primary" onclick="applyBulkCsv()">Apply CSV</button>
                  <button onclick="closeSettings()">Close</button>
                </div>
              </div>
            `;
            modal.classList.add('show');
        }

        function parseCsvLine(line) {
            // basic CSV parser handling quotes
            const out=[]; let cur=''; let inQ=false;
            for (let i=0;i<line.length;i++){
                const ch=line[i];
                if (ch === '"') {
                    if (inQ && line[i+1]==='"') { cur+='"'; i++; }
                    else inQ=!inQ;
                } else if (ch===',' && !inQ) { out.push(cur); cur=''; }
                else cur+=ch;
            }
            out.push(cur);
            return out;
        }

        function applyBulkCsv() {
            const ta = document.getElementById('bulkCsv');
            if (!ta) return;
            const text = ta.value.trim();
            const lines = text.split(/\r?\n/).filter(l=>l.trim().length);
            if (lines.length < 2) { showToast('CSV needs header + rows', true); return; }
            const header = parseCsvLine(lines[0]).map(h=>h.trim());
            const required = ['date','weight','bf_percent','lean_lbs'];
            for (const r of required){ if (!header.includes(r)) { showToast(`Missing required column: ${r}`, true); return; } }
            const rows = [];
            for (let i=1;i<lines.length;i++){
                const cols = parseCsvLine(lines[i]);
                const row = {};
                header.forEach((h, idx)=> row[h] = (cols[idx]!==undefined ? cols[idx] : ''));
                const e = {
                    date: row.date.trim(),
                    weight: row.weight===''? null : Number(row.weight),
                    bf_percent: row.bf_percent===''? null : Number(row.bf_percent),
                    lean_lbs: row.lean_lbs===''? null : Number(row.lean_lbs),
                    water_percent: row.water_percent===''? null : Number(row.water_percent),
                    calories: row.calories===''? null : Number(row.calories),
                    protein: row.protein===''? null : Number(row.protein),
                    fat: row.fat===''? null : Number(row.fat),
                    carbs: row.carbs===''? null : Number(row.carbs),
                    steps: row.steps===''? null : Number(row.steps),
                    rhr: row.rhr===''? null : Number(row.rhr),
                    sleep_score: row.sleep_score===''? null : Number(row.sleep_score),
                    sleep_duration_hrs: row.sleep_duration_hrs===''? null : Number(row.sleep_duration_hrs),
                    refeed: String(row.refeed||'').trim().toLowerCase() in ['yes','true','1','y','üî•'],
                    notes: (row.notes||'').replace(/^"|"$/g,'')
                };
                if (!/^\d{4}-\d{2}-\d{2}$/.test(e.date)) continue;
                const derived = computeDerivedFields(e.weight, e.bf_percent, e.lean_lbs);
                if (derived) { e.bf_lbs = derived.bf_lbs; e.lean_percent = derived.lean_percent; e.residual = derived.residual; }
                const integrity = computeIntegrityStatus(e.weight, e.bf_percent, e.lean_lbs);
                e.integrity_status = integrity.status;
                e.integrity_message = integrity.message;
                rows.push(e);
            }
            if (!rows.length) { showToast('No valid rows parsed', true); return; }
            bodyData = rows.sort((a,b)=>a.date.localeCompare(b.date));
            saveData();
            updateStats(); updateTable(); updateChart();
            showToast(`Bulk update applied (${rows.length} rows)`);
            closeSettings();
        }

// ----- Formula Documentation -----
        function openFormulaDocs() {
            const modal = document.getElementById('formulaModal');
            modal.innerHTML = `
              <div class="modal">
                <h2>‚ÑπÔ∏è Formula Documentation with Scientific References</h2>
                
                <div class="form-section">
                  <h3>Body Composition Calculations</h3>
                  <p style="color: var(--text-secondary); margin-bottom:10px;"><strong>BF lbs = Weight √ó (BF% √∑ 100)</strong></p>
                  <p style="color: var(--text-secondary); font-size:0.85em;">Direct calculation of fat mass from body fat percentage.</p>
                  
                  <p style="color: var(--text-secondary); margin:15px 0 10px;"><strong>Lean % = (Lean lbs √∑ Weight) √ó 100</strong></p>
                  <p style="color: var(--text-secondary); font-size:0.85em;">Percentage of total body weight that is lean mass (muscle, organs, bone, water).</p>
                  
                  <p style="color: var(--text-secondary); margin:15px 0 10px;"><strong>Residual = Weight ‚àí BF lbs ‚àí Lean lbs</strong></p>
                  <p style="color: var(--text-secondary); font-size:0.85em;"><strong>Note:</strong> This is device-specific and represents components measured separately by your body composition scale (bone density, intracellular vs extracellular water, etc.). This is NOT an error.</p>
                </div>

                <div class="form-section">
                  <h3>Fat Loss Rate & Energy Balance</h3>
                  <p style="color: var(--text-secondary); margin-bottom:10px;"><strong>Fat Loss (period) = BF lbs(start) ‚àí BF lbs(end)</strong></p>
                  <p style="color: var(--text-secondary); margin-bottom:10px;"><strong>Weekly Rate = (Fat Loss √∑ Days) √ó 7</strong></p>
                  <p style="color: var(--text-secondary); margin-bottom:10px;"><strong>Energy Deficit = Fat Loss per day √ó 3,500 calories</strong></p>
                  <p style="color: var(--text-secondary); font-size:0.85em;"><strong>Reference:</strong> Traditional "3,500 calorie rule" from Wishnofsky (1958). While this is a simplification, it provides a reasonable approximation for tracking purposes.</p>
                  <p style="color: var(--text-secondary); font-size:0.85em; margin-top:8px;"><strong>Example:</strong> If you lose 0.5 lbs of fat in one day, estimated deficit = 0.5 √ó 3,500 = 1,750 calories for that day.</p>
                </div>

                <div class="form-section">
                  <h3>TDEE Estimation</h3>
                  <p style="color: var(--text-secondary); margin-bottom:10px;"><strong>Estimated TDEE = Average Calories + Average Deficit per Day</strong></p>
                  <p style="color: var(--text-secondary); font-size:0.85em;">Based on energy balance equation. Becomes more accurate with longer tracking periods (4+ weeks recommended).</p>
                  <p style="color: var(--text-secondary); font-size:0.85em; margin-top:8px;"><strong>Example:</strong> If you eat 1,800 cal/day average and lose 1 lb/week (500 cal/day deficit), estimated TDEE = 1,800 + 500 = 2,300 calories/day.</p>
                  <p style="color: var(--text-secondary); font-size:0.85em; margin-top:8px;"><strong>Reference:</strong> Energy balance principles from Hall et al. (2011), "Quantification of the effect of energy imbalance on bodyweight." The Lancet.</p>
                </div>

                <div class="form-section">
                  <h3>Optimal Fat Loss Targets</h3>
                  <p style="color: var(--text-secondary); margin-bottom:10px;"><strong>Muscle Retention Deficit = TDEE ‚àí (0.5% body weight √ó 3,500 √∑ 7)</strong></p>
                  <p style="color: var(--text-secondary); font-size:0.85em;">Target: ~0.5% of body weight loss per week. This rate maximizes fat loss while preserving muscle mass.</p>
                  <p style="color: var(--text-secondary); font-size:0.85em; margin-top:8px;"><strong>Reference:</strong> Alpert, S.S. (2005). "A limit on the energy transfer rate from the human fat store in hypophagia." Journal of Theoretical Biology, 233(1), 1-13. This study established the maximum rate fat can be mobilized from adipose tissue.</p>
                  <p style="color: var(--text-secondary); font-size:0.85em; margin-top:8px;"><strong>Interpretation:</strong> Deficits larger than this may cause the body to break down muscle tissue for energy since fat stores cannot mobilize energy fast enough.</p>
                  
                  <p style="color: var(--text-secondary); margin:20px 0 10px;"><strong>Max Fat Burn Deficit = TDEE ‚àí (1.0% body weight √ó 3,500 √∑ 7)</strong></p>
                  <p style="color: var(--text-secondary); font-size:0.85em;">Target: ~1% of body weight loss per week. This represents the upper safe limit for fat loss.</p>
                  <p style="color: var(--text-secondary); font-size:0.85em; margin-top:8px;"><strong>Reference:</strong> Garthe et al. (2011). "Effect of two different weight-loss rates on body composition and strength in elite athletes." International Journal of Sport Nutrition and Exercise Metabolism. Found that 0.7% weekly loss preserved strength better than 1.4% weekly loss.</p>
                  <p style="color: var(--text-secondary); font-size:0.85em; margin-top:8px;"><strong>Interpretation:</strong> Rates above 1% body weight per week significantly increase risk of muscle loss, strength decreases, metabolic adaptation, and hormonal disruption.</p>
                </div>

                <div class="form-section">
                  <h3>Training Calculations</h3>
                  <p style="color: var(--text-secondary); margin-bottom:10px;"><strong>Working Volume = Œ£ (Sets √ó Reps √ó Weight)</strong></p>
                  <p style="color: var(--text-secondary); font-size:0.85em;">Total volume load. Excludes warm-up sets. Tracks training stimulus over time.</p>
                  
                  <p style="color: var(--text-secondary); margin:15px 0 10px;"><strong>Estimated 1RM (Epley) = Weight √ó (1 + Reps √∑ 30)</strong></p>
                  <p style="color: var(--text-secondary); font-size:0.85em;"><strong>Reference:</strong> Epley, B. (1985). Poundage Chart. Boyd Epley Workout. University of Nebraska.</p>
                  <p style="color: var(--text-secondary); font-size:0.85em; margin-top:8px;"><strong>Example:</strong> 225 lbs √ó (1 + 8 √∑ 30) = 225 √ó 1.267 = 285 lbs estimated 1RM</p>
                  <p style="color: var(--text-secondary); font-size:0.85em; margin-top:8px;"><strong>Note:</strong> Most accurate for 1-10 rep range. For higher reps (10-15), Brzycki formula may be more accurate: Weight √∑ (1.0278 ‚àí 0.0278 √ó Reps)</p>
                </div>

                <div class="form-section">
                  <h3>Progressive Overload Guidelines</h3>
                  <p style="color: var(--text-secondary); margin-bottom:10px;"><strong>Barbell Exercises: 1-3% weight increase</strong></p>
                  <p style="color: var(--text-secondary); margin-bottom:10px;"><strong>Dumbbell Exercises: 2-5% weight increase</strong></p>
                  <p style="color: var(--text-secondary); font-size:0.85em;">Conservative guidelines for sustainable progression. Increase when you can complete target reps with good form for 2 consecutive sessions.</p>
                  <p style="color: var(--text-secondary); font-size:0.85em; margin-top:8px;"><strong>Example:</strong> 100 lb barbell: add 2.5-5 lbs. 50 lb dumbbell: add 5 lbs (2.5 lb per hand).</p>
                  <p style="color: var(--text-secondary); font-size:0.85em; margin-top:8px;"><strong>Reference:</strong> Based on DeLorme & Watkins (1948) progressive resistance principles and modern periodization practices.</p>
                </div>

                <div class="form-section">
                  <h3>Protein Requirements</h3>
                  <p style="color: var(--text-secondary); margin-bottom:10px;"><strong>Maintenance: 0.8-1.0 g per lb body weight</strong></p>
                  <p style="color: var(--text-secondary); margin-bottom:10px;"><strong>Fat Loss: 1.0-1.2 g per lb body weight</strong></p>
                  <p style="color: var(--text-secondary); margin-bottom:10px;"><strong>Muscle Gain: 0.8-1.0 g per lb body weight</strong></p>
                  <p style="color: var(--text-secondary); font-size:0.85em;"><strong>Reference:</strong> Phillips, S.M. & Van Loon, L.J.C. (2011). "Dietary protein for athletes: from requirements to optimum adaptation." Journal of Sports Sciences.</p>
                  <p style="color: var(--text-secondary); font-size:0.85em; margin-top:8px;"><strong>Note:</strong> Higher protein during caloric deficit helps preserve muscle mass. Above 1.2 g/lb shows diminishing returns.</p>
                </div>

                <div style="background:rgba(6,182,212,0.1); border-left:4px solid var(--accent-cyan); padding:15px; border-radius:8px; margin-top:20px;">
                  <h4 style="color:var(--accent-cyan); margin-bottom:8px;">üí° How to Use These Formulas</h4>
                  <p style="color:var(--text-secondary); font-size:0.85em;">
                    ‚Ä¢ Track consistently for 2-4 weeks before making conclusions<br>
                    ‚Ä¢ Combine multiple metrics (weight, measurements, photos, performance)<br>
                    ‚Ä¢ Adjust based on actual results, not just calculations<br>
                    ‚Ä¢ Consider weekly averages to smooth daily fluctuations<br>
                    ‚Ä¢ These are guidelines, not absolute rules - individual variation exists
                  </p>
                </div>

                <div style="display:flex; gap:10px; margin-top: 20px;">
                  <button class="primary" onclick="closeFormulaDocs()">Close</button>
                </div>
              </div>
            `;
            modal.classList.add('show');
        }
        function closeFormulaDocs(){ document.getElementById('formulaModal').classList.remove('show'); }


        // ----- Analytics Tab (lightweight) -----
        function updateAnalyticsTab() {
            const sorted = bodyData.slice().sort((a,b)=>a.date.localeCompare(b.date));
            if (sorted.length < 10) {
                document.getElementById('analyticsContent').innerHTML = '<p style="color: var(--text-secondary);">Need more data to compute analytics.</p>';
                return;
            }
            const pairs = [];
            for (let i=1;i<sorted.length;i++){
                const prev = sorted[i-1];
                const cur = sorted[i];
                if (prev && cur) {
                    const fatPrev = (prev.bf_lbs != null) ? prev.bf_lbs : (prev.weight*prev.bf_percent/100);
                    const fatCur = (cur.bf_lbs != null) ? cur.bf_lbs : (cur.weight*cur.bf_percent/100);
                    const fatDelta = fatCur - fatPrev; // negative = fat loss
                    pairs.push({
                        calories: prev.calories, protein: prev.protein, fat: prev.fat, carbs: prev.carbs,
                        steps: prev.steps, sleep: prev.sleep_duration_hrs, rhr: prev.rhr,
                        nextFatDelta: fatDelta
                    });
                }
            }
            function corr(xk, yk) {
                const xs=[], ys=[];
                pairs.forEach(p=>{
                    const x=p[xk], y=p[yk];
                    if (isFinite(x) && isFinite(y)) { xs.push(x); ys.push(y); }
                });
                if (xs.length < 8) return null;
                const mx=xs.reduce((a,b)=>a+b,0)/xs.length;
                const my=ys.reduce((a,b)=>a+b,0)/ys.length;
                let num=0, dx=0, dy=0;
                for (let i=0;i<xs.length;i++){
                    const vx=xs[i]-mx, vy=ys[i]-my;
                    num += vx*vy; dx += vx*vx; dy += vy*vy;
                }
                const den = Math.sqrt(dx*dy);
                return den ? (num/den) : null;
            }
            const metrics = ['calories','protein','fat','carbs','steps','sleep','rhr'];
            const rows = metrics.map(m=>{
                const c = corr(m,'nextFatDelta');
                const val = (c==null) ? '‚Äî' : c.toFixed(2);
                const color = (c==null) ? 'var(--text-secondary)' : (c< -0.2 ? 'var(--accent-success)' : (c>0.2 ? 'var(--accent-danger)' : 'var(--accent-warning)'));
                return `<tr><td>${m}</td><td style="font-family:'Space Mono', monospace; color:${color};">${val}</td></tr>`;
            }).join('');

            document.getElementById('analyticsContent').innerHTML = `
              <div style="color: var(--text-secondary); margin-bottom: 12px;">
                Correlation of <b>previous-day inputs</b> vs <b>next-day fat change</b> (negative = more fat loss). This is directional and noisy, but useful.
              </div>
              <div class="table-container" style="max-height: 320px;">
                <table>
                  <thead><tr><th>Metric (Prev Day)</th><th>Corr ‚Üí Next-day Fat Œî</th></tr></thead>
                  <tbody>${rows}</tbody>
                </table>
              </div>
            `;
        }

        // Personal records store (for overload tab enhancements)
        function loadPRs() {
            const stored = localStorage.getItem(PR_KEY);
            if (stored) { try { personalRecords = JSON.parse(stored); } catch { personalRecords = null; } }
            if (!personalRecords) personalRecords = { version: 1, prs: {} };
        }
        function savePRs() { localStorage.setItem(PR_KEY, JSON.stringify(personalRecords)); }




        // ===== MOBILE SWIPE NAV (V13) =====
        function enableSwipeNav() {
            let startX = null, startY = null, startT = null;
            const threshold = 60;
            document.addEventListener('touchstart', (e)=>{
                if (!e.touches || e.touches.length!==1) return;
                startX = e.touches[0].clientX;
                startY = e.touches[0].clientY;
                startT = Date.now();
            }, {passive:true});
            document.addEventListener('touchend', (e)=>{
                if (startX===null) return;
                const dx = (e.changedTouches[0].clientX - startX);
                const dy = (e.changedTouches[0].clientY - startY);
                const dt = Date.now() - startT;
                startX=null; startY=null; startT=null;
                if (dt>700) return;
                if (Math.abs(dx) < threshold || Math.abs(dx) < Math.abs(dy)) return;
                const order = ['dashboard','nutrition','measurements','training','progressive','correlations','analytics','data'];
                const active = document.querySelector('.main-tab-content.active')?.id?.replace('-tab','') || 'dashboard';
                const idx = Math.max(0, order.indexOf(active));
                const nextIdx = dx < 0 ? Math.min(order.length-1, idx+1) : Math.max(0, idx-1);
                const tabName = order[nextIdx];
                // Find corresponding button and click
                const btn = Array.from(document.querySelectorAll('.tab-button')).find(b=>b.getAttribute('onclick')?.includes(`'${tabName}'`));
                if (btn) btn.click();
            }, {passive:true});
        }


// ===== INITIALIZATION =====
        
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ Body Tracker Pro - Complete Ultimate Edition');
            console.log('‚ú® With All Features: Nutrition, Measurements, Training, Correlations, Integrity Validation');
            
            loadSettings();
            loadPRs();
            loadData();
            loadMeasurements();
            loadExerciseLibrary();
            loadTemplates();
            loadTraining();
            loadTemplates();
            loadExerciseLibrary();
            updateTrainingTab();
            updateProgressiveTab();

            
            updateStats();
            updateTable();
            updateChart();
            
            console.log(`‚úÖ Loaded ${bodyData.length} body composition entries`);
            console.log(`‚úÖ Loaded ${measurements.length} measurement records`);
            console.log(`‚úÖ Loaded ${trainingLog.length} training sessions`);
            
            // Auto-update inputs on modal
            ['entryWeight', 'entryBfPercent', 'entryLeanLbs'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.addEventListener('input', updateModalDerivedFields);
            });
            
            // Show welcome message for first-time users
            const hasSeenWelcome = localStorage.getItem('hasSeenWelcome_v2');
            if (!hasSeenWelcome) {
                setTimeout(() => {
                    showToast(
                        'üéâ Welcome to Body Tracker Pro - Complete Edition!\n\n' +
                        '‚ú® 6 powerful tabs\n' +
                        'üìä Nutrition analysis & recommendations\n' +
                        'üìè Body measurements tracking\n' +
                        'üèãÔ∏è Training log\n' +
                        'üîç Correlations & insights\n' +
                        'üõ°Ô∏è Data integrity validation\n\n' +
                        'All 57 days pre-loaded!\nRAK CHAZAQ - Only Strong! üí™'
                    );
                    localStorage.setItem('hasSeenWelcome_v2', 'true');
                }, 500);
            }
        });
        
        // ===== PHASE 2 ENHANCEMENTS =====
        
        // Moving Average Calculator
        function calculateMovingAverage(data, field, windowSize) {
            const result = [];
            const sorted = data.slice().sort((a, b) => a.date.localeCompare(b.date));
            for (let i = 0; i < sorted.length; i++) {
                const windowStart = Math.max(0, i - windowSize + 1);
                const window = sorted.slice(windowStart, i + 1);
                const values = window.map(d => d[field]).filter(v => v != null && isFinite(v));
                const avg = values.length > 0 ? values.reduce((a, b) => a + b) / values.length : null;
                result.push(avg);
            }
            return result;
        }
        
        // Data Quality Score Calculator
        function calculateQualityScore(entry) {
            let score = 0;
            const max = 10;
            
            // Body composition (4 points)
            if (entry.weight != null) score += 1.5;
            if (entry.bf_percent != null) score += 1.5;
            if (entry.lean_lbs != null) score += 1;
            if (entry.water_percent != null) score += 0.5;
            
            // Nutrition (3 points)
            if (entry.calories != null) score += 1;
            if (entry.protein != null) score += 1;
            if (entry.fat != null && entry.carbs != null) score += 1;
            
            // Activity (2 points)
            if (entry.steps != null) score += 1;
            if (entry.rhr != null) score += 1;
            
            // Sleep (1 point)
            if (entry.sleep_score != null || entry.sleep_duration_hrs != null) score += 1;
            
            const percentage = (score / max) * 100;
            return {
                score: Math.round(percentage),
                grade: percentage >= 90 ? 'A' : percentage >= 80 ? 'B' : percentage >= 70 ? 'C' : 'D'
            };
        }
        
        // Volume Landmarks Calculator
        function calculateVolumeLandmarks() {
            let totalVolume = 0;
            trainingLog.forEach(workout => {
                workout.exercises.forEach(ex => {
                    totalVolume += ex.workingVolume || 0;
                });
            });
            
            const milestones = [100000, 250000, 500000, 1000000, 2500000, 5000000, 10000000];
            const achieved = milestones.filter(m => m <= totalVolume);
            const nextMilestone = milestones.find(m => m > totalVolume) || milestones[milestones.length - 1];
            const previousMilestone = achieved[achieved.length - 1] || 0;
            const progress = ((totalVolume - previousMilestone) / (nextMilestone - previousMilestone)) * 100;
            
            return { 
                totalVolume, 
                nextMilestone, 
                previousMilestone, 
                progress: Math.round(progress),
                achieved 
            };
        }
        
        // Enhanced Progressive Overload Tab Update
        function updateProgressiveTabEnhanced() {
            const content = document.getElementById('progressiveContent');
            if (!content) return;
            
            if (!trainingLog || trainingLog.length === 0) {
                content.innerHTML = `
                    <div style="background: rgba(245, 158, 11, 0.12); border-left: 4px solid var(--accent-warning); padding: 20px; border-radius: 10px;">
                        <h3 style="color: var(--accent-warning);">üèãÔ∏è No Training Data Yet</h3>
                        <p style="color: var(--text-secondary); margin-top: 10px;">
                            Log workouts in the Training tab to see progressive overload insights, personal records, and volume trends.
                        </p>
                    </div>
                `;
                return;
            }
            
            const landmarks = calculateVolumeLandmarks();
            
            // Volume Landmarks Section
            const landmarksHTML = `
                <div style="background: var(--bg-tertiary); padding: 25px; border-radius: 12px; margin-bottom: 20px;">
                    <h3 style="color: var(--accent-cyan); margin-bottom: 15px;">üéØ Volume Landmarks</h3>
                    <div style="font-size: 2.5em; font-weight: 900; font-family: 'Space Mono', monospace; text-align: center; margin: 20px 0;">
                        ${landmarks.totalVolume.toLocaleString()} lbs
                    </div>
                    <div style="text-align: center; color: var(--text-secondary); margin-bottom: 15px;">
                        Total Lifetime Volume
                    </div>
                    <div style="width: 100%; height: 30px; background: var(--bg-secondary); border-radius: 15px; overflow: hidden; margin: 15px 0;">
                        <div style="height: 100%; background: linear-gradient(90deg, var(--accent-cyan), var(--accent-purple)); width: ${landmarks.progress}%; transition: width 0.5s ease; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 0.9em;">
                            ${landmarks.progress}%
                        </div>
                    </div>
                    <div style="text-align: center; color: var(--text-secondary);">
                        Next: ${(landmarks.nextMilestone / 1000).toFixed(0)}K lbs 
                        (${(landmarks.nextMilestone - landmarks.totalVolume).toLocaleString()} lbs to go)
                    </div>
                    <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 20px; justify-content: center;">
                        ${[100, 250, 500, 1000, 2500, 5000, 10000].map(m => {
                            const value = m * 1000;
                            const achieved = value <= landmarks.totalVolume;
                            return `
                                <div style="padding: 8px 16px; border-radius: 20px; font-family: 'Space Mono', monospace; font-weight: 700; font-size: 0.85em; ${achieved ? 'background: var(--accent-success); color: white;' : 'background: var(--bg-secondary); color: var(--text-secondary); border: 2px dashed var(--border);'}">
                                    ${achieved ? '‚úì' : ''} ${m}K
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
            
            // Exercise PRs Table
            const exerciseVolumes = {};
            trainingLog.forEach(workout => {
                workout.exercises.forEach(ex => {
                    if (!exerciseVolumes[ex.name]) {
                        exerciseVolumes[ex.name] = {
                            totalVolume: 0,
                            pr1rm: ex.pr1rm || 0
                        };
                    }
                    exerciseVolumes[ex.name].totalVolume += ex.workingVolume || 0;
                });
            });
            
            const sortedExercises = Object.keys(exerciseVolumes)
                .sort((a, b) => exerciseVolumes[b].totalVolume - exerciseVolumes[a].totalVolume)
                .slice(0, 20);
            
            const prsHTML = `
                <div style="background: var(--bg-tertiary); padding: 25px; border-radius: 12px;">
                    <h3 style="color: var(--accent-cyan); margin-bottom: 15px;">üí™ Personal Records by Exercise</h3>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="border-bottom: 2px solid var(--accent-cyan);">
                                    <th style="padding: 12px; text-align: left; color: var(--accent-cyan);">Exercise</th>
                                    <th style="padding: 12px; text-align: right; color: var(--accent-cyan);">Total Volume</th>
                                    <th style="padding: 12px; text-align: right; color: var(--accent-cyan);">Est. 1RM</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${sortedExercises.map(name => {
                                    const data = exerciseVolumes[name];
                                    return `
                                        <tr style="border-bottom: 1px solid var(--border);">
                                            <td style="padding: 12px; font-weight: 600;">${name}</td>
                                            <td style="padding: 12px; text-align: right; font-family: 'Space Mono', monospace;">${data.totalVolume.toLocaleString()} lbs</td>
                                            <td style="padding: 12px; text-align: right; font-family: 'Space Mono', monospace; color: var(--accent-success); font-weight: 700;">${data.pr1rm} lbs</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            content.innerHTML = landmarksHTML + prsHTML;
        }
        
        // Call enhanced progressive tab on initialization
        if (document.getElementById('progressiveContent')) {
            updateProgressiveTabEnhanced();
        }
        
        // ===== PHASE 2 COMPREHENSIVE ENHANCEMENTS =====
// This file contains all 27 Phase 2 feature implementations

// ===== PRIORITY 1: ENHANCED PROGRESSIVE OVERLOAD =====

// Pearson Correlation Coefficient
function pearsonCorrelation(x, y) {
    const pairs = x.map((xi, i) => [xi, y[i]])
        .filter(([xi, yi]) => xi != null && yi != null && isFinite(xi) && isFinite(yi));
    
    if (pairs.length < 5) return null;
    
    const n = pairs.length;
    const sumX = pairs.reduce((sum, [xi]) => sum + xi, 0);
    const sumY = pairs.reduce((sum, [, yi]) => sum + yi, 0);
    const sumXY = pairs.reduce((sum, [xi, yi]) => sum + xi * yi, 0);
    const sumX2 = pairs.reduce((sum, [xi]) => sum + xi * xi, 0);
    const sumY2 = pairs.reduce((sum, [, yi]) => sum + yi * yi, 0);
    
    const numerator = n * sumXY - sumX * sumY;
    const denominator = Math.sqrt((n * sumX2 - sumX * sumX) * (n * sumY2 - sumY * sumY));
    
    return denominator === 0 ? null : numerator / denominator;
}

// Calculate Full Correlations
function calculateCorrelations() {
    const xVars = ['calories', 'protein', 'fat', 'carbs', 'steps', 'sleep_duration_hrs', 'rhr'];
    const yVars = ['weight', 'bf_percent', 'lean_lbs'];
    
    const sorted = bodyData.slice().sort((a, b) => a.date.localeCompare(b.date));
    const correlations = {};
    
    // Calculate changes for y variables
    const changes = {};
    yVars.forEach(yVar => {
        changes[yVar + '_change'] = [];
        for (let i = 1; i < sorted.length; i++) {
            if (sorted[i][yVar] != null && sorted[i-1][yVar] != null) {
                changes[yVar + '_change'].push(sorted[i][yVar] - sorted[i-1][yVar]);
            } else {
                changes[yVar + '_change'].push(null);
            }
        }
    });
    
    // Calculate correlations
    xVars.forEach(xVar => {
        correlations[xVar] = {};
        yVars.forEach(yVar => {
            const xValues = sorted.slice(1).map((d, i) => d[xVar]);
            const yValues = changes[yVar + '_change'];
            correlations[xVar][yVar + '_change'] = pearsonCorrelation(xValues, yValues);
        });
    });
    
    return correlations;
}

// Linear Regression for Projections
function calculateLinearRegression(data, field) {
    const sorted = data.slice().sort((a, b) => a.date.localeCompare(b.date));
    const values = sorted.map((d, i) => ({ x: i, y: d[field] }))
        .filter(p => p.y != null && isFinite(p.y));
    
    if (values.length < 5) return null;
    
    const n = values.length;
    const sumX = values.reduce((sum, p) => sum + p.x, 0);
    const sumY = values.reduce((sum, p) => sum + p.y, 0);
    const sumXY = values.reduce((sum, p) => sum + p.x * p.y, 0);
    const sumX2 = values.reduce((sum, p) => sum + p.x * p.x, 0);
    
    const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
    const intercept = (sumY - slope * sumX) / n;
    
    // Calculate R¬≤
    const meanY = sumY / n;
    const ssTotal = values.reduce((sum, p) => sum + Math.pow(p.y - meanY, 2), 0);
    const ssResidual = values.reduce((sum, p) => {
        const predicted = slope * p.x + intercept;
        return sum + Math.pow(p.y - predicted, 2);
    }, 0);
    const r2 = 1 - (ssResidual / ssTotal);
    
    return {
        slope,
        intercept,
        r2,
        predict: (days) => slope * (values.length - 1 + days) + intercept
    };
}

// Anomaly Detection
function detectAnomalies(data) {
    const anomalies = [];
    const fields = ['weight', 'bf_percent', 'calories', 'protein', 'steps', 'rhr'];
    
    fields.forEach(field => {
        const values = data.map(d => d[field]).filter(v => v != null && isFinite(v));
        if (values.length < 10) return;
        
        const mean = values.reduce((a, b) => a + b) / values.length;
        const variance = values.reduce((sum, v) => sum + Math.pow(v - mean, 2), 0) / values.length;
        const stdDev = Math.sqrt(variance);
        
        data.forEach(entry => {
            const value = entry[field];
            if (value != null && isFinite(value)) {
                const zScore = Math.abs((value - mean) / stdDev);
                if (zScore > 3) {
                    anomalies.push({
                        date: entry.date,
                        field: field,
                        value: value,
                        zScore: zScore,
                        mean: mean,
                        stdDev: stdDev
                    });
                }
            }
        });
    });
    
    return anomalies.sort((a, b) => b.zScore - a.zScore);
}

// Enhanced Recovery Score
function calculateRecoveryScore() {
    const last7Days = bodyData.slice().sort((a, b) => b.date.localeCompare(a.date)).slice(0, 7);
    const baseline14Days = bodyData.slice().sort((a, b) => b.date.localeCompare(a.date)).slice(7, 21);
    
    let rhrScore = 15;
    let sleepQualityScore = 15;
    let sleepDurationScore = 10;
    let volumeScore = 15;
    
    // RHR Component (30 points)
    const rhr7 = last7Days.filter(d => d.rhr).map(d => d.rhr);
    const rhrBaseline = baseline14Days.filter(d => d.rhr).map(d => d.rhr);
    
    if (rhr7.length > 0 && rhrBaseline.length > 0) {
        const avgRHR7 = rhr7.reduce((a, b) => a + b) / rhr7.length;
        const avgRHRBaseline = rhrBaseline.reduce((a, b) => a + b) / rhrBaseline.length;
        const rhrDiff = avgRHR7 - avgRHRBaseline;
        
        if (rhrDiff <= 0) rhrScore = 30;
        else if (rhrDiff <= 3) rhrScore = 25;
        else if (rhrDiff <= 5) rhrScore = 15;
        else rhrScore = 5;
    }
    
    // Sleep Quality (30 points)
    const sleepScores = last7Days.filter(d => d.sleep_score).map(d => d.sleep_score);
    if (sleepScores.length > 0) {
        const avgSleepScore = sleepScores.reduce((a, b) => a + b) / sleepScores.length;
        if (avgSleepScore >= 85) sleepQualityScore = 30;
        else if (avgSleepScore >= 75) sleepQualityScore = 23;
        else if (avgSleepScore >= 65) sleepQualityScore = 15;
        else sleepQualityScore = 7;
    }
    
    // Sleep Duration (20 points)
    const sleepHours = last7Days.filter(d => d.sleep_duration_hrs).map(d => d.sleep_duration_hrs);
    if (sleepHours.length > 0) {
        const avgSleepHrs = sleepHours.reduce((a, b) => a + b) / sleepHours.length;
        if (avgSleepHrs >= 8) sleepDurationScore = 20;
        else if (avgSleepHrs >= 7) sleepDurationScore = 15;
        else if (avgSleepHrs >= 6) sleepDurationScore = 10;
        else sleepDurationScore = 3;
    }
    
    // Volume Trend (20 points)
    if (trainingLog && trainingLog.length >= 2) {
        const recent = trainingLog.slice(-2);
        const older = trainingLog.slice(-4, -2);
        
        const recentVol = recent.reduce((sum, w) => sum + (w.totalVolume || 0), 0);
        const olderVol = older.reduce((sum, w) => sum + (w.totalVolume || 0), 0);
        
        if (olderVol > 0) {
            const change = (recentVol - olderVol) / olderVol;
            if (change >= -0.1 && change <= 0.2) volumeScore = 20;
            else if (change > 0.2) volumeScore = 12;
            else volumeScore = 8;
        }
    }
    
    const total = rhrScore + sleepQualityScore + sleepDurationScore + volumeScore;
    
    return {
        total: Math.round(total),
        status: total >= 80 ? 'excellent' : total >= 60 ? 'good' : total >= 40 ? 'moderate' : 'compromised',
        rhrScore,
        sleepQualityScore,
        sleepDurationScore,
        volumeScore
    };
}

// Injury Risk Assessment
function assessInjuryRisk() {
    const risks = {
        volumeSpike: false,
        rhrElevated: false,
        poorSleep: false,
        overallRisk: 'low',
        recommendations: []
    };
    
    // Check RHR elevation
    const last3Days = bodyData.slice().sort((a, b) => b.date.localeCompare(a.date)).slice(0, 3);
    const baseline = bodyData.slice().sort((a, b) => b.date.localeCompare(a.date)).slice(3, 17);
    
    const rhr3 = last3Days.filter(d => d.rhr).map(d => d.rhr);
    const rhrBase = baseline.filter(d => d.rhr).map(d => d.rhr);
    
    if (rhr3.length > 0 && rhrBase.length > 0) {
        const recentRHR = rhr3.reduce((a, b) => a + b) / rhr3.length;
        const baselineRHR = rhrBase.reduce((a, b) => a + b) / rhrBase.length;
        
        if (recentRHR > baselineRHR + 5) {
            risks.rhrElevated = true;
            risks.recommendations.push(`RHR elevated +${(recentRHR - baselineRHR).toFixed(0)} bpm - consider extra rest day`);
        }
    }
    
    // Check sleep
    const sleep3 = last3Days.filter(d => d.sleep_duration_hrs).map(d => d.sleep_duration_hrs);
    if (sleep3.length > 0) {
        const avgSleep = sleep3.reduce((a, b) => a + b) / sleep3.length;
        if (avgSleep < 6.5) {
            risks.poorSleep = true;
            risks.recommendations.push(`Sleep averaging ${avgSleep.toFixed(1)} hours - aim for 7-9 hours`);
        }
    }
    
    // Check volume spike
    if (trainingLog && trainingLog.length >= 2) {
        const lastWorkout = trainingLog[trainingLog.length - 1];
        const prevWorkout = trainingLog[trainingLog.length - 2];
        
        if (lastWorkout.totalVolume && prevWorkout.totalVolume) {
            const increase = (lastWorkout.totalVolume - prevWorkout.totalVolume) / prevWorkout.totalVolume;
            if (increase > 0.25) {
                risks.volumeSpike = true;
                risks.recommendations.push(`Volume increased ${(increase * 100).toFixed(0)}% - consider reducing 20-30% next session`);
            }
        }
    }
    
    const riskCount = [risks.volumeSpike, risks.rhrElevated, risks.poorSleep].filter(x => x).length;
    risks.overallRisk = riskCount >= 2 ? 'high' : riskCount === 1 ? 'medium' : 'low';
    
    return risks;
}

// Smart Recommendations Engine
function generateSmartRecommendations() {
    const recommendations = [];
    const sorted = bodyData.slice().sort((a, b) => a.date.localeCompare(b.date));
    const last30Days = sorted.slice(-30);
    
    if (last30Days.length < 7) return recommendations;
    
    // Protein recommendation
    const proteinEntries = last30Days.filter(d => d.protein);
    if (proteinEntries.length > 0) {
        const avgProtein = proteinEntries.reduce((sum, d) => sum + d.protein, 0) / proteinEntries.length;
        const latest = sorted[sorted.length - 1];
        const proteinPerLb = avgProtein / latest.weight;
        
        if (proteinPerLb < 0.8) {
            recommendations.push({
                priority: 'high',
                category: 'nutrition',
                title: 'Increase Protein Intake',
                message: `Currently averaging ${avgProtein.toFixed(0)}g/day (${proteinPerLb.toFixed(2)}g/lb). For optimal muscle retention during fat loss, aim for ${Math.round(latest.weight * 1.0)}g/day.`
            });
        } else if (proteinPerLb >= 1.0) {
            recommendations.push({
                priority: 'low',
                category: 'nutrition',
                title: 'Excellent Protein Intake',
                message: `Averaging ${avgProtein.toFixed(0)}g/day (${proteinPerLb.toFixed(2)}g/lb). This is optimal for muscle retention! Keep it up.`
            });
        }
    }
    
    // Sleep recommendation
    const sleepEntries = last30Days.filter(d => d.sleep_duration_hrs);
    if (sleepEntries.length > 0) {
        const avgSleep = sleepEntries.reduce((sum, d) => sum + d.sleep_duration_hrs, 0) / sleepEntries.length;
        if (avgSleep < 7) {
            recommendations.push({
                priority: 'high',
                category: 'recovery',
                title: 'Insufficient Sleep',
                message: `Averaging ${avgSleep.toFixed(1)} hours/night. Aim for 7-9 hours for optimal recovery, hormone balance, and body composition.`
            });
        }
    }
    
    // Progress acknowledgment
    const first = sorted[0];
    const latest = sorted[sorted.length - 1];
    const weightLost = first.weight - latest.weight;
    const fatLost = first.bf_lbs - latest.bf_lbs;
    const leanChange = latest.lean_lbs - first.lean_lbs;
    
    if (weightLost > 10 && fatLost > 8) {
        const leanRetention = ((first.lean_lbs + leanChange) / first.lean_lbs) * 100;
        recommendations.push({
            priority: 'low',
            category: 'progress',
            title: 'Outstanding Progress!',
            message: `You've lost ${weightLost.toFixed(1)} lbs with ${fatLost.toFixed(1)} lbs of pure fat loss and ${leanRetention.toFixed(0)}% lean mass retention. Excellent execution! RAK CHAZAQ! üí™`
        });
    }
    
    // Calorie consistency
    const calorieEntries = last30Days.filter(d => d.calories);
    if (calorieEntries.length >= 14) {
        const calories = calorieEntries.map(d => d.calories);
        const avgCal = calories.reduce((a, b) => a + b) / calories.length;
        const variance = calories.reduce((sum, c) => sum + Math.pow(c - avgCal, 2), 0) / calories.length;
        const stdDev = Math.sqrt(variance);
        
        if (stdDev > 400) {
            recommendations.push({
                priority: 'medium',
                category: 'nutrition',
                title: 'High Calorie Variability',
                message: `Daily calories vary significantly (SD: ${Math.round(stdDev)}). More consistency may improve results and make tracking easier.`
            });
        }
    }
    
    // Hydration/water percentage
    const waterEntries = last30Days.filter(d => d.water_percent);
    if (waterEntries.length > 0) {
        const avgWater = waterEntries.reduce((sum, d) => sum + d.water_percent, 0) / waterEntries.length;
        if (avgWater < 58) {
            recommendations.push({
                priority: 'medium',
                category: 'recovery',
                title: 'Hydration May Be Low',
                message: `Body water percentage averaging ${avgWater.toFixed(1)}%. Consider increasing water intake for better recovery and performance.`
            });
        }
    }
    
    return recommendations.slice(0, 5);
}

// ===== ANALYTICS TAB - COMPLETE IMPLEMENTATION =====
function updateAnalyticsTab() {
    const content = document.getElementById('analyticsContent');
    if (!content) return;
    
    const sorted = bodyData.slice().sort((a, b) => a.date.localeCompare(b.date));
    
    if (sorted.length < 7) {
        content.innerHTML = `
            <div style="background: rgba(245, 158, 11, 0.12); border-left: 4px solid var(--accent-warning); padding: 20px; border-radius: 10px;">
                <h3 style="color: var(--accent-warning);">üìä Insufficient Data</h3>
                <p style="color: var(--text-secondary); margin-top: 10px;">
                    Need at least 7 days of data for meaningful analytics. Current: ${sorted.length} days.
                </p>
            </div>
        `;
        return;
    }
    
    // Calculate correlations
    const correlations = calculateCorrelations();
    
    // Build correlation heatmap
    const xVars = Object.keys(correlations);
    const yVars = ['weight_change', 'bf_percent_change', 'lean_lbs_change'];
    
    const getCorrelationColor = (corr) => {
        if (corr === null) return '#334155';
        if (corr < -0.5) return '#064e3b';
        if (corr < -0.3) return '#10b981';
        if (corr < 0.3) return '#64748b';
        if (corr < 0.5) return '#dc2626';
        return '#7f1d1d';
    };
    
    let heatmapHTML = '<div style="overflow-x: auto;"><table style="border-collapse: collapse; margin: 15px 0;">';
    heatmapHTML += '<tr><th style="padding: 8px;"></th>';
    yVars.forEach(yVar => {
        const label = yVar.replace('_change', '').replace('_', ' ');
        heatmapHTML += `<th style="padding: 8px; color: var(--accent-cyan); font-size: 0.85em;">${label}</th>`;
    });
    heatmapHTML += '</tr>';
    
    xVars.forEach(xVar => {
        heatmapHTML += `<tr><td style="padding: 8px; color: var(--text-secondary); font-size: 0.85em;">${xVar.replace('_', ' ')}</td>`;
        yVars.forEach(yVar => {
            const corr = correlations[xVar][yVar];
            const color = getCorrelationColor(corr);
            const display = corr !== null ? corr.toFixed(2) : '‚Äî';
            heatmapHTML += `<td style="padding: 12px; background: ${color}; color: white; text-align: center; font-family: 'Space Mono', monospace; font-weight: 700; border: 1px solid var(--bg-primary);">${display}</td>`;
        });
        heatmapHTML += '</tr>';
    });
    heatmapHTML += '</table></div>';
    
    // Detect anomalies
    const anomalies = detectAnomalies(sorted);
    const anomaliesHTML = anomalies.length > 0 ? `
        <div style="background: rgba(245, 158, 11, 0.12); border-left: 4px solid var(--accent-warning); padding: 20px; border-radius: 10px; margin: 20px 0;">
            <h4 style="color: var(--accent-warning); margin-bottom: 15px;">‚ö†Ô∏è Statistical Outliers Detected</h4>
            ${anomalies.slice(0, 5).map(a => `
                <div style="margin: 10px 0; padding: 10px; background: var(--bg-tertiary); border-radius: 8px;">
                    <strong>${a.date}</strong>: ${a.field.replace('_', ' ')} = ${a.value.toFixed(1)}
                    <div style="color: var(--text-secondary); font-size: 0.9em; margin-top: 5px;">
                        ${a.zScore.toFixed(1)} standard deviations from mean (${a.mean.toFixed(1)})
                    </div>
                </div>
            `).join('')}
        </div>
    ` : '<div style="background: rgba(16, 185, 129, 0.12); border-left: 4px solid var(--accent-success); padding: 20px; border-radius: 10px; margin: 20px 0;"><h4 style="color: var(--accent-success);">‚úÖ No Statistical Outliers Detected</h4><p style="color: var(--text-secondary); margin-top: 10px;">All data points are within 3 standard deviations of the mean.</p></div>';
    
    // Trend projections
    const weightRegression = calculateLinearRegression(sorted, 'weight');
    const bfRegression = calculateLinearRegression(sorted, 'bf_percent');
    
    const projectionsHTML = weightRegression && bfRegression ? `
        <div style="background: var(--bg-tertiary); padding: 25px; border-radius: 12px; margin: 20px 0;">
            <h4 style="color: var(--accent-cyan); margin-bottom: 15px;">üìà Trend Projections</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                <div>
                    <strong style="color: var(--accent-cyan);">Weight Trend:</strong>
                    <div style="color: var(--text-secondary); margin-top: 10px; line-height: 1.8;">
                        Trajectory: ${weightRegression.slope > 0 ? '‚Üó' : '‚Üò'} ${Math.abs(weightRegression.slope * 7).toFixed(2)} lbs/week<br>
                        Confidence: R¬≤ = ${(weightRegression.r2 * 100).toFixed(0)}%<br>
                        7-day projection: ${weightRegression.predict(7).toFixed(1)} lbs<br>
                        14-day projection: ${weightRegression.predict(14).toFixed(1)} lbs<br>
                        30-day projection: ${weightRegression.predict(30).toFixed(1)} lbs
                    </div>
                </div>
                <div>
                    <strong style="color: var(--accent-purple);">Body Fat Trend:</strong>
                    <div style="color: var(--text-secondary); margin-top: 10px; line-height: 1.8;">
                        Trajectory: ${bfRegression.slope > 0 ? '‚Üó' : '‚Üò'} ${Math.abs(bfRegression.slope * 7).toFixed(2)}%/week<br>
                        Confidence: R¬≤ = ${(bfRegression.r2 * 100).toFixed(0)}%<br>
                        7-day projection: ${bfRegression.predict(7).toFixed(1)}%<br>
                        14-day projection: ${bfRegression.predict(14).toFixed(1)}%<br>
                        30-day projection: ${bfRegression.predict(30).toFixed(1)}%
                    </div>
                </div>
            </div>
        </div>
    ` : '';
    
    content.innerHTML = `
        <div style="background: var(--bg-tertiary); padding: 25px; border-radius: 12px; margin-bottom: 20px;">
            <h3 style="color: var(--accent-cyan); margin-bottom: 15px;">üî¨ Correlation Heatmap</h3>
            <p style="color: var(--text-secondary); margin-bottom: 15px; font-size: 0.9em;">
                Shows relationships between nutrition/activity variables and body composition changes.
                <strong>Dark green</strong> = strong negative correlation, <strong>Dark red</strong> = strong positive correlation.
            </p>
            ${heatmapHTML}
        </div>
        ${anomaliesHTML}
        ${projectionsHTML}
    `;
}

// ===== INSIGHTS TAB - COMPLETE IMPLEMENTATION =====
function updateInsightsTab() {
    const content = document.getElementById('insightsContent');
    if (!content) return;
    
    if (bodyData.length < 7) {
        content.innerHTML = `
            <div style="background: rgba(245, 158, 11, 0.12); border-left: 4px solid var(--accent-warning); padding: 20px; border-radius: 10px;">
                <h3 style="color: var(--accent-warning);">üí° Insufficient Data</h3>
                <p style="color: var(--text-secondary); margin-top: 10px;">
                    Need at least 7 days of data for insights. Current: ${bodyData.length} days.
                </p>
            </div>
        `;
        return;
    }
    
    const recoveryScore = calculateRecoveryScore();
    const injuryRisk = assessInjuryRisk();
    const recommendations = generateSmartRecommendations();
    
    // Recovery Score Display
    const recoveryHTML = `
        <div style="background: var(--bg-tertiary); padding: 25px; border-radius: 12px; margin-bottom: 20px;">
            <h3 style="color: var(--accent-cyan); margin-bottom: 15px;">üîã Recovery Score</h3>
            <div style="text-align: center;">
                <div style="font-size: 4em; font-weight: 900; font-family: 'Space Mono', monospace; margin: 20px 0; color: ${
                    recoveryScore.status === 'excellent' ? 'var(--accent-success)' :
                    recoveryScore.status === 'good' ? 'var(--accent-cyan)' :
                    recoveryScore.status === 'moderate' ? 'var(--accent-warning)' :
                    'var(--accent-danger)'
                };">
                    ${recoveryScore.total}
                </div>
                <div style="font-size: 1.2em; color: var(--accent-cyan); font-weight: 700; text-transform: uppercase; margin-bottom: 20px;">
                    ${recoveryScore.status}
                </div>
            </div>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 20px;">
                <div style="background: var(--bg-secondary); padding: 15px; border-radius: 8px; text-align: center;">
                    <div style="color: var(--text-secondary); font-size: 0.85em; margin-bottom: 5px;">RHR Status</div>
                    <div style="font-size: 1.5em; font-weight: 700; font-family: 'Space Mono', monospace;">${recoveryScore.rhrScore}/30</div>
                </div>
                <div style="background: var(--bg-secondary); padding: 15px; border-radius: 8px; text-align: center;">
                    <div style="color: var(--text-secondary); font-size: 0.85em; margin-bottom: 5px;">Sleep Quality</div>
                    <div style="font-size: 1.5em; font-weight: 700; font-family: 'Space Mono', monospace;">${recoveryScore.sleepQualityScore}/30</div>
                </div>
                <div style="background: var(--bg-secondary); padding: 15px; border-radius: 8px; text-align: center;">
                    <div style="color: var(--text-secondary); font-size: 0.85em; margin-bottom: 5px;">Sleep Duration</div>
                    <div style="font-size: 1.5em; font-weight: 700; font-family: 'Space Mono', monospace;">${recoveryScore.sleepDurationScore}/20</div>
                </div>
                <div style="background: var(--bg-secondary); padding: 15px; border-radius: 8px; text-align: center;">
                    <div style="color: var(--text-secondary); font-size: 0.85em; margin-bottom: 5px;">Volume Trend</div>
                    <div style="font-size: 1.5em; font-weight: 700; font-family: 'Space Mono', monospace;">${recoveryScore.volumeScore}/20</div>
                </div>
            </div>
        </div>
    `;
    
    // Injury Risk Display
    const riskColor = injuryRisk.overallRisk === 'high' ? 'var(--accent-danger)' :
                      injuryRisk.overallRisk === 'medium' ? 'var(--accent-warning)' :
                      'var(--accent-success)';
    
    const injuryRiskHTML = `
        <div style="background: ${
            injuryRisk.overallRisk === 'high' ? 'rgba(239, 68, 68, 0.12)' :
            injuryRisk.overallRisk === 'medium' ? 'rgba(245, 158, 11, 0.12)' :
            'rgba(16, 185, 129, 0.12)'
        }; border-left: 4px solid ${riskColor}; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
            <h3 style="color: ${riskColor}; margin-bottom: 10px;">
                ‚ö†Ô∏è Injury Risk Assessment: ${injuryRisk.overallRisk.toUpperCase()}
            </h3>
            ${injuryRisk.recommendations.length > 0 ? `
                <ul style="margin: 10px 0 0 20px; color: var(--text-secondary);">
                    ${injuryRisk.recommendations.map(rec => `<li style="margin: 8px 0;">${rec}</li>`).join('')}
                </ul>
            ` : '<p style="color: var(--text-secondary); margin-top: 10px;">‚úÖ No warning signs detected. Recovery markers look good. Keep up the great work!</p>'}
        </div>
    `;
    
    // Recommendations Display
    const recommendationsHTML = recommendations.length > 0 ? `
        <div style="background: var(--bg-tertiary); padding: 25px; border-radius: 12px;">
            <h3 style="color: var(--accent-cyan); margin-bottom: 15px;">üí° Smart Recommendations</h3>
            ${recommendations.map(rec => `
                <div style="background: var(--bg-secondary); padding: 18px; border-radius: 10px; margin: 12px 0; border-left: 4px solid ${
                    rec.priority === 'high' ? 'var(--accent-danger)' :
                    rec.priority === 'medium' ? 'var(--accent-warning)' :
                    'var(--accent-success)'
                };">
                    <div style="display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 0.75em; font-weight: 700; margin-bottom: 8px; background: ${
                        rec.category === 'nutrition' ? 'rgba(16, 185, 129, 0.15)' :
                        rec.category === 'recovery' ? 'rgba(6, 182, 212, 0.15)' :
                        rec.category === 'training' ? 'rgba(139, 92, 246, 0.15)' :
                        'rgba(245, 158, 11, 0.15)'
                    }; color: ${
                        rec.category === 'nutrition' ? 'var(--accent-success)' :
                        rec.category === 'recovery' ? 'var(--accent-cyan)' :
                        rec.category === 'training' ? 'var(--accent-purple)' :
                        'var(--accent-warning)'
                    };">
                        ${rec.category.toUpperCase()}
                    </div>
                    <div style="font-weight: 700; color: var(--accent-cyan); margin-bottom: 8px;">${rec.title}</div>
                    <div style="color: var(--text-secondary); line-height: 1.6;">${rec.message}</div>
                </div>
            `).join('')}
        </div>
    ` : '';
    
    content.innerHTML = recoveryHTML + injuryRiskHTML + recommendationsHTML;
}

// ===== QUICK ADD BOTTOM SHEET (MOBILE) =====
function initQuickAdd() {
    // Only show on mobile
    if (window.innerWidth <= 768) {
        const fabContainer = document.getElementById('fabContainer');
        if (fabContainer) fabContainer.style.display = 'block';
    }
}

function toggleQuickAdd() {
    const sheet = document.getElementById('quickAddSheet');
    if (sheet) {
        sheet.classList.toggle('open');
    }
}

function quickAddEntry() {
    const weight = parseFloat(document.getElementById('quickWeight').value);
    const bfPercent = parseFloat(document.getElementById('quickBfPercent').value);
    
    if (!weight || !bfPercent) {
        showToast('‚ö†Ô∏è Please enter weight and body fat %');
        return;
    }
    
    const date = new Date().toISOString().split('T')[0];
    const bf_lbs = (weight * bfPercent / 100);
    const lean_lbs = weight - bf_lbs;
    
    const entry = {
        date,
        weight,
        bf_percent: bfPercent,
        bf_lbs,
        lean_lbs,
        lean_percent: (lean_lbs / weight * 100),
        residual: weight - lean_lbs - bf_lbs,
        refeed: false,
        notes: 'Quick Add',
        integrity_status: 'yellow'
    };
    
    bodyData.push(entry);
    saveData();
    toggleQuickAdd();
    updateDashboard();
    updateTable();
    updateChart();
    
    document.getElementById('quickWeight').value = '';
    document.getElementById('quickBfPercent').value = '';
    
    showToast('‚úÖ Quick entry added!');
}

// ===== COLUMN VISIBILITY TOGGLES =====
let hiddenColumns = new Set();

function toggleColumn(columnName) {
    if (hiddenColumns.has(columnName)) {
        hiddenColumns.delete(columnName);
    } else {
        hiddenColumns.add(columnName);
    }
    updateTable();
}

function toggleCompactMode() {
    const isCompact = document.getElementById('compactModeToggle')?.checked;
    document.querySelectorAll('td, th').forEach(cell => {
        cell.style.padding = isCompact ? '6px 4px' : '12px 8px';
    });
}

// ===== DATA QUALITY TAB =====
function updateQualityTab() {
    const content = document.getElementById('qualityContent');
    if (!content) return;
    
    // Calculate quality distribution
    const qualityData = bodyData.map(entry => ({
        date: entry.date,
        ...calculateQualityScore(entry)
    }));
    
    const avgQuality = qualityData.reduce((sum, d) => sum + d.score, 0) / qualityData.length;
    const gradeDistribution = {
        A: qualityData.filter(d => d.grade === 'A').length,
        B: qualityData.filter(d => d.grade === 'B').length,
        C: qualityData.filter(d => d.grade === 'C').length,
        D: qualityData.filter(d => d.grade === 'D').length
    };
    
    content.innerHTML = `
        <div style="background: ${avgQuality >= 80 ? 'rgba(16, 185, 129, 0.12)' : avgQuality >= 60 ? 'rgba(6, 182, 212, 0.12)' : 'rgba(245, 158, 11, 0.12)'}; border-left: 4px solid ${avgQuality >= 80 ? 'var(--accent-success)' : avgQuality >= 60 ? 'var(--accent-cyan)' : 'var(--accent-warning)'}; padding: 25px; border-radius: 12px; margin-bottom: 20px;">
            <h3 style="color: ${avgQuality >= 80 ? 'var(--accent-success)' : avgQuality >= 60 ? 'var(--accent-cyan)' : 'var(--accent-warning)'}; margin-bottom: 15px;">üìä Overall Data Quality</h3>
            <div style="text-align: center;">
                <div style="font-size: 4em; font-weight: 900; font-family: 'Space Mono', monospace; margin: 20px 0; color: ${avgQuality >= 80 ? 'var(--accent-success)' : avgQuality >= 60 ? 'var(--accent-cyan)' : 'var(--accent-warning)'};">
                    ${avgQuality.toFixed(0)}%
                </div>
            </div>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 20px;">
                <div style="background: var(--bg-secondary); padding: 15px; border-radius: 8px; text-align: center;">
                    <div style="color: var(--accent-success); font-size: 2em; font-weight: 700; font-family: 'Space Mono', monospace;">${gradeDistribution.A}</div>
                    <div style="color: var(--text-secondary); font-size: 0.85em; margin-top: 5px;">Grade A (90%+)</div>
                </div>
                <div style="background: var(--bg-secondary); padding: 15px; border-radius: 8px; text-align: center;">
                    <div style="color: var(--accent-cyan); font-size: 2em; font-weight: 700; font-family: 'Space Mono', monospace;">${gradeDistribution.B}</div>
                    <div style="color: var(--text-secondary); font-size: 0.85em; margin-top: 5px;">Grade B (80%+)</div>
                </div>
                <div style="background: var(--bg-secondary); padding: 15px; border-radius: 8px; text-align: center;">
                    <div style="color: var(--accent-warning); font-size: 2em; font-weight: 700; font-family: 'Space Mono', monospace;">${gradeDistribution.C}</div>
                    <div style="color: var(--text-secondary); font-size: 0.85em; margin-top: 5px;">Grade C (70%+)</div>
                </div>
                <div style="background: var(--bg-secondary); padding: 15px; border-radius: 8px; text-align: center;">
                    <div style="color: var(--accent-danger); font-size: 2em; font-weight: 700; font-family: 'Space Mono', monospace;">${gradeDistribution.D}</div>
                    <div style="color: var(--text-secondary); font-size: 0.85em; margin-top: 5px;">Grade D (<70%)</div>
                </div>
            </div>
        </div>
        
        <div style="background: var(--bg-tertiary); padding: 25px; border-radius: 12px;">
            <h4 style="color: var(--accent-cyan); margin-bottom: 15px;">Quality Score Components</h4>
            <ul style="color: var(--text-secondary); margin-left: 20px; line-height: 2;">
                <li><strong>Body Composition (40 points):</strong> Weight, BF%, Lean Mass, Water%</li>
                <li><strong>Nutrition (30 points):</strong> Calories, Protein, Macros</li>
                <li><strong>Activity (20 points):</strong> Steps, RHR</li>
                <li><strong>Sleep (10 points):</strong> Sleep Score or Duration</li>
            </ul>
            <p style="color: var(--text-secondary); margin-top: 20px; font-size: 0.9em;">
                üí° Tip: Click on any entry in the Data Table to edit and improve its quality score.
            </p>
        </div>
    `;
}

// ===== PWA FEATURES =====
let deferredPrompt;

function initPWA() {
    // Service Worker Registration
    if ('serviceWorker' in navigator && location.protocol === 'https:') {
        const swCode = `
            const CACHE_NAME = 'body-tracker-v15';
            const urlsToCache = [
                './',
                'https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js'
            ];
            
            self.addEventListener('install', (event) => {
                event.waitUntil(
                    caches.open(CACHE_NAME)
                        .then((cache) => cache.addAll(urlsToCache))
                );
            });
            
            self.addEventListener('fetch', (event) => {
                event.respondWith(
                    caches.match(event.request)
                        .then((response) => response || fetch(event.request))
                );
            });
        `;
        
        const blob = new Blob([swCode], { type: 'application/javascript' });
        const swUrl = URL.createObjectURL(blob);
        
        navigator.serviceWorker.register(swUrl)
            .then(() => console.log('‚úÖ Service Worker registered'))
            .catch(err => console.error('Service Worker registration failed:', err));
    }
    
    // Install Prompt
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        const btn = document.getElementById('installAppBtn');
        if (btn) btn.style.display = 'block';
    });
    
    // Offline Detection
    window.addEventListener('online', () => {
        const banner = document.getElementById('offlineBanner');
        if (banner) banner.classList.remove('show');
        showToast('‚úÖ Back online!');
    });
    
    window.addEventListener('offline', () => {
        const banner = document.getElementById('offlineBanner');
        if (banner) banner.classList.add('show');
    });
}

function installApp() {
    if (!deferredPrompt) {
        showToast('‚ö†Ô∏è Install prompt not available');
        return;
    }
    
    deferredPrompt.prompt();
    deferredPrompt.userChoice.then((choiceResult) => {
        if (choiceResult.outcome === 'accepted') {
            showToast('üéâ App installed successfully!');
        }
        deferredPrompt = null;
        const btn = document.getElementById('installAppBtn');
        if (btn) btn.style.display = 'none';
    });
}

// ===== ENHANCED SWITCHAB FUNCTION =====
function switchTab(tabName) {
    // Hide all tabs
    document.querySelectorAll('.main-tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Remove active from all buttons
    document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Show selected tab
    const tabElement = document.getElementById(`${tabName}-tab`);
    if (tabElement) {
        tabElement.classList.add('active');
    }
    
    // Activate button
    document.querySelectorAll('.tab-button').forEach(btn => {
        if (btn.getAttribute('onclick')?.includes(`'${tabName}'`)) {
            btn.classList.add('active');
        }
    });
    
    // Update content based on tab
    switch(tabName) {
        case 'dashboard':
            updateDashboard();
            updateChart();
            break;
        case 'nutrition':
            updateNutritionTab();
            break;
        case 'training':
            updateTrainingTab();
            break;
        case 'progressive':
            updateProgressiveTabEnhanced();
            break;
        case 'analytics':
            updateAnalyticsTab();
            break;
        case 'insights':
            updateInsightsTab();
            break;
        case 'quality':
            updateQualityTab();
            break;
        case 'correlations':
            updateCorrelations();
            break;
        case 'data':
            updateTable();
            break;
    }
}

console.log('Phase 2 UI Enhancements Loaded');

        console.log('Phase 2 Tab Updates Loaded');

console.log('Phase 2 Analytics Functions Loaded');

        console.log('‚ú® Phase 2 Enhancements Loaded:');
        console.log('  ‚úì Moving averages');
        console.log('  ‚úì Data quality scoring');
        console.log('  ‚úì Volume landmarks');
        console.log('  ‚úì Enhanced progressive overload');
    </script>
    <!-- ===== PHASE 2 UI ELEMENTS ===== -->
    
    <!-- Floating Action Button (Mobile Only) -->
    <div id="fabContainer" style="display: none; position: fixed; bottom: 20px; right: 20px; z-index: 1000;">
        <button onclick="toggleQuickAdd()" style="width: 56px; height: 56px; border-radius: 50%; background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple)); border: none; color: white; font-size: 24px; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.3); transition: transform 0.2s;">
            ‚ûï
        </button>
    </div>
    
    <!-- Quick Add Bottom Sheet -->
    <div id="quickAddSheet" style="position: fixed; bottom: 0; left: 0; right: 0; background: var(--bg-tertiary); border-radius: 20px 20px 0 0; padding: 25px; transform: translateY(100%); transition: transform 0.3s ease; z-index: 999; box-shadow: 0 -4px 20px rgba(0,0,0,0.3);">
        <div style="width: 40px; height: 4px; background: var(--border); border-radius: 2px; margin: 0 auto 20px;"></div>
        <h3 style="color: var(--accent-cyan); margin-bottom: 20px;">‚ö° Quick Add Entry</h3>
        <div style="display: grid; gap: 15px;">
            <div>
                <label style="display: block; color: var(--text-secondary); margin-bottom: 5px; font-size: 0.9em;">Weight (lbs)</label>
                <input type="number" id="quickWeight" step="0.1" style="width: 100%; padding: 12px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-size: 16px;">
            </div>
            <div>
                <label style="display: block; color: var(--text-secondary); margin-bottom: 5px; font-size: 0.9em;">Body Fat %</label>
                <input type="number" id="quickBfPercent" step="0.1" style="width: 100%; padding: 12px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-size: 16px;">
            </div>
            <button onclick="quickAddEntry()" style="padding: 14px; background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple)); border: none; border-radius: 8px; color: white; font-weight: 700; font-size: 16px; cursor: pointer; min-height: 44px;">
                ‚úÖ Add Entry
            </button>
            <button onclick="toggleQuickAdd()" style="padding: 14px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-secondary); font-weight: 700; font-size: 16px; cursor: pointer; min-height: 44px;">
                Cancel
            </button>
        </div>
    </div>
    
    <!-- Offline Banner -->
    <div id="offlineBanner" style="position: fixed; top: 0; left: 0; right: 0; background: var(--accent-warning); color: white; padding: 12px; text-align: center; transform: translateY(-100%); transition: transform 0.3s ease; z-index: 1001; font-weight: 700;">
        ‚ö†Ô∏è You're offline - Changes will sync when reconnected
    </div>
    
    <!-- Install App Button (PWA) -->
    <button id="installAppBtn" onclick="installApp()" style="display: none; position: fixed; top: 20px; right: 20px; padding: 10px 20px; background: var(--accent-success); border: none; border-radius: 8px; color: white; font-weight: 700; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 1000; min-height: 44px;">
        üì≤ Install App
    </button>
    
    <!-- PR Celebration Modal -->
    <div id="prCelebrationModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); z-index: 2000; align-items: center; justify-content: center;">
        <div style="background: var(--bg-tertiary); padding: 40px; border-radius: 20px; text-align: center; max-width: 500px; position: relative; animation: slideInUp 0.5s ease;">
            <div style="font-size: 5em; margin-bottom: 20px;">üèÜ</div>
            <h2 id="prTitle" style="color: var(--accent-success); margin-bottom: 15px;"></h2>
            <div id="prDetails" style="color: var(--text-secondary); font-size: 1.2em; margin-bottom: 30px;"></div>
            <button onclick="closePRModal()" style="padding: 15px 40px; background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple)); border: none; border-radius: 10px; color: white; font-weight: 700; font-size: 16px; cursor: pointer; min-height: 44px;">
                üéâ Awesome!
            </button>
        </div>
    </div>
    
    <style>
    /* Phase 2 UI Enhancements CSS */
    
    /* Quick Add Sheet */
    #quickAddSheet.open {
        transform: translateY(0);
    }
    
    /* Offline Banner */
    #offlineBanner.show {
        transform: translateY(0);
    }
    
    /* PR Modal */
    #prCelebrationModal.show {
        display: flex !important;
    }
    
    /* Confetti Animation */
    @keyframes confetti {
        0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; }
        100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
    }
    
    /* Slide In Up Animation */
    @keyframes slideInUp {
        from { transform: translateY(50px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }
    
    /* FAB Hover Effect */
    #fabContainer button:hover {
        transform: scale(1.1);
    }
    
    #fabContainer button:active {
        transform: scale(0.95);
    }
    
    /* Touch Target Sizing (44x44px minimum) */
    .tab-button,
    button,
    .action-button,
    input[type="checkbox"],
    input[type="radio"] {
        min-height: 44px;
        min-width: 44px;
    }
    
    /* Responsive adjustments for mobile */
    @media (max-width: 768px) {
        #fabContainer {
            display: block !important;
        }
        
        .tabs {
            overflow-x: auto;
            white-space: nowrap;
            -webkit-overflow-scrolling: touch;
        }
        
        .tab-button {
            font-size: 0.85em;
            padding: 12px 16px;
        }
    }
    
    /* Prevent iOS zoom on input focus */
    input, select, textarea {
        font-size: 16px !important;
    }
    
    /* Data table enhancements */
    .compact-mode td,
    .compact-mode th {
        padding: 6px 4px !important;
        font-size: 0.85em;
    }
    
    /* Column toggle controls */
    .column-controls {
        background: var(--bg-tertiary);
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 15px;
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        align-items: center;
    }
    
    .column-toggle {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        background: var(--bg-secondary);
        border: 1px solid var(--border);
        border-radius: 6px;
        cursor: pointer;
        user-select: none;
        min-height: 44px;
    }
    
    .column-toggle input {
        cursor: pointer;
        min-width: 18px;
        min-height: 18px;
    }
    
    .column-toggle:hover {
        background: var(--bg-primary);
    }
    
    /* Info icon tooltips */
    .info-icon {
        display: inline-block;
        width: 18px;
        height: 18px;
        background: var(--accent-cyan);
        color: white;
        border-radius: 50%;
        text-align: center;
        line-height: 18px;
        font-size: 12px;
        font-weight: 700;
        cursor: help;
        margin-left: 5px;
        position: relative;
    }
    
    .info-icon:hover::after {
        content: attr(data-tooltip);
        position: absolute;
        bottom: 125%;
        left: 50%;
        transform: translateX(-50%);
        padding: 8px 12px;
        background: var(--bg-tertiary);
        border: 1px solid var(--border);
        border-radius: 6px;
        white-space: nowrap;
        font-size: 12px;
        font-weight: normal;
        z-index: 100;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    </style>

</body>
</html>
