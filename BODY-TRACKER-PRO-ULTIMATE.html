<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Body Tracker Pro - Ultimate Edition</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Work+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --accent-cyan: #06b6d4;
            --accent-purple: #8b5cf6;
            --accent-success: #10b981;
            --accent-danger: #ef4444;
            --accent-warning: #f59e0b;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border: #334155;
        }
        
        body {
            font-family: 'Work Sans', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container { max-width: 1600px; margin: 0 auto; }
        
        .header {
            background: var(--bg-secondary);
            padding: 30px;
            border-radius: 16px;
            margin-bottom: 30px;
            border: 1px solid var(--border);
        }
        
        .header h1 {
            font-size: 2.5em;
            font-weight: 700;
            font-family: 'Space Mono', monospace;
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }
        
        .header-subtitle {
            color: var(--text-secondary);
            font-family: 'Space Mono', monospace;
            font-size: 0.9em;
            margin-bottom: 5px;
        }
        
        .header-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        /* INTEGRITY BADGES */
        .integrity-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
            font-family: 'Space Mono', monospace;
        }
        
        .integrity-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        .integrity-green {
            background: rgba(16, 185, 129, 0.15);
            color: var(--accent-success);
            border: 1px solid var(--accent-success);
        }
        
        .integrity-yellow {
            background: rgba(245, 158, 11, 0.15);
            color: var(--accent-warning);
            border: 1px solid var(--accent-warning);
        }
        
        .integrity-red {
            background: rgba(239, 68, 68, 0.15);
            color: var(--accent-danger);
            border: 1px solid var(--accent-danger);
        }
        
        .integrity-blue {
            background: rgba(6, 182, 212, 0.15);
            color: var(--accent-cyan);
            border: 1px solid var(--accent-cyan);
        }
        
        .integrity-gray {
            background: rgba(148, 163, 184, 0.15);
            color: var(--text-secondary);
            border: 1px solid var(--border);
        }
        
        .dot-green { background: var(--accent-success); }
        .dot-yellow { background: var(--accent-warning); }
        .dot-red { background: var(--accent-danger); }
        .dot-blue { background: var(--accent-cyan); }
        .dot-gray { background: var(--text-secondary); }
        
        button {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border);
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 0.9em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        button:hover {
            background: var(--accent-cyan);
            border-color: var(--accent-cyan);
            transform: translateY(-2px);
        }
        
        button.primary {
            background: var(--accent-cyan);
            border-color: var(--accent-cyan);
        }
        
        button.danger {
            background: var(--accent-danger);
            border-color: var(--accent-danger);
            padding: 5px 10px;
            font-size: 0.8em;
        }
        
        .card {
            background: var(--bg-secondary);
            padding: 25px;
            border-radius: 12px;
            border: 1px solid var(--border);
            margin-bottom: 20px;
        }
        
        .card h2 {
            font-size: 1.5em;
            margin-bottom: 20px;
            color: var(--accent-cyan);
        }
        
        .grid { display: grid; gap: 20px; margin-bottom: 20px; }
        .grid-4 { grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); }
        
        .stat-card {
            background: var(--bg-tertiary);
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid var(--accent-cyan);
        }
        
        .stat-label {
            font-size: 0.85em;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: 700;
            font-family: 'Space Mono', monospace;
            margin: 10px 0;
        }
        
        .stat-change {
            font-size: 0.9em;
            font-family: 'Space Mono', monospace;
        }
        
        .positive { color: var(--accent-success); }
        .negative { color: var(--accent-danger); }
        
        .chart-wrapper {
            position: relative;
            height: 400px;
            width: 100%;
            margin-bottom: 20px;
        }
        
        canvas { max-height: 400px !important; }
        
        .chart-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .chart-tab {
            padding: 10px 20px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9em;
        }
        
        .chart-tab.active {
            background: var(--accent-cyan);
            border-color: var(--accent-cyan);
            font-weight: 600;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.75em;
        }
        
        th {
            background: var(--bg-tertiary);
            padding: 10px 6px;
            text-align: left;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.8em;
            letter-spacing: 0.5px;
            border-bottom: 2px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        td {
            padding: 8px 6px;
            border-bottom: 1px solid var(--border);
        }
        
        tbody tr:hover {
            background: var(--bg-tertiary);
            cursor: pointer;
        }
        
        tbody tr.editing {
            background: rgba(6, 182, 212, 0.15);
            outline: 2px solid var(--accent-cyan);
        }
        
        .refeed-row {
            background: rgba(239, 68, 68, 0.1);
        }
        
        .refeed-row:hover {
            background: rgba(239, 68, 68, 0.15);
        }
        
        td.editing input {
            width: 100%;
            background: var(--bg-primary);
            border: 1px solid var(--accent-cyan);
            color: var(--text-primary);
            padding: 4px 6px;
            border-radius: 4px;
            font-size: 0.95em;
        }
        
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            align-items: center;
            justify-content: center;
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
        }
        
        .modal-overlay.show { display: flex; }
        
        .modal {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 30px;
            max-width: 700px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid var(--border);
        }
        
        .form-section {
            background: var(--bg-tertiary);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        
        .form-section h3 {
            font-size: 1.1em;
            margin-bottom: 15px;
            color: var(--accent-cyan);
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
        }
        
        .form-field label {
            display: block;
            font-size: 0.85em;
            color: var(--text-secondary);
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .form-field input, .form-field textarea {
            width: 100%;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 8px;
            border-radius: 6px;
            font-size: 0.9em;
        }
        
        .form-field input:focus {
            outline: none;
            border-color: var(--accent-cyan);
        }
        
        .form-field input[readonly] {
            background: var(--bg-primary);
            color: var(--text-secondary);
            cursor: not-allowed;
        }
        
        .required::after {
            content: " *";
            color: var(--accent-danger);
        }
        
        .integrity-notice {
            background: rgba(6, 182, 212, 0.1);
            border-left: 4px solid var(--accent-cyan);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        .integrity-notice h4 {
            color: var(--accent-cyan);
            margin-bottom: 8px;
            font-size: 1em;
        }
        
        .integrity-notice p {
            font-size: 0.9em;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }
        
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--accent-success);
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 2000;
            display: none;
            animation: slideIn 0.3s ease;
            max-width: 500px;
            font-size: 0.9em;
            white-space: pre-line;
            font-family: 'Space Mono', monospace;
        }
        
        .toast.show { display: block; }
        .toast.error { background: var(--accent-danger); }
        .toast.warning { background: var(--accent-warning); }
        
        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .table-container {
            overflow-x: auto;
            max-height: 600px;
            overflow-y: auto;
        }
        
        .edit-actions {
            display: flex;
            gap: 5px;
        }
        
        @media (max-width: 768px) {
            .header h1 { font-size: 1.8em; }
            .grid-4 { grid-template-columns: 1fr; }
            .form-grid { grid-template-columns: 1fr; }
            table { font-size: 0.7em; }
            th, td { padding: 6px 3px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üí™ BODY TRACKER PRO - ULTIMATE EDITION</h1>
            <p class="header-subtitle">‚ú® With Intelligent Data Integrity Validation</p>
            <p style="color: var(--text-secondary); font-family: 'Space Mono', monospace;" id="headerStatus">Loading...</p>
            <div class="header-actions">
                <button onclick="showAddEntry()" class="primary">+ Add Entry</button>
                <button onclick="exportCSV()">üì• Export CSV</button>
                <button onclick="exportBackup()">üíæ Backup JSON</button>
                <button onclick="reloadData()" style="background: var(--accent-purple);">üîÑ Reload Data</button>
                <button onclick="debugData()" style="background: var(--accent-warning);">üîß Debug Data</button>
            </div>
        </div>

        <div class="grid grid-4" id="statsGrid"></div>

        <div class="card">
            <h2>üéØ Goal Projection</h2>
            <div id="goalContent"></div>
        </div>

        <div class="card">
            <h2>üìä Body Composition Analysis</h2>
            <p style="color: var(--text-secondary); margin-bottom: 15px;">Choose a view to understand your transformation better</p>
            <div class="chart-tabs">
                <div class="chart-tab active" onclick="switchChart('fatVsLean')">Fat vs Lean Breakdown</div>
                <div class="chart-tab" onclick="switchChart('weightTrend')">Weight & BF% Trend</div>
                <div class="chart-tab" onclick="switchChart('rateOfChange')">Daily Rate of Change</div>
                <div class="chart-tab" onclick="switchChart('nutrition')">Nutrition Tracking</div>
            </div>
            <div class="chart-wrapper">
                <canvas id="mainChart"></canvas>
            </div>
        </div>

        <div class="card">
            <h2>üìã Complete Data Log (<span id="entryCount">0</span> entries)</h2>
            <p style="color: var(--text-secondary); margin-bottom: 15px;">Click any row to edit ‚Ä¢ Red rows = refeed days ‚Ä¢ Badges show data integrity</p>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>‚úì</th>
                            <th>Weight</th>
                            <th>BF%</th>
                            <th>BF lbs</th>
                            <th>Lean</th>
                            <th>Cal</th>
                            <th>Pro</th>
                            <th>Fat</th>
                            <th>Carbs</th>
                            <th>Steps</th>
                            <th>RHR</th>
                            <th>Sleep</th>
                            <th>Sleep Hrs</th>
                            <th>Refeed</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="dataTable"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ADD ENTRY MODAL -->
    <div class="modal-overlay" id="addEntryModal">
        <div class="modal">
            <h2 id="modalTitle">Add New Entry</h2>
            
            <div class="integrity-notice">
                <h4>üõ°Ô∏è Intelligent Data Validation</h4>
                <p>This tracker automatically validates your entries to catch typos and errors.</p>
                <p>You'll be alerted if weight, body fat %, or lean mass don't align with your typical patterns.</p>
            </div>
            
            <div class="form-section">
                <h3>Body Composition (Required)</h3>
                <div class="form-grid">
                    <div class="form-field">
                        <label class="required">Date</label>
                        <input type="date" id="entryDate" required>
                    </div>
                    <div class="form-field">
                        <label class="required">Weight (lbs)</label>
                        <input type="number" step="0.1" id="entryWeight" required>
                    </div>
                    <div class="form-field">
                        <label class="required">Body Fat %</label>
                        <input type="number" step="0.1" id="entryBfPercent" required>
                    </div>
                    <div class="form-field">
                        <label class="required">Lean Mass (lbs)</label>
                        <input type="number" step="0.1" id="entryLeanLbs" required>
                    </div>
                    <div class="form-field">
                        <label>BF lbs (Auto)</label>
                        <input type="text" id="entryBfLbsAuto" readonly>
                    </div>
                    <div class="form-field">
                        <label>Lean % (Auto)</label>
                        <input type="text" id="entryLeanPercentAuto" readonly>
                    </div>
                    <div class="form-field">
                        <label>Residual (Auto)</label>
                        <input type="text" id="entryResidualAuto" readonly>
                        <div style="font-size: 0.75em; color: var(--text-secondary); margin-top: 3px;">Used for integrity check</div>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h3>Nutrition</h3>
                <div class="form-grid">
                    <div class="form-field">
                        <label>Calories</label>
                        <input type="number" id="entryCalories">
                    </div>
                    <div class="form-field">
                        <label>Protein (g)</label>
                        <input type="number" id="entryProtein">
                    </div>
                    <div class="form-field">
                        <label>Fat (g)</label>
                        <input type="number" id="entryFat">
                    </div>
                    <div class="form-field">
                        <label>Carbs (g)</label>
                        <input type="number" id="entryCarbs">
                    </div>
                    <div class="form-field">
                        <label><input type="checkbox" id="entryRefeed" style="width: auto; margin-right: 8px;">Refeed Day üî•</label>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h3>Activity & Wellness</h3>
                <div class="form-grid">
                    <div class="form-field">
                        <label>Steps</label>
                        <input type="number" id="entrySteps">
                    </div>
                    <div class="form-field">
                        <label>RHR (bpm)</label>
                        <input type="number" id="entryRhr">
                    </div>
                    <div class="form-field">
                        <label>Sleep Score (0-100)</label>
                        <input type="number" min="0" max="100" id="entrySleepScore">
                    </div>
                    <div class="form-field">
                        <label>Sleep Hours</label>
                        <input type="number" step="0.1" id="entrySleepHours">
                    </div>
                </div>
            </div>

            <div class="form-section">
                <div class="form-field">
                    <label>Notes</label>
                    <textarea rows="2" id="entryNotes"></textarea>
                </div>
            </div>

            <!-- Integrity Status in Modal -->
            <div id="modalIntegrityStatus" style="margin: 15px 0;"></div>

            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button onclick="saveEntry()" class="primary" id="saveBtn">Save Entry</button>
                <button onclick="hideModal()">Cancel</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        // ===== GLOBAL CONFIGURATION =====
        const STORAGE_KEY = 'bodyTrackingData_User1';
        const GOALS = {
            target_weight: 215,
            target_bf_percent: 10.0,
            target_bf_lbs: 21.5
        };
        
        // Integrity validation thresholds
        const INTEGRITY_CONFIG = {
            baselineWindow: 14,  // Days to use for baseline calculation
            greenThreshold: 1.0, // lbs - good integrity
            yellowThreshold: 2.0, // lbs - warning
            // Anything above yellowThreshold is red (error likely)
        };

        let bodyData = [];
        let currentChart = null;
        let currentChartType = 'fatVsLean';
        let editingRow = null;

        // ===== INITIAL DATA (48 days: Oct 27 - Dec 13, 2025) =====
        const INITIAL_DATA = [
            {"date":"2025-10-27","weight":208.1,"bf_percent":20.5,"lean_lbs":156.3,"calories":1405,"protein":116,"fat":83,"carbs":40,"rhr":48,"sleep_score":87,"sleep_duration_hrs":9.42,"steps":7046,"refeed":false,"notes":""},
            {"date":"2025-10-28","weight":208.9,"bf_percent":20.5,"lean_lbs":154.5,"calories":1565,"protein":139,"fat":92,"carbs":30,"rhr":null,"sleep_score":77,"sleep_duration_hrs":6.62,"steps":null,"refeed":false,"notes":""},
            {"date":"2025-10-29","weight":203.4,"bf_percent":20.3,"lean_lbs":154.6,"calories":1577,"protein":151,"fat":79,"carbs":50,"rhr":null,"sleep_score":63,"sleep_duration_hrs":9.18,"steps":null,"refeed":false,"notes":""},
            {"date":"2025-10-30","weight":202.6,"bf_percent":20.0,"lean_lbs":154.5,"calories":1555,"protein":142,"fat":95,"carbs":23,"rhr":55,"sleep_score":null,"sleep_duration_hrs":null,"steps":6480,"refeed":false,"notes":""},
            {"date":"2025-10-31","weight":205.0,"bf_percent":19.7,"lean_lbs":154.2,"calories":1290,"protein":147,"fat":59,"carbs":35,"rhr":54,"sleep_score":86,"sleep_duration_hrs":10.38,"steps":9519,"refeed":false,"notes":""},
            {"date":"2025-11-01","weight":204.4,"bf_percent":19.7,"lean_lbs":154.2,"calories":1735,"protein":146,"fat":41,"carbs":31,"rhr":52,"sleep_score":66,"sleep_duration_hrs":7.0,"steps":5231,"refeed":false,"notes":""},
            {"date":"2025-11-02","weight":203.8,"bf_percent":19.5,"lean_lbs":154.3,"calories":1436,"protein":134,"fat":76,"carbs":29,"rhr":51,"sleep_score":91,"sleep_duration_hrs":8.1,"steps":2859,"refeed":false,"notes":""},
            {"date":"2025-11-03","weight":204.0,"bf_percent":19.3,"lean_lbs":154.4,"calories":1981,"protein":207,"fat":76,"carbs":35,"rhr":55,"sleep_score":67,"sleep_duration_hrs":7.53,"steps":9321,"refeed":false,"notes":""},
            {"date":"2025-11-04","weight":203.9,"bf_percent":19.2,"lean_lbs":154.4,"calories":1660,"protein":131,"fat":48,"carbs":50,"rhr":54,"sleep_score":73,"sleep_duration_hrs":6.65,"steps":7202,"refeed":false,"notes":""},
            {"date":"2025-11-05","weight":200.8,"bf_percent":19.5,"lean_lbs":153.8,"calories":1525,"protein":161,"fat":85,"carbs":20,"rhr":52,"sleep_score":87,"sleep_duration_hrs":9.1,"steps":5753,"refeed":false,"notes":""},
            {"date":"2025-11-06","weight":200.6,"bf_percent":19.6,"lean_lbs":153.3,"calories":1492,"protein":141,"fat":82,"carbs":39,"rhr":50,"sleep_score":76,"sleep_duration_hrs":9.03,"steps":10762,"refeed":false,"notes":""},
            {"date":"2025-11-07","weight":200.2,"bf_percent":19.4,"lean_lbs":153.2,"calories":1724,"protein":179,"fat":71,"carbs":83,"rhr":52,"sleep_score":65,"sleep_duration_hrs":6.48,"steps":11448,"refeed":false,"notes":""},
            {"date":"2025-11-08","weight":201.1,"bf_percent":19.1,"lean_lbs":153.3,"calories":2465,"protein":180,"fat":82,"carbs":197,"rhr":49,"sleep_score":73,"sleep_duration_hrs":8.67,"steps":4149,"refeed":true,"notes":""},
            {"date":"2025-11-09","weight":202.8,"bf_percent":18.6,"lean_lbs":153.8,"calories":1710,"protein":203,"fat":57,"carbs":81,"rhr":48,"sleep_score":85,"sleep_duration_hrs":7.17,"steps":4673,"refeed":false,"notes":""},
            {"date":"2025-11-10","weight":201.8,"bf_percent":18.4,"lean_lbs":154.2,"calories":1908,"protein":203,"fat":68,"carbs":100,"rhr":51,"sleep_score":78,"sleep_duration_hrs":9.0,"steps":7444,"refeed":false,"notes":""},
            {"date":"2025-11-11","weight":200.3,"bf_percent":18.3,"lean_lbs":154.4,"calories":1199,"protein":150,"fat":26,"carbs":65,"rhr":45,"sleep_score":56,"sleep_duration_hrs":4.88,"steps":2327,"refeed":false,"notes":""},
            {"date":"2025-11-12","weight":199.1,"bf_percent":18.3,"lean_lbs":154.2,"calories":1210,"protein":101,"fat":72,"carbs":28,"rhr":46,"sleep_score":76,"sleep_duration_hrs":9.7,"steps":3724,"refeed":false,"notes":""},
            {"date":"2025-11-13","weight":199.5,"bf_percent":18.3,"lean_lbs":153.7,"calories":1756,"protein":133,"fat":112,"carbs":39,"rhr":48,"sleep_score":83,"sleep_duration_hrs":8.78,"steps":10266,"refeed":false,"notes":""},
            {"date":"2025-11-14","weight":197.5,"bf_percent":18.4,"lean_lbs":153.5,"calories":2583,"protein":202,"fat":51,"carbs":270,"rhr":47,"sleep_score":81,"sleep_duration_hrs":8.53,"steps":6214,"refeed":true,"notes":""},
            {"date":"2025-11-15","weight":199.1,"bf_percent":18.0,"lean_lbs":153.6,"calories":1960,"protein":219,"fat":84,"carbs":75,"rhr":55,"sleep_score":62,"sleep_duration_hrs":6.62,"steps":4173,"refeed":false,"notes":""},
            {"date":"2025-11-16","weight":199.6,"bf_percent":17.8,"lean_lbs":153.8,"calories":1502,"protein":156,"fat":30,"carbs":128,"rhr":54,"sleep_score":60,"sleep_duration_hrs":7.1,"steps":4655,"refeed":false,"notes":""},
            {"date":"2025-11-17","weight":198.3,"bf_percent":17.7,"lean_lbs":153.8,"calories":2165,"protein":207,"fat":127,"carbs":32,"rhr":52,"sleep_score":67,"sleep_duration_hrs":8.88,"steps":12478,"refeed":true,"notes":""},
            {"date":"2025-11-18","weight":199.8,"bf_percent":17.8,"lean_lbs":153.4,"calories":1718,"protein":163,"fat":103,"carbs":26,"rhr":50,"sleep_score":71,"sleep_duration_hrs":7.05,"steps":4852,"refeed":false,"notes":""},
            {"date":"2025-11-19","weight":199.8,"bf_percent":17.5,"lean_lbs":153.9,"calories":1715,"protein":169,"fat":60,"carbs":61,"rhr":57,"sleep_score":null,"sleep_duration_hrs":null,"steps":10165,"refeed":false,"notes":""},
            {"date":"2025-11-20","weight":197.9,"bf_percent":17.2,"lean_lbs":154.4,"calories":2008,"protein":195,"fat":105,"carbs":50,"rhr":54,"sleep_score":63,"sleep_duration_hrs":8.33,"steps":4982,"refeed":true,"notes":""},
            {"date":"2025-11-21","weight":197.2,"bf_percent":16.9,"lean_lbs":154.7,"calories":1275,"protein":207,"fat":48,"carbs":17,"rhr":54,"sleep_score":85,"sleep_duration_hrs":9.3,"steps":6988,"refeed":false,"notes":""},
            {"date":"2025-11-22","weight":198.4,"bf_percent":16.4,"lean_lbs":155.3,"calories":1835,"protein":229,"fat":48,"carbs":114,"rhr":48,"sleep_score":null,"sleep_duration_hrs":null,"steps":4021,"refeed":false,"notes":""},
            {"date":"2025-11-23","weight":200.2,"bf_percent":16.0,"lean_lbs":155.9,"calories":1501,"protein":132,"fat":37,"carbs":146,"rhr":51,"sleep_score":72,"sleep_duration_hrs":7.35,"steps":5803,"refeed":false,"notes":""},
            {"date":"2025-11-24","weight":196.7,"bf_percent":16.6,"lean_lbs":154.9,"calories":null,"protein":null,"fat":98,"carbs":18,"rhr":49,"sleep_score":88,"sleep_duration_hrs":10.03,"steps":7179,"refeed":false,"notes":""},
            {"date":"2025-11-25","weight":199.7,"bf_percent":16.5,"lean_lbs":154.7,"calories":1431,"protein":110,"fat":23,"carbs":188,"rhr":50,"sleep_score":76,"sleep_duration_hrs":7.98,"steps":9946,"refeed":false,"notes":""},
            {"date":"2025-11-26","weight":200.2,"bf_percent":16.5,"lean_lbs":154.8,"calories":1325,"protein":195,"fat":47,"carbs":25,"rhr":48,"sleep_score":67,"sleep_duration_hrs":7.82,"steps":10712,"refeed":false,"notes":""},
            {"date":"2025-11-27","weight":196.0,"bf_percent":16.9,"lean_lbs":154.3,"calories":null,"protein":null,"fat":null,"carbs":null,"rhr":49,"sleep_score":null,"sleep_duration_hrs":10.3,"steps":7392,"refeed":true,"notes":"Thanksgiving"},
            {"date":"2025-11-28","weight":200.1,"bf_percent":16.4,"lean_lbs":154.7,"calories":967,"protein":133,"fat":40,"carbs":13,"rhr":53,"sleep_score":78,"sleep_duration_hrs":10.3,"steps":7310,"refeed":false,"notes":""},
            {"date":"2025-11-29","weight":196.2,"bf_percent":16.7,"lean_lbs":154.6,"calories":null,"protein":null,"fat":75,"carbs":49,"rhr":50,"sleep_score":85,"sleep_duration_hrs":7.55,"steps":4914,"refeed":false,"notes":""},
            {"date":"2025-11-30","weight":196.3,"bf_percent":16.7,"lean_lbs":154.2,"calories":1410,"protein":206,"fat":46,"carbs":47,"rhr":49,"sleep_score":89,"sleep_duration_hrs":7.63,"steps":3947,"refeed":false,"notes":""},
            {"date":"2025-12-01","weight":192.6,"bf_percent":16.7,"lean_lbs":154.0,"calories":1105,"protein":182,"fat":27,"carbs":46,"rhr":49,"sleep_score":84,"sleep_duration_hrs":12.1,"steps":5540,"refeed":false,"notes":""},
            {"date":"2025-12-02","weight":194.1,"bf_percent":16.4,"lean_lbs":153.9,"calories":1442,"protein":201,"fat":36,"carbs":94,"rhr":49,"sleep_score":73,"sleep_duration_hrs":7.2,"steps":10665,"refeed":false,"notes":"Starting today (Dec 2), all carb entries are Total Carbs (not Net Carbs)."},
            {"date":"2025-12-03","weight":192.5,"bf_percent":16.1,"lean_lbs":154.1,"calories":1522,"protein":195,"fat":66,"carbs":45,"rhr":51,"sleep_score":81,"sleep_duration_hrs":8.72,"steps":6742,"refeed":false,"notes":""},
            {"date":"2025-12-04","weight":192.9,"bf_percent":16.1,"lean_lbs":152.8,"calories":1817,"protein":219,"fat":61,"carbs":118,"rhr":49,"sleep_score":85,"sleep_duration_hrs":7.5,"steps":3050,"refeed":false,"notes":""},
            {"date":"2025-12-05","weight":195.2,"bf_percent":15.6,"lean_lbs":154.1,"calories":1525,"protein":136,"fat":81,"carbs":159,"rhr":48,"sleep_score":90,"sleep_duration_hrs":7.99,"steps":8607,"refeed":false,"notes":"Traveled back from Tampa. Ate dinner at friend's house. Had sour dough bread and a cream of chicken dish. Difficult to accurately track nutrition."},
            {"date":"2025-12-06","weight":194.4,"bf_percent":15.7,"lean_lbs":153.7,"calories":1837,"protein":168,"fat":81,"carbs":122,"rhr":49,"sleep_score":85,"sleep_duration_hrs":8.27,"steps":2662,"refeed":false,"notes":"Ate at a friends but had 2 helpings of instant mashed potatoes and had cheese when I came home. Picked a little and probably had a half of a potato skin w/cheese."},
            {"date":"2025-12-07","weight":195.3,"bf_percent":15.5,"lean_lbs":153.9,"calories":1776,"protein":198,"fat":61,"carbs":118,"rhr":53,"sleep_score":null,"sleep_duration_hrs":8.25,"steps":5230,"refeed":false,"notes":"Diet was atrocious. Had crackers and dip around lunch time. Cleaned diet up in the afternoon and went to the gym and put in 1500 ropes to lessen the negative impact."},
            {"date":"2025-12-08","weight":193.2,"bf_percent":16.2,"lean_lbs":152.8,"calories":1768,"protein":198,"fat":67,"carbs":114,"rhr":47,"sleep_score":86,"sleep_duration_hrs":8.1,"steps":7734,"refeed":false,"notes":""},
            {"date":"2025-12-09","weight":193.2,"bf_percent":16.2,"lean_lbs":152.5,"calories":1330,"protein":185,"fat":36,"carbs":47,"rhr":47,"sleep_score":78,"sleep_duration_hrs":6.62,"steps":6809,"refeed":false,"notes":""},
            {"date":"2025-12-10","weight":196.7,"bf_percent":16.1,"lean_lbs":152.3,"calories":1465,"protein":213,"fat":47,"carbs":48,"rhr":47,"sleep_score":72,"sleep_duration_hrs":7.37,"steps":9408,"refeed":false,"notes":""},
            {"date":"2025-12-11","weight":192.5,"bf_percent":16.2,"lean_lbs":152.4,"calories":1604,"protein":194,"fat":66,"carbs":55,"rhr":47,"sleep_score":90,"sleep_duration_hrs":9.48,"steps":2821,"refeed":false,"notes":""},
            {"date":"2025-12-12","weight":193.2,"bf_percent":16.2,"lean_lbs":152.1,"calories":1571,"protein":193,"fat":66,"carbs":59,"rhr":52,"sleep_score":83,"sleep_duration_hrs":7.72,"steps":4484,"refeed":false,"notes":""},
            {"date":"2025-12-13","weight":193.8,"bf_percent":16.0,"lean_lbs":152.2,"calories":null,"protein":null,"fat":null,"carbs":null,"rhr":44,"sleep_score":82,"sleep_duration_hrs":6.43,"steps":null,"refeed":false,"notes":""}
        ];

        // ===== INTEGRITY VALIDATION FUNCTIONS =====
        
        function computeDerivedFields(weight, bfPercent, leanMass) {
            if (!isFinite(weight) || !isFinite(bfPercent) || !isFinite(leanMass)) {
                return null;
            }
            
            const bfLbs = weight * (bfPercent / 100);
            const leanPercent = (leanMass / weight) * 100;
            const residual = weight - bfLbs - leanMass;
            
            return {
                bf_lbs: parseFloat(bfLbs.toFixed(2)),
                lean_percent: parseFloat(leanPercent.toFixed(2)),
                residual: parseFloat(residual.toFixed(2))
            };
        }
        
        function validateEntry(weight, bfPercent, leanMass) {
            // Sanity checks
            const errors = [];
            
            if (!isFinite(weight) || !isFinite(bfPercent) || !isFinite(leanMass)) {
                return { status: 'gray', message: 'Missing required fields', errors: ['Enter weight, body fat %, and lean mass'] };
            }
            
            if (weight <= 50 || weight >= 500) errors.push('Weight looks out of range (50-500 lbs)');
            if (bfPercent <= 2 || bfPercent >= 70) errors.push('Body fat % looks out of range (2-70%)');
            if (leanMass <= 50 || leanMass >= weight) errors.push('Lean mass must be less than weight and plausible');
            
            const derived = computeDerivedFields(weight, bfPercent, leanMass);
            if (!derived) {
                errors.push('Unable to compute derived fields');
                return { status: 'red', message: 'Validation failed', errors, derived: null };
            }
            
            if (derived.bf_lbs < 0 || derived.bf_lbs > weight) errors.push('Computed body fat lbs out of range');
            if (derived.lean_percent < 30 || derived.lean_percent > 95) errors.push('Computed lean % out of range (30-95%)');
            if (derived.residual < -5 || derived.residual > 80) errors.push('Residual out of plausible range');
            
            if (errors.length > 0) {
                return { status: 'red', message: errors[0], errors, derived };
            }
            
            return { status: 'valid', message: 'Entry passes sanity checks', errors: [], derived };
        }
        
        function computeIntegrityStatus(weight, bfPercent, leanMass) {
            const validation = validateEntry(weight, bfPercent, leanMass);
            
            if (validation.status === 'red' || validation.status === 'gray') {
                return validation;
            }
            
            // Get historical residuals for baseline
            const validEntries = bodyData.filter(e => 
                isFinite(e.weight) && isFinite(e.bf_percent) && isFinite(e.lean_lbs) && e.residual !== undefined
            ).sort((a, b) => a.date.localeCompare(b.date));
            
            const recent = validEntries.slice(-INTEGRITY_CONFIG.baselineWindow);
            
            if (recent.length < 7) {
                return {
                    status: 'blue',
                    message: 'Building baseline (need 7+ entries)',
                    errors: [],
                    derived: validation.derived,
                    baselineCount: recent.length
                };
            }
            
            const residuals = recent.map(e => e.residual);
            const baselineMean = residuals.reduce((sum, r) => sum + r, 0) / residuals.length;
            const residualDelta = Math.abs(validation.derived.residual - baselineMean);
            
            if (residualDelta <= INTEGRITY_CONFIG.greenThreshold) {
                return {
                    status: 'green',
                    message: 'Good - Values align with baseline',
                    errors: [],
                    derived: validation.derived,
                    baselineMean,
                    residualDelta
                };
            } else if (residualDelta <= INTEGRITY_CONFIG.yellowThreshold) {
                return {
                    status: 'yellow',
                    message: 'Warning - Slight variance detected',
                    errors: [],
                    derived: validation.derived,
                    baselineMean,
                    residualDelta
                };
            } else {
                return {
                    status: 'red',
                    message: `Check data - Residual shifted ${residualDelta.toFixed(1)} lbs from baseline`,
                    errors: ['Possible entry error - verify values from Hume app'],
                    derived: validation.derived,
                    baselineMean,
                    residualDelta
                };
            }
        }
        
        function createIntegrityBadge(status, message) {
            const badges = {
                green: { class: 'integrity-green', dot: 'dot-green', text: '‚úì Good' },
                yellow: { class: 'integrity-yellow', dot: 'dot-yellow', text: '‚ö† Warn' },
                red: { class: 'integrity-red', dot: 'dot-red', text: '‚úó Check' },
                blue: { class: 'integrity-blue', dot: 'dot-blue', text: '‚óã Build' },
                gray: { class: 'integrity-gray', dot: 'dot-gray', text: '‚Äî N/A' }
            };
            
            const badge = badges[status] || badges.gray;
            return `<span class="integrity-badge ${badge.class}" title="${message}">
                        <span class="integrity-dot ${badge.dot}"></span>
                        <span>${badge.text}</span>
                    </span>`;
        }

        // ===== DATA MANAGEMENT =====
        
        function loadData() {
            const stored = localStorage.getItem(STORAGE_KEY);
            if (stored) {
                bodyData = JSON.parse(stored);
                console.log(`‚úÖ Loaded ${bodyData.length} entries from localStorage`);
            } else {
                // First time - load initial data
                bodyData = INITIAL_DATA.map(entry => {
                    const derived = computeDerivedFields(entry.weight, entry.bf_percent, entry.lean_lbs);
                    return {
                        ...entry,
                        bf_lbs: derived?.bf_lbs || (entry.weight * entry.bf_percent / 100),
                        lean_percent: derived?.lean_percent || ((entry.lean_lbs / entry.weight) * 100),
                        residual: derived?.residual || (entry.weight - (entry.weight * entry.bf_percent / 100) - entry.lean_lbs)
                    };
                });
                saveData();
                console.log(`‚úÖ Loaded ${bodyData.length} entries from INITIAL_DATA`);
            }
            
            // Recompute integrity for all entries
            bodyData = bodyData.map(entry => {
                const integrity = computeIntegrityStatus(entry.weight, entry.bf_percent, entry.lean_lbs);
                return {
                    ...entry,
                    integrity_status: integrity.status,
                    integrity_message: integrity.message
                };
            });
        }
        
        function saveData() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(bodyData));
        }
        
        function reloadData() {
            if (confirm('Reload original 48-day dataset? This will replace any new entries you added.')) {
                localStorage.removeItem(STORAGE_KEY);
                location.reload();
            }
        }
        
        // ===== UI UPDATE FUNCTIONS =====
        
        function updateStats() {
            if (bodyData.length === 0) {
                document.getElementById('headerStatus').textContent = 'No data yet - add your first entry!';
                return;
            }
            
            const sorted = bodyData.slice().sort((a, b) => a.date.localeCompare(b.date));
            const first = sorted[0];
            const latest = sorted[sorted.length - 1];
            
            const weightChange = latest.weight - first.weight;
            const bfChange = latest.bf_percent - first.bf_percent;
            const leanChange = latest.lean_lbs - first.lean_lbs;
            
            const fatLost = (first.weight * first.bf_percent / 100) - (latest.weight * latest.bf_percent / 100);
            
            document.getElementById('headerStatus').textContent = 
                `${bodyData.length} entries ‚Ä¢ ${first.date} to ${latest.date} ‚Ä¢ ` +
                `Weight: ${weightChange >= 0 ? '+' : ''}${weightChange.toFixed(1)} lbs ‚Ä¢ ` +
                `Fat Lost: ${fatLost.toFixed(1)} lbs`;
            
            document.getElementById('entryCount').textContent = bodyData.length;
            
            // Stats cards
            const statsHtml = `
                <div class="stat-card">
                    <div class="stat-label">Current Weight</div>
                    <div class="stat-value">${latest.weight.toFixed(1)}</div>
                    <div class="stat-change ${weightChange <= 0 ? 'positive' : 'negative'}">
                        ${weightChange >= 0 ? '+' : ''}${weightChange.toFixed(1)} lbs from start
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Body Fat %</div>
                    <div class="stat-value">${latest.bf_percent.toFixed(1)}%</div>
                    <div class="stat-change ${bfChange <= 0 ? 'positive' : 'negative'}">
                        ${bfChange >= 0 ? '+' : ''}${bfChange.toFixed(1)}% from start
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Fat Lost</div>
                    <div class="stat-value">${fatLost.toFixed(1)}</div>
                    <div class="stat-change positive">
                        lbs of pure fat
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Lean Mass</div>
                    <div class="stat-value">${latest.lean_lbs.toFixed(1)}</div>
                    <div class="stat-change ${leanChange >= 0 ? 'positive' : 'negative'}">
                        ${leanChange >= 0 ? '+' : ''}${leanChange.toFixed(1)} lbs from start
                    </div>
                </div>
            `;
            
            document.getElementById('statsGrid').innerHTML = statsHtml;
            
            // Goal projection
            updateGoalProjection(sorted, latest, fatLost);
        }
        
        function updateGoalProjection(sorted, latest, fatLost) {
            const currentFatLbs = latest.weight * latest.bf_percent / 100;
            const targetFatLbs = GOALS.target_bf_lbs;
            const fatToLose = currentFatLbs - targetFatLbs;
            
            const days = sorted.length;
            const avgFatLossPerDay = days > 1 ? fatLost / days : 0;
            const daysToGoal = avgFatLossPerDay > 0 ? fatToLose / avgFatLossPerDay : 0;
            
            const goalDate = new Date(latest.date);
            goalDate.setDate(goalDate.getDate() + daysToGoal);
            
            const progress = Math.max(0, Math.min(100, (fatLost / (fatLost + fatToLose)) * 100));
            
            const goalHtml = `
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span style="font-family: 'Space Mono', monospace;">Current: ${currentFatLbs.toFixed(1)} lbs fat</span>
                        <span style="font-family: 'Space Mono', monospace;">Target: ${targetFatLbs.toFixed(1)} lbs fat</span>
                    </div>
                    <div style="background: var(--bg-tertiary); height: 30px; border-radius: 8px; overflow: hidden;">
                        <div style="background: linear-gradient(90deg, var(--accent-success), var(--accent-cyan)); height: 100%; width: ${progress}%; transition: width 0.5s ease;"></div>
                    </div>
                    <div style="text-align: center; margin-top: 10px; color: var(--text-secondary);">
                        ${progress.toFixed(1)}% to goal
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div>
                        <div style="color: var(--text-secondary); font-size: 0.85em;">Fat to Lose</div>
                        <div style="font-size: 1.5em; font-weight: 700; font-family: 'Space Mono', monospace;">${fatToLose.toFixed(1)} lbs</div>
                    </div>
                    <div>
                        <div style="color: var(--text-secondary); font-size: 0.85em;">Avg Loss Rate</div>
                        <div style="font-size: 1.5em; font-weight: 700; font-family: 'Space Mono', monospace;">${(avgFatLossPerDay * 7).toFixed(2)} lbs/week</div>
                    </div>
                    <div>
                        <div style="color: var(--text-secondary); font-size: 0.85em;">Estimated Goal Date</div>
                        <div style="font-size: 1.5em; font-weight: 700; font-family: 'Space Mono', monospace;">
                            ${daysToGoal > 0 ? goalDate.toLocaleDateString() : 'N/A'}
                        </div>
                    </div>
                    <div>
                        <div style="color: var(--text-secondary); font-size: 0.85em;">Days Remaining</div>
                        <div style="font-size: 1.5em; font-weight: 700; font-family: 'Space Mono', monospace;">
                            ${daysToGoal > 0 ? Math.ceil(daysToGoal) : 'N/A'}
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('goalContent').innerHTML = goalHtml;
        }
        
        function updateTable() {
            const tbody = document.getElementById('dataTable');
            tbody.innerHTML = '';
            
            const sorted = bodyData.slice().sort((a, b) => b.date.localeCompare(a.date));
            
            sorted.forEach((entry, idx) => {
                const row = document.createElement('tr');
                if (entry.refeed) row.classList.add('refeed-row');
                
                const integrityBadge = createIntegrityBadge(
                    entry.integrity_status || 'gray',
                    entry.integrity_message || 'No validation'
                );
                
                row.innerHTML = `
                    <td>${entry.date}</td>
                    <td>${integrityBadge}</td>
                    <td>${entry.weight?.toFixed(1) || ''}</td>
                    <td>${entry.bf_percent?.toFixed(1) || ''}%</td>
                    <td>${entry.bf_lbs?.toFixed(1) || ''}</td>
                    <td>${entry.lean_lbs?.toFixed(1) || ''}</td>
                    <td>${entry.calories || ''}</td>
                    <td>${entry.protein || ''}</td>
                    <td>${entry.fat || ''}</td>
                    <td>${entry.carbs || ''}</td>
                    <td>${entry.steps || ''}</td>
                    <td>${entry.rhr || ''}</td>
                    <td>${entry.sleep_score || ''}</td>
                    <td>${entry.sleep_duration_hrs?.toFixed(1) || ''}</td>
                    <td>${entry.refeed ? 'üî•' : ''}</td>
                    <td>
                        <div class="edit-actions">
                            <button class="danger" onclick="deleteEntry('${entry.date}')">√ó</button>
                        </div>
                    </td>
                `;
                
                row.onclick = (e) => {
                    if (!e.target.classList.contains('danger')) {
                        editEntry(entry.date);
                    }
                };
                
                tbody.appendChild(row);
            });
        }

        // ===== MODAL FUNCTIONS =====
        
        function showAddEntry() {
            document.getElementById('modalTitle').textContent = 'Add New Entry';
            document.getElementById('entryDate').value = new Date().toISOString().split('T')[0];
            clearForm();
            document.getElementById('addEntryModal').classList.add('show');
            updateModalDerivedFields();
        }
        
        function editEntry(date) {
            const entry = bodyData.find(e => e.date === date);
            if (!entry) return;
            
            document.getElementById('modalTitle').textContent = 'Edit Entry';
            document.getElementById('entryDate').value = entry.date;
            document.getElementById('entryWeight').value = entry.weight || '';
            document.getElementById('entryBfPercent').value = entry.bf_percent || '';
            document.getElementById('entryLeanLbs').value = entry.lean_lbs || '';
            document.getElementById('entryCalories').value = entry.calories || '';
            document.getElementById('entryProtein').value = entry.protein || '';
            document.getElementById('entryFat').value = entry.fat || '';
            document.getElementById('entryCarbs').value = entry.carbs || '';
            document.getElementById('entrySteps').value = entry.steps || '';
            document.getElementById('entryRhr').value = entry.rhr || '';
            document.getElementById('entrySleepScore').value = entry.sleep_score || '';
            document.getElementById('entrySleepHours').value = entry.sleep_duration_hrs || '';
            document.getElementById('entryRefeed').checked = entry.refeed || false;
            document.getElementById('entryNotes').value = entry.notes || '';
            
            updateModalDerivedFields();
            document.getElementById('addEntryModal').classList.add('show');
        }
        
        function hideModal() {
            document.getElementById('addEntryModal').classList.remove('show');
            clearForm();
        }
        
        function clearForm() {
            document.getElementById('entryWeight').value = '';
            document.getElementById('entryBfPercent').value = '';
            document.getElementById('entryLeanLbs').value = '';
            document.getElementById('entryCalories').value = '';
            document.getElementById('entryProtein').value = '';
            document.getElementById('entryFat').value = '';
            document.getElementById('entryCarbs').value = '';
            document.getElementById('entrySteps').value = '';
            document.getElementById('entryRhr').value = '';
            document.getElementById('entrySleepScore').value = '';
            document.getElementById('entrySleepHours').value = '';
            document.getElementById('entryRefeed').checked = false;
            document.getElementById('entryNotes').value = '';
            updateModalDerivedFields();
        }
        
        function updateModalDerivedFields() {
            const weight = parseFloat(document.getElementById('entryWeight').value);
            const bfPercent = parseFloat(document.getElementById('entryBfPercent').value);
            const leanLbs = parseFloat(document.getElementById('entryLeanLbs').value);
            
            const derived = computeDerivedFields(weight, bfPercent, leanLbs);
            
            if (derived) {
                document.getElementById('entryBfLbsAuto').value = derived.bf_lbs.toFixed(1);
                document.getElementById('entryLeanPercentAuto').value = derived.lean_percent.toFixed(1) + '%';
                document.getElementById('entryResidualAuto').value = derived.residual.toFixed(2);
            } else {
                document.getElementById('entryBfLbsAuto').value = '';
                document.getElementById('entryLeanPercentAuto').value = '';
                document.getElementById('entryResidualAuto').value = '';
            }
            
            // Update integrity status in modal
            const integrity = computeIntegrityStatus(weight, bfPercent, leanLbs);
            const statusDiv = document.getElementById('modalIntegrityStatus');
            
            if (integrity.status === 'gray') {
                statusDiv.innerHTML = '';
            } else {
                const badge = createIntegrityBadge(integrity.status, integrity.message);
                let details = `<p style="margin: 5px 0; font-size: 0.9em; color: var(--text-secondary);">${integrity.message}</p>`;
                
                if (integrity.residualDelta !== undefined) {
                    details += `<p style="margin: 5px 0; font-size: 0.85em; font-family: 'Space Mono', monospace; color: var(--text-secondary);">
                        Residual: ${integrity.derived.residual.toFixed(2)} lbs | 
                        Baseline: ${integrity.baselineMean?.toFixed(2) || 'N/A'} lbs | 
                        Delta: ${integrity.residualDelta.toFixed(2)} lbs
                    </p>`;
                }
                
                statusDiv.innerHTML = `
                    <div style="background: rgba(6, 182, 212, 0.05); border: 1px solid var(--border); padding: 15px; border-radius: 8px;">
                        <div style="margin-bottom: 8px;">${badge}</div>
                        ${details}
                    </div>
                `;
            }
        }
        
        // Auto-update when user types
        ['entryWeight', 'entryBfPercent', 'entryLeanLbs'].forEach(id => {
            document.addEventListener('DOMContentLoaded', () => {
                document.getElementById(id)?.addEventListener('input', updateModalDerivedFields);
            });
        });
        
        function saveEntry() {
            const date = document.getElementById('entryDate').value;
            const weight = parseFloat(document.getElementById('entryWeight').value);
            const bf_percent = parseFloat(document.getElementById('entryBfPercent').value);
            const lean_lbs = parseFloat(document.getElementById('entryLeanLbs').value);
            
            if (!date || !isFinite(weight) || !isFinite(bf_percent) || !isFinite(lean_lbs)) {
                showToast('Please fill in required fields: Date, Weight, BF%, Lean Mass', true);
                return;
            }
            
            // Validate integrity
            const integrity = computeIntegrityStatus(weight, bf_percent, lean_lbs);
            
            // Show warning for yellow or red status
            if (integrity.status === 'red') {
                const confirm = window.confirm(
                    `‚ö†Ô∏è DATA INTEGRITY WARNING\n\n` +
                    `${integrity.message}\n\n` +
                    `${integrity.errors.join('\n')}\n\n` +
                    `This may indicate a data entry error.\n` +
                    `Please double-check your values from the Hume app.\n\n` +
                    `Save anyway?`
                );
                if (!confirm) return;
            } else if (integrity.status === 'yellow') {
                const confirm = window.confirm(
                    `‚ö†Ô∏è Slight Variance Detected\n\n` +
                    `${integrity.message}\n\n` +
                    `Residual: ${integrity.derived.residual.toFixed(2)} lbs\n` +
                    `Baseline: ${integrity.baselineMean.toFixed(2)} lbs\n` +
                    `Delta: ${integrity.residualDelta.toFixed(2)} lbs\n\n` +
                    `This is usually normal day-to-day variance.\n` +
                    `Continue saving?`
                );
                if (!confirm) return;
            }
            
            const entry = {
                date,
                weight,
                bf_percent,
                lean_lbs,
                bf_lbs: integrity.derived.bf_lbs,
                lean_percent: integrity.derived.lean_percent,
                residual: integrity.derived.residual,
                calories: parseFloat(document.getElementById('entryCalories').value) || null,
                protein: parseFloat(document.getElementById('entryProtein').value) || null,
                fat: parseFloat(document.getElementById('entryFat').value) || null,
                carbs: parseFloat(document.getElementById('entryCarbs').value) || null,
                steps: parseFloat(document.getElementById('entrySteps').value) || null,
                rhr: parseFloat(document.getElementById('entryRhr').value) || null,
                sleep_score: parseFloat(document.getElementById('entrySleepScore').value) || null,
                sleep_duration_hrs: parseFloat(document.getElementById('entrySleepHours').value) || null,
                refeed: document.getElementById('entryRefeed').checked,
                notes: document.getElementById('entryNotes').value,
                integrity_status: integrity.status,
                integrity_message: integrity.message
            };
            
            // Remove existing entry with same date
            bodyData = bodyData.filter(e => e.date !== date);
            bodyData.push(entry);
            bodyData.sort((a, b) => a.date.localeCompare(b.date));
            
            saveData();
            updateStats();
            updateTable();
            updateChart();
            hideModal();
            
            showToast(`Entry saved for ${date}\nIntegrity: ${integrity.message}`);
        }
        
        function deleteEntry(date) {
            if (!confirm(`Delete entry for ${date}?`)) return;
            
            bodyData = bodyData.filter(e => e.date !== date);
            saveData();
            updateStats();
            updateTable();
            updateChart();
            showToast(`Deleted entry for ${date}`);
        }

        // ===== CHART FUNCTIONS =====
        
        function switchChart(chartType) {
            currentChartType = chartType;
            
            // Update active tab
            document.querySelectorAll('.chart-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            
            updateChart();
        }
        
        function updateChart() {
            if (currentChart) {
                currentChart.destroy();
            }
            
            const sorted = bodyData.slice().sort((a, b) => a.date.localeCompare(b.date));
            
            if (sorted.length === 0) return;
            
            const ctx = document.getElementById('mainChart').getContext('2d');
            
            switch (currentChartType) {
                case 'fatVsLean':
                    currentChart = createFatVsLeanChart(ctx, sorted);
                    break;
                case 'weightTrend':
                    currentChart = createWeightTrendChart(ctx, sorted);
                    break;
                case 'rateOfChange':
                    currentChart = createRateOfChangeChart(ctx, sorted);
                    break;
                case 'nutrition':
                    currentChart = createNutritionChart(ctx, sorted);
                    break;
            }
        }
        
        function createFatVsLeanChart(ctx, data) {
            return new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [
                        {
                            label: 'Fat Mass',
                            data: data.map(d => d.bf_lbs),
                            backgroundColor: 'rgba(239, 68, 68, 0.3)',
                            borderColor: 'rgba(239, 68, 68, 1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.3
                        },
                        {
                            label: 'Lean Mass',
                            data: data.map(d => d.lean_lbs),
                            backgroundColor: 'rgba(16, 185, 129, 0.3)',
                            borderColor: 'rgba(16, 185, 129, 1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Body Composition: Fat vs Lean Mass',
                            color: '#f1f5f9',
                            font: { size: 16 }
                        },
                        legend: {
                            labels: { color: '#f1f5f9' }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(51, 65, 85, 0.3)' }
                        },
                        y: {
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(51, 65, 85, 0.3)' },
                            title: {
                                display: true,
                                text: 'Mass (lbs)',
                                color: '#f1f5f9'
                            }
                        }
                    }
                }
            });
        }
        
        function createWeightTrendChart(ctx, data) {
            return new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [
                        {
                            label: 'Weight (lbs)',
                            data: data.map(d => d.weight),
                            backgroundColor: 'rgba(6, 182, 212, 0.1)',
                            borderColor: 'rgba(6, 182, 212, 1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.3,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Body Fat %',
                            data: data.map(d => d.bf_percent),
                            backgroundColor: 'rgba(139, 92, 246, 0.1)',
                            borderColor: 'rgba(139, 92, 246, 1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.3,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Weight & Body Fat % Trend',
                            color: '#f1f5f9',
                            font: { size: 16 }
                        },
                        legend: {
                            labels: { color: '#f1f5f9' }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(51, 65, 85, 0.3)' }
                        },
                        y: {
                            type: 'linear',
                            position: 'left',
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(51, 65, 85, 0.3)' },
                            title: {
                                display: true,
                                text: 'Weight (lbs)',
                                color: '#06b6d4'
                            }
                        },
                        y1: {
                            type: 'linear',
                            position: 'right',
                            ticks: { color: '#94a3b8' },
                            grid: { display: false },
                            title: {
                                display: true,
                                text: 'Body Fat %',
                                color: '#8b5cf6'
                            }
                        }
                    }
                }
            });
        }
        
        function createRateOfChangeChart(ctx, data) {
            const changes = data.slice(1).map((d, i) => ({
                date: d.date,
                weightChange: d.weight - data[i].weight,
                fatChange: d.bf_lbs - data[i].bf_lbs,
                leanChange: d.lean_lbs - data[i].lean_lbs
            }));
            
            return new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: changes.map(d => d.date),
                    datasets: [
                        {
                            label: 'Weight Œî',
                            data: changes.map(d => d.weightChange),
                            backgroundColor: 'rgba(6, 182, 212, 0.7)',
                            borderColor: 'rgba(6, 182, 212, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Fat Œî',
                            data: changes.map(d => d.fatChange),
                            backgroundColor: 'rgba(239, 68, 68, 0.7)',
                            borderColor: 'rgba(239, 68, 68, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Lean Œî',
                            data: changes.map(d => d.leanChange),
                            backgroundColor: 'rgba(16, 185, 129, 0.7)',
                            borderColor: 'rgba(16, 185, 129, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Daily Rate of Change',
                            color: '#f1f5f9',
                            font: { size: 16 }
                        },
                        legend: {
                            labels: { color: '#f1f5f9' }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(51, 65, 85, 0.3)' }
                        },
                        y: {
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(51, 65, 85, 0.3)' },
                            title: {
                                display: true,
                                text: 'Change (lbs)',
                                color: '#f1f5f9'
                            }
                        }
                    }
                }
            });
        }
        
        function createNutritionChart(ctx, data) {
            const withNutrition = data.filter(d => d.calories);
            
            return new Chart(ctx, {
                type: 'line',
                data: {
                    labels: withNutrition.map(d => d.date),
                    datasets: [
                        {
                            label: 'Calories',
                            data: withNutrition.map(d => d.calories),
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            borderColor: 'rgba(245, 158, 11, 1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.3,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Protein (g)',
                            data: withNutrition.map(d => d.protein),
                            backgroundColor: 'rgba(6, 182, 212, 0.1)',
                            borderColor: 'rgba(6, 182, 212, 1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.3,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Nutrition Tracking',
                            color: '#f1f5f9',
                            font: { size: 16 }
                        },
                        legend: {
                            labels: { color: '#f1f5f9' }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(51, 65, 85, 0.3)' }
                        },
                        y: {
                            type: 'linear',
                            position: 'left',
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(51, 65, 85, 0.3)' },
                            title: {
                                display: true,
                                text: 'Calories',
                                color: '#f59e0b'
                            }
                        },
                        y1: {
                            type: 'linear',
                            position: 'right',
                            ticks: { color: '#94a3b8' },
                            grid: { display: false },
                            title: {
                                display: true,
                                text: 'Protein (g)',
                                color: '#06b6d4'
                            }
                        }
                    }
                }
            });
        }

        // ===== EXPORT FUNCTIONS =====
        
        function exportCSV() {
            if (bodyData.length === 0) {
                showToast('No data to export', true);
                return;
            }
            
            const headers = [
                'Date', 'Weight', 'BF%', 'BF lbs', 'Lean lbs', 'Lean%', 'Residual',
                'Calories', 'Protein', 'Fat', 'Carbs', 'Steps', 'RHR', 
                'Sleep Score', 'Sleep Hrs', 'Refeed', 'Integrity', 'Notes'
            ];
            
            const rows = bodyData
                .slice()
                .sort((a, b) => a.date.localeCompare(b.date))
                .map(d => [
                    d.date,
                    d.weight?.toFixed(1) || '',
                    d.bf_percent?.toFixed(1) || '',
                    d.bf_lbs?.toFixed(1) || '',
                    d.lean_lbs?.toFixed(1) || '',
                    d.lean_percent?.toFixed(1) || '',
                    d.residual?.toFixed(2) || '',
                    d.calories || '',
                    d.protein || '',
                    d.fat || '',
                    d.carbs || '',
                    d.steps || '',
                    d.rhr || '',
                    d.sleep_score || '',
                    d.sleep_duration_hrs?.toFixed(2) || '',
                    d.refeed ? 'Yes' : 'No',
                    d.integrity_status || '',
                    `"${(d.notes || '').replace(/"/g, '""')}"`
                ]);
            
            const csv = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `body-tracker-export-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            
            showToast('CSV exported successfully!');
        }
        
        function exportBackup() {
            if (bodyData.length === 0) {
                showToast('No data to backup', true);
                return;
            }
            
            const backup = {
                version: '2.0',
                exportDate: new Date().toISOString(),
                entries: bodyData.length,
                goals: GOALS,
                data: bodyData
            };
            
            const json = JSON.stringify(backup, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `body-tracker-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showToast('Backup created successfully!');
        }
        
        // ===== UTILITY FUNCTIONS =====
        
        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast show';
            if (isError) toast.classList.add('error');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
        
        function debugData() {
            console.log('=== BODY TRACKER DEBUG ===');
            console.log('Total entries:', bodyData.length);
            console.log('Storage key:', STORAGE_KEY);
            console.log('Goals:', GOALS);
            console.log('Integrity config:', INTEGRITY_CONFIG);
            console.log('Data sample:', bodyData.slice(0, 3));
            console.log('Latest entry:', bodyData[bodyData.length - 1]);
            
            // Integrity distribution
            const integrityCount = bodyData.reduce((acc, e) => {
                acc[e.integrity_status || 'unknown'] = (acc[e.integrity_status || 'unknown'] || 0) + 1;
                return acc;
            }, {});
            console.log('Integrity distribution:', integrityCount);
            
            // Residual stats
            const residuals = bodyData.filter(e => e.residual !== undefined).map(e => e.residual);
            if (residuals.length > 0) {
                const avgResidual = residuals.reduce((sum, r) => sum + r, 0) / residuals.length;
                const minResidual = Math.min(...residuals);
                const maxResidual = Math.max(...residuals);
                console.log('Residual stats:', {
                    avg: avgResidual.toFixed(2),
                    min: minResidual.toFixed(2),
                    max: maxResidual.toFixed(2),
                    range: (maxResidual - minResidual).toFixed(2)
                });
            }
            
            showToast('Debug info logged to console\n(Press F12 to view)');
        }
        
        // ===== INITIALIZATION =====
        
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ Body Tracker Pro - Ultimate Edition');
            console.log('‚ú® With Intelligent Data Integrity Validation');
            
            loadData();
            updateStats();
            updateTable();
            updateChart();
            
            console.log(`‚úÖ Loaded ${bodyData.length} entries`);
            
            // Show welcome message for first-time users
            const hasSeenWelcome = localStorage.getItem('hasSeenWelcome');
            if (!hasSeenWelcome) {
                setTimeout(() => {
                    showToast(
                        'üéâ Welcome to Body Tracker Pro Ultimate!\n\n' +
                        '‚ú® Now with intelligent data validation\n' +
                        'üõ°Ô∏è Automatic error detection\n' +
                        'üìä All 48 days pre-loaded\n\n' +
                        'Look for integrity badges (‚úì ‚ö† ‚úó) in your data!'
                    );
                    localStorage.setItem('hasSeenWelcome', 'true');
                }, 500);
            }
        });
    </script>
</body>
</html>
